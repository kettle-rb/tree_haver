<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: CHANGELOG
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "CHANGELOG";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: CHANGELOG</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="changelog">Changelog</h1>

<p><a href="https://semver.org/spec/v2.0.0.html"><img src="https://img.shields.io/badge/semver-2.0.0-FFDD67.svg?style=flat" alt="SemVer 2.0.0"></a> <a href="https://keepachangelog.com/en/1.0.0/"><img src="https://img.shields.io/badge/keep--a--changelog-1.0.0-FFDD67.svg?style=flat" alt="Keep-A-Changelog 1.0.0"></a></p>

<p>All notable changes to this project will be documented in this file.</p>

<p>The format is based on <a href="https://keepachangelog.com/en/1.0.0/">Keep a Changelog</a>,<br>
and this project adheres to <a href="https://semver.org/spec/v2.0.0.html">Semantic Versioning</a>,<br>
and <a href="https://tom.preston-werner.com/2022/05/23/major-version-numbers-are-not-sacred.html">yes</a>, platform and engine support are part of the <a href="https://github.com/semver/semver/issues/716#issuecomment-869336139">public API</a>.<br>
Please file a bug if you notice a violation of semantic versioning.</p>

<h2 id="unreleased"><a href="https://github.com/kettle-rb/tree_haver/compare/v5.0.2...HEAD">Unreleased</a></h2>

<h3 id="added">Added</h3>

<h3 id="changed">Changed</h3>

<h3 id="deprecated">Deprecated</h3>

<h3 id="removed">Removed</h3>

<h3 id="fixed">Fixed</h3>

<ul>
  <li>Documentation fixes related to gem family section</li>
</ul>

<h3 id="security">Security</h3>

<h2 id="502---2026-01-13">
<a href="https://github.com/kettle-rb/tree_haver/compare/v5.0.1...v5.0.2">5.0.2</a> - 2026-01-13</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v5.0.2">v5.0.2</a>
</li>
  <li>COVERAGE: 90.79% – 2308/2542 lines in 30 files</li>
  <li>BRANCH COVERAGE: 78.09% – 930/1191 branches in 30 files</li>
  <li>94.78% documented</li>
</ul>

<h3 id="added-1">Added</h3>

<ul>
  <li>More documentation about the Merge Gem Family</li>
  <li>
<strong><code>:json_parsing</code> and <code>:jsonc_parsing</code> RSpec dependency tags</strong>: Added missing parsing capability tags<br>
for JSON and JSONC (JSON with Comments) languages
    <ul>
      <li>
<code>any_json_backend_available?</code> - Checks if tree-sitter-json is available</li>
      <li>
<code>any_jsonc_backend_available?</code> - Checks if tree-sitter-jsonc is available</li>
      <li>Tests tagged with <code>:jsonc_parsing</code> will now be properly skipped on TruffleRuby and other<br>
platforms where tree-sitter backends are not available</li>
      <li>Fixes issue where jsonc-merge specs were running on TruffleRuby and failing because<br>
the tag was undefined and therefore not excluded</li>
    </ul>
  </li>
</ul>

<h3 id="changed-1">Changed</h3>

<ul>
  <li>Restored README.md (was accidentally corrupted during the last release)</li>
</ul>

<h2 id="501---2026-01-11">
<a href="https://github.com/kettle-rb/tree_haver/compare/v5.0.0...v5.0.1">5.0.1</a> - 2026-01-11</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v5.0.1">v5.0.1</a>
</li>
  <li>COVERAGE: 90.79% – 2308/2542 lines in 30 files</li>
  <li>BRANCH COVERAGE: 78.09% – 930/1191 branches in 30 files</li>
  <li>94.76% documented</li>
</ul>

<h3 id="added-2">Added</h3>

<ul>
  <li>
<code>TreeHaver::RSpec::TestableNode</code> - A testable node class for creating mock TreeHaver::Node instances<br>
in tests without requiring an actual parser backend. Available via <code>require "tree_haver/rspec/testable_node"</code><br>
or automatically when using <code>require "tree_haver/rspec"</code>.
    <ul>
      <li>
<code>TestableNode.create(type:, text:, ...)</code> - Create a single test node</li>
      <li>
<code>TestableNode.create_list(...)</code> - Create multiple test nodes</li>
      <li>
<code>MockInnerNode</code> - The underlying mock that simulates backend-specific nodes</li>
      <li>Top-level <code>TestableNode</code> constant for convenience in specs</li>
    </ul>
  </li>
  <li>
<strong>Fully Dynamic Tag Registration</strong> in <code>TreeHaver::BackendRegistry</code>:
    <ul>
      <li>
<code>register_tag(tag_name, category:, backend_name:, require_path:)</code> - Register a complete dependency tag<br>
with lazy loading support. External gems can now get full RSpec tag support without any hardcoded<br>
knowledge in tree_haver.</li>
      <li>
<code>tag_available?(tag_name)</code> - Check if a tag’s dependency is available, with automatic lazy loading<br>
via the registered <code>require_path</code>
</li>
      <li>
<code>registered_tags</code> - Get all registered tag names</li>
      <li>
<code>tags_by_category(category)</code> - Get tags filtered by category (:backend, :gem, :parsing, :grammar, :engine, :other)</li>
      <li>
<code>tag_metadata(tag_name)</code> - Get full metadata for a registered tag</li>
      <li>
<code>tag_summary</code> - Get availability status of all registered tags</li>
    </ul>
  </li>
</ul>

<h3 id="changed-2">Changed</h3>

<ul>
  <li>
<strong>Fully Dynamic Backend Availability</strong> in <code>BackendRegistry</code> and <code>DependencyTags</code>:
    <ul>
      <li>
<code>register_tag</code> now dynamically defines <code>*_available?</code> methods on <code>DependencyTags</code> at registration time</li>
      <li>External gems automatically get availability methods when they call <code>register_tag</code>
</li>
      <li>No changes to tree_haver are needed for new external backend gems</li>
      <li>Built-in backends (prism, psych, citrus, parslet) retain explicit methods</li>
      <li>
<code>summary</code> method dynamically includes registered backends from BackendRegistry</li>
      <li>
<code>backend_availability_methods</code> and <code>backend_tags</code> hashes are built dynamically</li>
    </ul>
  </li>
  <li>RSpec exclusion filters for backend tags are configured dynamically from BackendRegistry</li>
</ul>

<h3 id="fixed-1">Fixed</h3>

<ul>
  <li>
<strong><code>TreeHaver::Parser#unwrap_language</code> bug fix for MRI and Rust backends</strong>
    <ul>
      <li>
<code>:mri</code> and <code>:rust</code> cases were not returning the unwrapped language value</li>
      <li>The code called <code>lang.to_language</code> / <code>lang.inner_language</code> / <code>lang.name</code> but didn’t <code>return</code> the result</li>
      <li>Now properly returns the unwrapped language for all backend types</li>
    </ul>
  </li>
  <li>
<code>any_markdown_backend_available?</code> now uses <code>BackendRegistry.tag_available?</code> instead of calling<br>
<code>markly_available?</code> and <code>commonmarker_available?</code> directly. This fixes <code>NoMethodError</code> when<br>
the external markdown backend gems haven’t registered their tags yet.</li>
</ul>

<h2 id="500---2026-01-11">
<a href="https://github.com/kettle-rb/tree_haver/compare/v4.0.5...v5.0.0">5.0.0</a> - 2026-01-11</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v5.0.0">v5.0.0</a>
</li>
  <li>COVERAGE: 92.04% – 2289/2487 lines in 30 files</li>
  <li>BRANCH COVERAGE: 79.33% – 929/1171 branches in 30 files</li>
  <li>96.21% documented</li>
</ul>

<h3 id="added-3">Added</h3>

<ul>
  <li>
<strong>Shared Example Groups for Backend API Compliance Testing</strong>
    <ul>
      <li>
<code>node_api_examples.rb</code> - Tests for Node API compliance:
        <ul>
          <li>
<code>"node api compliance"</code> - Core Node interface (type, start_byte, end_byte, children)</li>
          <li>
<code>"node position api"</code> - Position API (start_point, end_point, start_line, end_line, source_position)</li>
          <li>
<code>"node children api"</code> - Children traversal (#child, #first_child, #last_child)</li>
          <li>
<code>"node enumerable behavior"</code> - Enumerable methods (#each, #map, #select, #find)</li>
          <li>
<code>"node comparison behavior"</code> - Comparison and equality (#==, #&lt;=&gt;, #hash)</li>
          <li>
<code>"node text extraction"</code> - Text content (#text, #to_s)</li>
          <li>
<code>"node inspection"</code> - Debug output (#inspect)</li>
        </ul>
      </li>
      <li>
<code>tree_api_examples.rb</code> - Tests for Tree API compliance:
        <ul>
          <li>
<code>"tree api compliance"</code> - Core Tree interface (root_node, source, errors, warnings, comments)</li>
          <li>
<code>"tree error handling"</code> - Error detection (#has_error?, #errors)</li>
          <li>
<code>"tree traversal"</code> - Depth-first traversal via root_node</li>
        </ul>
      </li>
      <li>
<code>parser_api_examples.rb</code> - Tests for Parser API compliance:
        <ul>
          <li>
<code>"parser api compliance"</code> - Core Parser interface (#parse, #parse_string, #language=)</li>
          <li>
<code>"parser incremental parsing"</code> - Incremental parsing support</li>
          <li>
<code>"parser error handling"</code> - Error recovery behavior</li>
        </ul>
      </li>
      <li>
<code>language_api_examples.rb</code> - Tests for Language API compliance:
        <ul>
          <li>
<code>"language api compliance"</code> - Core Language interface (#backend, #name/#language_name)</li>
          <li>
<code>"language comparison"</code> - Comparison and equality</li>
          <li>
<code>"language factory methods"</code> - Factory methods (.from_library, .from_path)</li>
        </ul>
      </li>
      <li>
<code>backend_api_examples.rb</code> - Tests for Backend module API compliance:
        <ul>
          <li>
<code>"backend module api"</code> - Backend availability and capabilities</li>
          <li>
<code>"backend class structure"</code> - Nested class verification</li>
          <li>
<code>"backend integration"</code> - Full parse cycle testing</li>
        </ul>
      </li>
      <li>
<code>spec/support/shared_examples.rb</code> - Master loader for all shared examples</li>
      <li>
<code>spec/integration/backend_api_compliance_spec.rb</code> - Integration tests using all shared examples</li>
    </ul>
  </li>
  <li>
<strong>Parslet Backend</strong>: New pure Ruby PEG parser backend (<code>TreeHaver::Backends::Parslet</code>)
    <ul>
      <li>Wraps Parslet-based parsers (like the <code>toml</code> gem) to provide a pure Ruby alternative to tree-sitter</li>
      <li>
<code>Parslet.available?</code> - Check if parslet gem is available</li>
      <li>
<code>Parslet.capabilities</code> - Returns <code>{ backend: :parslet, query: false, bytes_field: true, incremental: false, pure_ruby: true }</code>
</li>
      <li>
<code>Parslet::Language</code> - Wrapper for Parslet grammar classes
        <ul>
          <li>
<code>Language.new(grammar_class)</code> - Create from a Parslet::Parser subclass</li>
          <li>
<code>Language.from_library(path, symbol:, name:)</code> - API-compatible lookup via LanguageRegistry</li>
          <li>
<code>#language_name</code> / <code>#name</code> - Derive language name from grammar class</li>
        </ul>
      </li>
      <li>
<code>Parslet::Parser</code> - Wrapper that creates parser instances from grammar classes
        <ul>
          <li>Accepts both raw grammar class and Language wrapper (normalized API)</li>
        </ul>
      </li>
      <li>
<code>Parslet::Tree</code> - Wraps Parslet parse results, inherits from <code>Base::Tree</code>
</li>
      <li>
<code>Parslet::Node</code> - Unified node interface, inherits from <code>Base::Node</code>
        <ul>
          <li>Supports both Hash nodes (with named children) and Array nodes (with indexed children)</li>
          <li>
<code>#type</code> - Returns the node type (key name or “array”/”document”)</li>
          <li>
<code>#children</code> - Returns child nodes</li>
          <li>
<code>#child_by_field_name(name)</code> - Access named children in Hash nodes</li>
          <li>
<code>#text</code> - Returns the matched text from Parslet::Slice</li>
          <li>
<code>#start_byte</code>, <code>#end_byte</code> - Byte positions from Parslet::Slice</li>
          <li>
<code>#start_point</code>, <code>#end_point</code> - Line/column positions (computed from source)</li>
        </ul>
      </li>
      <li>Registered with <code>BackendRegistry.register_availability_checker(:parslet)</code>
</li>
    </ul>
  </li>
  <li>
<strong>RSpec Dependency Tags</strong>: Added <code>parslet_available?</code> method
    <ul>
      <li>Checks if parslet gem is installed via <code>BackendRegistry.available?(:parslet)</code>
</li>
      <li>
<code>:parslet_backend</code> tag for specs requiring Parslet</li>
      <li>
<code>:not_parslet_backend</code> negated tag for specs that should skip when Parslet is available</li>
    </ul>
  </li>
  <li>
<strong>RSpec Dependency Tags</strong>: Added <code>toml_gem_available?</code> method and updated <code>any_toml_backend_available?</code>
    <ul>
      <li>
<code>:toml_gem</code> tag for specs requiring the <code>toml</code> gem to be available</li>
      <li>
<code>:not_toml_gem</code> negated tag for specs that should skip when the <code>toml</code> gem is not available</li>
    </ul>
  </li>
  <li>
<strong>ParsletGrammarFinder</strong>: Utility for discovering and registering Parslet grammar gems
    <ul>
      <li>
<code>ParsletGrammarFinder.new(language:, gem_name:, grammar_const:, require_path:)</code> - Find Parslet grammars</li>
      <li>
<code>#available?</code> - Check if the Parslet grammar gem is installed and functional</li>
      <li>
<code>#grammar_class</code> - Get the resolved Parslet::Parser subclass</li>
      <li>
<code>#register!</code> - Register the grammar with TreeHaver</li>
      <li>Auto-loads via <code>TreeHaver::PARSLET_DEFAULTS</code> for known languages (toml)</li>
    </ul>
  </li>
  <li>
<strong>TreeHaver.register_language</strong>: Extended with <code>grammar_class:</code> parameter for Parslet grammars</li>
  <li>
<strong>TreeHaver.parser_for</strong>: Extended with <code>parslet_config:</code> parameter for explicit Parslet configuration</li>
  <li>
<code>MRI::Language#language_name</code> / <code>#name</code> - Derive language name from symbol or path</li>
  <li>
<code>FFI::Language#language_name</code> / <code>#name</code> - Derive language name from symbol or path</li>
  <li>
<strong>spec_helper.rb</strong>: Added <code>require "toml"</code> to load the toml gem for Parslet backend tests</li>
</ul>

<h3 id="changed-3">Changed</h3>

<ul>
  <li>
<strong>BREAKING: <code>TreeHaver::Language</code> converted from class to module</strong>
    <ul>
      <li>Previously <code>TreeHaver::Language</code> was a class that wrapped backend language objects</li>
      <li>Now <code>TreeHaver::Language</code> is a module providing factory methods (<code>method_missing</code> for dynamic language loading)</li>
      <li>Backend-specific language classes (e.g., <code>TreeHaver::Backends::MRI::Language</code>) are now the concrete implementations</li>
      <li>Code that instantiated <code>TreeHaver::Language.new(...)</code> directly must be updated to use backend-specific classes or the factory methods</li>
    </ul>
  </li>
  <li>
<strong>BREAKING: <code>TreeHaver::Tree</code> now inherits from <code>TreeHaver::Base::Tree</code></strong>
    <ul>
      <li>
<code>TreeHaver::Tree</code> is now a proper subclass of <code>TreeHaver::Base::Tree</code>
</li>
      <li>Inherits <code>inner_tree</code>, <code>source</code>, <code>lines</code> attributes from base class</li>
      <li>Base class provides default implementations; subclass documents divergence</li>
    </ul>
  </li>
  <li>
<strong>BREAKING: <code>TreeHaver::Node</code> now inherits from <code>TreeHaver::Base::Node</code></strong>
    <ul>
      <li>
<code>TreeHaver::Node</code> is now a proper subclass of <code>TreeHaver::Base::Node</code>
</li>
      <li>Inherits <code>inner_node</code>, <code>source</code>, <code>lines</code> attributes from base class</li>
      <li>Base class documents the API contract; subclass documents divergence</li>
    </ul>
  </li>
  <li>
<strong>BREAKING: <code>Citrus::Node</code> and <code>Citrus::Tree</code> now inherit from Base classes</strong>
    <ul>
      <li>
<code>Citrus::Node</code> now inherits from <code>TreeHaver::Base::Node</code>
</li>
      <li>
<code>Citrus::Tree</code> now inherits from <code>TreeHaver::Base::Tree</code>
</li>
      <li>Removes duplicated methods, uses inherited implementations</li>
      <li>Adds <code>#language_name</code> / <code>#name</code> methods for API compliance</li>
    </ul>
  </li>
  <li>
<strong>BREAKING: <code>Parslet::Node</code> and <code>Parslet::Tree</code> now inherit from Base classes</strong>
    <ul>
      <li>
<code>Parslet::Node</code> now inherits from <code>TreeHaver::Base::Node</code>
</li>
      <li>
<code>Parslet::Tree</code> now inherits from <code>TreeHaver::Base::Tree</code>
</li>
      <li>Removes duplicated methods, uses inherited implementations</li>
    </ul>
  </li>
  <li>
<strong>Base::Node#child now returns nil for negative indices</strong> (tree-sitter API compatibility)</li>
  <li>
<strong>Citrus::Parser#language= now accepts Language wrapper or raw grammar module</strong>
    <ul>
      <li>Both patterns now work: <code>parser.language = TomlRB::Document</code> or <code>parser.language = Citrus::Language.new(TomlRB::Document)</code>
</li>
    </ul>
  </li>
  <li>
<strong>Parslet::Parser#language= now accepts Language wrapper or raw grammar class</strong>
    <ul>
      <li>Both patterns now work: <code>parser.language = TOML::Parslet</code> or <code>parser.language = Parslet::Language.new(TOML::Parslet)</code>
</li>
    </ul>
  </li>
  <li>
<strong>TreeHaver::Parser#unwrap_language</strong> now passes Language wrappers directly to Citrus/Parslet backends
    <ul>
      <li>Previously unwrapped to raw grammar; now backends handle their own Language wrappers</li>
    </ul>
  </li>
  <li>
<strong>Language.method_missing</strong>: Now recognizes <code>:parslet</code> backend type and creates <code>Parslet::Language</code> instances</li>
  <li>
<strong>Parser</strong>: Updated to recognize Parslet languages and switch to Parslet parser automatically
    <ul>
      <li>
<code>#backend</code> now returns <code>:parslet</code> for Parslet-based parsers</li>
      <li>
<code>#language=</code> detects <code>Parslet::Language</code> and switches implementation</li>
      <li>
<code>handle_parser_creation_failure</code> tries Parslet as fallback after Citrus</li>
      <li>
<code>unwrap_language</code> extracts <code>grammar_class</code> for Parslet languages</li>
    </ul>
  </li>
</ul>

<h3 id="fixed-2">Fixed</h3>

<ul>
  <li>
<strong>FFI Backend Compliance Tests</strong>: Fixed tests to use <code>TreeHaver::Parser</code> wrapper instead of raw <code>FFI::Parser</code>
    <ul>
      <li>Raw FFI classes (<code>FFI::Tree</code>, <code>FFI::Node</code>) don’t have full API (missing <code>#children</code>, <code>#text</code>, <code>#source</code>, etc.)</li>
      <li>TreeHaver wrapper classes (<code>TreeHaver::Tree</code>, <code>TreeHaver::Node</code>) provide the complete unified API</li>
      <li>Tests now properly test the wrapped API that users actually interact with</li>
    </ul>
  </li>
  <li>
<strong>Parslet TOML Sources</strong>: Fixed test sources to be valid for the <code>toml</code> gem’s Parslet grammar
    <ul>
      <li>Grammar requires table sections (not bare key-value pairs at root)</li>
      <li>Grammar requires trailing newlines</li>
    </ul>
  </li>
  <li>
<strong>Examples</strong>: Fixed broken markdown examples that referenced non-existent TreeHaver backends
    <ul>
      <li>
<code>commonmarker_markdown.rb</code> - Rewrote to use commonmarker gem directly (not a TreeHaver backend)</li>
      <li>
<code>markly_markdown.rb</code> - Rewrote to use markly gem directly with correct <code>source_position</code> API</li>
      <li>
<code>commonmarker_merge_example.rb</code> - Fixed to use <code>commonmarker/merge</code> gem properly</li>
      <li>
<code>markly_merge_example.rb</code> - Fixed to use <code>markly/merge</code> gem properly</li>
      <li>
<code>parslet_toml.rb</code> - Rewrote to properly use TreeHaver’s Parslet backend with language registration</li>
    </ul>
  </li>
  <li>
<strong>Examples</strong>: Fixed <code>run_all.rb</code> test runner
    <ul>
      <li>Added parslet example to the test list</li>
      <li>Changed markdown examples to use <code>backend: "standalone"</code> (they’re not TreeHaver backends)</li>
      <li>Added MRI+TOML to known incompatibilities (parse returns nil)</li>
      <li>Added proper skip reason messages for all known incompatibilities</li>
    </ul>
  </li>
  <li>
<strong>Examples</strong>: Updated <code>examples/README.md</code> documentation
    <ul>
      <li>Added Parslet backend section with usage examples</li>
      <li>Renamed “Commonmarker Backend” and “Markly Backend” to “Commonmarker (Standalone)” and “Markly (Standalone)”</li>
      <li>Clarified that commonmarker and markly are standalone parsers, not TreeHaver backends</li>
    </ul>
  </li>
  <li>
<strong>Duplicate Constants</strong>: Removed duplicate <code>CITRUS_DEFAULTS</code> and <code>PARSLET_DEFAULTS</code> definitions
    <ul>
      <li>Constants were defined twice in <code>tree_haver.rb</code> (lines 170 and 315)</li>
      <li>This was causing “already initialized constant” warnings on every require</li>
    </ul>
  </li>
</ul>

<h2 id="405---2026-01-09">
<a href="https://github.com/kettle-rb/tree_haver/compare/v4.0.4...v4.0.5">4.0.5</a> - 2026-01-09</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v4.0.5">v4.0.5</a>
</li>
  <li>COVERAGE: 93.50% – 2058/2201 lines in 28 files</li>
  <li>BRANCH COVERAGE: 81.11% – 803/990 branches in 28 files</li>
  <li>95.60% documented</li>
</ul>

<h3 id="added-4">Added</h3>

<ul>
  <li>
<strong>FFI Backend</strong>: Added <code>child_by_field_name</code> method to <code>TreeHaver::Backends::FFI::Node</code>
    <ul>
      <li>Enables field-based child access using tree-sitter’s <code>ts_node_child_by_field_name</code> C API</li>
      <li>Works with all grammars (JSON, JSONC, TOML, Bash, etc.) that define field names</li>
      <li>Fixes compatibility issues with json-merge, jsonc-merge, and other gems that use field access</li>
      <li>Example: <code>pair.child_by_field_name("key")</code> returns the key node from a JSON pair</li>
    </ul>
  </li>
  <li>
<strong>RSpec Dependency Tags</strong>: Added <code>compute_blocked_backends</code> method
    <ul>
      <li>Determines blocked backends from <code>TREE_HAVER_BACKEND</code> env and ARGV <code>--tag</code> options</li>
      <li>Called by <code>summary</code> when <code>@blocked_backends</code> isn’t set yet (before RSpec.configure runs)</li>
      <li>Fixes issue where gem-specific <code>before(:suite)</code> hooks could load blocked backends</li>
    </ul>
  </li>
  <li>
<strong>RSpec Dependency Tags</strong>: Added <code>LD_LIBRARY_PATH</code> and <code>DYLD_LIBRARY_PATH</code> to <code>env_summary</code>
    <ul>
      <li>These library paths are relevant for tree-sitter shared library loading</li>
      <li>Useful for debugging grammar loading issues</li>
    </ul>
  </li>
  <li>
<strong>RSpec Dependency Tags</strong>: Added <code>TREE_SITTER_RBS_PATH</code> to <code>env_summary</code>
</li>
</ul>

<h3 id="changed-4">Changed</h3>

<ul>
  <li>
<strong>Language#method_missing</strong>: Simplified error handling in <code>Language#method_missing</code>
    <ul>
      <li>Removed unreachable rescue block for <code>FFI::NotFoundError</code>
</li>
      <li>
<code>FFI::NotFoundError</code> inherits from <code>LoadError</code>, so it’s already caught by the prior rescue clause</li>
      <li>Reduces code complexity without changing behavior</li>
    </ul>
  </li>
  <li>
<strong>Parser#initialize</strong>: Simplified error handling in <code>Parser#initialize</code>
    <ul>
      <li>Same fix as Language - removed unreachable <code>FFI::NotFoundError</code> handling</li>
      <li>Added comment noting that <code>FFI::NotFoundError</code> inherits from <code>LoadError</code>
</li>
    </ul>
  </li>
  <li>
<strong>FFI Backend Native#try_load!</strong>: Removed redundant <code>FFI::NotFoundError</code> from rescue clause
    <ul>
      <li>Only rescues <code>LoadError</code> now with comment explaining inheritance</li>
    </ul>
  </li>
  <li>
<strong>GrammarFinder.tree_sitter_runtime_usable?</strong>: Removed redundant <code>StandardError</code> rescue clause
    <ul>
      <li>
<code>LoadError</code> already catches <code>FFI::NotFoundError</code>
</li>
      <li>Added comment explaining the inheritance relationship</li>
    </ul>
  </li>
</ul>

<h3 id="fixed-3">Fixed</h3>

<ul>
  <li>
<strong>Test Isolation</strong>: Fixed state leakage in <code>language_registry_spec.rb</code>
    <ul>
      <li>Tests were registering real language names (<code>:toml</code>, <code>:json</code>, <code>:yaml</code>) with fake paths</li>
      <li>These registrations persisted and polluted other tests that expected real grammar paths</li>
      <li>Changed all tests to use unique test-only language names (prefixed with <code>test_lang_</code>)</li>
      <li>Fixes 2 spec failures when running all tests together (<code>TreeHaver::Tree#edit</code> specs)</li>
    </ul>
  </li>
</ul>

<h2 id="404---2026-01-09">
<a href="https://github.com/kettle-rb/tree_haver/compare/v4.0.3...v4.0.4">4.0.4</a> - 2026-01-09</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v4.0.4">v4.0.4</a>
</li>
  <li>COVERAGE: 95.27% – 2033/2134 lines in 28 files</li>
  <li>BRANCH COVERAGE: 84.07% – 802/954 branches in 28 files</li>
  <li>95.49% documented</li>
</ul>

<h3 id="fixed-4">Fixed</h3>

<ul>
  <li>
<strong>RSpec Dependency Tags</strong>: Fixed blocked backend tests not being excluded on JRuby
    <ul>
      <li>When <code>TREE_HAVER_BACKEND=ffi</code> is set, MRI backend is blocked to prevent conflicts</li>
      <li>Previously, this skipped BOTH the availability check AND the exclusion</li>
      <li>Now blocked backends are excluded without checking availability</li>
      <li>Tests tagged with <code>:mri_backend</code> now properly skip on JRuby when FFI is selected</li>
    </ul>
  </li>
</ul>

<h2 id="403---2026-01-08">
<a href="https://github.com/kettle-rb/tree_haver/compare/v4.0.2...v4.0.3">4.0.3</a> - 2026-01-08</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v4.0.3">v4.0.3</a>
</li>
  <li>COVERAGE: 95.27% – 2033/2134 lines in 28 files</li>
  <li>BRANCH COVERAGE: 84.17% – 803/954 branches in 28 files</li>
  <li>95.49% documented</li>
</ul>

<h3 id="changed-5">Changed</h3>

<ul>
  <li>
<strong>RSpec Dependency Tags</strong>: Refactored FFI backend isolation to use standard <code>:ffi_backend</code> tag
    <ul>
      <li>The <code>--tag ffi_backend</code> now triggers <code>isolated_test_mode</code> in <code>dependency_tags.rb</code>
</li>
      <li>This prevents MRI backend from loading during availability checks</li>
      <li>Legacy <code>*_backend_only</code> tags are still supported for backwards compatibility</li>
      <li>Simplifies the testing pattern: one tag serves as both dependency tag and isolation trigger</li>
    </ul>
  </li>
</ul>

<h3 id="deprecated-1">Deprecated</h3>

<ul>
  <li>
<strong><code>:ffi_backend_only</code> tag</strong>: Use <code>:ffi_backend</code> instead. The <code>*_backend_only</code> tags are now redundant.</li>
</ul>

<h2 id="402---2026-01-08">
<a href="https://github.com/kettle-rb/tree_haver/compare/v4.0.1...v4.0.2">4.0.2</a> - 2026-01-08</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v4.0.2">v4.0.2</a>
</li>
  <li>COVERAGE: 95.27% – 2033/2134 lines in 28 files</li>
  <li>BRANCH COVERAGE: 84.07% – 802/954 branches in 28 files</li>
  <li>95.49% documented</li>
</ul>

<h3 id="added-5">Added</h3>

<ul>
  <li>
<strong>FFI Backend</strong>: Implemented <code>missing?</code> method on <code>TreeHaver::Backends::FFI::Node</code>
    <ul>
      <li>Added <code>ts_node_is_missing</code> FFI function attachment</li>
      <li>This method was missing entirely, causing <code>NoMethodError</code> when checking for MISSING nodes</li>
    </ul>
  </li>
</ul>

<h3 id="changed-6">Changed</h3>

<ul>
  <li>
<strong>TreeHaver::Node</strong>: Removed defensive <code>respond_to?</code> checks from <code>has_error?</code> and <code>missing?</code> methods
    <ul>
      <li>All tree-sitter backends (MRI, Rust, FFI, Java) must implement these methods on their inner nodes</li>
      <li>This enforces proper backend API compliance rather than silently masking missing implementations</li>
    </ul>
  </li>
</ul>

<h3 id="fixed-5">Fixed</h3>

<ul>
  <li>
<strong>FFI Backend</strong>: Added explicit boolean conversion (<code>!!</code>) to <code>has_error?</code> return value
    <ul>
      <li>FFI <code>:bool</code> return type may behave inconsistently across Ruby versions and platforms</li>
      <li>Ensures <code>has_error?</code> always returns <code>true</code> or <code>false</code>, not truthy/falsy values</li>
    </ul>
  </li>
</ul>

<h2 id="401---2026-01-08">
<a href="https://github.com/kettle-rb/tree_haver/compare/v4.0.0...v4.0.1">4.0.1</a> - 2026-01-08</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v4.0.1">v4.0.1</a>
</li>
  <li>COVERAGE: 95.31% – 2032/2132 lines in 28 files</li>
  <li>BRANCH COVERAGE: 84.10% – 804/956 branches in 28 files</li>
  <li>95.48% documented</li>
</ul>

<h3 id="fixed-6">Fixed</h3>

<ul>
  <li>
<strong>FFI Backend</strong>: Implemented <code>has_error?</code> method on <code>TreeHaver::Backends::FFI::Node</code>
    <ul>
      <li>Previously was a stub that always returned <code>false</code>, causing parse errors to go undetected</li>
      <li>Now properly calls <code>ts_node_has_error</code> FFI function to detect syntax errors in parsed trees</li>
      <li>This fixes error detection on JRuby when using the FFI backend with tree-sitter grammars</li>
    </ul>
  </li>
</ul>

<h2 id="400---2026-01-08">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.2.6...v4.0.0">4.0.0</a> - 2026-01-08</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v4.0.0">v4.0.0</a>
</li>
  <li>COVERAGE: 95.31% – 2031/2131 lines in 28 files</li>
  <li>BRANCH COVERAGE: 84.21% – 805/956 branches in 28 files</li>
  <li>95.48% documented</li>
</ul>

<h3 id="added-6">Added</h3>

<ul>
  <li>
<strong>BackendRegistry</strong>: New <code>TreeHaver::BackendRegistry</code> module for registering backend availability checkers
    <ul>
      <li>Allows external gems (like <code>commonmarker-merge</code>, <code>markly-merge</code>, <code>rbs-merge</code>) to register their availability checkers</li>
      <li>
<code>register_availability_checker(backend_name, &amp;block)</code> - Register a callable that returns true if backend is available</li>
      <li>
<code>available?(backend_name)</code> - Check if a backend is available (results are cached)</li>
      <li>
<code>registered?(backend_name)</code> - Check if a checker is registered</li>
      <li>
<code>registered_backends</code> - Get all registered backend names</li>
      <li>Used by <code>TreeHaver::RSpec::DependencyTags</code> for dynamic backend detection</li>
    </ul>
  </li>
  <li>
<strong>Plugin System</strong>: <code>commonmarker-merge</code> and <code>markly-merge</code> now provide their own backends via <code>TreeHaver</code>’s registry system, removing them from <code>TreeHaver</code> core.</li>
  <li>
<strong>Backend Architecture Documentation</strong>: Added comprehensive documentation to base classes and all tree-sitter backends explaining the two backend categories:
    <ul>
      <li>Tree-sitter backends (MRI, Rust, FFI, Java): Use <code>TreeHaver::Tree</code> and <code>TreeHaver::Node</code> wrappers for raw tree-sitter objects</li>
      <li>Pure-Ruby/Plugin backends (Citrus, Prism, Psych, Commonmarker, Markly): Define own <code>Backend::X::Tree</code> and <code>Backend::X::Node</code> classes</li>
    </ul>
  </li>
</ul>

<h3 id="changed-7">Changed</h3>

<ul>
  <li>
<strong>Base Class Inheritance</strong>: <code>TreeHaver::Tree</code> and <code>TreeHaver::Node</code> now properly inherit from their respective <code>Base::</code> classes
    <ul>
      <li>
<code>TreeHaver::Tree &lt; Base::Tree</code> - inherits <code>inner_tree</code>, <code>source</code>, <code>lines</code> attributes and default implementations</li>
      <li>
<code>TreeHaver::Node &lt; Base::Node</code> - inherits <code>inner_node</code>, <code>source</code>, <code>lines</code> attributes and API contract</li>
      <li>Base classes document the API contract; subclasses document divergence</li>
    </ul>
  </li>
  <li>
<strong>Base::Node#initialize</strong>: Now accepts keyword arguments <code>source:</code> and <code>lines:</code> instead of positional for consistency with subclasses</li>
  <li>
<strong>DependencyTags</strong>: Now uses <code>BackendRegistry.available?(:backend_name)</code> instead of hardcoded <code>TreeHaver::Backends::*</code> checks</li>
  <li>
<strong>TreeHaver</strong>: <code>commonmarker</code> and <code>markly</code> backends are no longer built-in. Use <code>commonmarker-merge</code> and <code>markly-merge</code> gems which register themselves.</li>
  <li>
<strong>All backends</strong>: Now register their availability checkers with <code>BackendRegistry</code> when loaded (MRI, Rust, FFI, Java, Prism, Psych, Citrus)</li>
</ul>

<h3 id="removed-1">Removed</h3>

<ul>
  <li>
<strong>TreeHaver</strong>: Removed <code>TreeHaver::Backends::Commonmarker</code> and <code>TreeHaver::Backends::Markly</code> modules. These implementations have moved to their respective gems.</li>
</ul>

<h2 id="326---2026-01-06">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.2.5...v3.2.6">3.2.6</a> - 2026-01-06</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.2.6">v3.2.6</a>
</li>
  <li>COVERAGE: 92.07% – 2230/2422 lines in 23 files</li>
  <li>BRANCH COVERAGE: 74.69% – 788/1055 branches in 23 files</li>
  <li>90.37% documented</li>
</ul>

<h3 id="fixed-7">Fixed</h3>

<ul>
  <li>
<strong>Java backend</strong>: Fixed Optional handling in Node methods that could return nil incorrectly
    <ul>
      <li>
<code>child(index)</code>, <code>child_by_field_name(name)</code>, <code>parent</code>, <code>next_sibling</code>, <code>prev_sibling</code> now properly check for nil before attempting to unwrap Java Optional</li>
      <li>Previously, the ternary-based Optional check could fail when jtreesitter returned null directly instead of Optional.empty()</li>
      <li>This fixes JRuby test failures where <code>key_name</code> returned nil and object keys were not extracted</li>
    </ul>
  </li>
</ul>

<h2 id="325---2026-01-05">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.2.4...v3.2.5">3.2.5</a> - 2026-01-05</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.2.5">v3.2.5</a>
</li>
  <li>COVERAGE: 92.07% – 2230/2422 lines in 23 files</li>
  <li>BRANCH COVERAGE: 74.69% – 788/1055 branches in 23 files</li>
  <li>90.37% documented</li>
</ul>

<h3 id="fixed-8">Fixed</h3>

<ul>
  <li>
<strong>Markly backend</strong>: <code>Node#text</code> now correctly handles container nodes (headings, paragraphs, etc.)
    <ul>
      <li>Previously returned empty string because <code>string_content</code> was checked first (responds but returns empty for containers)</li>
      <li>Now falls through to <code>to_plaintext</code> or children concatenation when <code>string_content</code> is empty</li>
    </ul>
  </li>
  <li>
<strong>Commonmarker backend</strong>: <code>Node#text</code> now correctly handles container nodes
    <ul>
      <li>Previously could return empty string in edge cases</li>
      <li>Now consistently falls through to children concatenation when <code>string_content</code> is empty or raises TypeError</li>
    </ul>
  </li>
</ul>

<h2 id="324---2026-01-04">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.2.3...v3.2.4">3.2.4</a> - 2026-01-04</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.2.4">v3.2.4</a>
</li>
  <li>COVERAGE: 92.07% – 2229/2421 lines in 23 files</li>
  <li>BRANCH COVERAGE: 74.79% – 786/1051 branches in 23 files</li>
  <li>90.37% documented</li>
</ul>

<h3 id="added-7">Added</h3>

<ul>
  <li>
<strong>External backend registration via <code>backend_module</code></strong> - External gems can now register<br>
their own pure Ruby backends using the same API as built-in backends. This enables gems<br>
like rbs-merge to integrate with <code>TreeHaver.parser_for</code> without modifying tree_haver:
    <pre class="code language-ruby"><code class="language-ruby">TreeHaver.register_language(
:rbs,
backend_module: Rbs::Merge::Backends::RbsBackend,
backend_type: :rbs,
gem_name: &quot;rbs&quot;,
)
# Now TreeHaver.parser_for(:rbs) works!
</code></pre>
  </li>
  <li>
<strong><code>Backends::PURE_RUBY_BACKENDS</code> constant</strong> - Maps pure Ruby backend names to their<br>
language and module info. Used for auto-registration of built-in backends.</li>
  <li>
<strong><code>TreeHaver.register_builtin_backends!</code></strong> - Registers built-in pure Ruby backends<br>
(Prism, Psych, Commonmarker, Markly) in the LanguageRegistry using the same API that<br>
external backends use. Called automatically by <code>parser_for</code> on first use.</li>
  <li>
<strong><code>TreeHaver.ensure_builtin_backends_registered!</code></strong> - Idempotent helper that ensures<br>
built-in backends are registered exactly once.</li>
  <li>
<strong><code>parser_for</code> now supports registered <code>backend_module</code> backends</strong> - When a language<br>
has a registered <code>backend_module</code>, <code>parser_for</code> will use it. This enables external<br>
gems to provide language support without tree-sitter grammars:
    <ul>
      <li>Checks LanguageRegistry for registered <code>backend_module</code> entries</li>
      <li>Creates parser from the backend module’s <code>Parser</code> and <code>Language</code> classes</li>
      <li>Falls back to tree-sitter and Citrus if no backend_module matches</li>
    </ul>
  </li>
  <li>
<strong>RBS dependency tags in <code>DependencyTags</code></strong> - New RSpec tags for RBS parsing:
    <ul>
      <li>
<code>:rbs_grammar</code> - tree-sitter-rbs grammar is available and parsing works</li>
      <li>
<code>:rbs_parsing</code> - at least one RBS parser (rbs gem OR tree-sitter-rbs) is available</li>
      <li>
<code>:rbs_gem</code> - the official rbs gem is available (MRI only)</li>
      <li>Negated versions: <code>:not_rbs_grammar</code>, <code>:not_rbs_parsing</code>, <code>:not_rbs_gem</code>
</li>
      <li>New availability methods: <code>tree_sitter_rbs_available?</code>, <code>rbs_gem_available?</code>, <code>any_rbs_backend_available?</code>
</li>
    </ul>
  </li>
  <li>
<strong>Support for tree-sitter 0.26.x ABI</strong> - TreeHaver now fully supports grammars built<br>
against tree-sitter 0.26.x (LANGUAGE_VERSION 15). This required updates to vendored<br>
dependencies:
    <ul>
      <li>
<strong>ruby-tree-sitter</strong>: Updated to support tree-sitter 0.26.3 C library API changes<br>
including new <code>ts_language_abi_version()</code> function, UTF-16 encoding split, and<br>
removal of deprecated parser timeout/cancellation APIs</li>
      <li>
<strong>tree_stump (Rust backend)</strong>: Updated to tree-sitter Rust crate 0.26.3 with new<br>
<code>abi_version()</code> method, <code>u32</code> child indices, and streaming iterator-based query matches</li>
    </ul>
  </li>
  <li>
<strong>MRI backend now loads grammars with LANGUAGE_VERSION 15</strong> - Previously, MRI backend<br>
using ruby_tree_sitter could only load grammars with LANGUAGE_VERSION ≤ 14. Now supports<br>
grammars built against tree-sitter 0.26.x.</li>
  <li>
<strong>Rust backend now loads grammars with LANGUAGE_VERSION 15</strong> - Previously, the tree_stump<br>
Rust backend reported “Incompatible language version 15. Expected minimum 13, maximum 14”.<br>
Now supports the latest grammar format.</li>
  <li>
<strong>BackendAPI validation module</strong> - New <code>TreeHaver::BackendAPI</code> module for validating<br>
backend API compliance:
    <ul>
      <li>
<code>BackendAPI.validate(backend_module)</code> - Returns validation results hash</li>
      <li>
<code>BackendAPI.validate!(backend_module)</code> - Raises on validation failure</li>
      <li>
<code>BackendAPI.validate_node_instance(node)</code> - Validates a node instance</li>
      <li>Defines required and optional methods for Language, Parser, Tree, and Node classes</li>
      <li>Documents API contract for wrapper vs raw backends</li>
      <li>New <code>examples/validate_backends.rb</code> script to validate all backends</li>
    </ul>
  </li>
  <li>
<strong>Java backend Node class now implements full API</strong> - Added missing methods to ensure<br>
API consistency with other backends:
    <ul>
      <li>
<code>parent</code> - Get parent node</li>
      <li>
<code>next_sibling</code> - Get next sibling node</li>
      <li>
<code>prev_sibling</code> - Get previous sibling node</li>
      <li>
<code>named?</code> - Check if node is named</li>
      <li>
<code>child_by_field_name</code> - Get child by field name</li>
      <li>All methods properly handle jtreesitter 0.26.0’s <code>Optional&lt;Node&gt;</code> return types</li>
    </ul>
  </li>
  <li>
<strong>Three environment variables for backend control</strong> - Fine-grained control over which<br>
backends are available:
    <ul>
      <li>
<code>TREE_HAVER_BACKEND</code> - Single backend selection (auto, mri, ffi, rust, java, citrus, etc.)</li>
      <li>
<code>TREE_HAVER_NATIVE_BACKEND</code> - Allow list for native backends (auto, none, or comma-separated<br>
list like <code>mri,ffi</code>). Use <code>none</code> for pure-Ruby-only mode.</li>
      <li>
<code>TREE_HAVER_RUBY_BACKEND</code> - Allow list for pure Ruby backends (auto, none, or comma-separated<br>
list like <code>citrus,prism</code>). Use <code>none</code> for native-only mode.</li>
    </ul>
  </li>
  <li>
<strong>Backend availability now respects allow lists</strong> - When <code>TREE_HAVER_NATIVE_BACKEND</code> is set<br>
to specific backends (e.g., <code>mri,ffi</code>), all other native backends are treated as unavailable.<br>
This applies to ALL backend selection mechanisms:
    <ul>
      <li>Auto-selection in <code>backend_module</code>
</li>
      <li>Explicit selection via <code>with_backend(:rust)</code> - returns nil/unavailable</li>
      <li>Explicit selection via <code>resolve_backend_module(:rust)</code> - returns nil</li>
      <li>RSpec dependency tags (<code>ffi_available?</code>, etc.)</li>
    </ul>

    <p>This makes the environment variables a <strong>hard restriction</strong>, not just a hint for auto-selection.<br>
Use <code>TREE_HAVER_NATIVE_BACKEND=none</code> for pure-Ruby-only mode, or specify exactly which<br>
native backends are permitted (e.g., <code>mri,ffi</code>).</p>
  </li>
  <li>
<strong>Java backend updated for jtreesitter 0.26.0</strong> - Full compatibility with jtreesitter 0.26.0:
    <ul>
      <li>Updated <code>Parser#parse</code> and <code>Parser#parse_string</code> to handle <code>Optional&lt;Tree&gt;</code> return type</li>
      <li>Updated <code>Tree#root_node</code> to handle <code>Optional&lt;Node&gt;</code> return type</li>
      <li>Fixed <code>parse_string</code> argument order to match jtreesitter 0.26.0 API: <code>parse(String, Tree)</code>
</li>
      <li>Updated <code>Language.load_by_name</code> to use <code>SymbolLookup</code> API (single-arg <code>load(name)</code> removed)</li>
      <li>Added <code>bin/setup-jtreesitter</code> script to download jtreesitter JAR from Maven Central</li>
      <li>Added <code>bin/build-grammar</code> script to build tree-sitter grammars from source</li>
      <li>Older versions of jtreesitter are NOT supported</li>
    </ul>
  </li>
  <li>
<strong><code>TREE_HAVER_BACKEND_PROTECT</code> environment variable</strong> - Explicit control over backend<br>
conflict protection. Set to <code>false</code> to disable protection that prevents mixing<br>
incompatible native backends (e.g., FFI after MRI). Useful for testing scenarios<br>
where you understand the risks. Default behavior (protection enabled) unchanged.</li>
</ul>

<h3 id="changed-8">Changed</h3>

<ul>
  <li>
<strong>API normalized: <code>from_library</code> is now universal</strong> - All language-specific backends<br>
(Psych, Prism, Commonmarker, Markly) now implement <code>Language.from_library</code> for API<br>
consistency. This allows <code>TreeHaver.parser_for(:yaml)</code> to work uniformly regardless<br>
of which backend is active:
    <ul>
      <li>
<strong>Psych</strong>: <code>from_library</code> accepts (and ignores) path/symbol, returns YAML language</li>
      <li>
<strong>Prism</strong>: <code>from_library</code> accepts (and ignores) path/symbol, returns Ruby language</li>
      <li>
<strong>Commonmarker</strong>: <code>from_library</code> accepts (and ignores) path/symbol, returns Markdown language</li>
      <li>
<strong>Markly</strong>: <code>from_library</code> accepts (and ignores) path/symbol, returns Markdown language</li>
      <li>All raise <code>TreeHaver::NotAvailable</code> if a different language is requested</li>
    </ul>
  </li>
  <li>
<strong>Citrus backend <code>from_library</code> now looks up registered grammars</strong> - Instead of always<br>
raising an error, <code>Backends::Citrus::Language.from_library</code> now looks up registered<br>
Citrus grammars by name via <code>LanguageRegistry</code>. This enables <code>TreeHaver.parser_for(:toml)</code><br>
to work seamlessly when a Citrus grammar has been registered with<br>
<code>TreeHaver.register_language(:toml, grammar_module: TomlRB::Document)</code>.</li>
  <li>
<strong>Java backend requires jtreesitter &gt;= 0.26.0</strong> - Due to API changes in jtreesitter,<br>
older versions are no longer supported. The tree-sitter runtime library must also be<br>
version 0.26.x to match.<br>
by the RSpec dependency tags. This ensures tests tagged with <code>:mri_backend</code> only run when<br>
MRI is in the allow list. Same for <code>TREE_HAVER_RUBY_BACKEND</code> and pure Ruby backends.</li>
  <li>New <code>TreeHaver.allowed_native_backends</code> method returns the allow list for native backends.</li>
  <li>New <code>TreeHaver.allowed_ruby_backends</code> method returns the allow list for pure Ruby backends.</li>
  <li>New <code>TreeHaver.backend_allowed?(backend)</code> method checks if a specific backend is allowed<br>
based on the current environment variable settings.</li>
  <li>New <code>DependencyTags.allowed_native_backends</code> and <code>DependencyTags.allowed_ruby_backends</code> methods.</li>
  <li>Updated <code>examples/test_backend_selection.rb</code> script to test all three environment variables.</li>
  <li>
<strong><code>LanguageRegistry</code> now supports any backend type</strong> - Previously only <code>:tree_sitter</code> and<br>
<code>:citrus</code> were documented. Now supports arbitrary backend types including <code>:prism</code>, <code>:psych</code>,<br>
<code>:commonmarker</code>, <code>:markly</code>, <code>:rbs</code>, or any custom type. External gems can register their<br>
own backend types using the same API.</li>
  <li>
<strong><code>register_language</code> accepts <code>backend_module</code> parameter</strong> - New parameter for registering<br>
pure Ruby backends. The module must provide <code>Language</code> and <code>Parser</code> classes with the<br>
standard TreeHaver API (<code>available?</code>, <code>capabilities</code>, <code>from_library</code>, etc.).</li>
</ul>

<h3 id="fixed-9">Fixed</h3>

<ul>
  <li>
<strong><code>TreeHaver::Node#text</code> now handles backends with different <code>text</code> method signatures</strong> -<br>
Previously, <code>Node#text</code> would call <code>@inner_node.text</code> directly, but <code>TreeStump::Node#text</code><br>
(Rust backend) requires the source as an argument (<code>text(source)</code>). This caused<br>
<code>ArgumentError: wrong number of arguments (given 0, expected 1)</code> when using the Rust<br>
backend. Now <code>Node#text</code> checks the method arity and passes the source when required:
    <ul>
      <li>Arity 0 or -1: calls <code>@inner_node.text</code> without arguments</li>
      <li>Arity &gt;= 1: calls <code>@inner_node.text(@source)</code> with source</li>
      <li>Falls back to byte-based extraction if source is available</li>
    </ul>
  </li>
  <li>
<strong>AUTO mode now gracefully falls back when explicitly requested backend is blocked</strong> -<br>
Previously, if <code>TREE_HAVER_BACKEND=ffi</code> was set in the environment but FFI was blocked<br>
due to MRI being used first (backend conflict protection), <code>parser_for</code> would raise a<br>
<code>BackendConflict</code> error. Now, when the explicitly requested backend is blocked by a<br>
<strong>backend conflict</strong> (e.g., FFI after MRI causes segfaults):
    <ul>
      <li>
<code>backend_module</code> detects the conflict and falls back to auto-selection</li>
      <li>
<code>resolve_native_backend_module</code> rescues <code>BackendConflict</code> and continues to the next<br>
backend in the priority list</li>
      <li>This enables seamless multi-backend usage in test suites where different tests use<br>
different backends, but one backend has already “poisoned” the process for another.</li>
    </ul>

    <p>Note: This fallback only applies to <strong>backend conflicts</strong> (runtime incompatibility).<br>
If a backend is disallowed by <code>TREE_HAVER_NATIVE_BACKEND</code> or <code>TREE_HAVER_RUBY_BACKEND</code>,<br>
it will simply be unavailable—no error is raised, but no fallback occurs either.</p>
  </li>
  <li>
<strong><code>java_backend_available?</code> now verifies grammar loading works</strong> - Previously, the<br>
<code>DependencyTags.java_backend_available?</code> method only checked if java-tree-sitter<br>
classes could be loaded, but didn’t verify that grammars could actually be used.<br>
This caused tests tagged with <code>:java_backend</code> to run on JRuby even when the grammar<br>
<code>.so</code> files (built for MRI) were incompatible with java-tree-sitter’s Foreign Function<br>
Memory API. Now the check does a live test by attempting to load a grammar, ensuring<br>
the tag accurately reflects whether the Java backend is fully functional.</li>
</ul>

<h2 id="323---2026-01-02">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.2.2...v3.2.3">3.2.3</a> - 2026-01-02</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.2.3">v3.2.3</a>
</li>
  <li>COVERAGE: 94.91% – 2088/2200 lines in 22 files</li>
  <li>BRANCH COVERAGE: 81.37% – 738/907 branches in 22 files</li>
  <li>90.14% documented</li>
</ul>

<h3 id="fixed-10">Fixed</h3>

<ul>
  <li>
<strong><code>parser_for</code> now respects explicitly requested non-native backends</strong> - Previously,<br>
<code>parser_for</code> would always try tree-sitter backends first and only fall back to alternative<br>
backends if tree-sitter was unavailable. Now it checks <code>effective_backend</code> and skips<br>
tree-sitter attempts entirely when a non-native backend is explicitly requested via:
    <ul>
      <li>
<code>TREE_HAVER_BACKEND=citrus</code> (or <code>prism</code>, <code>psych</code>, <code>commonmarker</code>, <code>markly</code>)</li>
      <li><code>TreeHaver.backend = :citrus</code></li>
      <li><code>TreeHaver.with_backend(:citrus) { ... }</code></li>
    </ul>

    <p>Native backends (<code>:mri</code>, <code>:rust</code>, <code>:ffi</code>, <code>:java</code>) still use tree-sitter grammar discovery.</p>
  </li>
  <li>
    <p><strong><code>load_tree_sitter_language</code> now correctly ignores Citrus registrations</strong> - Previously,<br>
if a language was registered with Citrus first, <code>load_tree_sitter_language</code> would<br>
incorrectly try to use it even when a native backend was explicitly requested. Now it<br>
only uses registrations that have a <code>:tree_sitter</code> key, allowing proper backend switching<br>
between Citrus and native tree-sitter backends.</p>
  </li>
  <li>
    <p><strong><code>load_tree_sitter_language</code> now validates registered paths exist</strong> - Previously,<br>
if a language had a stale/invalid tree-sitter registration with a non-existent path<br>
(e.g., from a test), the code would try to use it and fail. Now it checks<br>
<code>File.exist?(path)</code> before using a registered path, falling back to auto-discovery<br>
via <code>GrammarFinder</code> if the registered path doesn’t exist.</p>
  </li>
  <li>
    <p><strong><code>Language.method_missing</code> no longer falls back to Citrus when native backend explicitly requested</strong> -<br>
Previously, when tree-sitter loading failed (e.g., .so file missing), the code would<br>
silently fall back to Citrus even if the user explicitly requested <code>:mri</code>, <code>:rust</code>,<br>
<code>:ffi</code>, or <code>:java</code>. Now fallback to Citrus only happens when <code>effective_backend</code> is <code>:auto</code>.<br>
This is a <strong>breaking change</strong> for users who relied on silent fallback behavior.</p>
  </li>
  <li>
<strong>Simplified <code>parser_for</code> implementation</strong> - Refactored from complex nested conditionals to<br>
cleaner helper methods (<code>load_tree_sitter_language</code>, <code>load_citrus_language</code>). The logic is<br>
now easier to follow and maintain.</li>
</ul>

<h2 id="322---2026-01-01">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.2.1...v3.2.2">3.2.2</a> - 2026-01-01</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.2.2">v3.2.2</a>
</li>
  <li>COVERAGE: 94.79% – 2076/2190 lines in 22 files</li>
  <li>BRANCH COVERAGE: 81.35% – 733/901 branches in 22 files</li>
  <li>90.14% documented</li>
</ul>

<h3 id="fixed-11">Fixed</h3>

<ul>
  <li>RSpec dependency tags now respect <code>TREE_HAVER_BACKEND</code> environment variable
    <ul>
      <li>When <code>TREE_HAVER_BACKEND=ffi</code> is set, MRI backend availability is not checked</li>
      <li>Prevents <code>BackendConflict</code> errors when loading gems that use tree-sitter grammars</li>
      <li>The <code>blocked_backends</code> set now includes backends that would conflict with the explicitly selected backend</li>
      <li>This allows <code>*-merge</code> gems to load correctly in test suites when a specific backend is selected</li>
    </ul>
  </li>
</ul>

<h2 id="321---2025-12-31">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.2.0...v3.2.1">3.2.1</a> - 2025-12-31</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.2.1">v3.2.1</a>
</li>
  <li>COVERAGE: 94.75% – 2075/2190 lines in 22 files</li>
  <li>BRANCH COVERAGE: 81.35% – 733/901 branches in 22 files</li>
  <li>90.14% documented</li>
</ul>

<h3 id="added-8">Added</h3>

<ul>
  <li>
<code>TreeHaver::LibraryPathUtils</code> module for consistent path parsing across all backends
    <ul>
      <li>
<code>derive_symbol_from_path(path)</code> - derives tree-sitter symbol (e.g., <code>tree_sitter_toml</code>) from library path</li>
      <li>
<code>derive_language_name_from_path(path)</code> - derives language name (e.g., <code>toml</code>) from library path</li>
      <li>
<code>derive_language_name_from_symbol(symbol)</code> - strips <code>tree_sitter_</code> prefix from symbol</li>
      <li>Handles various naming conventions: <code>libtree-sitter-toml.so</code>, <code>libtree_sitter_toml.so</code>, <code>tree-sitter-toml.so</code>, <code>toml.so</code>
</li>
    </ul>
  </li>
  <li>Isolated backend RSpec tags for running tests without loading conflicting backends
    <ul>
      <li>
<code>:ffi_backend_only</code> - runs FFI tests without triggering <code>mri_backend_available?</code> check</li>
      <li>
<code>:mri_backend_only</code> - runs MRI tests without triggering <code>ffi_available?</code> check</li>
      <li>Uses <code>TreeHaver::Backends::BLOCKED_BY</code> to dynamically determine which availability checks to skip</li>
      <li>Enables <code>rake ffi_specs</code> to run FFI tests before MRI is loaded</li>
    </ul>
  </li>
  <li>
<code>DependencyTags.ffi_backend_only_available?</code> - checks FFI availability without loading MRI</li>
  <li>
<code>DependencyTags.mri_backend_only_available?</code> - checks MRI availability without checking FFI</li>
</ul>

<h3 id="changed-9">Changed</h3>

<ul>
  <li>All backends now use shared <code>LibraryPathUtils</code> for path parsing
    <ul>
      <li>MRI, Rust, FFI, and Java backends updated for consistency</li>
      <li>Ensures identical behavior across all tree-sitter backends</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Language</code> class extracted to <code>lib/tree_haver/language.rb</code>
    <ul>
      <li>No API changes, just file organization</li>
      <li>Loaded via autoload for lazy loading</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Parser</code> class extracted to <code>lib/tree_haver/parser.rb</code>
    <ul>
      <li>No API changes, just file organization</li>
      <li>Loaded via autoload for lazy loading</li>
    </ul>
  </li>
  <li>Backend availability exclusions in <code>dependency_tags.rb</code> are now dynamic
    <ul>
      <li>Uses <code>TreeHaver::Backends::BLOCKED_BY</code> to skip availability checks for blocked backends</li>
      <li>When running with <code>--tag ffi_backend_only</code>, MRI availability is not checked</li>
      <li>Prevents MRI from being loaded before FFI tests can run</li>
    </ul>
  </li>
  <li>Rakefile <code>ffi_specs</code> task now uses <code>:ffi_backend_only</code> tag
    <ul>
      <li>Ensures FFI tests run without loading MRI backend first</li>
    </ul>
  </li>
</ul>

<h3 id="fixed-12">Fixed</h3>

<ul>
  <li>Rakefile now uses correct RSpec tags for FFI isolation
    <ul>
      <li>The <code>ffi_specs</code> task uses <code>:ffi_backend_only</code> to prevent MRI from loading</li>
      <li>The <code>remaining_specs</code> task excludes <code>:ffi_backend_only</code> tests</li>
      <li>Tags in Rakefile align with canonical tags from <code>dependency_tags.rb</code>
</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::RSpec::DependencyTags.mri_backend_available?</code> now uses correct require path
    <ul>
      <li>Was: <code>require "ruby_tree_sitter"</code> (wrong - causes LoadError)</li>
      <li>Now: <code>require "tree_sitter"</code> (correct - gem name is ruby_tree_sitter but require path is tree_sitter)</li>
      <li>This fix ensures the MRI backend is correctly detected as available in CI environments</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Backends::MRI::Language.from_library</code> now properly derives symbol from path
    <ul>
      <li>Previously, calling <code>from_library(path)</code> without <code>symbol:</code> would fail because <code>language_name</code> was nil</li>
      <li>Now delegates to private <code>from_path</code> after deriving symbol, ensuring proper language name derivation</li>
      <li>
<code>from_path</code> is now private (but still accessible via <code>send</code> for testing if needed)</li>
      <li>Extracts language name from paths like <code>/usr/lib/libtree-sitter-toml.so</code> → <code>tree_sitter_toml</code>
</li>
      <li>Handles both dash and underscore separators in filenames</li>
      <li>Handles simple language names like <code>toml.so</code> → <code>tree_sitter_toml</code>
</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Backends::MRI::Parser#language=</code> now unwraps <code>TreeHaver::Backends::MRI::Language</code> wrappers
    <ul>
      <li>Accepts both raw <code>TreeSitter::Language</code> and wrapped <code>TreeHaver::Backends::MRI::Language</code>
</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::GrammarFinder.tree_sitter_runtime_usable?</code> no longer references <code>FFI::NotFoundError</code> directly
    <ul>
      <li>Prevents <code>NameError</code> when FFI gem is not loaded</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Parser#initialize</code> no longer references <code>FFI::NotFoundError</code> directly in rescue clause
    <ul>
      <li>Uses <code>defined?(::FFI::NotFoundError)</code> check to safely handle FFI errors when FFI is loaded</li>
      <li>Prevents <code>NameError: uninitialized constant TreeHaver::Parser::FFI</code> when FFI gem is not available</li>
      <li>Extracted error handling to <code>handle_parser_creation_failure</code> private method for clarity</li>
    </ul>
  </li>
  <li>RSpec <code>dependency_tags.rb</code> now correctly detects <code>--tag</code> options during configuration
    <ul>
      <li>RSpec’s <code>config.inclusion_filter.rules</code> is empty during configuration phase</li>
      <li>Now parses <code>ARGV</code> directly to detect <code>--tag ffi_backend_only</code> and similar tags</li>
      <li>Skips grammar availability checks (which load MRI) when running isolated backend tests</li>
      <li>Skips full dependency summary in <code>before(:suite)</code> when backends are blocked</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Backends::FFI.reset!</code> now uses consistent pattern with other backends
    <ul>
      <li>Was using <code>@ffi_gem_available</code> with <code>defined?()</code> check, which returned truthy after <code>reset!</code> set it to nil</li>
      <li>Now uses <code>@load_attempted</code> / <code>@loaded</code> pattern like MRI, Rust, Citrus, Prism, Psych, etc.</li>
      <li>This fixes FFI tests failing after the first test when <code>reset!</code> was called in <code>after</code> blocks</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Language.method_missing</code> no longer references <code>FFI::NotFoundError</code> directly in rescue clause
    <ul>
      <li>Uses <code>defined?(::FFI::NotFoundError)</code> check to safely handle FFI errors when FFI is loaded</li>
      <li>Prevents <code>NameError</code> when FFI gem is not available but tree-sitter backends are used</li>
      <li>Extracted Citrus fallback logic to <code>handle_tree_sitter_load_failure</code> private method</li>
    </ul>
  </li>
</ul>

<h2 id="320---2025-12-30">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.1.2...v3.2.0">3.2.0</a> - 2025-12-30</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.2.0">v3.2.0</a>
</li>
  <li>COVERAGE: 86.82% – 2167/2496 lines in 22 files</li>
  <li>BRANCH COVERAGE: 66.79% – 734/1099 branches in 22 files</li>
  <li>90.03% documented</li>
</ul>

<h3 id="added-9">Added</h3>

<ul>
  <li>
<code>TreeHaver::CITRUS_DEFAULTS</code> constant with default Citrus configurations for known languages
    <ul>
      <li>Enables automatic Citrus fallback for TOML without explicit <code>citrus_config</code> parameter</li>
      <li>Currently includes configuration for <code>:toml</code> (gem: <code>toml-rb</code>, const: <code>TomlRB::Document</code>)</li>
    </ul>
  </li>
  <li>Regression test suite for Citrus fallback (<code>spec/integration/citrus_fallback_spec.rb</code>)
    <ul>
      <li>Tests <code>parser_for</code> with all tree-sitter backends stubbed as unavailable (simulating TruffleRuby)</li>
      <li>Tests <code>CitrusGrammarFinder</code> with nil <code>gem_name</code> and <code>require_path</code>
</li>
      <li>Tests explicit Citrus backend usage on MRI via <code>with_backend(:citrus)</code>
</li>
    </ul>
  </li>
  <li>Shared examples for TOML parsing tests (<code>spec/support/shared_examples/toml_parsing_examples.rb</code>)
    <ul>
      <li>
<code>"toml parsing basics"</code> - tests basic parsing, positions, children, text extraction</li>
      <li>
<code>"toml node navigation"</code> - tests first_child, named_children navigation</li>
    </ul>
  </li>
  <li>Multi-backend TOML test suite (<code>spec/integration/multi_backend_toml_spec.rb</code>)
    <ul>
      <li>Runs shared examples against both tree-sitter-toml and Citrus/toml-rb backends</li>
      <li>Tests backend equivalence for parsing results and positions</li>
      <li>Tagged appropriately so tests run on whichever backends are available</li>
    </ul>
  </li>
  <li>Backend Platform Compatibility section to README
    <ul>
      <li>Complete compatibility matrix showing which backends work on MRI, JRuby, TruffleRuby</li>
      <li>Detailed explanations for TruffleRuby and JRuby limitations</li>
    </ul>
  </li>
  <li>
<code>FFI.available?</code> method at module level for API consistency with other backends</li>
  <li>
<code>TreeHaver.resolve_native_backend_module</code> method for resolving only tree-sitter backends</li>
  <li>
<code>TreeHaver::NATIVE_BACKENDS</code> constant listing backends that support shared libraries</li>
  <li>TruffleRuby short-circuit in <code>resolve_native_backend_module</code> for efficiency
    <ul>
      <li>Avoids trying 3 backends that are all known to fail on TruffleRuby</li>
    </ul>
  </li>
  <li>
<code>citrus_available?</code> method to check if Citrus backend is available</li>
</ul>

<h3 id="fixed-13">Fixed</h3>

<ul>
  <li>
<strong><code>TreeHaver::Node#child</code> now returns <code>nil</code> for out-of-bounds indices on all backends</strong>
    <ul>
      <li>MRI backend (ruby_tree_sitter) raises <code>IndexError</code> for invalid indices</li>
      <li>Other backends return <code>nil</code> for invalid indices</li>
      <li>Now consistently returns <code>nil</code> across all backends for API compatibility</li>
    </ul>
  </li>
  <li>
<strong>Citrus backend <code>calculate_point</code> returns negative column values</strong>
    <ul>
      <li>When <code>offset</code> was 0, <code>@source.rindex("\n", -1)</code> searched from end of string</li>
      <li>This caused <code>column = 0 - (position_of_last_newline) - 1</code> to be negative (e.g., -34)</li>
      <li>Fix: Early return <code>{row: 0, column: 0}</code> for <code>offset &lt;= 0</code>
</li>
      <li>This bug affected both MRI and TruffleRuby when using Citrus backend</li>
    </ul>
  </li>
  <li>
<strong>Citrus fallback fails on TruffleRuby when no explicit <code>citrus_config</code> provided</strong>
    <ul>
      <li>
<code>parser_for(:toml)</code> would fail with <code>TypeError: no implicit conversion of nil into String</code>
</li>
      <li>Root cause: <code>citrus_config</code> defaulted to <code>{}</code>, so <code>citrus_config[:gem_name]</code> was <code>nil</code>
</li>
      <li>
<code>CitrusGrammarFinder</code> was instantiated with <code>gem_name: nil</code>, causing <code>require nil</code>
</li>
      <li>On TruffleRuby, this triggered a bug in <code>bundled_gems.rb</code> calling <code>File.path</code> on nil</li>
      <li>Fix: Added <code>CITRUS_DEFAULTS</code> with known Citrus configurations (TOML currently)</li>
      <li>Fix: <code>parser_for</code> now uses <code>CITRUS_DEFAULTS[name]</code> when no explicit config provided</li>
      <li>Fix: Added guard in <code>CitrusGrammarFinder#available?</code> to return false when <code>require_path</code> is nil</li>
      <li>Fix: Added <code>TypeError</code> to rescue clause for TruffleRuby-specific edge cases</li>
    </ul>
  </li>
  <li>
<strong><code>from_library</code> no longer falls back to pure-Ruby backends</strong>
    <ul>
      <li>Previously, calling <code>Language.from_library(path)</code> on TruffleRuby would fall back to Citrus<br>
backend which then raised a confusing error about not supporting shared libraries</li>
      <li>Now <code>from_library</code> only considers native tree-sitter backends (MRI, Rust, FFI, Java)</li>
      <li>Clear error message when no native backend is available explaining the situation</li>
    </ul>
  </li>
  <li>
<strong>Integration specs now use <code>parser_for</code> instead of explicit paths</strong>
    <ul>
      <li>
<code>tree_edge_cases_spec.rb</code> and <code>node_edge_cases_spec.rb</code> now use <code>TreeHaver.parser_for(:toml)</code><br>
which auto-discovers the best available backend (tree-sitter or Citrus fallback)</li>
      <li>Tests now work correctly on all platforms (MRI, JRuby, TruffleRuby)</li>
      <li>Tagged with <code>:toml_parsing</code> which passes if ANY toml parser is available</li>
    </ul>
  </li>
  <li>
<strong>Core specs now use <code>parser_for</code> instead of explicit paths</strong>
    <ul>
      <li>
<code>tree_spec.rb</code>, <code>node_spec.rb</code>, <code>parser_spec.rb</code> converted to use <code>TreeHaver.parser_for(:toml)</code>
</li>
      <li>All <code>:toml_grammar</code> tags changed to <code>:toml_parsing</code> for cross-platform compatibility</li>
      <li>Tests now run on JRuby and TruffleRuby via Citrus/toml-rb fallback</li>
    </ul>
  </li>
  <li>FFI backend now properly reports as unavailable on TruffleRuby
    <ul>
      <li>
<code>ffi_gem_available?</code> returns <code>false</code> on TruffleRuby since tree-sitter uses STRUCT_BY_VALUE return types</li>
      <li>
<code>FFI.available?</code> added at module level (was only in Native submodule)</li>
      <li>Prevents confusing runtime errors (Polyglot::ForeignException) by detecting incompatibility upfront</li>
      <li>Dependency tags now check <code>truffleruby?</code> before attempting FFI backend tests</li>
    </ul>
  </li>
  <li>MRI backend now properly reports as unavailable on JRuby and TruffleRuby
    <ul>
      <li>
<code>available?</code> returns <code>false</code> on non-MRI platforms (C extension only works on MRI)</li>
    </ul>
  </li>
  <li>Rust backend now properly reports as unavailable on JRuby and TruffleRuby
    <ul>
      <li>
<code>available?</code> returns <code>false</code> on non-MRI platforms (magnus requires MRI’s C API)</li>
    </ul>
  </li>
  <li>Backend compatibility matrix spec now properly skips tests for platform-incompatible backends
    <ul>
      <li>MRI and Rust backends skip on JRuby/TruffleRuby with clear skip messages</li>
      <li>FFI backend skips on TruffleRuby with clear skip message</li>
    </ul>
  </li>
</ul>

<h3 id="changed-10">Changed</h3>

<ul>
  <li>
<strong>BREAKING: RSpec Dependency Tag Naming Convention Overhaul</strong>
    <ul>
      <li>All dependency tags now follow consistent naming conventions with suffixes</li>
      <li>Backend tags now use <code>*_backend</code> suffix (e.g., <code>:commonmarker_backend</code>, <code>:markly_backend</code>)</li>
      <li>Engine tags now use <code>*_engine</code> suffix (e.g., <code>:mri_engine</code>, <code>:jruby_engine</code>, <code>:truffleruby_engine</code>)</li>
      <li>Grammar tags now use <code>*_grammar</code> suffix (e.g., <code>:bash_grammar</code>, <code>:toml_grammar</code>, <code>:json_grammar</code>)</li>
      <li>Parsing capability tags now use <code>*_parsing</code> suffix (e.g., <code>:toml_parsing</code>, <code>:markdown_parsing</code>)</li>
      <li>
<strong>Migration required</strong>: Update specs using legacy tags:
        <ul>
          <li>
<code>:commonmarker</code> → <code>:commonmarker_backend</code>
</li>
          <li>
<code>:markly</code> → <code>:markly_backend</code>
</li>
          <li>
<code>:mri</code> → <code>:mri_engine</code>
</li>
          <li>
<code>:jruby</code> → <code>:jruby_engine</code>
</li>
          <li>
<code>:truffleruby</code> → <code>:truffleruby_engine</code>
</li>
          <li>
<code>:tree_sitter_bash</code> → <code>:bash_grammar</code>
</li>
          <li>
<code>:tree_sitter_toml</code> → <code>:toml_grammar</code>
</li>
          <li>
<code>:tree_sitter_json</code> → <code>:json_grammar</code>
</li>
          <li>
<code>:tree_sitter_jsonc</code> → <code>:jsonc_grammar</code>
</li>
          <li>
<code>:toml_backend</code> → <code>:toml_parsing</code>
</li>
          <li>
<code>:markdown_backend</code> → <code>:markdown_parsing</code>
</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<strong>Removed inner-merge dependency tags from tree_haver</strong>
    <ul>
      <li>Tags <code>:toml_merge</code>, <code>:json_merge</code>, <code>:prism_merge</code>, <code>:psych_merge</code> removed</li>
      <li>These belong in ast-merge gem, not tree_haver</li>
      <li>Use <code>require "ast/merge/rspec/dependency_tags"</code> for merge gem tags</li>
    </ul>
  </li>
  <li>
<strong>API Consistency</strong>: All backends now have uniform <code>available?</code> API at module level:
    <ul>
      <li>
<code>TreeHaver::Backends::FFI.available?</code> - checks ffi gem + not TruffleRuby + MRI not loaded</li>
      <li>
<code>TreeHaver::Backends::MRI.available?</code> - checks MRI platform + ruby_tree_sitter gem</li>
      <li>
<code>TreeHaver::Backends::Rust.available?</code> - checks MRI platform + tree_stump gem</li>
      <li>
<code>TreeHaver::Backends::Java.available?</code> - checks JRuby platform + jtreesitter JAR</li>
      <li>
<code>TreeHaver::Backends::Prism.available?</code> - checks prism gem (all platforms)</li>
      <li>
<code>TreeHaver::Backends::Psych.available?</code> - checks psych stdlib (all platforms)</li>
      <li>
<code>TreeHaver::Backends::Commonmarker.available?</code> - checks commonmarker gem (all platforms)</li>
      <li>
<code>TreeHaver::Backends::Markly.available?</code> - checks markly gem (all platforms)</li>
      <li>
<code>TreeHaver::Backends::Citrus.available?</code> - checks citrus gem (all platforms)</li>
    </ul>
  </li>
  <li>README now accurately documents TruffleRuby backend support
    <ul>
      <li>FFI backend doesn’t work on TruffleRuby due to <code>STRUCT_BY_VALUE</code> limitation in TruffleRuby’s FFI</li>
      <li>Rust backend (tree_stump) doesn’t work due to magnus/rb-sys incompatibility with TruffleRuby’s C API</li>
      <li>TruffleRuby users should use Prism, Psych, Commonmarker, Markly, or Citrus backends</li>
    </ul>
  </li>
  <li>Documented confirmed tree-sitter backend limitations:
    <ul>
      <li>
<strong>TruffleRuby</strong>: No tree-sitter backend works (FFI, MRI, Rust all fail)</li>
      <li>
<strong>JRuby</strong>: Only Java and FFI backends work; Rust/MRI don’t</li>
    </ul>
  </li>
  <li>Updated Rust Backend section with platform compatibility notes</li>
  <li>Updated FFI Backend section with TruffleRuby limitation details</li>
  <li>Use kettle-rb/ts-grammar-setup GHA in CI workflows</li>
</ul>

<h3 id="fixed-14">Fixed</h3>

<ul>
  <li>Rakefile now properly overrides <code>test</code> task after <code>require "kettle/dev"</code>
    <ul>
      <li>Works around a bug in kettle-dev where test task runs minitest loader in CI</li>
      <li>Ensures <code>rake test</code> runs RSpec specs instead of empty minitest suite</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::RSpec::DependencyTags</code> now catches TruffleRuby FFI exceptions
    <ul>
      <li>TruffleRuby’s FFI raises <code>Polyglot::ForeignException</code> for unsupported types like <code>STRUCT_BY_VALUE</code>
</li>
      <li>
<code>ffi_available?</code> and <code>libtree_sitter_available?</code> now return <code>false</code> instead of crashing</li>
      <li>Fixes spec loading errors on TruffleRuby</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Backends::FFI::Language.from_library</code> now catches <code>RuntimeError</code> from TruffleRuby
    <ul>
      <li>TruffleRuby raises <code>RuntimeError</code> instead of <code>LoadError</code> when a shared library cannot be opened</li>
      <li>Now properly converts to <code>TreeHaver::NotAvailable</code> with descriptive message</li>
    </ul>
  </li>
  <li>
<code>TreeHaver::Backends::FFI::Native.try_load!</code> now only sets <code>@loaded = true</code> after all <code>attach_function</code> calls succeed
    <ul>
      <li>Previously, <code>loaded?</code> returned <code>true</code> even when <code>attach_function</code> failed (e.g., on TruffleRuby)</li>
      <li>Now <code>loaded?</code> correctly returns <code>false</code> when FFI functions couldn’t be attached</li>
      <li>Ensures FFI tests are properly skipped on TruffleRuby</li>
    </ul>
  </li>
</ul>

<h2 id="312---2025-12-29">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.1.1...v3.1.2">3.1.2</a> - 2025-12-29</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.1.2">v3.1.2</a>
</li>
  <li>COVERAGE: 87.40% – 2171/2484 lines in 22 files</li>
  <li>BRANCH COVERAGE: 67.04% – 726/1083 branches in 22 files</li>
  <li>90.03% documented</li>
</ul>

<h3 id="added-10">Added</h3>

<ul>
  <li>Enhanced <code>TreeHaver::RSpec::DependencyTags</code> debugging
    <ul>
      <li>
<code>env_summary</code> method returns relevant environment variables for diagnosis</li>
      <li>
<code>grammar_works?</code> now logs detailed trace when <code>TREE_HAVER_DEBUG=1</code>
</li>
      <li>
<code>before(:suite)</code> prints both env vars and dependency status when debugging</li>
      <li>Helps diagnose differences between local and CI environments</li>
    </ul>
  </li>
  <li>Many new specs for:
    <ul>
      <li>TreeHaver::GrammarFinder</li>
      <li>TreeHaver::Node</li>
      <li>TreeHaver::Tree</li>
    </ul>
  </li>
</ul>

<h2 id="311---2025-12-28">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.1.0...v3.1.1">3.1.1</a> - 2025-12-28</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.1.1">v3.1.1</a>
</li>
  <li>COVERAGE: 87.44% – 2152/2461 lines in 22 files</li>
  <li>BRANCH COVERAGE: 66.67% – 710/1065 branches in 22 files</li>
  <li>90.02% documented</li>
</ul>

<h3 id="added-11">Added</h3>

<ul>
  <li>
<strong><code>TreeHaver::RSpec::DependencyTags</code></strong>: Shared RSpec dependency detection for the entire gem family
    <ul>
      <li>New <code>lib/tree_haver/rspec.rb</code> entry point - other gems can simply <code>require "tree_haver/rspec"</code>
</li>
      <li>Detects all TreeHaver backends: FFI, MRI, Rust, Java, Prism, Psych, Commonmarker, Markly, Citrus</li>
      <li>Ruby engine detection: <code>jruby?</code>, <code>truffleruby?</code>, <code>mri?</code>
</li>
      <li>Language grammar detection: <code>tree_sitter_bash_available?</code>, <code>tree_sitter_toml_available?</code>, <code>tree_sitter_json_available?</code>, <code>tree_sitter_jsonc_available?</code>
</li>
      <li>Inner-merge dependency detection: <code>toml_merge_available?</code>, <code>json_merge_available?</code>, <code>prism_merge_available?</code>, <code>psych_merge_available?</code>
</li>
      <li>Composite checks: <code>any_toml_backend_available?</code>, <code>any_markdown_backend_available?</code>
</li>
      <li>Records MRI backend usage when checking availability (critical for FFI conflict detection)</li>
      <li>Configures RSpec exclusion filters for all dependency tags automatically</li>
      <li>Supports debug output via <code>TREE_HAVER_DEBUG=1</code> environment variable</li>
      <li>Comprehensive documentation with usage examples</li>
    </ul>
  </li>
  <li>
<strong><code>TreeHaver.parser_for</code></strong>: New high-level factory method for creating configured parsers
    <ul>
      <li>Handles all language loading complexity in one call</li>
      <li>Auto-discovers tree-sitter grammar via <code>GrammarFinder</code>
</li>
      <li>Falls back to Citrus grammar if tree-sitter unavailable</li>
      <li>Accepts <code>library_path</code> for explicit grammar location</li>
      <li>Accepts <code>citrus_config</code> for Citrus fallback configuration</li>
      <li>Raises <code>NotAvailable</code> with helpful message if no backend works</li>
      <li>Example: <code>parser = TreeHaver.parser_for(:toml)</code>
</li>
      <li>Raises <code>NotAvailable</code> if the specified path doesn’t exist (Principle of Least Surprise)</li>
      <li>Does not back to auto-discovery when an explicit path is provided</li>
      <li>Re-raises with context-rich error message if loading from explicit path fails</li>
      <li>Auto-discovery still works normally when no <code>library_path</code> is provided</li>
    </ul>
  </li>
</ul>

<h3 id="changed-11">Changed</h3>

<ul>
  <li>
<strong>Backend sibling navigation</strong>: Backends that don’t support sibling/parent navigation now raise <code>NotImplementedError</code> instead of returning <code>nil</code>
    <ul>
      <li>This distinguishes “not implemented” from “no sibling exists”</li>
      <li>Affected backends: Prism, Psych</li>
      <li>Affected methods: <code>next_sibling</code>, <code>prev_sibling</code>, <code>parent</code>
</li>
    </ul>
  </li>
  <li>
<strong>Canonical sibling method name</strong>: All backends now use <code>prev_sibling</code> as the canonical method name (not <code>previous_sibling</code>)
    <ul>
      <li>Matches the universal <code>TreeHaver::Node</code> API</li>
    </ul>
  </li>
</ul>

<h3 id="fixed-15">Fixed</h3>

<ul>
  <li>
<strong>Backend conflict detection</strong>: Fixed bug where MRI backend usage wasn’t being recorded during availability checks
    <ul>
      <li>
<code>mri_backend_available?</code> now calls <code>TreeHaver.record_backend_usage(:mri)</code> after successfully loading ruby_tree_sitter</li>
      <li>This ensures FFI conflict detection works correctly even when MRI is loaded indirectly</li>
    </ul>
  </li>
  <li>
<strong>GrammarFinder#not_found_message</strong>: Improved error message when grammar file exists but no tree-sitter runtime is available
    <ul>
      <li>Now suggests adding <code>ruby_tree_sitter</code>, <code>ffi</code>, or <code>tree_stump</code> gem to Gemfile</li>
      <li>Clearer guidance for users who have grammar files but are missing the Ruby tree-sitter bindings</li>
    </ul>
  </li>
</ul>

<h2 id="310---2025-12-18">
<a href="https://github.com/kettle-rb/tree_haver/compare/v3.0.0...v3.1.0">3.1.0</a> - 2025-12-18</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.1.0">v3.1.0</a>
</li>
  <li>COVERAGE: 82.65% – 943/1141 lines in 11 files</li>
  <li>BRANCH COVERAGE: 63.80% – 349/547 branches in 11 files</li>
  <li>88.97% documented</li>
</ul>

<h3 id="added-12">Added</h3>

<ul>
  <li>
<strong>Position API Enhancements</strong> – Added consistent position methods to all backend Node classes for compatibility with <code>*-merge</code> gems
    <ul>
      <li>
<code>start_line</code> - Returns 1-based line number where node starts (converts 0-based <code>start_point.row</code> to 1-based)</li>
      <li>
<code>end_line</code> - Returns 1-based line number where node ends (converts 0-based <code>end_point.row</code> to 1-based)</li>
      <li>
<code>source_position</code> - Returns hash <code>{start_line:, end_line:, start_column:, end_column:}</code> with 1-based lines and 0-based columns</li>
      <li>
<code>first_child</code> - Convenience method that returns <code>children.first</code> for iteration compatibility</li>
      <li>
<strong>Fixed:</strong> <code>TreeHaver::Node#start_point</code> and <code>#end_point</code> now handle both Point objects and hashes from backends (Prism, Citrus return hashes)</li>
      <li>
<strong>Fixed:</strong> Added Psych, Commonmarker, and Markly backends to <code>resolve_backend_module</code> and <code>backend_module</code> case statements so they can be explicitly selected with <code>TreeHaver.backend = :psych</code> etc.</li>
      <li>
<strong>Fixed:</strong> Added Prism, Psych, Commonmarker, and Markly backends to <code>unwrap_language</code> method so language objects are properly passed to backend parsers</li>
      <li>
<strong>Fixed:</strong> Commonmarker backend’s <code>text</code> method now safely handles container nodes that don’t have string_content (wraps in rescue TypeError)</li>
      <li>
<strong>Added to:</strong>
        <ul>
          <li>Main <code>TreeHaver::Node</code> wrapper (used by tree-sitter backends: MRI, FFI, Java, Rust)</li>
          <li>
<code>Backends::Commonmarker::Node</code> - uses Commonmarker’s <code>sourcepos</code> (already 1-based)</li>
          <li>
<code>Backends::Markly::Node</code> - uses Markly’s <code>source_position</code> (already 1-based)</li>
          <li>
<code>Backends::Prism::Node</code> - uses Prism’s <code>location</code> (already 1-based)</li>
          <li>
<code>Backends::Psych::Node</code> - calculates from <code>start_point</code>/<code>end_point</code> (0-based)</li>
          <li>
<code>Backends::Citrus::Node</code> - calculates from <code>start_point</code>/<code>end_point</code> (0-based)</li>
        </ul>
      </li>
      <li>
<strong>Backward Compatible:</strong> Existing <code>start_point</code>/<code>end_point</code> methods continue to work unchanged</li>
      <li>
<strong>Purpose:</strong> Enables all <code>*-merge</code> gems to use consistent position API without backend-specific workarounds</li>
    </ul>
  </li>
  <li>
<strong>Prism Backend</strong> – New backend wrapping Ruby’s official Prism parser (stdlib in Ruby 3.4+, gem for 3.2+)
    <ul>
      <li>
<code>TreeHaver::Backends::Prism::Language</code> - Language wrapper (Ruby-only)</li>
      <li>
<code>TreeHaver::Backends::Prism::Parser</code> - Parser with <code>parse</code> and <code>parse_string</code> methods</li>
      <li>
<code>TreeHaver::Backends::Prism::Tree</code> - Tree wrapper with <code>root_node</code>, <code>errors</code>, <code>warnings</code>, <code>comments</code>
</li>
      <li>
<code>TreeHaver::Backends::Prism::Node</code> - Node wrapper implementing full TreeHaver::Node protocol</li>
      <li>Registered with <code>:prism</code> backend name, no conflicts with other backends</li>
    </ul>
  </li>
  <li>
<strong>Psych Backend</strong> – New backend wrapping Ruby’s standard library YAML parser
    <ul>
      <li>
<code>TreeHaver::Backends::Psych::Language</code> - Language wrapper (YAML-only)</li>
      <li>
<code>TreeHaver::Backends::Psych::Parser</code> - Parser with <code>parse</code> and <code>parse_string</code> methods</li>
      <li>
<code>TreeHaver::Backends::Psych::Tree</code> - Tree wrapper with <code>root_node</code>, <code>errors</code>
</li>
      <li>
<code>TreeHaver::Backends::Psych::Node</code> - Node wrapper implementing TreeHaver::Node protocol</li>
      <li>Psych-specific methods: <code>mapping?</code>, <code>sequence?</code>, <code>scalar?</code>, <code>alias?</code>, <code>mapping_entries</code>, <code>anchor</code>, <code>tag</code>, <code>value</code>
</li>
      <li>Registered with <code>:psych</code> backend name, no conflicts with other backends</li>
    </ul>
  </li>
  <li>
<strong>Commonmarker Backend</strong> – New backend wrapping the Commonmarker gem (comrak Rust parser)
    <ul>
      <li>
<code>TreeHaver::Backends::Commonmarker::Language</code> - Language wrapper with parse options passthrough</li>
      <li>
<code>TreeHaver::Backends::Commonmarker::Parser</code> - Parser with <code>parse</code> and <code>parse_string</code> methods</li>
      <li>
<code>TreeHaver::Backends::Commonmarker::Tree</code> - Tree wrapper with <code>root_node</code>
</li>
      <li>
<code>TreeHaver::Backends::Commonmarker::Node</code> - Node wrapper implementing TreeHaver::Node protocol</li>
      <li>Commonmarker-specific methods: <code>header_level</code>, <code>fence_info</code>, <code>url</code>, <code>title</code>, <code>next_sibling</code>, <code>previous_sibling</code>, <code>parent</code>
</li>
      <li>Registered with <code>:commonmarker</code> backend name, no conflicts with other backends</li>
    </ul>
  </li>
  <li>
<strong>Markly Backend</strong> – New backend wrapping the Markly gem (cmark-gfm C library)
    <ul>
      <li>
<code>TreeHaver::Backends::Markly::Language</code> - Language wrapper with flags and extensions passthrough</li>
      <li>
<code>TreeHaver::Backends::Markly::Parser</code> - Parser with <code>parse</code> and <code>parse_string</code> methods</li>
      <li>
<code>TreeHaver::Backends::Markly::Tree</code> - Tree wrapper with <code>root_node</code>
</li>
      <li>
<code>TreeHaver::Backends::Markly::Node</code> - Node wrapper implementing TreeHaver::Node protocol</li>
      <li>Type normalization: <code>:header</code> → <code>"heading"</code>, <code>:hrule</code> → <code>"thematic_break"</code>, <code>:html</code> → <code>"html_block"</code>
</li>
      <li>Markly-specific methods: <code>header_level</code>, <code>fence_info</code>, <code>url</code>, <code>title</code>, <code>next_sibling</code>, <code>previous_sibling</code>, <code>parent</code>, <code>raw_type</code>
</li>
      <li>Registered with <code>:markly</code> backend name, no conflicts with other backends</li>
    </ul>
  </li>
  <li>
<strong>Automatic Citrus Fallback</strong> – When tree-sitter fails, automatically fall back to Citrus backend
    <ul>
      <li>
<code>TreeHaver::Language.method_missing</code> now catches tree-sitter loading errors (<code>NotAvailable</code>, <code>ArgumentError</code>, <code>LoadError</code>, <code>FFI::NotFoundError</code>) and falls back to registered Citrus grammar</li>
      <li>
<code>TreeHaver::Parser#initialize</code> now catches parser creation errors and falls back to Citrus parser when backend is <code>:auto</code>
</li>
      <li>
<code>TreeHaver::Parser#language=</code> automatically switches to Citrus parser when a Citrus language is assigned</li>
      <li>Enables seamless use of pure-Ruby parsers (like toml-rb) when tree-sitter runtime is unavailable</li>
    </ul>
  </li>
  <li>
<strong>GrammarFinder Runtime Check</strong> – <code>GrammarFinder#available?</code> now verifies tree-sitter runtime is actually usable
    <ul>
      <li>New <code>GrammarFinder.tree_sitter_runtime_usable?</code> class method tests if parser can be created</li>
      <li>
<code>TREE_SITTER_BACKENDS</code> constant defines which backends use tree-sitter (MRI, FFI, Rust, Java)</li>
      <li>Prevents registration of grammars when tree-sitter runtime isn’t functional</li>
      <li>
<code>GrammarFinder.reset_runtime_check!</code> for testing</li>
    </ul>
  </li>
  <li>
<strong>Empty ENV Variable as Explicit Skip</strong> – Setting <code>TREE_SITTER_&lt;LANG&gt;_PATH=''</code> explicitly disables that grammar
    <ul>
      <li>Previously, empty string was treated same as unset (would search paths)</li>
      <li>Now, empty string means “do not use tree-sitter for this language”</li>
      <li>Allows explicit opt-out to force fallback to alternative backends like Citrus</li>
      <li>Useful for testing and environments where tree-sitter isn’t desired</li>
    </ul>
  </li>
  <li>
<strong>TOML Examples</strong> – New example scripts demonstrating TOML parsing with various backends
    <ul>
      <li>
<code>examples/auto_toml.rb</code> - Auto backend selection with Citrus fallback demonstration</li>
      <li>
<code>examples/ffi_toml.rb</code> - FFI backend with TOML</li>
      <li>
<code>examples/mri_toml.rb</code> - MRI backend with TOML</li>
      <li>
<code>examples/rust_toml.rb</code> - Rust backend with TOML</li>
      <li>
<code>examples/java_toml.rb</code> - Java backend with TOML (JRuby only)</li>
    </ul>
  </li>
</ul>

<h3 id="fixed-16">Fixed</h3>

<ul>
  <li>
<strong>BREAKING</strong>: <code>TreeHaver::Language.method_missing</code> no longer raises <code>ArgumentError</code> when only Citrus grammar is registered and tree-sitter backend is active – it now falls back to Citrus instead
    <ul>
      <li>Previously: Would raise “No grammar registered for :lang compatible with tree_sitter backend”</li>
      <li>Now: Returns <code>TreeHaver::Backends::Citrus::Language</code> if Citrus grammar is registered</li>
      <li>Migration: If you were catching this error, update your code to handle the fallback behavior</li>
      <li>This is a bug fix, but would be a breaking change for some users who were relying on the old behavior</li>
    </ul>
  </li>
</ul>

<h2 id="300---2025-12-16">
<a href="https://github.com/kettle-rb/tree_haver/compare/v2.0.0...v3.0.0">3.0.0</a> - 2025-12-16</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v3.0.0">v3.0.0</a>
</li>
  <li>COVERAGE: 85.19% – 909/1067 lines in 11 files</li>
  <li>BRANCH COVERAGE: 67.47% – 338/501 branches in 11 files</li>
  <li>92.93% documented</li>
</ul>

<h3 id="added-13">Added</h3>

<h4 id="backend-requirements">Backend Requirements</h4>

<ul>
  <li>
<strong>MRI Backend</strong>: Requires <code>ruby_tree_sitter</code> v2.0+ (exceptions inherit from <code>Exception</code> not <code>StandardError</code>)
    <ul>
      <li>In ruby_tree_sitter v2.0, TreeSitter errors were changed to inherit from Exception for thread-safety</li>
      <li>TreeHaver now properly handles: <code>ParserNotFoundError</code>, <code>LanguageLoadError</code>, <code>SymbolNotFoundError</code>, etc.</li>
    </ul>
  </li>
</ul>

<h4 id="thread-safe-backend-selection-hybrid-approach">Thread-Safe Backend Selection (Hybrid Approach)</h4>

<ul>
  <li>
<strong>NEW: Block-based backend API</strong> - <code>TreeHaver.with_backend(:ffi) { ... }</code> for thread-safe backend selection
    <ul>
      <li>Thread-local context with proper nesting support</li>
      <li>Exception-safe (context restored even on errors)</li>
      <li>Fully backward compatible with existing global backend setting</li>
    </ul>
  </li>
  <li>
<strong>NEW: Explicit backend parameters</strong>
    <ul>
      <li>
<code>Parser.new(backend: :mri)</code> - specify backend when creating parser</li>
      <li>
<code>Language.from_library(path, backend: :ffi)</code> - specify backend when loading language</li>
      <li>Backend parameters override thread context and global settings</li>
    </ul>
  </li>
  <li>
<strong>NEW: Backend introspection</strong> - <code>parser.backend</code> returns the current backend name (<code>:ffi</code>, <code>:mri</code>, etc.)</li>
  <li>
<strong>Backend precedence chain</strong>: <code>explicit parameter &gt; thread context &gt; global setting &gt; :auto</code>
</li>
  <li>
<strong>Backend-aware caching</strong> - Language cache now includes backend in cache key to prevent cross-backend pollution</li>
  <li>Added <code>TreeHaver.effective_backend</code> - returns the currently effective backend considering precedence</li>
  <li>Added <code>TreeHaver.current_backend_context</code> - returns thread-local backend context</li>
  <li>Added <code>TreeHaver.resolve_backend_module(explicit_backend)</code> - resolves backend module with precedence</li>
</ul>

<h4 id="examples-and-discovery">Examples and Discovery</h4>

<ul>
  <li>Added 18 comprehensive examples demonstrating all backends and languages
    <ul>
      <li>JSON examples (5): auto, MRI, Rust, FFI, Java</li>
      <li>JSONC examples (5): auto, MRI, Rust, FFI, Java</li>
      <li>Bash examples (5): auto, MRI, Rust, FFI, Java</li>
      <li>Citrus examples (3): TOML, Finitio, Dhall</li>
      <li>All examples use bundler inline (self-contained, no Gemfile needed)</li>
      <li>Added <code>examples/run_all.rb</code> - comprehensive test runner with colored output</li>
      <li>Updated <code>examples/README.md</code> - complete guide to all examples</li>
    </ul>
  </li>
  <li>Added <code>TreeHaver::CitrusGrammarFinder</code> for language-agnostic discovery and registration of Citrus-based grammar gems
    <ul>
      <li>Automatically discovers Citrus grammar gems by gem name and grammar constant path</li>
      <li>Validates grammar modules respond to <code>.parse(source)</code> before registration</li>
      <li>Provides helpful error messages when grammars are not found</li>
    </ul>
  </li>
  <li>Added multi-backend language registry supporting multiple backends per language simultaneously
    <ul>
      <li>Restructured <code>LanguageRegistry</code> to use nested hash: <code>{ language: { backend_type: config } }</code>
</li>
      <li>Enables registering both tree-sitter and Citrus grammars for the same language without conflicts</li>
      <li>Supports runtime backend switching, benchmarking, and fallback scenarios</li>
    </ul>
  </li>
  <li>Added <code>LanguageRegistry.register(name, backend_type, **config)</code> with backend-specific configuration storage</li>
  <li>Added <code>LanguageRegistry.registered(name, backend_type = nil)</code> to query by specific backend or get all backends</li>
  <li>Added <code>TreeHaver::Backends::Citrus::Node#structural?</code> method to distinguish structural nodes from terminals
    <ul>
      <li>Uses Citrus grammar’s <code>terminal?</code> method to dynamically determine node classification</li>
      <li>Works with any Citrus grammar without language-specific knowledge</li>
    </ul>
  </li>
</ul>

<h3 id="changed-12">Changed</h3>

<ul>
  <li>
<strong>BREAKING</strong>: All errors now inherit from <code>TreeHaver::Error</code> which inherits from <code>Exception</code>
    <ul>
      <li>see: https://github.com/Faveod/ruby-tree-sitter/pull/83 for reasoning</li>
    </ul>
  </li>
  <li>
<strong>BREAKING</strong>: <code>LanguageRegistry.register</code> signature changed from <code>register(name, path:, symbol:)</code> to <code>register(name, backend_type, **config)</code>
    <ul>
      <li>This enables proper separation of tree-sitter and Citrus configurations</li>
      <li>Users should update to use <code>TreeHaver.register_language</code> instead of calling <code>LanguageRegistry.register</code> directly</li>
    </ul>
  </li>
  <li>Updated <code>TreeHaver.register_language</code> to support both tree-sitter and Citrus grammars in single call or separate calls
    <ul>
      <li>Can now register: <code>register_language(:toml, path: "...", symbol: "...", grammar_module: TomlRB::Document)</code>
</li>
      <li>
<strong>INTENTIONAL DESIGN</strong>: Uses separate <code>if</code> statements (not <code>elsif</code>) to allow registering both backends simultaneously</li>
      <li>Enables maximum flexibility: runtime backend switching, performance benchmarking, fallback scenarios</li>
      <li>Multiple registrations for same language now merge instead of overwrite</li>
    </ul>
  </li>
</ul>

<h3 id="improved">Improved</h3>

<h4 id="code-quality-and-documentation">Code Quality and Documentation</h4>

<ul>
  <li>
<strong>Uniform backend API</strong>: All backends now implement <code>reset!</code> method for consistent testing interface
    <ul>
      <li>Eliminates need for tests to manipulate private instance variables</li>
      <li>Provides clean way to reset backend state between tests</li>
    </ul>
  </li>
  <li>
<strong>Documented design decisions</strong> with inline rationale
    <ul>
      <li>FFI Tree finalizer behavior and why Parser doesn’t use finalizers</li>
      <li>
<code>resolve_backend_module</code> early-return pattern with comprehensive comments</li>
      <li>
<code>register_language</code> multi-backend registration capability extensively documented</li>
    </ul>
  </li>
  <li>
<strong>Enhanced YARD documentation</strong>
    <ul>
      <li>All Citrus examples now include <code>gem_name</code> parameter (matches actual usage patterns)</li>
      <li>Added complete examples showing both single-backend and multi-backend registration</li>
      <li>Documented backend precedence chain and thread-safety guarantees</li>
    </ul>
  </li>
  <li>
<strong>Comprehensive test coverage</strong> for thread-safe backend selection
    <ul>
      <li>Thread-local context tests</li>
      <li>Parser backend parameter tests</li>
      <li>Language backend parameter tests</li>
      <li>Concurrent parsing tests with multiple backends</li>
      <li>Backend-aware cache isolation tests</li>
      <li>Nested block behavior tests (inner blocks override outer blocks)</li>
      <li>Exception safety tests (context restored even on errors)</li>
      <li>Explicit parameter precedence tests</li>
    </ul>
  </li>
  <li>Updated <code>Language.method_missing</code> to automatically select appropriate grammar based on active backend
    <ul>
      <li>tree-sitter backends (MRI, Rust, FFI, Java) query <code>:tree_sitter</code> registry key</li>
      <li>Citrus backend queries <code>:citrus</code> registry key</li>
      <li>Provides clear error messages when requested backend has no registered grammar</li>
    </ul>
  </li>
  <li>Improved <code>TreeHaver::Backends::Citrus::Node#type</code> to use dynamic Citrus grammar introspection
    <ul>
      <li>Uses event <code>.name</code> method and Symbol events for accurate type extraction</li>
      <li>Works with any Citrus grammar without language-specific code</li>
      <li>Handles compound rules (Repeat, Choice, Optional) intelligently</li>
    </ul>
  </li>
</ul>

<h3 id="fixed-17">Fixed</h3>

<h4 id="thread-safety-and-backend-selection">Thread-Safety and Backend Selection</h4>

<ul>
  <li>Fixed <code>resolve_backend_module</code> to properly handle mocked backends without <code>available?</code> method
    <ul>
      <li>Assumes modules without <code>available?</code> are available (for test compatibility and backward compatibility)</li>
      <li>Only rejects if module explicitly has <code>available?</code> method and returns false</li>
      <li>Makes code more defensive and test-friendly</li>
    </ul>
  </li>
  <li>Fixed Language cache to include backend in cache key
    <ul>
      <li>Prevents returning wrong backend’s Language object when switching backends</li>
      <li>Essential for correctness with multiple backends in use</li>
      <li>Cache key now: <code>"#{path}:#{symbol}:#{backend}"</code> instead of just <code>"#{path}:#{symbol}"</code>
</li>
    </ul>
  </li>
  <li>Fixed <code>TreeHaver.register_language</code> to properly support multi-backend registration
    <ul>
      <li>Documented intentional design: uses <code>if</code> not <code>elsif</code> to allow both backends in one call</li>
      <li>Added comprehensive inline comments explaining why no early return</li>
      <li>Added extensive YARD documentation with examples</li>
    </ul>
  </li>
</ul>

<h4 id="backend-bug-fixes">Backend Bug Fixes</h4>

<ul>
  <li>Fixed critical double-wrapping bug in ALL backends (MRI, Rust, FFI, Java, Citrus)
    <ul>
      <li>Backend <code>Parser#parse</code> and <code>parse_string</code> methods now return raw backend trees</li>
      <li>TreeHaver::Parser wraps the raw tree in TreeHaver::Tree (single wrapping)</li>
      <li>Previously backends were returning TreeHaver::Tree, then TreeHaver::Parser wrapped it again (double wrapping)</li>
      <li>This caused <code>@inner_tree</code> to be a TreeHaver::Tree instead of raw backend tree, leading to nil errors</li>
    </ul>
  </li>
  <li>Fixed TreeHaver::Parser to pass source parameter when wrapping backend trees
    <ul>
      <li>Enables <code>Node#text</code> to work correctly by providing source for text extraction</li>
      <li>Fixes all parse and parse_string methods to include <code>source: source</code> parameter</li>
    </ul>
  </li>
  <li>Fixed MRI backend to properly use ruby_tree_sitter API
    <ul>
      <li>Fixed <code>require "tree_sitter"</code> (gem name is <code>ruby_tree_sitter</code> but requires <code>tree_sitter</code>)</li>
      <li>Fixed <code>Language.load</code> to use correct argument order: <code>(symbol_name, path)</code>
</li>
      <li>Fixed <code>Parser#parse</code> to use <code>parse_string(nil, source)</code> instead of creating Input objects</li>
      <li>Fixed <code>Language.from_library</code> to implement the expected signature matching other backends</li>
    </ul>
  </li>
  <li>Fixed FFI backend missing essential node methods
    <ul>
      <li>Added <code>ts_node_start_byte</code>, <code>ts_node_end_byte</code>, <code>ts_node_start_point</code>, <code>ts_node_end_point</code>
</li>
      <li>Added <code>ts_node_is_null</code>, <code>ts_node_is_named</code>
</li>
      <li>These methods are required for accessing node byte positions and metadata</li>
      <li>Fixes <code>NoMethodError</code> when using FFI backend to traverse AST nodes</li>
    </ul>
  </li>
  <li>Fixed GrammarFinder error messages for environment variable validation
    <ul>
      <li>Detects leading/trailing whitespace in paths and provides correction suggestions</li>
      <li>Shows when TREE_SITTER_*_PATH is set but points to nonexistent file</li>
      <li>Provides helpful guidance for setting environment variables correctly</li>
    </ul>
  </li>
  <li>Fixed registry conflicts when registering multiple backend types for the same language</li>
  <li>Fixed <code>CitrusGrammarFinder</code> to use gem name as-is for require path (e.g., <code>require "toml-rb"</code> not <code>require "toml/rb"</code>)</li>
  <li>Fixed Citrus backend infinite recursion in <code>Node#extract_type_from_event</code>
    <ul>
      <li>Added cycle detection to prevent stack overflow when traversing recursive grammar structures</li>
    </ul>
  </li>
</ul>

<h3 id="known-issues">Known Issues</h3>

<ul>
  <li>
<strong>MRI backend + Bash grammar</strong>: ABI/symbol loading incompatibility
    <ul>
      <li>The ruby_tree_sitter gem cannot load tree-sitter-bash grammar (symbol not found)</li>
      <li>Workaround: Use FFI backend instead (works perfectly)</li>
      <li>This is documented in examples and test runner</li>
    </ul>
  </li>
  <li>
<strong>Rust backend + Bash grammar</strong>: Version mismatch due to static linking
    <ul>
      <li>tree_stump statically links tree-sitter at compile time</li>
      <li>System bash.so may be compiled with different tree-sitter version</li>
      <li>Workaround: Use FFI backend (dynamic linking avoids version conflicts)</li>
      <li>This is documented in examples with detailed explanations</li>
    </ul>
  </li>
</ul>

<h3 id="notes-on-backward-compatibility">Notes on Backward Compatibility</h3>

<p>Despite the major version bump to 3.0.0 (following semver due to the breaking <code>LanguageRegistry.register</code> signature change), <strong>most users will experience NO BREAKING CHANGES</strong>:</p>

<h4 id="why-300">Why 3.0.0?</h4>

<ul>
  <li>
<code>LanguageRegistry.register</code> signature changed to support multi-backend registration</li>
  <li>However, most users should use <code>TreeHaver.register_language</code> (which remains backward compatible)</li>
  <li>Direct calls to <code>LanguageRegistry.register</code> are rare in practice</li>
</ul>

<h4 id="what-stays-the-same">What Stays the Same?</h4>

<ul>
  <li>
<strong>Global backend setting</strong>: <code>TreeHaver.backend = :ffi</code> works unchanged</li>
  <li>
<strong>Parser creation</strong>: <code>Parser.new</code> without parameters works as before</li>
  <li>
<strong>Language loading</strong>: <code>Language.from_library(path)</code> works as before</li>
  <li>
<strong>Auto-detection</strong>: Backend auto-selection still works when backend is <code>:auto</code>
</li>
  <li>
<strong>All existing code</strong> continues to work without modifications</li>
</ul>

<h4 id="whats-new-all-optional">What’s New (All Optional)?</h4>

<ul>
  <li>Thread-safe block API: <code>TreeHaver.with_backend(:ffi) { ... }</code>
</li>
  <li>Explicit backend parameters: <code>Parser.new(backend: :mri)</code>
</li>
  <li>Backend introspection: <code>parser.backend</code>
</li>
  <li>Multi-backend language registration</li>
</ul>

<p><strong>Migration Path</strong>: Existing codebases can upgrade to 3.0.0 and gain access to new thread-safe features without changing any existing code. The new features are purely additive and opt-in.</p>

<h2 id="200---2025-12-15">
<a href="https://github.com/kettle-rb/tree_haver/compare/v1.0.0...v2.0.0">2.0.0</a> - 2025-12-15</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/releases/tag/v2.0.0">v2.0.0</a>
</li>
  <li>COVERAGE: 82.78% – 601/726 lines in 11 files</li>
  <li>BRANCH COVERAGE: 70.45% – 186/264 branches in 11 files</li>
  <li>91.90% documented</li>
</ul>

<h3 id="added-14">Added</h3>

<ul>
  <li>Added support for Citrus backend (<code>backends/citrus.rb</code>) - a pure Ruby grammar parser with its own distinct grammar structure</li>
  <li>Added <code>TreeHaver::Tree</code> unified wrapper class providing consistent API across all backends</li>
  <li>Added <code>TreeHaver::Node</code> unified wrapper class providing consistent API across all backends</li>
  <li>Added <code>TreeHaver::Point</code> class that works as both object and hash for position compatibility</li>
  <li>Added passthrough mechanism via <code>method_missing</code> for accessing backend-specific features</li>
  <li>Added <code>inner_node</code> accessor on <code>TreeHaver::Node</code> for advanced backend-specific usage</li>
  <li>Added <code>inner_tree</code> accessor on <code>TreeHaver::Tree</code> for advanced backend-specific usage</li>
  <li>Added comprehensive test suite for <code>TreeHaver::Node</code> wrapper class (88 examples)</li>
  <li>Added comprehensive test suite for <code>TreeHaver::Tree</code> wrapper class (17 examples)</li>
  <li>Added comprehensive test suite for <code>TreeHaver::Parser</code> class (12 examples)</li>
  <li>Added complete test coverage for Citrus backend (41 examples)</li>
  <li>Enhanced <code>TreeHaver::Language</code> tests for dynamic language helpers</li>
</ul>

<h3 id="changed-13">Changed</h3>

<ul>
  <li>
<strong>BREAKING:</strong> All backends now return <code>TreeHaver::Tree</code> from <code>Parser#parse</code> and <code>Parser#parse_string</code>
</li>
  <li>
<strong>BREAKING:</strong> <code>TreeHaver::Tree#root_node</code> now returns <code>TreeHaver::Node</code> instead of backend-specific node</li>
  <li>
<strong>BREAKING:</strong> All child/sibling/parent methods on nodes now return <code>TreeHaver::Node</code> wrappers</li>
  <li>Updated MRI backend (<code>backends/mri.rb</code>) to return wrapped <code>TreeHaver::Tree</code> with source</li>
  <li>Updated Rust backend (<code>backends/rust.rb</code>) to return wrapped <code>TreeHaver::Tree</code> with source</li>
  <li>Updated FFI backend (<code>backends/ffi.rb</code>) to return wrapped <code>TreeHaver::Tree</code> with source</li>
  <li>Updated Java backend (<code>backends/java.rb</code>) to return wrapped <code>TreeHaver::Tree</code> with source</li>
  <li>Updated Citrus backend (<code>backends/citrus.rb</code>) to return wrapped <code>TreeHaver::Tree</code> with source</li>
  <li>Disabled old pass-through stub classes in <code>tree_haver.rb</code> (wrapped in <code>if false</code> for reference)</li>
</ul>

<h3 id="fixed-18">Fixed</h3>

<ul>
  <li>Fixed <code>TreeHaver::Tree#supports_editing?</code> and <code>#edit</code> to handle Delegator wrappers correctly by using <code>.method(:edit)</code> check instead of <code>respond_to?</code>
</li>
  <li>Fixed <code>PathValidator</code> to accept versioned <code>.so</code> files (e.g., <code>.so.0</code>, <code>.so.14</code>) which are standard on Linux systems</li>
  <li>Fixed backend portability - code now works identically across MRI, Rust, FFI, Java, and Citrus backends</li>
  <li>Fixed inconsistent API - <code>node.type</code> now works on all backends (was <code>node.kind</code> on TreeStump)</li>
  <li>Fixed position objects - <code>start_point</code> and <code>end_point</code> now return objects that work as both <code>.row</code> and <code>[:row]</code>
</li>
  <li>Fixed child iteration - <code>node.each</code> and <code>node.children</code> now consistently return <code>TreeHaver::Node</code> objects</li>
  <li>Fixed text extraction - <code>node.text</code> now works consistently by storing source in <code>TreeHaver::Tree</code>
</li>
</ul>

<h2 id="100---2025-12-15">
<a href="https://github.com/kettle-rb/tree_haver/compare/a89211bff10f4440b96758a8ac9d7d539001b0c8...v1.0.0">1.0.0</a> - 2025-12-15</h2>

<ul>
  <li>TAG: <a href="https://github.com/kettle-rb/tree_haver/tags/v1.0.0">v1.0.0</a>
</li>
  <li>COVERAGE: 97.21% – 487/501 lines in 8 files</li>
  <li>BRANCH COVERAGE: 90.75% – 157/173 branches in 8 files</li>
  <li>97.31% documented</li>
</ul>

<h3 id="added-15">Added</h3>

<ul>
  <li>Initial release</li>
</ul>

</div></div>

      <div id="footer">
  Generated on Tue Jan 20 13:17:43 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.1).
</div>

    </div>
  </body>
</html>