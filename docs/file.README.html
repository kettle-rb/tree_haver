<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><table>
  <thead>
    <tr>
      <th>ğŸ“ NOTE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>RubyGems (the <a href="https://github.com/rubygems/">GitHub org</a>, not the website) <a href="https://joel.drapper.me/p/ruby-central-security-measures/">suffered</a> a <a href="https://pup-e.com/blog/goodbye-rubygems/">hostile takeover</a> in September 2025.</td>
    </tr>
    <tr>
      <td>Ultimately <a href="https://www.reddit.com/r/ruby/s/gOk42POCaV">4 maintainers</a> were <a href="https://bsky.app/profile/martinemde.com/post/3m3occezxxs2q">hard removed</a> and a reason has been given for only 1 of those, while 2 others resigned in protest.</td>
    </tr>
    <tr>
      <td>It is a <a href="https://joel.drapper.me/p/ruby-central-takeover/">complicated story</a> which is difficult to <a href="https://joel.drapper.me/p/ruby-central-fact-check/">parse quickly</a>.</td>
    </tr>
    <tr>
      <td>Simply put - there was active policy for adding or removing maintainers/owners of <a href="https://github.com/ruby/rubygems/blob/b1ab33a3d52310a84d16b193991af07f5a6a07c0/doc/rubygems/POLICIES.md?plain=1#L187-L196">rubygems</a> and <a href="https://github.com/ruby/rubygems/blob/b1ab33a3d52310a84d16b193991af07f5a6a07c0/doc/bundler/playbooks/TEAM_CHANGES.md">bundler</a>, and those <a href="https://www.reddit.com/r/ruby/comments/1ove9vp/rubycentral_hates_this_one_fact/">policies were not followed</a>.</td>
    </tr>
    <tr>
      <td>Iâ€™m adding notes like this to gems because I <a href="https://joel.drapper.me/p/ruby-central/">donâ€™t condone theft</a> of repositories or gems from their rightful owners.</td>
    </tr>
    <tr>
      <td>If a similar theft happened with my repos/gems, Iâ€™d hope some would stand up for me.</td>
    </tr>
    <tr>
      <td>Disenfranchised former-maintainers have started <a href="https://gem.coop">gem.coop</a>.</td>
    </tr>
    <tr>
      <td>Once available I will publish there exclusively; unless RubyCentral makes amends with the community.</td>
    </tr>
    <tr>
      <td>The <a href="https://youtu.be/_H4qbtC5qzU?si=BvuBU90R2wAqD2E6">â€œTechnology for Humans: Joel Draperâ€</a> podcast episode by <a href="https://reinteractive.com/ruby-on-rails">reinteractive</a> is the most cogent summary Iâ€™m aware of.</td>
    </tr>
    <tr>
      <td>See <a href="https://github.com/gem-coop/gem.coop/issues/12">here</a>, <a href="https://gem.coop">here</a> and <a href="https://martinemde.com/2025/10/05/announcing-gem-coop.html">here</a> for more info on what comes next.</td>
    </tr>
    <tr>
      <td>What Iâ€™m doing: A (WIP) proposal for <a href="https://github.com/galtzo-floss/bundle-namespace">bundler/gem scopes</a>, and a (WIP) proposal for a federated <a href="https://github.com/galtzo-floss/gem-server">gem server</a>.</td>
    </tr>
  </tbody>
</table>

<p><a href="https://discord.gg/3qme4XHNKN"><img src="https://logos.galtzo.com/assets/images/galtzo-floss/avatar-192px.svg" alt="Galtzo FLOSS Logo by Aboling0, CC BY-SA 4.0"></a> <a href="https://www.ruby-lang.org/"><img src="https://logos.galtzo.com/assets/images/ruby-lang/avatar-192px.svg" alt="ruby-lang Logo, Yukihiro Matsumoto, Ruby Visual Identity Team, CC BY-SA 2.5"></a> <a href="https://github.com/kettle-rb"><img src="https://logos.galtzo.com/assets/images/kettle-rb/avatar-192px.svg" alt="kettle-rb Logo by Aboling0, CC BY-SA 4.0"></a></p>

<h1 id="-treehaver">ğŸŒ´ TreeHaver</h1>

<p><a href="https://bestgems.org/gems/tree_haver"><img src="https://img.shields.io/gem/v/tree_haver.svg" alt="Version"></a> <a href="http://github.com/kettle-rb/tree_haver/releases"><img src="https://img.shields.io/github/tag/kettle-rb/tree_haver.svg" alt="GitHub tag (latest SemVer)"></a> <a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-259D6C.svg" alt="License: MIT"></a> <a href="https://bestgems.org/gems/tree_haver"><img src="https://img.shields.io/gem/rd/tree_haver.svg" alt="Downloads Rank"></a> <a href="https://www.codetriage.com/kettle-rb/tree_haver"><img src="https://www.codetriage.com/kettle-rb/tree_haver/badges/users.svg" alt="Open Source Helpers"></a> <a href="https://codecov.io/gh/kettle-rb/tree_haver"><img src="https://codecov.io/gh/kettle-rb/tree_haver/graph/badge.svg" alt="CodeCov Test Coverage"></a> <a href="https://coveralls.io/github/kettle-rb/tree_haver?branch=main"><img src="https://coveralls.io/repos/github/kettle-rb/tree_haver/badge.svg?branch=main" alt="Coveralls Test Coverage"></a> <a href="https://qlty.sh/gh/kettle-rb/projects/tree_haver/metrics/code?sort=coverageRating"><img src="https://qlty.sh/gh/kettle-rb/projects/tree_haver/coverage.svg" alt="QLTY Test Coverage"></a> <a href="https://qlty.sh/gh/kettle-rb/projects/tree_haver"><img src="https://qlty.sh/gh/kettle-rb/projects/tree_haver/maintainability.svg" alt="QLTY Maintainability"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml/badge.svg" alt="CI Heads"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/dep-heads.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/dep-heads.yml/badge.svg" alt="CI Runtime Dependencies @ HEAD"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml/badge.svg" alt="CI Current"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml/badge.svg" alt="CI Truffle Ruby"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/locked_deps.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/locked_deps.yml/badge.svg" alt="Deps Locked"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/unlocked_deps.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/unlocked_deps.yml/badge.svg" alt="Deps Unlocked"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml/badge.svg" alt="CI Supported"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/coverage.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/coverage.yml/badge.svg" alt="CI Test Coverage"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/style.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/style.yml/badge.svg" alt="CI Style"></a> <a href="https://github.com/kettle-rb/tree_haver/security/code-scanning"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/codeql-analysis.yml/badge.svg" alt="CodeQL"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/license-eye.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/license-eye.yml/badge.svg" alt="Apache SkyWalking Eyes License Compatibility Check"></a></p>

<p><code>if ci_badges.map(&amp;:color).detect { it != "green"}</code> â˜ï¸ <a href="https://discord.gg/3qme4XHNKN">let me know</a>, as I may have missed the <a href="https://discord.gg/3qme4XHNKN">discord notification</a>.</p>

<hr>

<p><code>if ci_badges.map(&amp;:color).all? { it == "green"}</code> ğŸ‘‡ï¸ send money so I can do more of this. FLOSS maintenance is now my full-time job.</p>

<p><a href="https://opencollective.com/kettle-rb#backer"><img src="https://opencollective.com/kettle-rb/backers/badge.svg?style=flat" alt="OpenCollective Backers"></a> <a href="https://opencollective.com/kettle-rb#sponsor"><img src="https://opencollective.com/kettle-rb/sponsors/badge.svg?style=flat" alt="OpenCollective Sponsors"></a> <a href="https://github.com/sponsors/pboling"><img src="https://img.shields.io/badge/Sponsor_Me!-pboling.svg?style=social&amp;logo=github" alt="Sponsor Me on Github"></a> <a href="https://liberapay.com/pboling/donate"><img src="https://img.shields.io/liberapay/goal/pboling.svg?logo=liberapay&amp;color=a51611&amp;style=flat" alt="Liberapay Goal Progress"></a> <a href="https://www.paypal.com/paypalme/peterboling"><img src="https://img.shields.io/badge/donate-paypal-a51611.svg?style=flat&amp;logo=paypal" alt="Donate on PayPal"></a> <a href="https://www.buymeacoffee.com/pboling"><img src="https://img.shields.io/badge/buy_me_a_coffee-%E2%9C%93-a51611.svg?style=flat" alt="Buy me a coffee"></a> <a href="https://polar.sh/pboling"><img src="https://img.shields.io/badge/polar-donate-a51611.svg?style=flat" alt="Donate on Polar"></a> <a href="https://ko-fi.com/O5O86SNP4"><img src="https://img.shields.io/badge/ko--fi-%E2%9C%93-a51611.svg?style=flat" alt="Donate at ko-fi.com"></a></p>

<h2 id="-synopsis">ğŸŒ» Synopsis</h2>

<p>TreeHaver is a cross-Ruby adapter for the <a href="https://tree-sitter.github.io/tree-sitter/">tree-sitter</a> parsing library that works seamlessly across MRI Ruby, JRuby, and TruffleRuby. It provides a unified API for parsing source code using tree-sitter grammars, regardless of your Ruby implementation.</p>

<h3 id="the-adapter-pattern-like-faraday-but-for-parsing">The Adapter Pattern: Like Faraday, but for Parsing</h3>

<p>If youâ€™ve used <a href="https://github.com/lostisland/faraday">Faraday</a>, <a href="https://github.com/intridea/multi_json">multi_json</a>, or <a href="https://github.com/sferik/multi_xml">multi_xml</a>, youâ€™ll feel right at home with TreeHaver. These gems share a common philosophy:</p>

<table>
  <thead>
    <tr>
      <th>Gem</th>
      <th>Unified API for</th>
      <th>Backend Examples</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Faraday</strong></td>
      <td>HTTP requests</td>
      <td>Net::HTTP, Typhoeus, Patron, Excon</td>
    </tr>
    <tr>
      <td><strong>multi_json</strong></td>
      <td>JSON parsing</td>
      <td>Oj, Yajl, JSON gem</td>
    </tr>
    <tr>
      <td><strong>multi_xml</strong></td>
      <td>XML parsing</td>
      <td>Nokogiri, LibXML, Ox</td>
    </tr>
    <tr>
      <td><strong>TreeHaver</strong></td>
      <td>tree-sitter parsing</td>
      <td>ruby_tree_sitter, tree_stump, FFI, Java JARs, Citrus</td>
    </tr>
  </tbody>
</table>

<p><strong>Write once, run anywhere.</strong> Just as Faraday lets you swap HTTP adapters without changing your code, TreeHaver lets you swap tree-sitter backends. Your parsing code remains the same whether youâ€™re running on MRI with native C extensions, JRuby with FFI, or TruffleRuby.</p>

<pre class="code language-ruby"><code class="language-ruby"># Your code stays the same regardless of backend
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Language.from_library(&quot;/path/to/grammar.so&quot;)
tree = parser.parse(source_code)

# TreeHaver automatically picks the best backend:
# - MRI â†’ ruby_tree_sitter (C extension)
# - JRuby â†’ FFI (system&#39;s libtree-sitter)
# - TruffleRuby â†’ FFI or MRI backend
</code></pre>

<h3 id="key-features">Key Features</h3>

<ul>
  <li>
<strong>Universal Ruby Support</strong>: Works on MRI Ruby, JRuby, and TruffleRuby</li>
  <li>
<strong>Multiple Backends</strong>:
    <ul>
      <li>
<strong>MRI Backend</strong>: Leverages the excellent <a href="https://github.com/Faveod/ruby-tree-sitter"><code>ruby_tree_sitter</code></a> gem (C extension)</li>
      <li>
<strong>Rust Backend</strong>: Uses <a href="https://github.com/anthropics/tree_stump"><code>tree_stump</code></a> gem (Rust extension with precompiled binaries)
        <ul>
          <li>
<strong>Note</strong>: Currently requires <a href="https://github.com/pboling/tree_stump/tree/tree_haver">pbolingâ€™s fork</a> until PRs <a href="https://github.com/joker1007/tree_stump/pull/5">#5</a>, <a href="https://github.com/joker1007/tree_stump/pull/7">#7</a>, <a href="https://github.com/joker1007/tree_stump/pull/11">#11</a>, and <a href="https://github.com/joker1007/tree_stump/pull/13">#13 (inclusive of the others)</a> are merged</li>
        </ul>
      </li>
      <li>
<strong>FFI Backend</strong>: Pure Ruby FFI bindings to <code>libtree-sitter</code> (ideal for JRuby)</li>
      <li>
<strong>Java Backend</strong>: Support for JRubyâ€™s native Java integration, and native java-tree-sitter grammar JARs</li>
      <li>
<strong>Citrus Backend</strong>: Pure Ruby parser using <a href="https://github.com/mjackson/citrus"><code>citrus</code></a> gem (no native dependencies, portable)</li>
    </ul>
  </li>
  <li>
<strong>Automatic Backend Selection</strong>: Intelligently selects the best backend for your Ruby implementation</li>
  <li>
<strong>Language Agnostic</strong>: Load any tree-sitter grammar dynamically (TOML, JSON, Ruby, JavaScript, etc.)</li>
  <li>
<strong>Grammar Discovery</strong>: Built-in <code>GrammarFinder</code> utility for platform-aware grammar library discovery</li>
  <li>
<strong>Thread-Safe</strong>: Built-in language registry with thread-safe caching</li>
  <li>
<strong>Minimal API Surface</strong>: Simple, focused API that covers the most common tree-sitter use cases</li>
</ul>

<h3 id="why-treehaver">Why TreeHaver?</h3>

<p>tree-sitter is a powerful parser generator that creates incremental parsers for many programming languages. However, integrating it into Ruby applications can be challenging:</p>

<ul>
  <li>MRI-based C extensions donâ€™t work on JRuby</li>
  <li>FFI-based solutions may not be optimal for MRI</li>
  <li>Managing different backends for different Ruby implementations is cumbersome</li>
</ul>

<p>TreeHaver solves these problems by providing a unified API that automatically selects the appropriate backend for your Ruby implementation, allowing you to write code once and run it anywhere.</p>

<h3 id="comparison-with-other-ruby-ast--parser-bindings">Comparison with Other Ruby AST / Parser Bindings</h3>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>
<a href="https://github.com/kettle-rb/tree_haver">tree_haver</a> (this gem)</th>
      <th><a href="https://github.com/Faveod/ruby-tree-sitter">ruby_tree_sitter</a></th>
      <th><a href="https://github.com/anthropics/tree_stump">tree_stump</a></th>
      <th><a href="https://github.com/mjackson/citrus">citrus</a></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>MRI Ruby</strong></td>
      <td>âœ… Yes</td>
      <td>âœ… Yes</td>
      <td>âœ… Yes</td>
      <td>âœ… Yes</td>
    </tr>
    <tr>
      <td><strong>JRuby</strong></td>
      <td>âœ… Yes (FFI, Java, or Citrus backend)</td>
      <td>âŒ No</td>
      <td>âŒ No</td>
      <td>âœ… Yes</td>
    </tr>
    <tr>
      <td><strong>TruffleRuby</strong></td>
      <td>âœ… Yes (FFI or Citrus)</td>
      <td>âŒ No</td>
      <td>â“ Unknown</td>
      <td>âœ… Yes</td>
    </tr>
    <tr>
      <td><strong>Backend</strong></td>
      <td>Multi (MRI C, Rust, FFI, Java, Citrus)</td>
      <td>C extension only</td>
      <td>Rust extension</td>
      <td>Pure Ruby</td>
    </tr>
    <tr>
      <td><strong>Incremental Parsing</strong></td>
      <td>âœ… Via MRI C/Rust/Java backend</td>
      <td>âœ… Yes</td>
      <td>âœ… Yes</td>
      <td>âŒ No</td>
    </tr>
    <tr>
      <td><strong>Query API</strong></td>
      <td>âš¡ Via MRI/Rust/Java backend</td>
      <td>âœ… Yes</td>
      <td>âœ… Yes</td>
      <td>âŒ No</td>
    </tr>
    <tr>
      <td><strong>Grammar Discovery</strong></td>
      <td>âœ… Built-in <code>GrammarFinder</code>
</td>
      <td>âŒ Manual</td>
      <td>âŒ Manual</td>
      <td>âŒ Manual</td>
    </tr>
    <tr>
      <td><strong>Security Validations</strong></td>
      <td>âœ… <code>PathValidator</code>
</td>
      <td>âŒ No</td>
      <td>âŒ No</td>
      <td>âŒ No</td>
    </tr>
    <tr>
      <td><strong>Language Registration</strong></td>
      <td>âœ… Thread-safe registry</td>
      <td>âŒ No</td>
      <td>âŒ No</td>
      <td>âŒ No</td>
    </tr>
    <tr>
      <td><strong>Native Performance</strong></td>
      <td>âš¡ Backend-dependent</td>
      <td>âœ… Native C</td>
      <td>âœ… Native Rust</td>
      <td>âŒ Pure Ruby</td>
    </tr>
    <tr>
      <td><strong>Precompiled Binaries</strong></td>
      <td>âš¡ Via Rust backend</td>
      <td>âœ… Yes</td>
      <td>âœ… Yes</td>
      <td>âœ… Pure Ruby</td>
    </tr>
    <tr>
      <td><strong>Zero Native Deps</strong></td>
      <td>âš¡ Via Citrus backend</td>
      <td>âŒ No</td>
      <td>âŒ No</td>
      <td>âœ… Yes</td>
    </tr>
    <tr>
      <td><strong>Minimum Ruby</strong></td>
      <td>3.2+</td>
      <td>3.0+</td>
      <td>3.1+</td>
      <td>0+</td>
    </tr>
  </tbody>
</table>

<p><strong>Note:</strong> Java backend works with grammar JARs built specifically for java-tree-sitter, or grammar .so files that statically link tree-sitter. This is why FFI is recommended for JRuby &amp; TruffleRuby.</p>

<p><strong>Note:</strong> TreeHaver can use <code>ruby_tree_sitter</code> or <code>tree_stump</code> as backends, giving you TreeHaverâ€™s unified API, grammar discovery, and security features, plus full access to incremental parsing when using those backends.</p>

<p><strong>Note:</strong> <code>tree_stump</code> currently requires <a href="https://github.com/pboling/tree_stump/tree/tree_haver">pbolingâ€™s fork (tree_haver branch)</a> until upstream PRs <a href="https://github.com/joker1007/tree_stump/pull/5">#5</a>, <a href="https://github.com/joker1007/tree_stump/pull/7">#7</a>, <a href="https://github.com/joker1007/tree_stump/pull/11">#11</a>, and <a href="https://github.com/joker1007/tree_stump/pull/13">#13</a> are merged.</p>

<h4 id="when-to-use-each">When to Use Each</h4>

<p><strong>Choose TreeHaver when:</strong></p>

<ul>
  <li>You need JRuby or TruffleRuby support</li>
  <li>Youâ€™re building a library that should work across Ruby implementations</li>
  <li>You want automatic grammar discovery and security validations</li>
  <li>You want flexibility to switch backends without code changes</li>
  <li>You need incremental parsing with a unified API</li>
</ul>

<p><strong>Choose ruby_tree_sitter directly when:</strong></p>

<ul>
  <li>You only target MRI Ruby</li>
  <li>You need the full Query API without abstraction</li>
  <li>You want the most battle-tested C bindings</li>
  <li>You donâ€™t need TreeHaverâ€™s grammar discovery</li>
</ul>

<p><strong>Choose tree_stump directly when:</strong></p>

<ul>
  <li>You only target MRI Ruby</li>
  <li>You prefer Rust-based native extensions</li>
  <li>You want precompiled binaries without system dependencies</li>
  <li>You donâ€™t need TreeHaverâ€™s grammar discovery</li>
  <li>
<strong>Note:</strong> Use <a href="https://github.com/pboling/tree_stump/tree/tree_haver">pbolingâ€™s fork (tree_haver branch)</a> until PRs <a href="https://github.com/joker1007/tree_stump/pull/5">#5</a>, <a href="https://github.com/joker1007/tree_stump/pull/7">#7</a>, <a href="https://github.com/joker1007/tree_stump/pull/11">#11</a>, <a href="https://github.com/joker1007/tree_stump/pull/13">#13</a> are merged</li>
</ul>

<p><strong>Choose citrus directly when:</strong></p>

<ul>
  <li>You need zero native dependencies (pure Ruby)</li>
  <li>Youâ€™re using a Citrus grammar (not tree-sitter grammars)</li>
  <li>Performance is less critical than portability</li>
  <li>You donâ€™t need TreeHaverâ€™s unified API</li>
</ul>

<h2 id="-info-you-can-shake-a-stick-at">ğŸ’¡ Info you can shake a stick at</h2>

<table>
  <thead>
    <tr>
      <th>Tokens to Remember</th>
      <th>
<a href="https://bestgems.org/gems/tree_haver"><img src="https://img.shields.io/badge/name-tree__haver-3C2D2D.svg?style=square&amp;logo=rubygems&amp;logoColor=red" alt="Gem name"></a> <a href="https://github.com/kettle-rb/tree_haver"><img src="https://img.shields.io/badge/namespace-TreeHaver-3C2D2D.svg?style=square&amp;logo=ruby&amp;logoColor=white" alt="Gem namespace"></a>
</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Works with JRuby</td>
      <td>
<a href="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml"><img src="https://img.shields.io/badge/JRuby-current-FBE742?style=for-the-badge&amp;logo=ruby&amp;logoColor=green" alt="JRuby 10.0 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml"><img src="https://img.shields.io/badge/JRuby-HEAD-FBE742?style=for-the-badge&amp;logo=ruby&amp;logoColor=blue" alt="JRuby HEAD Compat"></a>
</td>
    </tr>
    <tr>
      <td>Works with Truffle Ruby</td>
      <td>
<a href="https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml"><img src="https://img.shields.io/badge/Truffle_Ruby-23.1-34BCB1?style=for-the-badge&amp;logo=ruby&amp;logoColor=pink" alt="Truffle Ruby 23.1 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml"><img src="https://img.shields.io/badge/Truffle_Ruby-current-34BCB1?style=for-the-badge&amp;logo=ruby&amp;logoColor=green" alt="Truffle Ruby 24.1 Compat"></a>
</td>
    </tr>
    <tr>
      <td>Works with MRI Ruby 3</td>
      <td>
<a href="https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml"><img src="https://img.shields.io/badge/Ruby-3.2-CC342D?style=for-the-badge&amp;logo=ruby&amp;logoColor=white" alt="Ruby 3.2 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml"><img src="https://img.shields.io/badge/Ruby-3.3-CC342D?style=for-the-badge&amp;logo=ruby&amp;logoColor=white" alt="Ruby 3.3 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml"><img src="https://img.shields.io/badge/Ruby-current-CC342D?style=for-the-badge&amp;logo=ruby&amp;logoColor=green" alt="Ruby 3.4 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml"><img src="https://img.shields.io/badge/Ruby-HEAD-CC342D?style=for-the-badge&amp;logo=ruby&amp;logoColor=blue" alt="Ruby HEAD Compat"></a>
</td>
    </tr>
    <tr>
      <td>Support &amp; Community</td>
      <td>
<a href="https://app.daily.dev/squads/rubyfriends"><img src="https://img.shields.io/badge/daily.dev-%F0%9F%92%8E_Ruby_Friends-0A0A0A?style=for-the-badge&amp;logo=dailydotdev&amp;logoColor=white" alt="Join Me on Daily.dev's RubyFriends"></a> <a href="https://discord.gg/3qme4XHNKN"><img src="https://img.shields.io/discord/1373797679469170758?style=for-the-badge&amp;logo=discord" alt="Live Chat on Discord"></a> <a href="https://www.upwork.com/freelancers/~014942e9b056abdf86?mp_source=share"><img src="https://img.shields.io/badge/UpWork-13544E?style=for-the-badge&amp;logo=Upwork&amp;logoColor=white" alt="Get help from me on Upwork"></a> <a href="https://www.codementor.io/peterboling?utm_source=github&amp;utm_medium=button&amp;utm_term=peterboling&amp;utm_campaign=github"><img src="https://img.shields.io/badge/CodeMentor-Get_Help-1abc9c?style=for-the-badge&amp;logo=CodeMentor&amp;logoColor=white" alt="Get help from me on Codementor"></a>
</td>
    </tr>
    <tr>
      <td>Source</td>
      <td>
<a href="https://gitlab.com/kettle-rb/tree_haver/"><img src="https://img.shields.io/badge/GitLab-FBA326?style=for-the-badge&amp;logo=Gitlab&amp;logoColor=orange" alt="Source on GitLab.com"></a> <a href="https://codeberg.org/kettle-rb/tree_haver"><img src="https://img.shields.io/badge/CodeBerg-4893CC?style=for-the-badge&amp;logo=CodeBerg&amp;logoColor=blue" alt="Source on CodeBerg.org"></a> <a href="https://github.com/kettle-rb/tree_haver"><img src="https://img.shields.io/badge/GitHub-238636?style=for-the-badge&amp;logo=Github&amp;logoColor=green" alt="Source on Github.com"></a> <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ"><img src="https://img.shields.io/badge/KLOC-0.726-FFDD67.svg?style=for-the-badge&amp;logo=YouTube&amp;logoColor=blue" alt="The best SHA: dQw4w9WgXcQ!"></a>
</td>
    </tr>
    <tr>
      <td>Documentation</td>
      <td>
<a href="http://rubydoc.info/gems/tree_haver"><img src="https://img.shields.io/badge/RubyDoc-Current_Release-943CD2?style=for-the-badge&amp;logo=readthedocs&amp;logoColor=white" alt="Current release on RubyDoc.info"></a> <a href="https://tree-haver.galtzo.com"><img src="https://img.shields.io/badge/YARD_on_Galtzo.com-HEAD-943CD2?style=for-the-badge&amp;logo=readthedocs&amp;logoColor=white" alt="YARD on Galtzo.com"></a> <a href="http://www.railsbling.com/tags/tree_haver"><img src="https://img.shields.io/badge/blog-railsbling-0093D0.svg?style=for-the-badge&amp;logo=rubyonrails&amp;logoColor=orange" alt="Maintainer Blog"></a> <a href="https://gitlab.com/kettle-rb/tree_haver/-/wikis/home"><img src="https://img.shields.io/badge/wiki-examples-943CD2.svg?style=for-the-badge&amp;logo=gitlab&amp;logoColor=white" alt="GitLab Wiki"></a> <a href="https://github.com/kettle-rb/tree_haver/wiki"><img src="https://img.shields.io/badge/wiki-examples-943CD2.svg?style=for-the-badge&amp;logo=github&amp;logoColor=white" alt="GitHub Wiki"></a>
</td>
    </tr>
    <tr>
      <td>Compliance</td>
      <td>
<a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-259D6C.svg" alt="License: MIT"></a> <a href="https://dev.to/galtzo/how-to-check-license-compatibility-41h0"><img src="https://img.shields.io/badge/Apache_Compatible:_Category_A-%E2%9C%93-259D6C.svg?style=flat&amp;logo=Apache" alt="Compatible with Apache Software Projects: Verified by SkyWalking Eyes"></a> <a href="https://www.ilo.org/declaration/lang--en/index.htm"><img src="https://img.shields.io/badge/ILO_Fundamental_Principles-%E2%9C%93-259D6C.svg?style=flat" alt="ğŸ“„ilo-declaration-img"></a> <a href="file.SECURITY.html" title="&lt;img src=&quot;https://img.shields.io/badge/security-policy-259D6C.svg?style=flat&quot; alt=&quot;Security Policy&quot;&gt;"><img src="https://img.shields.io/badge/security-policy-259D6C.svg?style=flat" alt="Security Policy"></a> <a href="file.CODE_OF_CONDUCT.html" title="&lt;img src=&quot;https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg&quot; alt=&quot;Contributor Covenant 2.1&quot;&gt;"><img src="https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg" alt="Contributor Covenant 2.1"></a> <a href="https://semver.org/spec/v2.0.0.html"><img src="https://img.shields.io/badge/semver-2.0.0-259D6C.svg?style=flat" alt="SemVer 2.0.0"></a>
</td>
    </tr>
    <tr>
      <td>Style</td>
      <td>
<a href="https://github.com/rubocop-lts/rubocop-lts"><img src="https://img.shields.io/badge/code_style_&amp;_linting-rubocop--lts-34495e.svg?plastic&amp;logo=ruby&amp;logoColor=white" alt="Enforced Code Style Linter"></a> <a href="https://keepachangelog.com/en/1.0.0/"><img src="https://img.shields.io/badge/keep--a--changelog-1.0.0-34495e.svg?style=flat" alt="Keep-A-Changelog 1.0.0"></a> <a href="https://gitmoji.dev"><img src="https://img.shields.io/badge/gitmoji_commits-%20%F0%9F%98%9C%20%F0%9F%98%8D-34495e.svg?style=flat-square" alt="Gitmoji Commits"></a> <a href="https://github.com/appraisal-rb/appraisal2"><img src="https://img.shields.io/badge/appraised_by-appraisal2-34495e.svg?plastic&amp;logo=ruby&amp;logoColor=white" alt="Compatibility appraised by: appraisal2"></a>
</td>
    </tr>
    <tr>
      <td>Maintainer ğŸ–ï¸</td>
      <td>
<a href="http://www.linkedin.com/in/peterboling"><img src="https://img.shields.io/badge/PeterBoling-LinkedIn-0B66C2?style=flat&amp;logo=newjapanprowrestling" alt="Follow Me on LinkedIn"></a> <a href="https://ruby.social/@galtzo"><img src="https://img.shields.io/mastodon/follow/109447111526622197?domain=https://ruby.social&amp;style=flat&amp;logo=mastodon&amp;label=Ruby%20@galtzo" alt="Follow Me on Ruby.Social"></a> <a href="https://bsky.app/profile/galtzo.com"><img src="https://img.shields.io/badge/@galtzo.com-0285FF?style=flat&amp;logo=bluesky&amp;logoColor=white" alt="Follow Me on Bluesky"></a> <a href="http://www.railsbling.com/contact"><img src="https://img.shields.io/badge/Contact-Maintainer-0093D0.svg?style=flat&amp;logo=rubyonrails&amp;logoColor=red" alt="Contact Maintainer"></a> <a href="https://dev.to/galtzo"><img src="https://img.shields.io/badge/dev.to-0A0A0A?style=flat&amp;logo=devdotto&amp;logoColor=white" alt="My technical writing"></a>
</td>
    </tr>
    <tr>
      <td>
<code>...</code> ğŸ’–</td>
      <td>
<a href="https://wellfound.com/u/peter-boling"><img src="https://img.shields.io/badge/peter--boling-orange?style=flat&amp;logo=wellfound" alt="Find Me on WellFound:"></a> <a href="https://www.crunchbase.com/person/peter-boling"><img src="https://img.shields.io/badge/peter--boling-purple?style=flat&amp;logo=crunchbase" alt="Find Me on CrunchBase"></a> <a href="https://linktr.ee/galtzo"><img src="https://img.shields.io/badge/galtzo-purple?style=flat&amp;logo=linktree" alt="My LinkTree"></a> <a href="https://about.me/peter.boling"><img src="https://img.shields.io/badge/about.me-0A0A0A?style=flat&amp;logo=aboutme&amp;logoColor=white" alt="More About Me"></a> <a href="https://codeberg.org/pboling">ğŸ§Š</a> <a href="https://github.org/pboling">ğŸ™</a> <a href="https://sr.ht/~galtzo/">ğŸ›–</a> <a href="https://gitlab.com/pboling">ğŸ§ª</a>
</td>
    </tr>
  </tbody>
</table>

<h3 id="compatibility">Compatibility</h3>

<p>Compatible with MRI Ruby 3.2.0+, and concordant releases of JRuby, and TruffleRuby.</p>

<table>
  <thead>
    <tr>
      <th>ğŸšš <em>Amazing</em> test matrix was brought to you by</th>
      <th>ğŸ” appraisal2 ğŸ” and the color ğŸ’š green ğŸ’š</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ğŸ‘Ÿ Check it out!</td>
      <td>âœ¨ <a href="https://github.com/appraisal-rb/appraisal2">github.com/appraisal-rb/appraisal2</a> âœ¨</td>
    </tr>
  </tbody>
</table>

<h3 id="federated-dvcs">Federated DVCS</h3>

<details>
  <summary>Find this repo on federated forges (Coming soon!)</summary>

  <table>
    <thead>
      <tr>
        <th>Federated <a href="https://railsbling.com/posts/dvcs/put_the_d_in_dvcs/">DVCS</a> Repository</th>
        <th>Status</th>
        <th>Issues</th>
        <th>PRs</th>
        <th>Wiki</th>
        <th>CI</th>
        <th>Discussions</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>ğŸ§ª <a href="https://gitlab.com/kettle-rb/tree_haver/">kettle-rb/tree_haver on GitLab</a>
</td>
        <td>The Truth</td>
        <td><a href="https://gitlab.com/kettle-rb/tree_haver/-/issues">ğŸ’š</a></td>
        <td><a href="https://gitlab.com/kettle-rb/tree_haver/-/merge_requests">ğŸ’š</a></td>
        <td><a href="https://gitlab.com/kettle-rb/tree_haver/-/wikis/home">ğŸ’š</a></td>
        <td>ğŸ­ Tiny Matrix</td>
        <td>â–</td>
      </tr>
      <tr>
        <td>ğŸ§Š <a href="https://codeberg.org/kettle-rb/tree_haver">kettle-rb/tree_haver on CodeBerg</a>
</td>
        <td>An Ethical Mirror (<a href="https://donate.codeberg.org/">Donate</a>)</td>
        <td><a href="https://codeberg.org/kettle-rb/tree_haver/issues">ğŸ’š</a></td>
        <td><a href="https://codeberg.org/kettle-rb/tree_haver/pulls">ğŸ’š</a></td>
        <td>â–</td>
        <td>â­•ï¸ No Matrix</td>
        <td>â–</td>
      </tr>
      <tr>
        <td>ğŸ™ <a href="https://github.com/kettle-rb/tree_haver">kettle-rb/tree_haver on GitHub</a>
</td>
        <td>Another Mirror</td>
        <td><a href="https://github.com/kettle-rb/tree_haver/issues">ğŸ’š</a></td>
        <td><a href="https://github.com/kettle-rb/tree_haver/pulls">ğŸ’š</a></td>
        <td><a href="https://github.com/kettle-rb/tree_haver/wiki">ğŸ’š</a></td>
        <td>ğŸ’¯ Full Matrix</td>
        <td><a href="https://github.com/kettle-rb/tree_haver/discussions">ğŸ’š</a></td>
      </tr>
      <tr>
        <td>ğŸ®ï¸ <a href="https://discord.gg/3qme4XHNKN">Discord Server</a>
</td>
        <td><a href="https://discord.gg/3qme4XHNKN"><img src="https://img.shields.io/discord/1373797679469170758?style=for-the-badge&amp;logo=discord" alt="Live Chat on Discord"></a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">Letâ€™s</a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">talk</a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">about</a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">this</a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">library!</a></td>
      </tr>
    </tbody>
  </table>

</details>

<h3 id="enterprise-support-">Enterprise Support <a href="https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&amp;utm_medium=referral&amp;utm_campaign=readme"><img src="https://tidelift.com/badges/package/rubygems/tree_haver" alt="Tidelift"></a>
</h3>

<p>Available as part of the Tidelift Subscription.</p>

<details>
  <summary>Need enterprise-level guarantees?</summary>

  <p>The maintainers of this and thousands of other packages are working with Tidelift to deliver commercial support and maintenance for the open source packages you use to build your applications. Save time, reduce risk, and improve code health, while paying the maintainers of the exact packages you use.</p>

  <p><a href="https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&amp;utm_medium=referral&amp;utm_campaign=readme"><img src="https://img.shields.io/badge/Tidelift_and_Sonar-Enterprise_Support-FD3456?style=for-the-badge&amp;logo=sonar&amp;logoColor=white" alt="Get help from me on Tidelift"></a></p>

  <ul>
    <li>ğŸ’¡Subscribe for support guarantees covering <em>all</em> your FLOSS dependencies</li>
    <li>ğŸ’¡Tidelift is part of <a href="https://blog.tidelift.com/tidelift-joins-sonar">Sonar</a>
</li>
    <li>ğŸ’¡Tidelift pays maintainers to maintain the software you depend on!<br>ğŸ“Š<code>@</code>Pointy Haired Boss: An <a href="https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&amp;utm_medium=referral&amp;utm_campaign=readme">enterprise support</a> subscription is â€œ<a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">never gonna let you down</a>â€, and <em>supports</em> open source maintainers</li>
  </ul>

  <p>Alternatively:</p>

  <ul>
    <li><a href="https://discord.gg/3qme4XHNKN"><img src="https://img.shields.io/discord/1373797679469170758?style=for-the-badge&amp;logo=discord" alt="Live Chat on Discord"></a></li>
    <li><a href="https://www.upwork.com/freelancers/~014942e9b056abdf86?mp_source=share"><img src="https://img.shields.io/badge/UpWork-13544E?style=for-the-badge&amp;logo=Upwork&amp;logoColor=white" alt="Get help from me on Upwork"></a></li>
    <li><a href="https://www.codementor.io/peterboling?utm_source=github&amp;utm_medium=button&amp;utm_term=peterboling&amp;utm_campaign=github"><img src="https://img.shields.io/badge/CodeMentor-Get_Help-1abc9c?style=for-the-badge&amp;logo=CodeMentor&amp;logoColor=white" alt="Get help from me on Codementor"></a></li>
  </ul>

</details>

<h2 id="-installation">âœ¨ Installation</h2>

<p>Install the gem and add to the applicationâ€™s Gemfile by executing:</p>

<pre class="code language-console"><code class="language-console">bundle add tree_haver
</code></pre>

<p>If bundler is not being used to manage dependencies, install the gem by executing:</p>

<pre class="code language-console"><code class="language-console">gem install tree_haver
</code></pre>

<h3 id="-secure-installation">ğŸ”’ Secure Installation</h3>

<details>
  <summary>For Medium or High Security Installations</summary>

  <p>This gem is cryptographically signed, and has verifiable <a href="https://gitlab.com/kettle-rb/tree_haver/-/tree/main/checksums">SHA-256 and SHA-512</a> checksums by
<a href="https://github.com/galtzo-floss/stone_checksums">stone_checksums</a>. Be sure the gem you install hasnâ€™t been tampered with
by following the instructions below.</p>

  <p>Add my public key (if you havenâ€™t already, expires 2045-04-29) as a trusted certificate:</p>

  <pre class="code language-console"><code class="language-console">gem cert --add &lt;(curl -Ls https://raw.github.com/galtzo-floss/certs/main/pboling.pem)
</code></pre>

  <p>You only need to do that once. Then proceed to install with:</p>

  <pre class="code language-console"><code class="language-console">gem install tree_haver -P HighSecurity
</code></pre>

  <p>The <code>HighSecurity</code> trust profile will verify signed gems, and not allow the installation of unsigned dependencies.</p>

  <p>If you want to up your security game full-time:</p>

  <pre class="code language-console"><code class="language-console">bundle config set --global trust-policy MediumSecurity
</code></pre>

  <p><code>MediumSecurity</code> instead of <code>HighSecurity</code> is necessary if not all the gems you use are signed.</p>

  <p>NOTE: Be prepared to track down certs for signed gems and add them the same way you added mine.</p>

</details>

<h2 id="ï¸-configuration">âš™ï¸ Configuration</h2>

<h3 id="security-considerations">Security Considerations</h3>

<p><strong>âš ï¸ Loading shared libraries (.so/.dylib/.dll) executes arbitrary native code.</strong></p>

<p>TreeHaver provides defense-in-depth validations, but you should understand the risks:</p>

<h4 id="attack-vectors-mitigated">Attack Vectors Mitigated</h4>

<p>TreeHaverâ€™s <code>PathValidator</code> module protects against:</p>

<ul>
  <li>
<strong>Path traversal</strong>: Paths containing <code>/../</code> or <code>/./</code> are rejected</li>
  <li>
<strong>Null byte injection</strong>: Paths containing null bytes are rejected</li>
  <li>
<strong>Non-absolute paths</strong>: Relative paths are rejected to prevent CWD-based attacks</li>
  <li>
<strong>Invalid extensions</strong>: Only <code>.so</code>, <code>.dylib</code>, and <code>.dll</code> files are accepted</li>
  <li>
<strong>Malicious filenames</strong>: Filenames must match a safe pattern (alphanumeric, hyphens, underscores)</li>
  <li>
<strong>Invalid language names</strong>: Language names must be lowercase alphanumeric with underscores</li>
  <li>
<strong>Invalid symbol names</strong>: Symbol names must be valid C identifiers</li>
</ul>

<h4 id="secure-usage">Secure Usage</h4>

<pre class="code language-ruby"><code class="language-ruby"># Standard usage - paths from ENV are validated
finder = TreeHaver::GrammarFinder.new(:toml)
path = finder.find_library_path  # Validates ENV path before returning

# Maximum security - only trusted system directories
path = finder.find_library_path_safe  # Ignores ENV, only /usr/lib etc.

# Manual validation
if TreeHaver::PathValidator.safe_library_path?(user_provided_path)
  language = TreeHaver::Language.from_library(user_provided_path)
end

# Get validation errors for debugging
errors = TreeHaver::PathValidator.validation_errors(path)
# =&gt; [&quot;Path is not absolute&quot;, &quot;Path contains traversal sequence&quot;]
</code></pre>

<h4 id="trusted-directories">Trusted Directories</h4>

<p>The <code>find_library_path_safe</code> method only returns paths in trusted directories.</p>

<p><strong>Default trusted directories:</strong></p>

<ul>
  <li>
<code>/usr/lib</code>, <code>/usr/lib64</code>
</li>
  <li>
<code>/usr/lib/x86_64-linux-gnu</code>, <code>/usr/lib/aarch64-linux-gnu</code>
</li>
  <li><code>/usr/local/lib</code></li>
  <li>
<code>/opt/homebrew/lib</code>, <code>/opt/local/lib</code>
</li>
</ul>

<p><strong>Adding custom trusted directories:</strong></p>

<p>For non-standard installations (Homebrew on Linux, luarocks, mise, asdf, etc.), register additional trusted directories:</p>

<pre class="code language-ruby"><code class="language-ruby"># Programmatically at application startup
TreeHaver::PathValidator.add_trusted_directory(&quot;/home/linuxbrew/.linuxbrew/Cellar&quot;)
TreeHaver::PathValidator.add_trusted_directory(&quot;~/.local/share/mise/installs/lua&quot;)

# Or via environment variable (comma-separated, in your shell profile)
export TREE_HAVER_TRUSTED_DIRS = &quot;/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua&quot;
</code></pre>

<p><strong>Example: Fedora Silverblue with Homebrew and luarocks</strong></p>

<pre class="code language-bash"><code class="language-bash"># In ~/.bashrc or ~/.zshrc
export TREE_HAVER_TRUSTED_DIRS=&quot;/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua&quot;

# tree-sitter runtime library
export TREE_SITTER_RUNTIME_LIB=/home/linuxbrew/.linuxbrew/Cellar/tree-sitter/0.26.3/lib/libtree-sitter.so

# Language grammar (luarocks-installed)
export TREE_SITTER_TOML_PATH=~/.local/share/mise/installs/lua/5.4.8/luarocks/lib/luarocks/rocks-5.4/tree-sitter-toml/0.0.31-1/parser/toml.so
</code></pre>

<h4 id="recommendations">Recommendations</h4>

<ol>
  <li>
<strong>Production</strong>: Consider using <code>find_library_path_safe</code> to ignore ENV overrides</li>
  <li>
<strong>Development</strong>: Standard <code>find_library_path</code> is convenient for testing</li>
  <li>
<strong>User Input</strong>: Always validate paths before passing to <code>Language.from_library</code>
</li>
  <li>
<strong>CI/CD</strong>: Be cautious of ENV vars that could be set by untrusted sources</li>
  <li>
<strong>Custom installs</strong>: Register trusted directories via <code>TREE_HAVER_TRUSTED_DIRS</code> or <code>add_trusted_directory</code>
</li>
</ol>

<h3 id="backend-selection">Backend Selection</h3>

<p>TreeHaver automatically selects the best backend for your Ruby implementation, but you can override this behavior:</p>

<pre class="code language-ruby"><code class="language-ruby"># Automatic backend selection (default)
TreeHaver.backend = :auto

# Force a specific backend
TreeHaver.backend = :mri     # Use ruby_tree_sitter (MRI only, C extension)
TreeHaver.backend = :rust    # Use tree_stump (MRI, Rust extension with precompiled binaries)
                             # Note: Requires pboling&#39;s fork until PRs #5, #7, #11, #13 are merged
                             # See: https://github.com/pboling/tree_stump/tree/tree_haver
TreeHaver.backend = :ffi     # Use FFI bindings (works on MRI and JRuby)
TreeHaver.backend = :java    # Use Java bindings (JRuby only, coming soon)
TreeHaver.backend = :citrus  # Use Citrus pure Ruby parser
                             # NOTE: Portable, all Ruby implementations
                             # CAVEAT: few major language grammars, but many esoteric grammars
</code></pre>

<p><strong>Auto-selection priority on MRI:</strong> MRI â†’ Rust â†’ FFI â†’ Citrus</p>

<p>You can also set the backend via environment variable:</p>

<pre class="code language-bash"><code class="language-bash">export TREE_HAVER_BACKEND=rust
</code></pre>

<h3 id="environment-variables">Environment Variables</h3>

<p>TreeHaver recognizes several environment variables for configuration:</p>

<p><strong>Note</strong>: All path-based environment variables are validated before use. Invalid paths are ignored.</p>

<h4 id="security-configuration">Security Configuration</h4>

<ul>
  <li>
    <p><strong><code>TREE_HAVER_TRUSTED_DIRS</code></strong>: Comma-separated list of additional trusted directories for grammar libraries</p>

    <pre class="code language-bash"><code class="language-bash"># For Homebrew on Linux and luarocks
export TREE_HAVER_TRUSTED_DIRS=&quot;/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua&quot;
</code></pre>

    <p>Tilde (<code>~</code>) is expanded to the userâ€™s home directory. Directories listed here are considered safe for <code>find_library_path_safe</code>.</p>
  </li>
</ul>

<h4 id="core-runtime-library">Core Runtime Library</h4>

<ul>
  <li>
<strong><code>TREE_SITTER_RUNTIME_LIB</code></strong>: Absolute path to the core <code>libtree-sitter</code> shared library
    <pre class="code language-bash"><code class="language-bash">export TREE_SITTER_RUNTIME_LIB=/usr/local/lib/libtree-sitter.so
</code></pre>
  </li>
</ul>

<p>If not set, TreeHaver tries these names in order:</p>

<ul>
  <li><code>tree-sitter</code></li>
  <li><code>libtree-sitter.so.0</code></li>
  <li><code>libtree-sitter.so</code></li>
  <li><code>libtree-sitter.dylib</code></li>
  <li><code>libtree-sitter.dll</code></li>
</ul>

<h4 id="language-symbol-resolution">Language Symbol Resolution</h4>

<p>When loading a language grammar, if you donâ€™t specify the <code>symbol:</code> parameter, TreeHaver resolves it in this precedence:</p>

<ol>
  <li>
<strong><code>TREE_SITTER_LANG_SYMBOL</code></strong>: Explicit symbol override</li>
  <li>Guessed from filename (e.g., <code>libtree-sitter-toml.so</code> â†’ <code>tree_sitter_toml</code>)</li>
  <li>Default fallback (<code>tree_sitter_toml</code>)</li>
</ol>

<pre class="code language-bash"><code class="language-bash">export TREE_SITTER_LANG_SYMBOL=tree_sitter_toml
</code></pre>

<h4 id="language-library-paths">Language Library Paths</h4>

<p>For specific languages, you can set environment variables to point to grammar libraries:</p>

<pre class="code language-bash"><code class="language-bash">export TREE_SITTER_TOML_PATH=/usr/local/lib/libtree-sitter-toml.so
export TREE_SITTER_JSON_PATH=/usr/local/lib/libtree-sitter-json.so
</code></pre>

<h4 id="jruby-specific-java-backend-jars">JRuby-Specific: Java Backend JARs</h4>

<p>For the Java backend on JRuby:</p>

<pre class="code language-bash"><code class="language-bash">export TREE_SITTER_JAVA_JARS_DIR=/path/to/java-tree-sitter/jars
</code></pre>

<h3 id="language-registration">Language Registration</h3>

<p>Register languages once at application startup for convenient access:</p>

<pre class="code language-ruby"><code class="language-ruby"># Register a TOML grammar
TreeHaver.register_language(
  :toml,
  path: &quot;/usr/local/lib/libtree-sitter-toml.so&quot;,
  symbol: &quot;tree_sitter_toml&quot;,  # optional, will be inferred if omitted
)

# Now you can use the convenient helper
language = TreeHaver::Language.toml

# Or still override path/symbol per-call
language = TreeHaver::Language.toml(
  path: &quot;/custom/path/libtree-sitter-toml.so&quot;,
)
</code></pre>

<h3 id="grammar-discovery-with-grammarfinder">Grammar Discovery with GrammarFinder</h3>

<p>For libraries that need to automatically locate tree-sitter grammars (like the <code>*-merge</code> family of gems), TreeHaver provides the <code>GrammarFinder</code> utility class. It handles platform-aware grammar discovery without requiring language-specific code in TreeHaver itself.</p>

<pre class="code language-ruby"><code class="language-ruby"># Create a finder for any language
finder = TreeHaver::GrammarFinder.new(:toml)

# Check if the grammar is available
if finder.available?
  puts &quot;TOML grammar found at: #{finder.find_library_path}&quot;
else
  puts finder.not_found_message
  # =&gt; &quot;tree-sitter toml grammar not found. Searched: /usr/lib/libtree-sitter-toml.so, ...&quot;
end

# Register the language if available
finder.register! if finder.available?

# Now use the registered language
language = TreeHaver::Language.toml
</code></pre>

<h4 id="grammarfinder-automatic-derivation">GrammarFinder Automatic Derivation</h4>

<p>Given just the language name, <code>GrammarFinder</code> automatically derives:</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Derived Value (for <code>:toml</code>)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ENV var</td>
      <td><code>TREE_SITTER_TOML_PATH</code></td>
    </tr>
    <tr>
      <td>Library filename</td>
      <td>
<code>libtree-sitter-toml.so</code> (Linux) or <code>.dylib</code> (macOS)</td>
    </tr>
    <tr>
      <td>Symbol name</td>
      <td><code>tree_sitter_toml</code></td>
    </tr>
  </tbody>
</table>

<h4 id="search-order">Search Order</h4>

<p><code>GrammarFinder</code> searches for grammars in this order:</p>

<ol>
  <li>
<strong>Environment variable</strong>: <code>TREE_SITTER_&lt;LANG&gt;_PATH</code> (highest priority)</li>
  <li>
<strong>Extra paths</strong>: Custom paths provided at initialization</li>
  <