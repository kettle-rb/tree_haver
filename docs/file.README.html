<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><table>
  <thead>
    <tr>
      <th>üìç NOTE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>RubyGems (the <a href="https://github.com/rubygems/">GitHub org</a>, not the website) <a href="https://joel.drapper.me/p/ruby-central-security-measures/">suffered</a> a <a href="https://pup-e.com/blog/goodbye-rubygems/">hostile takeover</a> in September 2025.</td>
    </tr>
    <tr>
      <td>Ultimately <a href="https://www.reddit.com/r/ruby/s/gOk42POCaV">4 maintainers</a> were <a href="https://bsky.app/profile/martinemde.com/post/3m3occezxxs2q">hard removed</a> and a reason has been given for only 1 of those, while 2 others resigned in protest.</td>
    </tr>
    <tr>
      <td>It is a <a href="https://joel.drapper.me/p/ruby-central-takeover/">complicated story</a> which is difficult to <a href="https://joel.drapper.me/p/ruby-central-fact-check/">parse quickly</a>.</td>
    </tr>
    <tr>
      <td>Simply put - there was active policy for adding or removing maintainers/owners of <a href="https://github.com/ruby/rubygems/blob/b1ab33a3d52310a84d16b193991af07f5a6a07c0/doc/rubygems/POLICIES.md?plain=1#L187-L196">rubygems</a> and <a href="https://github.com/ruby/rubygems/blob/b1ab33a3d52310a84d16b193991af07f5a6a07c0/doc/bundler/playbooks/TEAM_CHANGES.md">bundler</a>, and those <a href="https://www.reddit.com/r/ruby/comments/1ove9vp/rubycentral_hates_this_one_fact/">policies were not followed</a>.</td>
    </tr>
    <tr>
      <td>I‚Äôm adding notes like this to gems because I <a href="https://joel.drapper.me/p/ruby-central/">don‚Äôt condone theft</a> of repositories or gems from their rightful owners.</td>
    </tr>
    <tr>
      <td>If a similar theft happened with my repos/gems, I‚Äôd hope some would stand up for me.</td>
    </tr>
    <tr>
      <td>Disenfranchised former-maintainers have started <a href="https://gem.coop">gem.coop</a>.</td>
    </tr>
    <tr>
      <td>Once available I will publish there exclusively; unless RubyCentral makes amends with the community.</td>
    </tr>
    <tr>
      <td>The <a href="https://youtu.be/_H4qbtC5qzU?si=BvuBU90R2wAqD2E6">‚ÄúTechnology for Humans: Joel Draper‚Äù</a> podcast episode by <a href="https://reinteractive.com/ruby-on-rails">reinteractive</a> is the most cogent summary I‚Äôm aware of.</td>
    </tr>
    <tr>
      <td>See <a href="https://github.com/gem-coop/gem.coop/issues/12">here</a>, <a href="https://gem.coop">here</a> and <a href="https://martinemde.com/2025/10/05/announcing-gem-coop.html">here</a> for more info on what comes next.</td>
    </tr>
    <tr>
      <td>What I‚Äôm doing: A (WIP) proposal for <a href="https://github.com/galtzo-floss/bundle-namespace">bundler/gem scopes</a>, and a (WIP) proposal for a federated <a href="https://github.com/galtzo-floss/gem-server">gem server</a>.</td>
    </tr>
  </tbody>
</table>

<p><a href="https://discord.gg/3qme4XHNKN"><img src="https://logos.galtzo.com/assets/images/galtzo-floss/avatar-192px.svg" alt="Galtzo FLOSS Logo by Aboling0, CC BY-SA 4.0"></a> <a href="https://www.ruby-lang.org/"><img src="https://logos.galtzo.com/assets/images/ruby-lang/avatar-192px.svg" alt="ruby-lang Logo, Yukihiro Matsumoto, Ruby Visual Identity Team, CC BY-SA 2.5"></a> <a href="https://github.com/kettle-rb"><img src="https://logos.galtzo.com/assets/images/kettle-rb/avatar-192px.svg" alt="kettle-rb Logo by Aboling0, CC BY-SA 4.0"></a></p>

<h1 id="-treehaver">üå¥ TreeHaver</h1>

<p><a href="https://bestgems.org/gems/tree_haver"><img src="https://img.shields.io/gem/v/tree_haver.svg" alt="Version"></a> <a href="http://github.com/kettle-rb/tree_haver/releases"><img src="https://img.shields.io/github/tag/kettle-rb/tree_haver.svg" alt="GitHub tag (latest SemVer)"></a> <a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-259D6C.svg" alt="License: MIT"></a> <a href="https://bestgems.org/gems/tree_haver"><img src="https://img.shields.io/gem/rd/tree_haver.svg" alt="Downloads Rank"></a> <a href="https://www.codetriage.com/kettle-rb/tree_haver"><img src="https://www.codetriage.com/kettle-rb/tree_haver/badges/users.svg" alt="Open Source Helpers"></a> <a href="https://codecov.io/gh/kettle-rb/tree_haver"><img src="https://codecov.io/gh/kettle-rb/tree_haver/graph/badge.svg" alt="CodeCov Test Coverage"></a> <a href="https://coveralls.io/github/kettle-rb/tree_haver?branch=main"><img src="https://coveralls.io/repos/github/kettle-rb/tree_haver/badge.svg?branch=main" alt="Coveralls Test Coverage"></a> <a href="https://qlty.sh/gh/kettle-rb/projects/tree_haver/metrics/code?sort=coverageRating"><img src="https://qlty.sh/gh/kettle-rb/projects/tree_haver/coverage.svg" alt="QLTY Test Coverage"></a> <a href="https://qlty.sh/gh/kettle-rb/projects/tree_haver"><img src="https://qlty.sh/gh/kettle-rb/projects/tree_haver/maintainability.svg" alt="QLTY Maintainability"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml/badge.svg" alt="CI Heads"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/dep-heads.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/dep-heads.yml/badge.svg" alt="CI Runtime Dependencies @ HEAD"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml/badge.svg" alt="CI Current"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml/badge.svg" alt="CI Truffle Ruby"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/locked_deps.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/locked_deps.yml/badge.svg" alt="Deps Locked"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/unlocked_deps.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/unlocked_deps.yml/badge.svg" alt="Deps Unlocked"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml/badge.svg" alt="CI Supported"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/coverage.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/coverage.yml/badge.svg" alt="CI Test Coverage"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/style.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/style.yml/badge.svg" alt="CI Style"></a> <a href="https://github.com/kettle-rb/tree_haver/security/code-scanning"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/codeql-analysis.yml/badge.svg" alt="CodeQL"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/license-eye.yml"><img src="https://github.com/kettle-rb/tree_haver/actions/workflows/license-eye.yml/badge.svg" alt="Apache SkyWalking Eyes License Compatibility Check"></a></p>

<p><code>if ci_badges.map(&amp;:color).detect { it != "green"}</code> ‚òùÔ∏è <a href="https://discord.gg/3qme4XHNKN">let me know</a>, as I may have missed the <a href="https://discord.gg/3qme4XHNKN">discord notification</a>.</p>

<hr>
<p><code>if ci_badges.map(&amp;:color).all? { it == "green"}</code> üëáÔ∏è send money so I can do more of this. FLOSS maintenance is now my full-time job.</p>

<p><a href="https://opencollective.com/kettle-rb#backer"><img src="https://opencollective.com/kettle-rb/backers/badge.svg?style=flat" alt="OpenCollective Backers"></a> <a href="https://opencollective.com/kettle-rb#sponsor"><img src="https://opencollective.com/kettle-rb/sponsors/badge.svg?style=flat" alt="OpenCollective Sponsors"></a> <a href="https://github.com/sponsors/pboling"><img src="https://img.shields.io/badge/Sponsor_Me!-pboling.svg?style=social&amp;logo=github" alt="Sponsor Me on Github"></a> <a href="https://liberapay.com/pboling/donate"><img src="https://img.shields.io/liberapay/goal/pboling.svg?logo=liberapay&amp;color=a51611&amp;style=flat" alt="Liberapay Goal Progress"></a> <a href="https://www.paypal.com/paypalme/peterboling"><img src="https://img.shields.io/badge/donate-paypal-a51611.svg?style=flat&amp;logo=paypal" alt="Donate on PayPal"></a> <a href="https://www.buymeacoffee.com/pboling"><img src="https://img.shields.io/badge/buy_me_a_coffee-%E2%9C%93-a51611.svg?style=flat" alt="Buy me a coffee"></a> <a href="https://polar.sh/pboling"><img src="https://img.shields.io/badge/polar-donate-a51611.svg?style=flat" alt="Donate on Polar"></a> <a href="https://ko-fi.com/O5O86SNP4"><img src="https://img.shields.io/badge/ko--fi-%E2%9C%93-a51611.svg?style=flat" alt="Donate at ko-fi.com"></a></p>

<h2 id="-synopsis">üåª Synopsis</h2>

<p>TreeHaver is a cross-Ruby adapter for the <a href="https://tree-sitter.github.io/tree-sitter/">tree-sitter</a> and <a href="https://github.com/mjackson/citrus">Citrus</a> parsing libraries and other dedicated parsing tools that works seamlessly across MRI Ruby, JRuby, and TruffleRuby. It provides a unified API for parsing source code using grammars, regardless of your Ruby implementation.</p>

<h3 id="the-adapter-pattern-like-faraday-but-for-parsing">The Adapter Pattern: Like Faraday, but for Parsing</h3>

<p>If you‚Äôve used <a href="https://github.com/lostisland/faraday">Faraday</a>, <a href="https://github.com/intridea/multi_json">multi_json</a>, or <a href="https://github.com/sferik/multi_xml">multi_xml</a>, you‚Äôll feel right at home with TreeHaver. These gems share a common philosophy:</p>

<table>
  <thead>
    <tr>
      <th>Gem</th>
      <th>Unified API for</th>
      <th>Backend Examples</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Faraday</strong></td>
      <td>HTTP requests</td>
      <td>Net::HTTP, Typhoeus, Patron, Excon</td>
    </tr>
    <tr>
      <td><strong>multi_json</strong></td>
      <td>JSON parsing</td>
      <td>Oj, Yajl, JSON gem</td>
    </tr>
    <tr>
      <td><strong>multi_xml</strong></td>
      <td>XML parsing</td>
      <td>Nokogiri, LibXML, Ox</td>
    </tr>
    <tr>
      <td><strong>TreeHaver</strong></td>
      <td>Code parsing</td>
      <td>MRI, Rust, FFI, Java, Prism, Psych, Commonmarker, Markly, Citrus (&amp; Co.)</td>
    </tr>
  </tbody>
</table>

<p><strong>Write once, run anywhere.</strong></p>

<p><strong>Learn once, write anywhere.</strong></p>

<p>Just as Faraday lets you swap HTTP adapters without changing your code, TreeHaver lets you swap tree-sitter backends. Your parsing code remains the same whether you‚Äôre running on MRI with native C extensions, JRuby with FFI, or TruffleRuby.</p>

<pre class="code language-ruby"><code class="language-ruby"># Your code stays the same regardless of backend
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Language.from_library(&quot;/path/to/grammar.so&quot;)
tree = parser.parse(source_code)

# TreeHaver automatically picks the best available backend:
# - MRI: ruby_tree_sitter, tree_stump, ffi, prism, psych, commonmarker, markly, citrus
# - JRuby: ffi, java-tree-sitter (not a gem, but the jtreesitter maven package), prism, psych, commonmarker, markly, citrus
# - TruffleRuby: prism, psych, commonmarker, markly, citrus
#   (tree-sitter backends don&#39;t work on Truffleruby with ffi gem due to FFI STRUCT_BY_VALUE limitation)
</code></pre>

<h3 id="key-features">Key Features</h3>

<ul>
  <li>
<strong>Universal Ruby Support</strong>: Works on MRI Ruby, JRuby, and TruffleRuby</li>
  <li>
<strong>10 Parsing Backends</strong> - Choose the right backend for your needs:
    <ul>
      <li>
<strong>Tree-sitter Backends</strong> (high-performance, incremental parsing):
        <ul>
          <li>
<strong>MRI Backend</strong>: Leverages <a href="https://github.com/Faveod/ruby-tree-sitter"><code>ruby_tree_sitter</code></a> gem (C extension, fastest on MRI)</li>
          <li>
<strong>Rust Backend</strong>: Uses <a href="https://github.com/joker1007/tree_stump"><code>tree_stump</code></a> gem (Rust with precompiled binaries)
            <ul>
              <li>
<strong>Note</strong>: <code>tree_stump</code> currently requires unreleased fixes in the <code>main</code> branch.</li>
            </ul>
          </li>
          <li>
<strong>FFI Backend</strong>: Pure Ruby FFI bindings to <code>libtree-sitter</code> (JRuby only; TruffleRuby‚Äôs FFI doesn‚Äôt support tree-sitter‚Äôs struct-by-value returns)</li>
          <li>
<strong>Java Backend</strong>: Native Java integration for JRuby with <a href="https://github.com/tree-sitter/java-tree-sitter"><code>java-tree-sitter</code></a> / <a href="https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter"><code>jtreesitter</code></a> grammar JARs</li>
        </ul>
      </li>
      <li>
<strong>Language-Specific Backends</strong> (native parser integration):
        <ul>
          <li>
<strong>Prism Backend</strong>: Ruby‚Äôs official parser (<a href="https://github.com/ruby/prism">Prism</a>, stdlib in Ruby 3.4+)</li>
          <li>
<strong>Psych Backend</strong>: Ruby‚Äôs YAML parser (<a href="https://github.com/ruby/psych">Psych</a>, stdlib)</li>
          <li>
<strong>Commonmarker Backend</strong>: Fast Markdown parser (<a href="https://github.com/gjtorikian/commonmarker">Commonmarker</a>, comrak Rust)</li>
          <li>
<strong>Markly Backend</strong>: GitHub Flavored Markdown (<a href="https://github.com/ioquatix/markly">Markly</a>, cmark-gfm C)</li>
        </ul>
      </li>
      <li>
<strong>Pure Ruby Fallback</strong>:
        <ul>
          <li>
<strong>Citrus Backend</strong>: Pure Ruby parsing via <a href="https://github.com/mjackson/citrus"><code>citrus</code></a> (no native dependencies)</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<strong>Automatic Backend Selection</strong>: Intelligently selects the best backend for your Ruby implementation</li>
  <li>
<strong>Language Agnostic</strong>: Parse any language - Ruby, Markdown, YAML, JSON, Bash, TOML, JavaScript, etc.</li>
  <li>
<strong>Grammar Discovery</strong>: Built-in <code>GrammarFinder</code> utility for platform-aware grammar library discovery</li>
  <li>
<strong>Unified Position API</strong>: Consistent <code>start_line</code>, <code>end_line</code>, <code>source_position</code> across all backends</li>
  <li>
<strong>Thread-Safe</strong>: Built-in language registry with thread-safe caching</li>
  <li>
<strong>Minimal API Surface</strong>: Simple, focused API that covers the most common use cases
    <h3 id="backend-requirements">Backend Requirements</h3>
  </li>
</ul>

<p>TreeHaver has minimal dependencies and automatically selects the best backend for your Ruby implementation. Each backend has specific version requirements:</p>

<h4 id="mri-backend-ruby_tree_sitter-c-extensions">MRI Backend (ruby_tree_sitter, C extensions)</h4>

<p><strong>Requires <code>ruby_tree_sitter</code> v2.0+</strong></p>

<p>In ruby_tree_sitter v2.0, all TreeSitter exceptions were changed to inherit from <code>Exception</code> (not <code>StandardError</code>). This was an intentional breaking change made for thread-safety and signal handling reasons.</p>

<p><strong>Exception Mapping</strong>: TreeHaver catches <code>TreeSitter::TreeSitterError</code> and its subclasses, converting them to <code>TreeHaver::NotAvailable</code> while preserving the original error message. This provides a consistent exception API across all backends:</p>

<table>
  <thead>
    <tr>
      <th>ruby_tree_sitter Exception</th>
      <th>TreeHaver Exception</th>
      <th>When It Occurs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>TreeSitter::ParserNotFoundError</code></td>
      <td><code>TreeHaver::NotAvailable</code></td>
      <td>Parser library file cannot be loaded</td>
    </tr>
    <tr>
      <td><code>TreeSitter::LanguageLoadError</code></td>
      <td><code>TreeHaver::NotAvailable</code></td>
      <td>Language symbol loads but returns nothing</td>
    </tr>
    <tr>
      <td><code>TreeSitter::SymbolNotFoundError</code></td>
      <td><code>TreeHaver::NotAvailable</code></td>
      <td>Symbol not found in library</td>
    </tr>
    <tr>
      <td><code>TreeSitter::ParserVersionError</code></td>
      <td><code>TreeHaver::NotAvailable</code></td>
      <td>Parser version incompatible with tree-sitter</td>
    </tr>
    <tr>
      <td><code>TreeSitter::QueryCreationError</code></td>
      <td><code>TreeHaver::NotAvailable</code></td>
      <td>Query creation fails</td>
    </tr>
  </tbody>
</table>

<pre class="code language-ruby"><code class="language-ruby"># Add to your Gemfile for MRI backend
gem &quot;ruby_tree_sitter&quot;, &quot;~&gt; 2.0&quot;
</code></pre>

<h4 id="rust-backend-tree_stump">Rust Backend (tree_stump)</h4>

<p><strong>MRI Ruby only</strong> - Does not work on JRuby or TruffleRuby.</p>

<p>The Rust backend uses <a href="https://github.com/joker1007/tree_stump">tree_stump</a>, which is a Rust native extension built with <a href="https://github.com/matsadler/magnus">magnus</a> and <a href="https://github.com/oxidize-rb/rb-sys">rb-sys</a>. These libraries are only compatible with MRI Ruby‚Äôs C API.</p>

<ul>
  <li>
<strong>JRuby</strong>: Cannot load native <code>.so</code> extensions (runs on JVM)</li>
  <li>
<strong>TruffleRuby</strong>: magnus/rb-sys are incompatible with TruffleRuby‚Äôs C API emulation<br>
NOTE: <code>tree_stump</code> currently requires unreleased fixes in the <code>main</code> branch.<br>
<!-- end list -->
    <pre class="code language-ruby"><code class="language-ruby"># Add to your Gemfile for Rust backend (MRI only)
gem &quot;tree_stump&quot;, github: &quot;joker1007/tree_stump&quot;, branch: &quot;main&quot;
</code></pre>
  </li>
</ul>

<h4 id="ffi-backend">FFI Backend</h4>

<p><strong>MRI and JRuby only</strong> - Does not work on TruffleRuby.</p>

<p>Requires the <code>ffi</code> gem and a system installation of <code>libtree-sitter</code>.</p>

<ul>
  <li>
<strong>TruffleRuby</strong>: TruffleRuby‚Äôs FFI implementation doesn‚Äôt support <code>STRUCT_BY_VALUE</code> return types, which tree-sitter‚Äôs C API uses for functions like <code>ts_tree_root_node</code> and <code>ts_node_child</code>.<br>
<!-- end list -->
    <pre class="code language-ruby"><code class="language-ruby"># Add to your Gemfile for FFI backend (MRI and JRuby)
gem &quot;ffi&quot;, &quot;&gt;= 1.15&quot;, &quot;&lt; 2.0&quot;
</code></pre>
  </li>
</ul>

<pre class="code language-bash"><code class="language-bash"># Install libtree-sitter on your system:
# macOS
brew install tree-sitter

# Ubuntu/Debian
apt-get install libtree-sitter0 libtree-sitter-dev

# Fedora
dnf install tree-sitter tree-sitter-devel
</code></pre>

<h4 id="citrus-backend">Citrus Backend</h4>

<p>Pure Ruby parser with no native dependencies:</p>

<pre class="code language-ruby"><code class="language-ruby"># Add to your Gemfile for Citrus backend
gem &quot;citrus&quot;, &quot;~&gt; 3.0&quot;
</code></pre>

<h4 id="java-backend-jruby-only">Java Backend (JRuby only)</h4>

<p><strong>Requires jtreesitter &gt;= 0.26.0</strong> from Maven Central. Older versions are not supported due to breaking API changes.</p>

<pre class="code language-ruby"><code class="language-ruby"># No gem dependency - uses JRuby&#39;s built-in Java integration
# Download the JAR:
# curl -L -o jtreesitter-0.26.0.jar \
#   &quot;https://repo1.maven.org/maven2/io/github/tree-sitter/jtreesitter/0.26.0/jtreesitter-0.26.0.jar&quot;

# Set environment variable:
# export TREE_SITTER_JAVA_JARS_DIR=/path/to/jars
</code></pre>

<p><strong>Also requires</strong>:</p>
<ul>
  <li>Tree-sitter runtime library (<code>libtree-sitter.so</code>) version 0.26+ (must match jtreesitter version)</li>
  <li>Grammar <code>.so</code> files built against tree-sitter 0.26+ (or rebuilt with <code>tree-sitter generate</code>)
    <h3 id="backend-platform-compatibility">Backend Platform Compatibility</h3>
  </li>
</ul>

<p>Not all backends work on all Ruby platforms. Here‚Äôs a complete compatibility matrix:</p>

<table>
  <thead>
    <tr>
      <th>Backend</th>
      <th style="text-align: center">MRI</th>
      <th style="text-align: center">JRuby</th>
      <th style="text-align: center">TruffleRuby</th>
      <th style="text-align: center">API Complete</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
<strong>MRI</strong> (<a href="https://github.com/Faveod/ruby-tree-sitter">ruby_tree_sitter</a>)</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚úÖ</td>
      <td>C extension, MRI only</td>
    </tr>
    <tr>
      <td>
<strong>Rust</strong> (<a href="https://github.com/joker1007/tree_stump">tree_stump</a>)</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚úÖ</td>
      <td>magnus/rb-sys incompatible with non-MRI</td>
    </tr>
    <tr>
      <td><strong>FFI</strong></td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚ö†Ô∏è</td>
      <td>TruffleRuby FFI doesn‚Äôt support <code>STRUCT_BY_VALUE</code>
</td>
    </tr>
    <tr>
      <td>
<strong>Java</strong> (<a href="https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter">jtreesitter</a>)</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚úÖ</td>
      <td>JRuby only, requires jtreesitter &gt;= 0.26.0</td>
    </tr>
    <tr>
      <td><strong>Prism</strong></td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td>Ruby parsing, stdlib in Ruby 3.4+</td>
    </tr>
    <tr>
      <td><strong>Psych</strong></td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td>YAML parsing, stdlib</td>
    </tr>
    <tr>
      <td><strong>Citrus</strong></td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚ö†Ô∏è</td>
      <td>Pure Ruby, no native dependencies</td>
    </tr>
    <tr>
      <td><strong>Commonmarker</strong></td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚ùì</td>
      <td style="text-align: center">‚úÖ</td>
      <td>Rust extension for Markdown</td>
    </tr>
    <tr>
      <td><strong>Markly</strong></td>
      <td style="text-align: center">‚úÖ</td>
      <td style="text-align: center">‚ùå</td>
      <td style="text-align: center">‚ùì</td>
      <td style="text-align: center">‚úÖ</td>
      <td>C extension for Markdown</td>
    </tr>
  </tbody>
</table>

<p><strong>Legend</strong>: ‚úÖ = Works / Complete, ‚ùå = Does not work, ‚ùì = Untested, ‚ö†Ô∏è = Partial (some optional methods missing)</p>

<p><strong>API Complete</strong> indicates whether the backend implements all optional Node methods (<code>parent</code>, <code>next_sibling</code>, <code>prev_sibling</code>, <code>named?</code>, <code>missing?</code>, <code>text</code>, <code>child_by_field_name</code>). Backends marked ‚ö†Ô∏è work but may be missing some advanced traversal methods. Use <code>TreeHaver::BackendAPI.validate(backend_module)</code> to check specific backends.</p>

<h3 id="version-requirements-for-tree-sitter-backends">Version Requirements for Tree-Sitter Backends</h3>

<h4 id="tree-sitter-runtime-library">tree-sitter Runtime Library</h4>

<p>All tree-sitter backends (MRI, Rust, FFI, Java) require the tree-sitter runtime library. <strong>Version 0.26+ is required</strong> for the Java backend (to match jtreesitter 0.26.0). Other backends may work with 0.24+, but 0.26+ is recommended for consistency.</p>

<pre class="code language-bash"><code class="language-bash"># Check your tree-sitter version
tree-sitter --version  # Should be 0.26.0 or newer for Java backend

# macOS
brew install tree-sitter

# Ubuntu/Debian
apt-get install libtree-sitter0 libtree-sitter-dev

# Fedora
dnf install tree-sitter tree-sitter-devel
</code></pre>

<h4 id="jtreesitter-java-backend">jtreesitter (Java Backend)</h4>

<p><strong>The Java backend requires jtreesitter &gt;= 0.26.0.</strong> This version introduced breaking API changes:</p>

<ul>
  <li>
<code>Parser.parse()</code> returns <code>Optional&lt;Tree&gt;</code> instead of <code>Tree</code>
</li>
  <li>
<code>Tree.getRootNode()</code> returns <code>Node</code> directly (not <code>Optional&lt;Node&gt;</code>)</li>
  <li>
<code>Node.getChild()</code>, <code>getParent()</code>, <code>getNextSibling()</code>, <code>getPrevSibling()</code> return <code>Optional&lt;Node&gt;</code>
</li>
  <li>
<code>Language.load(name)</code> was removed; use <code>SymbolLookup</code> API instead<br>
Older versions of jtreesitter are <strong>NOT supported</strong>.<br>
<!-- end list --><br>
``` bash
    <h1 id="download-jtreesitter-0260-from-maven-central">Download jtreesitter 0.26.0 from Maven Central</h1>
    <p>curl -L -o jtreesitter-0.26.0.jar \<br>
  ‚Äúhttps://repo1.maven.org/maven2/io/github/tree-sitter/jtreesitter/0.26.0/jtreesitter-0.26.0.jar‚Äù</p>
  </li>
</ul>

<h1 id="or-use-the-provided-setup-script">Or use the provided setup script</h1>
<p>bin/setup-jtreesitter</p>
<pre class="code ruby"><code class="ruby">
Set the environment variable to point to your JAR directory:

``` bash
export TREE_SITTER_JAVA_JARS_DIR=/path/to/jars
</code></pre>

<h4 id="grammar-abi-compatibility">Grammar ABI Compatibility</h4>

<p><strong>CRITICAL</strong>: Grammars must be built against a compatible tree-sitter version.</p>

<p>Tree-sitter 0.24+ changed how language ABI versions are reported (from <code>ts_language_version()</code> to <code>ts_language_abi_version()</code>). For the Java backend with jtreesitter 0.26.0, grammars must be built against tree-sitter 0.26+. If you get errors like:</p>

<pre class="code ruby"><code class="ruby">Failed to load tree_sitter_toml
Version mismatch detected: The grammar was built against tree-sitter &lt; 0.26 You need to rebuild the grammar from source:
</code></pre>

<pre class="code language-bash"><code class="language-bash"># Use the provided build script
bin/build-grammar toml

# Or manually:
git clone https://github.com/tree-sitter-grammars/tree-sitter-toml
cd tree-sitter-toml
tree-sitter generate  # Regenerates parser.c for your tree-sitter version
cc -shared -fPIC -o libtree-sitter-toml.so src/parser.c src/scanner.c -I src
</code></pre>

<p><strong>Grammar sources for common languages:</strong></p>

<table>
  <thead>
    <tr>
      <th>Language</th>
      <th>Repository</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TOML</td>
      <td><a href="https://github.com/tree-sitter-grammars/tree-sitter-toml">tree-sitter-grammars/tree-sitter-toml</a></td>
    </tr>
    <tr>
      <td>JSON</td>
      <td><a href="https://github.com/tree-sitter/tree-sitter-json">tree-sitter/tree-sitter-json</a></td>
    </tr>
    <tr>
      <td>JSONC</td>
      <td><a href="https://gitlab.com/WhyNotHugo/tree-sitter-jsonc">WhyNotHugo/tree-sitter-jsonc</a></td>
    </tr>
    <tr>
      <td>Bash</td>
      <td><a href="https://github.com/tree-sitter/tree-sitter-bash">tree-sitter/tree-sitter-bash</a></td>
    </tr>
  </tbody>
</table>

<h4 id="truffleruby-limitations">TruffleRuby Limitations</h4>

<p>TruffleRuby has <strong>no working tree-sitter backend</strong>:</p>

<ul>
  <li>
<strong>FFI</strong>: TruffleRuby‚Äôs FFI doesn‚Äôt support <code>STRUCT_BY_VALUE</code> return types (used by <code>ts_tree_root_node</code>, <code>ts_node_child</code>, etc.)</li>
  <li>
<strong>MRI/Rust</strong>: C and Rust extensions require MRI‚Äôs C API internals (<code>RBasic.flags</code>, <code>rb_gc_writebarrier</code>, etc.) that TruffleRuby doesn‚Äôt expose<br>
TruffleRuby users should use: <strong>Prism</strong> (Ruby), <strong>Psych</strong> (YAML), <strong>Citrus</strong> (TOML via toml-rb), or potentially <strong>Commonmarker/Markly</strong> (Markdown).
    <h4 id="jruby-limitations">JRuby Limitations</h4>
  </li>
</ul>

<p>JRuby runs on the JVM and <strong>cannot load native <code>.so</code> extensions via Ruby‚Äôs C API</strong>:</p>

<ul>
  <li>
<strong>MRI/Rust</strong>: C and Rust extensions simply cannot be loaded</li>
  <li>
<strong>FFI</strong>: Works! JRuby has excellent FFI support</li>
  <li>
<strong>Java</strong>: Works! The Java backend uses jtreesitter (requires &gt;= 0.26.0)<br>
JRuby users should use: <strong>Java backend</strong> (best performance, full API) or <strong>FFI backend</strong> for tree-sitter, plus <strong>Prism</strong>, <strong>Psych</strong>, <strong>Citrus</strong> for other formats.<br>
<a href="https://github.com/Faveod/ruby-tree-sitter">ruby_tree_sitter</a>: https://github.com/Faveod/ruby-tree-sitter<br>
<a href="https://github.com/joker1007/tree_stump">tree_stump</a>: https://github.com/joker1007/tree_stump<br>
[jtreesitter]: https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter
    <h3 id="why-treehaver">Why TreeHaver?</h3>
  </li>
</ul>

<p>tree-sitter is a powerful parser generator that creates incremental parsers for many programming languages. However, integrating it into Ruby applications can be challenging:</p>

<ul>
  <li>MRI-based C extensions don‚Äôt work on JRuby</li>
  <li>FFI-based solutions may not be optimal for MRI</li>
  <li>Managing different backends for different Ruby implementations is cumbersome<br>
TreeHaver solves these problems by providing a unified API that automatically selects the appropriate backend for your Ruby implementation, allowing you to write code once and run it anywhere.</li>
</ul>

<h3 id="the--merge-gem-family">The <code>*-merge</code> Gem Family</h3>

<p>The <code>*-merge</code> gem family provides intelligent, AST-based merging for various file formats. At the foundation is <a href="https://github.com/kettle-rb/tree_haver">tree_haver</a>, which provides a unified cross-Ruby parsing API that works seamlessly across MRI, JRuby, and TruffleRuby.</p>

<table>
  <thead>
    <tr>
      <th>Gem</th>
      <th>Language<br>/ Format</th>
      <th>Parser Backend(s)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/kettle-rb/tree_haver">tree_haver</a></td>
      <td>Multi</td>
      <td>MRI C, Rust, FFI, Java, Prism, Psych, Commonmarker, Markly, Citrus</td>
      <td>
<strong>Foundation</strong>: Cross-Ruby adapter for parsing libraries (like Faraday for HTTP)</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/ast-merge">ast-merge</a></td>
      <td>Text</td>
      <td>internal</td>
      <td>
<strong>Infrastructure</strong>: Shared base classes and merge logic for all <code>*-merge</code> gems</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/bash-merge">bash-merge</a></td>
      <td>Bash</td>
      <td>
<a href="https://github.com/tree-sitter/tree-sitter-bash">tree-sitter-bash</a> (via tree_haver)</td>
      <td>Smart merge for Bash scripts</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/commonmarker-merge">commonmarker-merge</a></td>
      <td>Markdown</td>
      <td>
<a href="https://github.com/gjtorikian/commonmarker">Commonmarker</a> (via tree_haver)</td>
      <td>Smart merge for Markdown (CommonMark via comrak Rust)</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/dotenv-merge">dotenv-merge</a></td>
      <td>Dotenv</td>
      <td>internal</td>
      <td>Smart merge for <code>.env</code> files</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/json-merge">json-merge</a></td>
      <td>JSON</td>
      <td>
<a href="https://github.com/tree-sitter/tree-sitter-json">tree-sitter-json</a> (via tree_haver)</td>
      <td>Smart merge for JSON files</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/jsonc-merge">jsonc-merge</a></td>
      <td>JSONC</td>
      <td>
<a href="https://gitlab.com/WhyNotHugo/tree-sitter-jsonc">tree-sitter-jsonc</a> (via tree_haver)</td>
      <td>‚ö†Ô∏è Proof of concept; Smart merge for JSON with Comments</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/markdown-merge">markdown-merge</a></td>
      <td>Markdown</td>
      <td>
<a href="https://github.com/gjtorikian/commonmarker">Commonmarker</a> / <a href="https://github.com/ioquatix/markly">Markly</a> (via tree_haver)</td>
      <td>
<strong>Foundation</strong>: Shared base for Markdown mergers with inner code block merging</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/markly-merge">markly-merge</a></td>
      <td>Markdown</td>
      <td>
<a href="https://github.com/ioquatix/markly">Markly</a> (via tree_haver)</td>
      <td>Smart merge for Markdown (CommonMark via cmark-gfm C)</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/prism-merge">prism-merge</a></td>
      <td>Ruby</td>
      <td>
<a href="https://github.com/ruby/prism">Prism</a> (<code>prism</code> std lib gem)</td>
      <td>Smart merge for Ruby source files</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/psych-merge">psych-merge</a></td>
      <td>YAML</td>
      <td>
<a href="https://github.com/ruby/psych">Psych</a> (<code>psych</code> std lib gem)</td>
      <td>Smart merge for YAML files</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/rbs-merge">rbs-merge</a></td>
      <td>RBS</td>
      <td>[tree-sitter-bash][ts-rbs] (via tree_haver), <a href="https://github.com/ruby/rbs">RBS</a> (<code>rbs</code> std lib gem)</td>
      <td>Smart merge for Ruby type signatures</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/toml-merge">toml-merge</a></td>
      <td>TOML</td>
      <td>
<a href="https://github.com/emancu/toml-rb">Citrus + toml-rb</a> (default, via tree_haver), <a href="https://github.com/tree-sitter-grammars/tree-sitter-toml">tree-sitter-toml</a> (via tree_haver)</td>
      <td>Smart merge for TOML files</td>
    </tr>
  </tbody>
</table>

<p><strong>Example implementations</strong> for the gem templating use case:</p>

<table>
  <thead>
    <tr>
      <th>Gem</th>
      <th>Purpose</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/kettle-rb/kettle-dev">kettle-dev</a></td>
      <td>Gem Development</td>
      <td>Gem templating tool using <code>*-merge</code> gems</td>
    </tr>
    <tr>
      <td><a href="https://github.com/kettle-rb/kettle-jem">kettle-jem</a></td>
      <td>Gem Templating</td>
      <td>Gem template library with smart merge support</td>
    </tr>
  </tbody>
</table>

<h3 id="comparison-with-other-ruby-ast--parser-bindings">Comparison with Other Ruby AST / Parser Bindings</h3>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>
<a href="https://github.com/kettle-rb/tree_haver">tree_haver</a> (this gem)</th>
      <th><a href="https://github.com/Faveod/ruby-tree-sitter">ruby_tree_sitter</a></th>
      <th><a href="https://github.com/joker1007/tree_stump">tree_stump</a></th>
      <th><a href="https://github.com/mjackson/citrus">citrus</a></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>MRI Ruby</strong></td>
      <td>‚úÖ Yes</td>
      <td>‚úÖ Yes</td>
      <td>‚úÖ Yes</td>
      <td>‚úÖ Yes</td>
    </tr>
    <tr>
      <td><strong>JRuby</strong></td>
      <td>‚úÖ Yes (FFI, Java, or Citrus backend)</td>
      <td>‚ùå No</td>
      <td>‚ùå No</td>
      <td>‚úÖ Yes</td>
    </tr>
    <tr>
      <td><strong>TruffleRuby</strong></td>
      <td>‚úÖ Yes (FFI or Citrus)</td>
      <td>‚ùå No</td>
      <td>‚ùì Unknown</td>
      <td>‚úÖ Yes</td>
    </tr>
    <tr>
      <td><strong>Backend</strong></td>
      <td>Multi (MRI C, Rust, FFI, Java, Citrus)</td>
      <td>C extension only</td>
      <td>Rust extension</td>
      <td>Pure Ruby</td>
    </tr>
    <tr>
      <td><strong>Incremental Parsing</strong></td>
      <td>‚úÖ Via MRI C/Rust/Java backend</td>
      <td>‚úÖ Yes</td>
      <td>‚úÖ Yes</td>
      <td>‚ùå No</td>
    </tr>
    <tr>
      <td><strong>Query API</strong></td>
      <td>‚ö° Via MRI/Rust/Java backend</td>
      <td>‚úÖ Yes</td>
      <td>‚úÖ Yes</td>
      <td>‚ùå No</td>
    </tr>
    <tr>
      <td><strong>Grammar Discovery</strong></td>
      <td>‚úÖ Built-in <code>GrammarFinder</code>
</td>
      <td>‚ùå Manual</td>
      <td>‚ùå Manual</td>
      <td>‚ùå Manual</td>
    </tr>
    <tr>
      <td><strong>Security Validations</strong></td>
      <td>‚úÖ <code>PathValidator</code>
</td>
      <td>‚ùå No</td>
      <td>‚ùå No</td>
      <td>‚ùå No</td>
    </tr>
    <tr>
      <td><strong>Language Registration</strong></td>
      <td>‚úÖ Thread-safe registry</td>
      <td>‚ùå No</td>
      <td>‚ùå No</td>
      <td>‚ùå No</td>
    </tr>
    <tr>
      <td><strong>Native Performance</strong></td>
      <td>‚ö° Backend-dependent</td>
      <td>‚úÖ Native C</td>
      <td>‚úÖ Native Rust</td>
      <td>‚ùå Pure Ruby</td>
    </tr>
    <tr>
      <td><strong>Precompiled Binaries</strong></td>
      <td>‚ö° Via Rust backend</td>
      <td>‚úÖ Yes</td>
      <td>‚úÖ Yes</td>
      <td>‚úÖ Pure Ruby</td>
    </tr>
    <tr>
      <td><strong>Zero Native Deps</strong></td>
      <td>‚ö° Via Citrus backend</td>
      <td>‚ùå No</td>
      <td>‚ùå No</td>
      <td>‚úÖ Yes</td>
    </tr>
    <tr>
      <td><strong>Minimum Ruby</strong></td>
      <td>3.2+</td>
      <td>3.0+</td>
      <td>3.1+</td>
      <td>0+</td>
    </tr>
  </tbody>
</table>

<p><strong>Note:</strong> Java backend works with grammar <code>.so</code> files built against tree-sitter 0.24+. The grammars must be rebuilt with <code>tree-sitter generate</code> if they were compiled against older tree-sitter versions. FFI is recommended for JRuby as it‚Äôs easier to set up.</p>

<p><strong>Note:</strong> TreeHaver can use <code>ruby_tree_sitter</code> (MRI) or <code>tree_stump</code> (MRI) as backends, or <code>java-tree-sitter</code> / <code>jtreesitter</code> &gt;= 0.26.0 (<a href="https://tree-sitter.github.io/java-tree-sitter/">docs</a>, <a href="https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter">maven</a>, <a href="https://github.com/tree-sitter/java-tree-sitter">source</a>, JRuby), or FFI on any backend, giving you TreeHaver‚Äôs unified API, grammar discovery, and security features, plus full access to incremental parsing when using those backends.</p>

<p><strong>Note:</strong> <code>tree_stump</code> currently requires unreleased fixes in the <code>main</code> branch.</p>

<h4 id="when-to-use-each">When to Use Each</h4>

<p><strong>Choose TreeHaver when:</strong></p>

<ul>
  <li>
    <p>You need JRuby or TruffleRuby support</p>
  </li>
  <li>
    <p>You‚Äôre building a library that should work across Ruby implementations</p>
  </li>
  <li>
    <p>You want automatic grammar discovery and security validations</p>
  </li>
  <li>
    <p>You want flexibility to switch backends without code changes</p>
  </li>
  <li>
    <p>You need incremental parsing with a unified API<br>
<strong>Choose ruby_tree_sitter directly when:</strong></p>
  </li>
  <li>
    <p>You only target MRI Ruby</p>
  </li>
  <li>
    <p>You need the full Query API without abstraction</p>
  </li>
  <li>
    <p>You want the most battle-tested C bindings</p>
  </li>
  <li>
    <p>You don‚Äôt need TreeHaver‚Äôs grammar discovery<br>
<strong>Choose tree_stump directly when:</strong></p>
  </li>
  <li>
    <p>You only target MRI Ruby</p>
  </li>
  <li>
    <p>You prefer Rust-based native extensions</p>
  </li>
  <li>
    <p>You want precompiled binaries without system dependencies</p>
  </li>
  <li>
    <p>You don‚Äôt need TreeHaver‚Äôs grammar discovery</p>
  </li>
  <li>
    <p><strong>Note:</strong> <code>tree_stump</code> currently requires unreleased fixes in the <code>main</code> branch.<br>
<strong>Choose citrus directly when:</strong></p>
  </li>
  <li>
    <p>You need zero native dependencies (pure Ruby)</p>
  </li>
  <li>
    <p>You‚Äôre using a Citrus grammar (not tree-sitter grammars)</p>
  </li>
  <li>
    <p>Performance is less critical than portability</p>
  </li>
  <li>
    <p>You don‚Äôt need TreeHaver‚Äôs unified API</p>
    <h2 id="-info-you-can-shake-a-stick-at">üí° Info you can shake a stick at</h2>
  </li>
</ul>

<table>
  <thead>
    <tr>
      <th>Tokens to Remember</th>
      <th>
<a href="https://bestgems.org/gems/tree_haver"><img src="https://img.shields.io/badge/name-tree__haver-3C2D2D.svg?style=square&amp;logo=rubygems&amp;logoColor=red" alt="Gem name"></a> <a href="https://github.com/kettle-rb/tree_haver"><img src="https://img.shields.io/badge/namespace-TreeHaver-3C2D2D.svg?style=square&amp;logo=ruby&amp;logoColor=white" alt="Gem namespace"></a>
</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Works with JRuby</td>
      <td>
<a href="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml"><img src="https://img.shields.io/badge/JRuby-current-FBE742?style=for-the-badge&amp;logo=ruby&amp;logoColor=green" alt="JRuby 10.0 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml"><img src="https://img.shields.io/badge/JRuby-HEAD-FBE742?style=for-the-badge&amp;logo=ruby&amp;logoColor=blue" alt="JRuby HEAD Compat"></a>
</td>
    </tr>
    <tr>
      <td>Works with Truffle Ruby</td>
      <td>
<a href="https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml"><img src="https://img.shields.io/badge/Truffle_Ruby-23.1-34BCB1?style=for-the-badge&amp;logo=ruby&amp;logoColor=pink" alt="Truffle Ruby 23.1 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml"><img src="https://img.shields.io/badge/Truffle_Ruby-current-34BCB1?style=for-the-badge&amp;logo=ruby&amp;logoColor=green" alt="Truffle Ruby 24.1 Compat"></a>
</td>
    </tr>
    <tr>
      <td>Works with MRI Ruby 3</td>
      <td>
<a href="https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml"><img src="https://img.shields.io/badge/Ruby-3.2-CC342D?style=for-the-badge&amp;logo=ruby&amp;logoColor=white" alt="Ruby 3.2 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml"><img src="https://img.shields.io/badge/Ruby-3.3-CC342D?style=for-the-badge&amp;logo=ruby&amp;logoColor=white" alt="Ruby 3.3 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml"><img src="https://img.shields.io/badge/Ruby-current-CC342D?style=for-the-badge&amp;logo=ruby&amp;logoColor=green" alt="Ruby 3.4 Compat"></a> <a href="https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml"><img src="https://img.shields.io/badge/Ruby-HEAD-CC342D?style=for-the-badge&amp;logo=ruby&amp;logoColor=blue" alt="Ruby HEAD Compat"></a>
</td>
    </tr>
    <tr>
      <td>Support &amp; Community</td>
      <td>
<a href="https://app.daily.dev/squads/rubyfriends"><img src="https://img.shields.io/badge/daily.dev-%F0%9F%92%8E_Ruby_Friends-0A0A0A?style=for-the-badge&amp;logo=dailydotdev&amp;logoColor=white" alt="Join Me on Daily.dev's RubyFriends"></a> <a href="https://discord.gg/3qme4XHNKN"><img src="https://img.shields.io/discord/1373797679469170758?style=for-the-badge&amp;logo=discord" alt="Live Chat on Discord"></a> <a href="https://www.upwork.com/freelancers/~014942e9b056abdf86?mp_source=share"><img src="https://img.shields.io/badge/UpWork-13544E?style=for-the-badge&amp;logo=Upwork&amp;logoColor=white" alt="Get help from me on Upwork"></a> <a href="https://www.codementor.io/peterboling?utm_source=github&amp;utm_medium=button&amp;utm_term=peterboling&amp;utm_campaign=github"><img src="https://img.shields.io/badge/CodeMentor-Get_Help-1abc9c?style=for-the-badge&amp;logo=CodeMentor&amp;logoColor=white" alt="Get help from me on Codementor"></a>
</td>
    </tr>
    <tr>
      <td>Source</td>
      <td>
<a href="https://gitlab.com/kettle-rb/tree_haver/"><img src="https://img.shields.io/badge/GitLab-FBA326?style=for-the-badge&amp;logo=Gitlab&amp;logoColor=orange" alt="Source on GitLab.com"></a> <a href="https://codeberg.org/kettle-rb/tree_haver"><img src="https://img.shields.io/badge/CodeBerg-4893CC?style=for-the-badge&amp;logo=CodeBerg&amp;logoColor=blue" alt="Source on CodeBerg.org"></a> <a href="https://github.com/kettle-rb/tree_haver"><img src="https://img.shields.io/badge/GitHub-238636?style=for-the-badge&amp;logo=Github&amp;logoColor=green" alt="Source on Github.com"></a> <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ"><img src="https://img.shields.io/badge/KLOC-2.484-FFDD67.svg?style=for-the-badge&amp;logo=YouTube&amp;logoColor=blue" alt="The best SHA: dQw4w9WgXcQ!"></a>
</td>
    </tr>
    <tr>
      <td>Documentation</td>
      <td>
<a href="http://rubydoc.info/gems/tree_haver"><img src="https://img.shields.io/badge/RubyDoc-Current_Release-943CD2?style=for-the-badge&amp;logo=readthedocs&amp;logoColor=white" alt="Current release on RubyDoc.info"></a> <a href="https://tree-haver.galtzo.com"><img src="https://img.shields.io/badge/YARD_on_Galtzo.com-HEAD-943CD2?style=for-the-badge&amp;logo=readthedocs&amp;logoColor=white" alt="YARD on Galtzo.com"></a> <a href="http://www.railsbling.com/tags/tree_haver"><img src="https://img.shields.io/badge/blog-railsbling-0093D0.svg?style=for-the-badge&amp;logo=rubyonrails&amp;logoColor=orange" alt="Maintainer Blog"></a> <a href="https://gitlab.com/kettle-rb/tree_haver/-/wikis/home"><img src="https://img.shields.io/badge/wiki-examples-943CD2.svg?style=for-the-badge&amp;logo=gitlab&amp;logoColor=white" alt="GitLab Wiki"></a> <a href="https://github.com/kettle-rb/tree_haver/wiki"><img src="https://img.shields.io/badge/wiki-examples-943CD2.svg?style=for-the-badge&amp;logo=github&amp;logoColor=white" alt="GitHub Wiki"></a>
</td>
    </tr>
    <tr>
      <td>Compliance</td>
      <td>
<a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-259D6C.svg" alt="License: MIT"></a> <a href="https://dev.to/galtzo/how-to-check-license-compatibility-41h0"><img src="https://img.shields.io/badge/Apache_Compatible:_Category_A-%E2%9C%93-259D6C.svg?style=flat&amp;logo=Apache" alt="Compatible with Apache Software Projects: Verified by SkyWalking Eyes"></a> <a href="https://www.ilo.org/declaration/lang--en/index.htm"><img src="https://img.shields.io/badge/ILO_Fundamental_Principles-%E2%9C%93-259D6C.svg?style=flat" alt="üìÑilo-declaration-img"></a> <a href="file.SECURITY.html" title="&lt;img src=&quot;https://img.shields.io/badge/security-policy-259D6C.svg?style=flat&quot; alt=&quot;Security Policy&quot;&gt;"><img src="https://img.shields.io/badge/security-policy-259D6C.svg?style=flat" alt="Security Policy"></a> <a href="file.CODE_OF_CONDUCT.html" title="&lt;img src=&quot;https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg&quot; alt=&quot;Contributor Covenant 2.1&quot;&gt;"><img src="https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg" alt="Contributor Covenant 2.1"></a> <a href="https://semver.org/spec/v2.0.0.html"><img src="https://img.shields.io/badge/semver-2.0.0-259D6C.svg?style=flat" alt="SemVer 2.0.0"></a>
</td>
    </tr>
    <tr>
      <td>Style</td>
      <td>
<a href="https://github.com/rubocop-lts/rubocop-lts"><img src="https://img.shields.io/badge/code_style_&amp;_linting-rubocop--lts-34495e.svg?plastic&amp;logo=ruby&amp;logoColor=white" alt="Enforced Code Style Linter"></a> <a href="https://keepachangelog.com/en/1.0.0/"><img src="https://img.shields.io/badge/keep--a--changelog-1.0.0-34495e.svg?style=flat" alt="Keep-A-Changelog 1.0.0"></a> <a href="https://gitmoji.dev"><img src="https://img.shields.io/badge/gitmoji_commits-%20%F0%9F%98%9C%20%F0%9F%98%8D-34495e.svg?style=flat-square" alt="Gitmoji Commits"></a> <a href="https://github.com/appraisal-rb/appraisal2"><img src="https://img.shields.io/badge/appraised_by-appraisal2-34495e.svg?plastic&amp;logo=ruby&amp;logoColor=white" alt="Compatibility appraised by: appraisal2"></a>
</td>
    </tr>
    <tr>
      <td>Maintainer üéñÔ∏è</td>
      <td>
<a href="http://www.linkedin.com/in/peterboling"><img src="https://img.shields.io/badge/PeterBoling-LinkedIn-0B66C2?style=flat&amp;logo=newjapanprowrestling" alt="Follow Me on LinkedIn"></a> <a href="https://ruby.social/@galtzo"><img src="https://img.shields.io/mastodon/follow/109447111526622197?domain=https://ruby.social&amp;style=flat&amp;logo=mastodon&amp;label=Ruby%20@galtzo" alt="Follow Me on Ruby.Social"></a> <a href="https://bsky.app/profile/galtzo.com"><img src="https://img.shields.io/badge/@galtzo.com-0285FF?style=flat&amp;logo=bluesky&amp;logoColor=white" alt="Follow Me on Bluesky"></a> <a href="http://www.railsbling.com/contact"><img src="https://img.shields.io/badge/Contact-Maintainer-0093D0.svg?style=flat&amp;logo=rubyonrails&amp;logoColor=red" alt="Contact Maintainer"></a> <a href="https://dev.to/galtzo"><img src="https://img.shields.io/badge/dev.to-0A0A0A?style=flat&amp;logo=devdotto&amp;logoColor=white" alt="My technical writing"></a>
</td>
    </tr>
    <tr>
      <td>
<code>...</code> üíñ</td>
      <td>
<a href="https://wellfound.com/u/peter-boling"><img src="https://img.shields.io/badge/peter--boling-orange?style=flat&amp;logo=wellfound" alt="Find Me on WellFound:"></a> <a href="https://www.crunchbase.com/person/peter-boling"><img src="https://img.shields.io/badge/peter--boling-purple?style=flat&amp;logo=crunchbase" alt="Find Me on CrunchBase"></a> <a href="https://linktr.ee/galtzo"><img src="https://img.shields.io/badge/galtzo-purple?style=flat&amp;logo=linktree" alt="My LinkTree"></a> <a href="https://about.me/peter.boling"><img src="https://img.shields.io/badge/about.me-0A0A0A?style=flat&amp;logo=aboutme&amp;logoColor=white" alt="More About Me"></a> <a href="https://codeberg.org/pboling">üßä</a> <a href="https://github.org/pboling">üêô</a> <a href="https://sr.ht/~galtzo/">üõñ</a> <a href="https://gitlab.com/pboling">üß™</a>
</td>
    </tr>
  </tbody>
</table>

<h3 id="compatibility">Compatibility</h3>

<p>Compatible with MRI Ruby 3.2.0+, and concordant releases of JRuby, and TruffleRuby.</p>

<table>
  <thead>
    <tr>
      <th>üöö <em>Amazing</em> test matrix was brought to you by</th>
      <th>üîé appraisal2 üîé and the color üíö green üíö</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>üëü Check it out!</td>
      <td>‚ú® <a href="https://github.com/appraisal-rb/appraisal2">github.com/appraisal-rb/appraisal2</a> ‚ú®</td>
    </tr>
  </tbody>
</table>

<h3 id="federated-dvcs">Federated DVCS</h3>

<details>
  <summary>Find this repo on federated forges (Coming soon!)</summary>

  <table>
    <thead>
      <tr>
        <th>Federated <a href="https://railsbling.com/posts/dvcs/put_the_d_in_dvcs/">DVCS</a> Repository</th>
        <th>Status</th>
        <th>Issues</th>
        <th>PRs</th>
        <th>Wiki</th>
        <th>CI</th>
        <th>Discussions</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>üß™ <a href="https://gitlab.com/kettle-rb/tree_haver/">kettle-rb/tree_haver on GitLab</a>
</td>
        <td>The Truth</td>
        <td><a href="https://gitlab.com/kettle-rb/tree_haver/-/issues">üíö</a></td>
        <td><a href="https://gitlab.com/kettle-rb/tree_haver/-/merge_requests">üíö</a></td>
        <td><a href="https://gitlab.com/kettle-rb/tree_haver/-/wikis/home">üíö</a></td>
        <td>üê≠ Tiny Matrix</td>
        <td>‚ûñ</td>
      </tr>
      <tr>
        <td>üßä <a href="https://codeberg.org/kettle-rb/tree_haver">kettle-rb/tree_haver on CodeBerg</a>
</td>
        <td>An Ethical Mirror (<a href="https://donate.codeberg.org/">Donate</a>)</td>
        <td><a href="https://codeberg.org/kettle-rb/tree_haver/issues">üíö</a></td>
        <td><a href="https://codeberg.org/kettle-rb/tree_haver/pulls">üíö</a></td>
        <td>‚ûñ</td>
        <td>‚≠ïÔ∏è No Matrix</td>
        <td>‚ûñ</td>
      </tr>
      <tr>
        <td>üêô <a href="https://github.com/kettle-rb/tree_haver">kettle-rb/tree_haver on GitHub</a>
</td>
        <td>Another Mirror</td>
        <td><a href="https://github.com/kettle-rb/tree_haver/issues">üíö</a></td>
        <td><a href="https://github.com/kettle-rb/tree_haver/pulls">üíö</a></td>
        <td><a href="https://github.com/kettle-rb/tree_haver/wiki">üíö</a></td>
        <td>üíØ Full Matrix</td>
        <td><a href="https://github.com/kettle-rb/tree_haver/discussions">üíö</a></td>
      </tr>
      <tr>
        <td>üéÆÔ∏è <a href="https://discord.gg/3qme4XHNKN">Discord Server</a>
</td>
        <td><a href="https://discord.gg/3qme4XHNKN"><img src="https://img.shields.io/discord/1373797679469170758?style=for-the-badge&amp;logo=discord" alt="Live Chat on Discord"></a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">Let‚Äôs</a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">talk</a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">about</a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">this</a></td>
        <td><a href="https://discord.gg/3qme4XHNKN">library!</a></td>
      </tr>
    </tbody>
  </table>

</details>

<h3 id="enterprise-support-">Enterprise Support <a href="https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&amp;utm_medium=referral&amp;utm_campaign=readme"><img src="https://tidelift.com/badges/package/rubygems/tree_haver" alt="Tidelift"></a>
</h3>

<p>Available as part of the Tidelift Subscription.</p>

<details>
  <summary>Need enterprise-level guarantees?</summary>

  <p>The maintainers of this and thousands of other packages are working with Tidelift to deliver commercial support and maintenance for the open source packages you use to build your applications. Save time, reduce risk, and improve code health, while paying the maintainers of the exact packages you use.</p>

  <p><a href="https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&amp;utm_medium=referral&amp;utm_campaign=readme"><img src="https://img.shields.io/badge/Tidelift_and_Sonar-Enterprise_Support-FD3456?style=for-the-badge&amp;logo=sonar&amp;logoColor=white" alt="Get help from me on Tidelift"></a></p>

  <ul>
    <li>
      <p>üí°Subscribe for support guarantees covering <em>all</em> your FLOSS dependencies</p>
    </li>
    <li>
      <p>üí°Tidelift is part of <a href="https://blog.tidelift.com/tidelift-joins-sonar">Sonar</a></p>
    </li>
    <li>
      <p>üí°Tidelift pays maintainers to maintain the software you depend on!<br>üìä<code>@</code>Pointy Haired Boss: An <a href="https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&amp;utm_medium=referral&amp;utm_campaign=readme">enterprise support</a> subscription is ‚Äú<a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">never gonna let you down</a>‚Äù, and <em>supports</em> open source maintainers
Alternatively:</p>
    </li>
    <li>
      <p><a href="https://discord.gg/3qme4XHNKN"><img src="https://img.shields.io/discord/1373797679469170758?style=for-the-badge&amp;logo=discord" alt="Live Chat on Discord"></a></p>
    </li>
    <li>
      <p><a href="https://www.upwork.com/freelancers/~014942e9b056abdf86?mp_source=share"><img src="https://img.shields.io/badge/UpWork-13544E?style=for-the-badge&amp;logo=Upwork&amp;logoColor=white" alt="Get help from me on Upwork"></a></p>
    </li>
    <li>
      <p><a href="https://www.codementor.io/peterboling?utm_source=github&amp;utm_medium=button&amp;utm_term=peterboling&amp;utm_campaign=github"><img src="https://img.shields.io/badge/CodeMentor-Get_Help-1abc9c?style=for-the-badge&amp;logo=CodeMentor&amp;logoColor=white" alt="Get help from me on Codementor"></a></p>
    </li>
  </ul>
</details>

<h2 id="-installation">‚ú® Installation</h2>

<p>Install the gem and add to the application‚Äôs Gemfile by executing:</p>

<pre class="code language-console"><code class="language-console">bundle add tree_haver
</code></pre>

<p>If bundler is not being used to manage dependencies, install the gem by executing:</p>

<pre class="code language-console"><code class="language-console">gem install tree_haver
</code></pre>

<h3 id="-secure-installation">üîí Secure Installation</h3>

<details>
  <summary>For Medium or High Security Installations</summary>

  <p>This gem is cryptographically signed, and has verifiable <a href="https://gitlab.com/kettle-rb/tree_haver/-/tree/main/checksums">SHA-256 and SHA-512</a> checksums by
<a href="https://github.com/galtzo-floss/stone_checksums">stone_checksums</a>. Be sure the gem you install hasn‚Äôt been tampered with
by following the instructions below.</p>

  <p>Add my public key (if you haven‚Äôt already, expires 2045-04-29) as a trusted certificate:</p>

  <pre class="code language-console"><code class="language-console">gem cert --add &lt;(curl -Ls https://raw.github.com/galtzo-floss/certs/main/pboling.pem)
</code></pre>

  <p>You only need to do that once. Then proceed to install with:</p>

  <pre class="code language-console"><code class="language-console">gem install tree_haver -P HighSecurity
</code></pre>

  <p>The <code>HighSecurity</code> trust profile will verify signed gems, and not allow the installation of unsigned dependencies.</p>

  <p>If you want to up your security game full-time:</p>

  <pre class="code language-console"><code class="language-console">bundle config set --global trust-policy MediumSecurity
</code></pre>

  <p><code>MediumSecurity</code> instead of <code>HighSecurity</code> is necessary if not all the gems you use are signed.</p>

  <p>NOTE: Be prepared to track down certs for signed gems and add them the same way you added mine.</p>

</details>

<h2 id="Ô∏è-configuration">‚öôÔ∏è Configuration</h2>

<h3 id="available-backends">Available Backends</h3>

<p>TreeHaver supports 10 parsing backends, each with different trade-offs. The <code>auto</code> backend automatically selects the best available option.</p>

<h4 id="tree-sitter-backends-universal-parsing">Tree-sitter Backends (Universal Parsing)</h4>

<table>
  <thead>
    <tr>
      <th>Backend</th>
      <th>Description</th>
      <th>Performance</th>
      <th>Portability</th>
      <th>Examples</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Auto</strong></td>
      <td>Auto-selects best backend</td>
      <td>Varies</td>
      <td>‚úÖ Universal</td>
      <td>
<a href="examples/auto_json.rb">JSON</a> ¬∑ <a href="examples/auto_jsonc.rb">JSONC</a> ¬∑ <a href="examples/auto_bash.rb">Bash</a> ¬∑ <a href="examples/auto_toml.rb">TOML</a>
</td>
    </tr>
    <tr>
      <td><strong>MRI</strong></td>
      <td>C extension via ruby_tree_sitter</td>
      <td>‚ö° Fastest</td>
      <td>MRI only</td>
      <td>
<a href="examples/mri_json.rb">JSON</a> ¬∑ <a href="examples/mri_jsonc.rb">JSONC</a> ¬∑ ~~Bash~~* ¬∑ <a href="examples/mri_toml.rb">TOML</a>
</td>
    </tr>
    <tr>
      <td><strong>Rust</strong></td>
      <td>Precompiled via tree_stump</td>
      <td>‚ö° Very Fast</td>
      <td>‚úÖ Good</td>
      <td>
<a href="examples/rust_json.rb">JSON</a> ¬∑ <a href="examples/rust_jsonc.rb">JSONC</a> ¬∑ ~~Bash~~* ¬∑ <a href="examples/rust_toml.rb">TOML</a>
</td>
    </tr>
    <tr>
      <td><strong>FFI</strong></td>
      <td>Dynamic linking via FFI</td>
      <td>üîµ Fast</td>
      <td>‚úÖ Universal</td>
      <td>
<a href="examples/ffi_json.rb">JSON</a> ¬∑ <a href="examples/ffi_jsonc.rb">JSONC</a> ¬∑ <a href="examples/ffi_bash.rb">Bash</a> ¬∑ <a href="examples/ffi_toml.rb">TOML</a>
</td>
    </tr>
    <tr>
      <td><strong>Java</strong></td>
      <td>JNI bindings (jtreesitter &gt;= 0.26.0)</td>
      <td>‚ö° Very Fast</td>
      <td>JRuby only</td>
      <td>
<a href="examples/java_json.rb">JSON</a> ¬∑ <a href="examples/java_jsonc.rb">JSONC</a> ¬∑ <a href="examples/java_bash.rb">Bash</a> ¬∑ <a href="examples/java_toml.rb">TOML</a>
</td>
    </tr>
  </tbody>
</table>

<h4 id="language-specific-backends-native-parser-integration">Language-Specific Backends (Native Parser Integration)</h4>

<table>
  <thead>
    <tr>
      <th>Backend</th>
      <th>Description</th>
      <th>Performance</th>
      <th>Portability</th>
      <th>Examples</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Prism</strong></td>
      <td>Ruby‚Äôs official parser</td>
      <td>‚ö° Very Fast</td>
      <td>‚úÖ Universal</td>
      <td><a href="examples/prism_ruby.rb">Ruby</a></td>
    </tr>
    <tr>
      <td><strong>Psych</strong></td>
      <td>Ruby‚Äôs YAML parser (stdlib)</td>
      <td>‚ö° Very Fast</td>
      <td>‚úÖ Universal</td>
      <td><a href="examples/psych_yaml.rb">YAML</a></td>
    </tr>
    <tr>
      <td><strong>Commonmarker</strong></td>
      <td>Markdown via comrak (Rust)</td>
      <td>‚ö° Very Fast</td>
      <td>‚úÖ Good</td>
      <td>
<a href="examples/commonmarker_markdown.rb">Markdown</a> ¬∑ <a href="examples/commonmarker_merge_example.rb">Merge</a>
</td>
    </tr>
    <tr>
      <td><strong>Markly</strong></td>
      <td>GFM via cmark-gfm (C)</td>
      <td>‚ö° Very Fast</td>
      <td>‚úÖ Good</td>
      <td>
<a href="examples/markly_markdown.rb">Markdown</a> ¬∑ <a href="examples/markly_merge_example.rb">Merge</a>
</td>
    </tr>
    <tr>
      <td><strong>Citrus</strong></td>
      <td>Pure Ruby parsing</td>
      <td>üü° Slower</td>
      <td>‚úÖ Universal</td>
      <td>
<a href="examples/citrus_toml.rb">TOML</a> ¬∑ <a href="examples/citrus_finitio.rb">Finitio</a> ¬∑ <a href="examples/citrus_dhall.rb">Dhall</a>
</td>
    </tr>
  </tbody>
</table>

<p><strong>Selection Priority (Auto mode):</strong> MRI ‚Üí Rust ‚Üí FFI ‚Üí Java ‚Üí Prism ‚Üí Psych ‚Üí Commonmarker ‚Üí Markly ‚Üí Citrus</p>

<p><strong>Known Issues:</strong></p>
<ul>
  <li>*MRI + Bash: ABI incompatibility (use FFI instead)</li>
  <li>*Rust + Bash: Version mismatch (use FFI instead)<br>
<strong>Backend Requirements:</strong><br>
<!-- end list --><br>
``` ruby
    <h1 id="tree-sitter-backends">Tree-sitter backends</h1>
    <p>gem ‚Äúruby_tree_sitter‚Äù, ‚Äú~&gt; 2.0‚Äù  # MRI backend<br>
gem ‚Äútree_stump‚Äù                   # Rust backend<br>
gem ‚Äúffi‚Äù, ‚Äú&gt;= 1.15‚Äù, ‚Äú&lt; 2.0‚Äù     # FFI backend</p>
    <h1 id="java-backend-no-gem-required-uses-jrubys-built-in-jni">Java backend: no gem required (uses JRuby‚Äôs built-in JNI)</h1>
  </li>
</ul>

<h1 id="language-specific-backends">Language-specific backends</h1>
<p>gem ‚Äúprism‚Äù, ‚Äú~&gt; 1.0‚Äù              # Ruby parsing (stdlib in Ruby 3.4+)</p>
<h1 id="psych-no-gem-required-ruby-stdlib">Psych: no gem required (Ruby stdlib)</h1>
<p>gem ‚Äúcommonmarker‚Äù, ‚Äú&gt;= 0.23‚Äù      # Markdown parsing (comrak)<br>
gem ‚Äúmarkly‚Äù, ‚Äú~&gt; 0.11‚Äù            # GFM parsing (cmark-gfm)</p>

<h1 id="pure-ruby-fallback">Pure Ruby fallback</h1>
<p>gem ‚Äúcitrus‚Äù, ‚Äú~&gt; 3.0‚Äù             # Citrus backend</p>
<h1 id="plus-grammar-gems-toml-rb-dhall-finitio-etc">Plus grammar gems: toml-rb, dhall, finitio, etc.</h1>
<pre class="code ruby"><code class="ruby">
**Force Specific Backend:**

``` ruby
# Tree-sitter backends
TreeHaver.backend = :mri    # Force MRI backend (ruby_tree_sitter)
TreeHaver.backend = :rust   # Force Rust backend (tree_stump)
TreeHaver.backend = :ffi    # Force FFI backend
TreeHaver.backend = :java   # Force Java backend (JRuby only)

# Language-specific backends
TreeHaver.backend = :prism        # Force Prism (Ruby parsing)
TreeHaver.backend = :psych        # Force Psych (YAML parsing)
TreeHaver.backend = :commonmarker # Force Commonmarker (Markdown)
TreeHaver.backend = :markly       # Force Markly (GFM Markdown)

# Pure Ruby fallback
TreeHaver.backend = :citrus # Force Citrus backend

# Auto-selection (default)
TreeHaver.backend = :auto   # Let TreeHaver choose
</code></pre>

<p><strong>Block-based Backend Switching:</strong></p>

<p>Use <code>with_backend</code> to temporarily switch backends for a specific block of code.<br>
This is thread-safe and supports nesting‚Äîthe previous backend is automatically<br>
restored when the block exits (even if an exception is raised).</p>

<pre class="code language-ruby"><code class="language-ruby"># Temporarily use a specific backend
TreeHaver.with_backend(:mri) do
  parser = TreeHaver::Parser.new
  tree = parser.parse(source)
  # All operations in this block use the MRI backend
end
# Backend is restored to its previous value here

# Nested blocks work correctly
TreeHaver.with_backend(:rust) do
  # Uses :rust
  TreeHaver.with_backend(:citrus) do
    # Uses :citrus
    parser = TreeHaver::Parser.new
  end
  # Back to :rust
end
# Back to original backend
</code></pre>

<p>This is particularly useful for:</p>

<ul>
  <li>
<strong>Testing</strong>: Test the same code with different backends</li>
  <li>
<strong>Performance comparison</strong>: Benchmark different backends</li>
  <li>
<strong>Fallback scenarios</strong>: Try one backend, fall back to another</li>
  <li>
<strong>Thread isolation</strong>: Each thread can use a different backend safely<br>
<!-- end list -->
    <pre class="code language-ruby"><code class="language-ruby"># Example: Testing with multiple backends
[:mri, :rust, :citrus].each do |backend_name|
  TreeHaver.with_backend(backend_name) do
parser = TreeHaver::Parser.new
result = parser.parse(source)
puts &quot;#{backend_name}: #{result.root_node.type}&quot;
  end
end
</code></pre>
  </li>
</ul>

<p><strong>Check Backend Capabilities:</strong></p>

<pre class="code language-ruby"><code class="language-ruby">TreeHaver.backend              # =&gt; :ffi
TreeHaver.backend_module       # =&gt; TreeHaver::Backends::FFI
TreeHaver.capabilities         # =&gt; { backend: :ffi, parse: true, query: false, ... }
</code></pre>

<p>See <a href="examples/">examples/</a> directory for <strong>26 complete working examples</strong> demonstrating all 10 backends with multiple languages (JSON, JSONC, Bash, TOML, Ruby, YAML, Markdown) plus markdown-merge integration examples.</p>

<h3 id="security-considerations">Security Considerations</h3>

<p><strong>‚ö†Ô∏è Loading shared libraries (.so/.dylib/.dll) executes arbitrary native code.</strong></p>

<p>TreeHaver provides defense-in-depth validations, but you should understand the risks:</p>

<h4 id="attack-vectors-mitigated">Attack Vectors Mitigated</h4>

<p>TreeHaver‚Äôs <code>PathValidator</code> module protects against:</p>

<ul>
  <li>
<strong>Path traversal</strong>: Paths containing <code>/../</code> or <code>/./</code> are rejected</li>
  <li>
<strong>Null byte injection</strong>: Paths containing null bytes are rejected</li>
  <li>
<strong>Non-absolute paths</strong>: Relative paths are rejected to prevent CWD-based attacks</li>
  <li>
<strong>Invalid extensions</strong>: Only <code>.so</code>, <code>.dylib</code>, and <code>.dll</code> files are accepted</li>
  <li>
<strong>Malicious filenames</strong>: Filenames must match a safe pattern (alphanumeric, hyphens, underscores)</li>
  <li>
<strong>Invalid language names</strong>: Language names must be lowercase alphanumeric with underscores</li>
  <li>
<strong>Invalid symbol names</strong>: Symbol names must be valid C identifiers
    <h4 id="secure-usage">Secure Usage</h4>
  </li>
</ul>

<pre class="code language-ruby"><code class="language-ruby"># Standard usage - paths from ENV are validated
finder = TreeHaver::GrammarFinder.new(:toml)
path = finder.find_library_path  # Validates ENV path before returning

# Maximum security - only trusted system directories
path = finder.find_library_path_safe  # Ignores ENV, only /usr/lib etc.

# Manual validation
if TreeHaver::PathValidator.safe_library_path?(user_provided_path)
  language = TreeHaver::Language.from_library(user_provided_path)
end

# Get validation errors for debugging
errors = TreeHaver::PathValidator.validation_errors(path)
# =&gt; [&quot;Path is not absolute&quot;, &quot;Path contains traversal sequence&quot;]
</code></pre>

<h4 id="trusted-directories">Trusted Directories</h4>

<p>The <code>find_library_path_safe</code> method only returns paths in trusted directories.</p>

<p><strong>Default trusted directories:</strong></p>

<ul>
  <li>
<code>/usr/lib</code>, <code>/usr/lib64</code>
</li>
  <li>
<code>/usr/lib/x86_64-linux-gnu</code>, <code>/usr/lib/aarch64-linux-gnu</code>
</li>
  <li><code>/usr/local/lib</code></li>
  <li>
<code>/opt/homebrew/lib</code>, <code>/opt/local/lib</code><br>
<strong>Adding custom trusted directories:</strong><br>
For non-standard installations (Homebrew on Linux, luarocks, mise, asdf, etc.), register additional trusted directories:<br>
<!-- end list --><br>
``` ruby
    <h1 id="programmatically-at-application-startup">Programmatically at application startup</h1>
    <p>TreeHaver::PathValidator.add_trusted_directory(‚Äú/home/linuxbrew/.linuxbrew/Cellar‚Äù)<br>
TreeHaver::PathValidator.add_trusted_directory(‚Äú~/.local/share/mise/installs/lua‚Äù)</p>
  </li>
</ul>

<h1 id="or-via-environment-variable-comma-separated-in-your-shell-profile">Or via environment variable (comma-separated, in your shell profile)</h1>
<p>export TREE_HAVER_TRUSTED_DIRS = ‚Äú/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua‚Äù</p>
<pre class="code ruby"><code class="ruby">
**Example: Fedora Silverblue with Homebrew and luarocks**

``` bash
# In ~/.bashrc or ~/.zshrc
export TREE_HAVER_TRUSTED_DIRS=&quot;/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua&quot;

# tree-sitter runtime library
export TREE_SITTER_RUNTIME_LIB=/home/linuxbrew/.linuxbrew/Cellar/tree-sitter/0.26.3/lib/libtree-sitter.so

# Language grammar (luarocks-installed)
export TREE_SITTER_TOML_PATH=~/.local/share/mise/installs/lua/5.4.8/luarocks/lib/luarocks/rocks-5.4/tree-sitter-toml/0.0.31-1/parser/toml.so
</code></pre>

<h4 id="recommendations">Recommendations</h4>

<ol>
  <li>
<strong>Production</strong>: Consider using <code>find_library_path_safe</code> to ignore ENV overrides</li>
  <li>
<strong>Development</strong>: Standard <code>find_library_path</code> is convenient for testing</li>
  <li>
<strong>User Input</strong>: Always validate paths before passing to <code>Language.from_library</code>
</li>
  <li>
<strong>CI/CD</strong>: Be cautious of ENV vars that could be set by untrusted sources</li>
  <li>
<strong>Custom installs</strong>: Register trusted directories via <code>TREE_HAVER_TRUSTED_DIRS</code> or <code>add_trusted_directory</code>
    <h3 id="backend-selection">Backend Selection</h3>
  </li>
</ol>

<p>TreeHaver automatically selects the best backend for your Ruby implementation, but you can override this behavior:</p>

<pre class="code language-ruby"><code class="language-ruby"># Automatic backend selection (default)
TreeHaver.backend = :auto

# Force a specific backend
TreeHaver.backend = :mri     # Use ruby_tree_sitter (MRI only, C extension)
TreeHaver.backend = :rust    # Use tree_stump (MRI, Rust extension with precompiled binaries)
                             # Note: `tree_stump` currently requires unreleased fixes in the `main` branch.
                             # See: https://github.com/joker1007/tree_stump
TreeHaver.backend = :ffi     # Use FFI bindings (works on MRI and JRuby)
TreeHaver.backend = :java    # Use Java bindings (JRuby only, coming soon)
TreeHaver.backend = :citrus  # Use Citrus pure Ruby parser
                             # NOTE: Portable, all Ruby implementations
                             # CAVEAT: few major language grammars, but many esoteric grammars
</code></pre>

<p><strong>Auto-selection priority on MRI:</strong> MRI ‚Üí Rust ‚Üí FFI ‚Üí Citrus</p>

<p>You can also set the backend via environment variable:</p>

<pre class="code language-bash"><code class="language-bash">export TREE_HAVER_BACKEND=rust
</code></pre>

<h3 id="environment-variables">Environment Variables</h3>

<p>TreeHaver recognizes several environment variables for configuration:</p>

<p><strong>Note</strong>: All path-based environment variables are validated before use. Invalid paths are ignored.</p>

<h4 id="security-configuration">Security Configuration</h4>

<ul>
  <li>
    <p><strong><code>TREE_HAVER_TRUSTED_DIRS</code></strong>: Comma-separated list of additional trusted directories for grammar libraries</p>

    <pre class="code language-bash"><code class="language-bash"># For Homebrew on Linux and luarocks
export TREE_HAVER_TRUSTED_DIRS=&quot;/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua&quot;
</code></pre>

    <p>Tilde (<code>~</code>) is expanded to the user‚Äôs home directory. Directories listed here are considered safe for <code>find_library_path_safe</code>.</p>
    <h4 id="core-runtime-library">Core Runtime Library</h4>
  </li>
  <li>
<strong><code>TREE_SITTER_RUNTIME_LIB</code></strong>: Absolute path to the core <code>libtree-sitter</code> shared library
    <pre class="code language-bash"><code class="language-bash">export TREE_SITTER_RUNTIME_LIB=/usr/local/lib/libtree-sitter.so
</code></pre>
    <p>If not set, TreeHaver tries these names in order:</p>
  </li>
  <li><code>tree-sitter</code></li>
  <li><code>libtree-sitter.so.0</code></li>
  <li><code>libtree-sitter.so</code></li>
  <li><code>libtree-sitter.dylib</code></li>
  <li>
<code>libtree-sitter.dll</code>
    <h4 id="language-symbol-resolution">Language Symbol Resolution</h4>
  </li>
</ul>

<p>When loading a language grammar, if you don‚Äôt specify the <code>symbol:</code> parameter, TreeHaver resolves it in this precedence:</p>

<ol>
  <li>
<strong><code>TREE_SITTER_LANG_SYMBOL</code></strong>: Explicit symbol override</li>
  <li>Guessed from filename (e.g., <code>libtree-sitter-toml.so</code> ‚Üí <code>tree_sitter_toml</code>)</li>
  <li>Default fallback (<code>tree_sitter_toml</code>)<br>
<!-- end list -->
    <pre class="code language-bash"><code class="language-bash">export TREE_SITTER_LANG_SYMBOL=tree_sitter_toml
</code></pre>
  </li>
</ol>

<h4 id="language-library-paths">Language Library Paths</h4>

<p>For specific languages, you can set environment variables to point to grammar libraries:</p>

<pre class="code language-bash"><code class="language-bash">export TREE_SITTER_TOML_PATH=/usr/local/lib/libtree-sitter-toml.so
export TREE_SITTER_JSON_PATH=/usr/local/lib/libtree-sitter-json.so
</code></pre>

<h4 id="jruby-specific-java-backend-configuration">JRuby-Specific: Java Backend Configuration</h4>

<p>For the Java backend on JRuby, you need:</p>

<ol>
  <li>
<strong>jtreesitter &gt;= 0.26.0</strong> JAR from Maven Central</li>
  <li>
<strong>Tree-sitter runtime library</strong> (<code>libtree-sitter.so</code>) version 0.26+</li>
  <li>
<strong>Grammar <code>.so</code> files</strong> built against tree-sitter 0.26+<br>
<!-- end list --><br>
``` bash
    <h1 id="download-jtreesitter-jar-or-use-binsetup-jtreesitter">Download jtreesitter JAR (or use bin/setup-jtreesitter)</h1>
    <p>export TREE_SITTER_JAVA_JARS_DIR=/path/to/java-tree-sitter/jars</p>
  </li>
</ol>

<h1 id="point-to-tree-sitter-runtime-must-be-026">Point to tree-sitter runtime (must be 0.26+)</h1>
<p>export TREE_SITTER_RUNTIME_LIB=/usr/local/lib/libtree-sitter.so</p>

<h1 id="point-to-grammar-libraries-must-be-built-for-tree-sitter-026">Point to grammar libraries (must be built for tree-sitter 0.26+)</h1>
<p>export TREE_SITTER_TOML_PATH=/path/to/libtree-sitter-toml.so</p>
<pre class="code ruby"><code class="ruby">
**Building grammars for Java backend:**

If you get &quot;version mismatch&quot; errors, rebuild the grammar:

``` bash
# Use the provided build script
bin/build-grammar toml

# This regenerates parser.c for your tree-sitter version and compiles it
</code></pre>

<p>For more see <a href="https://tree-sitter.github.io/java-tree-sitter/">docs</a>, <a href="https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter">maven</a>, and <a href="https://github.com/tree-sitter/java-tree-sitter">source</a>.</p>

<h3 id="language-registration">Language Registration</h3>

<p>Register languages once at application startup for convenient access:</p>

<pre class="code language-ruby"><code class="language-ruby"># Register a TOML grammar
TreeHaver.register_language(
  :toml,
  path: &quot;/usr/local/lib/libtree-sitter-toml.so&quot;,
  symbol: &quot;tree_sitter_toml&quot;,  # optional, will be inferred if omitted
)

# Now you can use the convenient helper
language = TreeHaver::Language.toml

# Or still override path/symbol per-call
language = TreeHaver::Language.toml(
  path: &quot;/custom/path/libtree-sitter-toml.so&quot;,
)
</code></pre>

<h3 id="grammar-discovery-with-grammarfinder">Grammar Discovery with GrammarFinder</h3>

<p>For libraries that need to automatically locate tree-sitter grammars (like the <code>*-merge</code> family of gems), TreeHaver provides the <code>GrammarFinder</code> utility class. It handles platform-aware grammar discovery without requiring language-specific code in TreeHaver itself.</p>

<pre class="code language-ruby"><code class="language-ruby"># Create a finder for any language
finder = TreeHaver::GrammarFinder.new(:toml)

# Check if the grammar is available
if finder.available?
  puts &quot;TOML grammar found at: #{finder.find_library_path}&quot;
else
  puts finder.not_found_message
  # =&gt; &quot;tree-sitter toml grammar not found. Searched: /usr/lib/libtree-sitter-toml.so, ...&quot;
end

# Register the language if available
finder.register! if finder.available?

# Now use the registered language
language = TreeHaver::Language.toml
</code></pre>

<h4 id="grammarfinder-automatic-derivation">GrammarFinder Automatic Derivation</h4>

<p>Given just the language name, <code>GrammarFinder</code> automatically derives:</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Derived Value (for <code>:toml</code>)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ENV var</td>
      <td><code>TREE_SITTER_TOML_PATH</code></td>
    </tr>
    <tr>
      <td>Library filename</td>
      <td>
<code>libtree-sitter-toml.so</code> (Linux) or <code>.dylib</code> (macOS)</td>
    </tr>
    <tr>
      <td>Symbol name</td>
      <td><code>tree_sitter_toml</code></td>
    </tr>
  </tbody>
</table>

<h4 id="search-order">Search Order</h4>

<p><code>GrammarFinder</code> searches for grammars in this order:</p>

<ol>
  <li>
<strong>Environment variable</strong>: <code>TREE_SITTER_&lt;LANG&gt;_PATH</code> (highest priority)</li>
  <li>
<strong>Extra paths</strong>: Custom paths provided at initialization</li>
  <li>
<strong>System paths</strong>: Common installation directories (<code>/usr/lib</code>, <code>/usr/local/lib</code>, <code>/opt/homebrew/lib</code>, etc.)
    <h4 id="usage-in--merge-gems">Usage in *-merge Gems</h4>
  </li>
</ol>

<p>The <code>GrammarFinder</code> pattern enables clean integration in language-specific merge gems:</p>

<pre class="code language-ruby"><code class="language-ruby"># In toml-merge
finder = TreeHaver::GrammarFinder.new(:toml)
finder.register! if finder.available?

# In json-merge
finder = TreeHaver::GrammarFinder.new(:json)
finder.register! if finder.available?

# In bash-merge
finder = TreeHaver::GrammarFinder.new(:bash)
finder.register! if finder.available?
</code></pre>

<p>Each gem uses the same API‚Äîonly the language name changes.</p>

<h4 id="adding-custom-search-paths">Adding Custom Search Paths</h4>

<p>For non-standard installations, provide extra search paths:</p>

<pre class="code language-ruby"><code class="language-ruby">finder = TreeHaver::GrammarFinder.new(:toml, extra_paths: [
  &quot;/opt/custom/lib&quot;,
  &quot;/home/user/.local/lib&quot;,
])
</code></pre>

<h4 id="debug-information">Debug Information</h4>

<p>Get detailed information about the grammar search:</p>

<pre class="code language-ruby"><code class="language-ruby">finder = TreeHaver::GrammarFinder.new(:toml)
puts finder.search_info
# =&gt; {
#      language: :toml,
#      env_var: &quot;TREE_SITTER_TOML_PATH&quot;,
#      env_value: nil,
#      symbol: &quot;tree_sitter_toml&quot;,
#      library_filename: &quot;libtree-sitter-toml.so&quot;,
#      search_paths: [&quot;/usr/lib/libtree-sitter-toml.so&quot;, ...],
#      found_path: &quot;/usr/lib/libtree-sitter-toml.so&quot;,
#      available: true
#    }
</code></pre>

<h3 id="checking-capabilities">Checking Capabilities</h3>

<p>Different backends may support different features:</p>

<pre class="code language-ruby"><code class="language-ruby">TreeHaver.capabilities
# =&gt; { backend: :mri, query: true, bytes_field: true }
# or
# =&gt; { backend: :ffi, parse: true, query: false, bytes_field: true }
# or
# =&gt; { backend: :citrus, parse: true, query: false, bytes_field: false }
</code></pre>

<h3 id="compatibility-mode">Compatibility Mode</h3>

<p>For codebases migrating from <code>ruby_tree_sitter</code>, TreeHaver provides a compatibility shim:</p>

<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver/compat&quot;

# Now TreeSitter constants map to TreeHaver
parser = TreeSitter::Parser.new  # Actually creates TreeHaver::Parser
</code></pre>

<p>This is safe and idempotent‚Äîif the real <code>TreeSitter</code> module is already loaded, the shim does nothing.</p>

<h4 id="Ô∏è-important-exception-hierarchy">‚ö†Ô∏è Important: Exception Hierarchy</h4>

<p><strong>Both ruby_tree_sitter v2+ and TreeHaver exceptions inherit from <code>Exception</code> (not <code>StandardError</code>).</strong></p>

<p>This design decision follows ruby_tree_sitter‚Äôs lead for thread-safety and signal handling reasons. See <a href="https://github.com/Faveod/ruby-tree-sitter/pull/83">ruby_tree_sitter PR #83</a> for the rationale.</p>

<p><strong>What this means for exception handling:</strong></p>

<pre class="code language-ruby"><code class="language-ruby"># ‚ö†Ô∏è This will NOT catch TreeHaver errors
begin
  TreeHaver::Language.from_library(&quot;/nonexistent.so&quot;)
rescue =&gt; e
  puts &quot;Caught!&quot;  # Never reached - TreeHaver::Error inherits Exception
end

# ‚úÖ Explicit rescue is required
begin
  TreeHaver::Language.from_library(&quot;/nonexistent.so&quot;)
rescue TreeHaver::Error =&gt; e
  puts &quot;Caught!&quot;  # This works
end

# ‚úÖ Or rescue specific exceptions
begin
  TreeHaver::Language.from_library(&quot;/nonexistent.so&quot;)
rescue TreeHaver::NotAvailable =&gt; e
  puts &quot;Grammar not available: #{e.message}&quot;
end
</code></pre>

<p><strong>TreeHaver Exception Hierarchy:</strong></p>

<pre class="code ruby"><code class="ruby"><span class='const'>Exception</span>
<span class='id identifier rubyid_‚îî‚îÄ‚îÄ'>‚îî‚îÄ‚îÄ</span> <span class='const'><span class='object_link'><a href="TreeHaver.html" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Error.html" title="TreeHaver::Error (class)">Error</a></span></span>              <span class='comment'># Base error class
</span>    <span class='id identifier rubyid_‚îú‚îÄ‚îÄ'>‚îú‚îÄ‚îÄ</span> <span class='const'><span class='object_link'><a href="TreeHaver.html" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span></span>   <span class='comment'># Backend/grammar not available
</span>    <span class='id identifier rubyid_‚îî‚îÄ‚îÄ'>‚îî‚îÄ‚îÄ</span> <span class='const'><span class='object_link'><a href="TreeHaver.html" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/BackendConflict.html" title="TreeHaver::BackendConflict (class)">BackendConflict</a></span></span> <span class='comment'># Backend incompatibility detected **Compatibility Mode Behavior:**
</span></code></pre>

<p>The compat mode (<code>require "tree_haver/compat"</code>) creates aliases but <strong>does not change the exception hierarchy</strong>:</p>

<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver/compat&quot;

# TreeSitter constants are now aliases to TreeHaver
TreeSitter::Error       # =&gt; TreeHaver::Error (still inherits Exception)
TreeSitter::Parser      # =&gt; TreeHaver::Parser
TreeSitter::Language    # =&gt; TreeHaver::Language

# Exception handling remains the same
begin
  TreeSitter::Language.load(&quot;missing&quot;, &quot;/nonexistent.so&quot;)
rescue TreeSitter::Error =&gt; e  # Still requires explicit rescue
  puts &quot;Error: #{e.message}&quot;
end
</code></pre>

<p><strong>Best Practices:</strong></p>

<ol>
  <li>
    <p><strong>Always use explicit rescue</strong> for TreeHaver errors:</p>

    <pre class="code language-ruby"><code class="language-ruby">begin
  finder = TreeHaver::GrammarFinder.new(:toml)
  finder.register! if finder.available?
  language = TreeHaver::Language.toml
rescue TreeHaver::NotAvailable =&gt; e
  warn(&quot;TOML grammar not available: #{e.message}&quot;)
  # Fallback to another backend or fail gracefully
end
</code></pre>
  </li>
  <li>
    <p><strong>Never rely on <code>rescue =&gt; e</code></strong> to catch TreeHaver errors (it won‚Äôt work)<br>
<strong>Why inherit from Exception?</strong><br>
Following ruby_tree_sitter‚Äôs reasoning:<br>
<!-- end list --></p>
    <ul>
      <li>
<strong>Thread safety</strong>: Prevents accidental catching in thread cleanup code</li>
      <li>
<strong>Signal handling</strong>: Ensures parsing errors don‚Äôt interfere with SIGTERM/SIGINT</li>
      <li>
<strong>Intentional handling</strong>: Forces developers to explicitly handle parsing errors<br>
See <code>lib/tree_haver/compat.rb</code> for compatibility layer documentation.
        <h2 id="-basic-usage">üîß Basic Usage</h2>
      </li>
    </ul>
  </li>
</ol>

<h3 id="quick-start">Quick Start</h3>

<p>The simplest way to parse code is with <code>TreeHaver.parser_for</code>, which handles all the complexity of language loading, grammar discovery, and backend selection:</p>

<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver&quot;

# Parse TOML - auto-discovers grammar and falls back to Citrus if needed
parser = TreeHaver.parser_for(:toml)
tree = parser.parse(&quot;[package]\nname = \&quot;my-app\&quot;&quot;)

# Parse JSON
parser = TreeHaver.parser_for(:json)
tree = parser.parse(&#39;{&quot;key&quot;: &quot;value&quot;}&#39;)

# Parse Bash
parser = TreeHaver.parser_for(:bash)
tree = parser.parse(&quot;#!/bin/bash\necho hello&quot;)

# With explicit library path
parser = TreeHaver.parser_for(:toml, library_path: &quot;/custom/path/libtree-sitter-toml.so&quot;)

# With Citrus fallback configuration
parser = TreeHaver.parser_for(
  :toml,
  citrus_config: {gem_name: &quot;toml-rb&quot;, grammar_const: &quot;TomlRB::Document&quot;},
)
</code></pre>

<p><code>TreeHaver.parser_for</code> handles:</p>
<ol>
  <li>Checking if the language is already registered</li>
  <li>Auto-discovering tree-sitter grammar via <code>GrammarFinder</code>
</li>
  <li>Falling back to Citrus grammar if tree-sitter is unavailable</li>
  <li>Creating and configuring the parser</li>
  <li>Raising <code>NotAvailable</code> with a helpful message if nothing works
    <h3 id="manual-parser-setup">Manual Parser Setup</h3>
  </li>
</ol>

<p>For more control, you can create parsers manually:</p>

<p>TreeHaver works with any language through its 10 backends. Here are examples for different parsing needs:</p>

<h4 id="parsing-with-tree-sitter-universal-languages">Parsing with Tree-sitter (Universal Languages)</h4>

<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver&quot;

# Load a tree-sitter grammar (works with MRI, Rust, FFI, or Java backend)
language = TreeHaver::Language.from_library(
  &quot;/usr/local/lib/libtree-sitter-toml.so&quot;,
  symbol: &quot;tree_sitter_toml&quot;,
)

# Create a parser
parser = TreeHaver::Parser.new
parser.language = language

# Parse source code
source = &lt;&lt;~TOML
  [package]
  name = &quot;my-app&quot;
  version = &quot;1.0.0&quot;
TOML

tree = parser.parse(source)

# Access the unified Position API (works across all backends)
root = tree.root_node
puts &quot;Root type: #{root.type}&quot;              # =&gt; &quot;document&quot;
puts &quot;Start line: #{root.start_line}&quot;       # =&gt; 1 (1-based)
puts &quot;End line: #{root.end_line}&quot;           # =&gt; 3
puts &quot;Position: #{root.source_position}&quot;    # =&gt; {start_line: 1, end_line: 3, ...}

# Traverse the tree
root.each do |child|
  puts &quot;Child: #{child.type} at line #{child.start_line}&quot;
end
</code></pre>

<h4 id="parsing-ruby-with-prism">Parsing Ruby with Prism</h4>

<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver&quot;

TreeHaver.backend = :prism
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Backends::Prism::Language.ruby

source = &lt;&lt;~RUBY
  class Example
    def hello
      puts &quot;Hello, world!&quot;
    end
  end
RUBY

tree = parser.parse(source)
root = tree.root_node

# Find all method definitions
def find_methods(node, results = [])
  results &lt;&lt; node if node.type == &quot;def_node&quot;
  node.children.each { |child| find_methods(child, results) }
  results
end

methods = find_methods(root)
methods.each do |method_node|
  pos = method_node.source_position
  puts &quot;Method at lines #{pos[:start_line]}-#{pos[:end_line]}&quot;
end
</code></pre>

<h4 id="parsing-yaml-with-psych">Parsing YAML with Psych</h4>

<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver&quot;

TreeHaver.backend = :psych
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Backends::Psych::Language.yaml

source = &lt;&lt;~YAML
  database:
    host: localhost
    port: 5432
YAML

tree = parser.parse(source)
root = tree.root_node

# Navigate YAML structure
def show_structure(node, indent = 0)
  prefix = &quot;  &quot; * indent
  puts &quot;#{prefix}#{node.type} (line #{node.start_line})&quot;
  node.children.each { |child| show_structure(child, indent + 1) }
end

show_structure(root)
</code></pre>

<h4 id="parsing-markdown-with-commonmarker-or-markly">Parsing Markdown with Commonmarker or Markly</h4>

<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver&quot;

# Choose your backend
TreeHaver.backend = :commonmarker  # or :markly for GFM

parser = TreeHaver::Parser.new
parser.language = TreeHaver::Backends::Commonmarker::Language.markdown

source = &lt;&lt;~MARKDOWN
  # My Document

  ## Section

  - Item 1
  - Item 2
MARKDOWN

tree = parser.parse(source)
root = tree.root_node

# Find all headings
def find_headings(node, results = [])
  results &lt;&lt; node if node.type == &quot;heading&quot;
  node.children.each { |child| find_headings(child, results) }
  results
end

headings = find_headings(root)
headings.each do |heading|
  level = heading.header_level
  text = heading.children.map(&amp;:text).join
  puts &quot;H#{level}: #{text} (line #{heading.start_line})&quot;
end
</code></pre>

<h3 id="using-language-registration">Using Language Registration</h3>

<p>For cleaner code, register languages at startup:</p>

<pre class="code language-ruby"><code class="language-ruby"># At application initialization
TreeHaver.register_language(
  :toml,
  path: &quot;/usr/local/lib/libtree-sitter-toml.so&quot;,
)

TreeHaver.register_language(
  :json,
  path: &quot;/usr/local/lib/libtree-sitter-json.so&quot;,
)

# Later in your code
toml_language = TreeHaver::Language.toml
json_language = TreeHaver::Language.json

parser = TreeHaver::Parser.new
parser.language = toml_language
tree = parser.parse(toml_source)
</code></pre>

<h4 id="flexible-language-names">Flexible Language Names</h4>

<p>The <code>name</code> parameter in <code>register_language</code> is an arbitrary identifier you choose‚Äîit doesn‚Äôt<br>
need to match the actual language name. The actual grammar identity comes from the <code>path</code><br>
and <code>symbol</code> parameters (for tree-sitter) or <code>grammar_module</code> (for Citrus).</p>

<p>This flexibility is useful for:</p>

<ul>
  <li>
<strong>Aliasing</strong>: Register the same grammar under multiple names</li>
  <li>
<strong>Versioning</strong>: Register different grammar versions (e.g., <code>:ruby_2</code>, <code>:ruby_3</code>)</li>
  <li>
<strong>Testing</strong>: Use unique names to avoid collisions between tests</li>
  <li>
<strong>Context-specific naming</strong>: Use names that make sense for your application<br>
<!-- end list --><br>
``` ruby
    <h1 id="register-the-same-toml-grammar-under-different-names-for-different-purposes">Register the same TOML grammar under different names for different purposes</h1>
    <p>TreeHaver.register_language(<br>
  :config_parser,  # Custom name for your app<br>
  path: ‚Äú/usr/local/lib/libtree-sitter-toml.so‚Äù,<br>
  symbol: ‚Äútree_sitter_toml‚Äù,<br>
)</p>
  </li>
</ul>

<p>TreeHaver.register_language(<br>
  :toml_v1,  # Version-specific name<br>
  path: ‚Äú/usr/local/lib/libtree-sitter-toml.so‚Äù,<br>
  symbol: ‚Äútree_sitter_toml‚Äù,<br>
)</p>

<h1 id="use-your-custom-names">Use your custom names</h1>
<p>config_lang = TreeHaver::Language.config_parser<br>
versioned_lang = TreeHaver::Language.toml_v1</p>
<pre class="code ruby"><code class="ruby">
### Parsing Different Languages

TreeHaver works with any tree-sitter grammar:

``` ruby
# Parse Ruby code
ruby_lang = TreeHaver::Language.from_library(
  &quot;/path/to/libtree-sitter-ruby.so&quot;,
)
parser = TreeHaver::Parser.new
parser.language = ruby_lang
tree = parser.parse(&quot;class Foo; end&quot;)

# Parse JavaScript
js_lang = TreeHaver::Language.from_library(
  &quot;/path/to/libtree-sitter-javascript.so&quot;,
)
parser.language = js_lang  # Reuse the same parser
tree = parser.parse(&quot;const x = 42;&quot;)
</code></pre>

<h3 id="walking-the-ast">Walking the AST</h3>

<p>TreeHaver provides simple node traversal:</p>

<pre class="code language-ruby"><code class="language-ruby">tree = parser.parse(source)
root = tree.root_node

# Recursive tree walk
def walk_tree(node, depth = 0)
  puts &quot;#{&quot;  &quot; * depth}#{node.type}&quot;
  node.each { |child| walk_tree(child, depth + 1) }
end

walk_tree(root)
</code></pre>

<h3 id="incremental-parsing">Incremental Parsing</h3>

<p>TreeHaver supports incremental parsing when using the MRI or Rust backends. This is a major performance optimization for editors and IDEs that need to re-parse on every keystroke.</p>

<pre class="code language-ruby"><code class="language-ruby"># Check if current backend supports incremental parsing
if TreeHaver.capabilities[:incremental]
  puts &quot;Incremental parsing is available!&quot;
end

# Initial parse
parser = TreeHaver::Parser.new
parser.language = language
tree = parser.parse_string(nil, &quot;x = 1&quot;)

# User edits the source: &quot;x = 1&quot; -&gt; &quot;x = 42&quot;
# Mark the tree as edited (tell tree-sitter what changed)
tree.edit(
  start_byte: 4,           # edit starts at byte 4
  old_end_byte: 5,         # old text &quot;1&quot; ended at byte 5
  new_end_byte: 6,         # new text &quot;42&quot; ends at byte 6
  start_point: {row: 0, column: 4},
  old_end_point: {row: 0, column: 5},
  new_end_point: {row: 0, column: 6},
)

# Re-parse incrementally - tree-sitter reuses unchanged nodes
new_tree = parser.parse_string(tree, &quot;x = 42&quot;)
</code></pre>

<p><strong>Note:</strong> Incremental parsing requires the MRI (<code>ruby_tree_sitter</code>), Rust (<code>tree_stump</code>), or Java (<code>java-tree-sitter</code> / <code>jtreesitter</code>) backend. The FFI and Citrus backends do not currently support incremental parsing. You can check support with:</p>

<p><strong>Note:</strong> <code>tree_stump</code> currently requires unreleased fixes in the <code>main</code> branch.</p>

<pre class="code language-ruby"><code class="language-ruby">tree.supports_editing?  # =&gt; true if edit() is available
</code></pre>

<h3 id="error-handling">Error Handling</h3>

<pre class="code language-ruby"><code class="language-ruby">begin
  language = TreeHaver::Language.from_library(&quot;/path/to/grammar.so&quot;)
rescue TreeHaver::NotAvailable =&gt; e
  puts &quot;Failed to load grammar: #{e.message}&quot;
end

# Check if a backend is available
if TreeHaver.backend_module.nil?
  puts &quot;No TreeHaver backend is available!&quot;
  puts &quot;Install ruby_tree_sitter (MRI), ffi gem with libtree-sitter, or citrus gem&quot;
end
</code></pre>

<h3 id="platform-specific-examples">Platform-Specific Examples</h3>

<h4 id="mri-ruby">MRI Ruby</h4>

<p>On MRI, TreeHaver uses <code>ruby_tree_sitter</code> by default:</p>

<pre class="code language-ruby"><code class="language-ruby"># Gemfile
gem &quot;tree_haver&quot;
gem &quot;ruby_tree_sitter&quot;  # MRI backend

# Code - no changes needed, TreeHaver auto-selects MRI backend
parser = TreeHaver::Parser.new
</code></pre>

<h4 id="jruby">JRuby</h4>

<p>On JRuby, TreeHaver can use the FFI backend, Java backend, or Citrus backend:</p>

<p><strong>Option 1: FFI Backend (recommended for tree-sitter grammars)</strong></p>

<pre class="code language-ruby"><code class="language-ruby"># Gemfile
gem &quot;tree_haver&quot;
gem &quot;ffi&quot;  # Required for FFI backend

# Ensure libtree-sitter is installed on your system
# On macOS with Homebrew:
#   brew install tree-sitter

# On Ubuntu/Debian:
#   sudo apt-get install libtree-sitter0 libtree-sitter-dev

# Code - TreeHaver auto-selects FFI backend on JRuby
parser = TreeHaver::Parser.new
</code></pre>

<p><strong>Option 2: Java Backend (native JVM performance)</strong></p>

<pre class="code language-bash"><code class="language-bash"># 1. Download java-tree-sitter JAR from Maven Central
mkdir -p vendor/jars
curl -fSL -o vendor/jars/jtreesitter-0.23.2.jar \
  &quot;https://repo1.maven.org/maven2/io/github/tree-sitter/jtreesitter/0.23.2/jtreesitter-0.23.2.jar&quot;

# 2. Set environment variables
export CLASSPATH=&quot;$(pwd)/vendor/jars:$CLASSPATH&quot;
export LD_LIBRARY_PATH=&quot;/path/to/libtree-sitter/lib:$LD_LIBRARY_PATH&quot;

# 3. Run with JRuby (requires Java 22+ for Foreign Function API)
JAVA_OPTS=&quot;--enable-native-access=ALL-UNNAMED&quot; jruby your_script.rb
</code></pre>

<pre class="code language-ruby"><code class="language-ruby"># Force Java backend
TreeHaver.backend = :java

# Check if Java backend is available
if TreeHaver::Backends::Java.available?
  puts &quot;Java backend is ready!&quot;
  puts TreeHaver.capabilities
  # =&gt; { backend: :java, parse: true, query: true, bytes_field: true, incremental: true }
end
</code></pre>

<p><strong>‚ö†Ô∏è Java Backend Limitation: Symbol Resolution</strong></p>

<p>The Java backend uses Java‚Äôs Foreign Function &amp; Memory (FFM) API which loads libraries in isolation. Unlike the system‚Äôs dynamic linker (<code>dlopen</code>), FFM‚Äôs <code>SymbolLookup.or()</code> chains symbol lookups but doesn‚Äôt resolve dynamic library dependencies.</p>

<p>This means grammar <code>.so</code> files with unresolved references to <code>libtree-sitter.so</code> symbols won‚Äôt load correctly. Most grammars from luarocks, npm, or other sources have these dependencies.</p>

<p><strong>Recommended approach for JRuby:</strong> Use the <strong>FFI backend</strong>:</p>

<pre class="code language-ruby"><code class="language-ruby"># On JRuby, use FFI backend (recommended)
TreeHaver.backend = :ffi
</code></pre>

<p>The FFI backend uses Ruby‚Äôs FFI gem which relies on the system‚Äôs dynamic linker, correctly resolving symbol dependencies between <code>libtree-sitter.so</code> and grammar libraries.</p>

<p>The Java backend will work with:</p>

<ul>
  <li>Grammar JARs built specifically for java-tree-sitter / jtreesitter (self-contained, <a href="https://tree-sitter.github.io/java-tree-sitter/">docs</a>, <a href="https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter">maven</a>, <a href="https://github.com/tree-sitter/java-tree-sitter">source</a>)</li>
  <li>Grammar <code>.so</code> files that statically link tree-sitter<br>
<strong>Option 3: Citrus Backend (pure Ruby, portable)</strong><br>
<!-- end list --><br>
``` ruby
    <h1 id="gemfile">Gemfile</h1>
    <p>gem ‚Äútree_haver‚Äù<br>
gem ‚Äúcitrus‚Äù  # Pure Ruby parser, zero native dependencies</p>
  </li>
</ul>

<h1 id="code---force-citrus-backend-for-maximum-portability">Code - Force Citrus backend for maximum portability</h1>
<p>TreeHaver.backend = :citrus</p>

<h1 id="check-if-citrus-backend-is-available">Check if Citrus backend is available</h1>
<p>if TreeHaver::Backends::Citrus.available?<br>
  puts ‚ÄúCitrus backend is ready!‚Äù<br>
  puts TreeHaver.capabilities<br>
  # =&gt; { backend: :citrus, parse: true, query: false, bytes_field: false }<br>
end</p>
<pre class="code ruby"><code class="ruby">
**‚ö†Ô∏è Citrus Backend Limitations:**

  - Uses Citrus grammars (not tree-sitter grammars)
  - No incremental parsing support
  - No query API
  - Pure Ruby performance (slower than native backends)
  - Best for: prototyping, environments without native extension support, teaching
#### TruffleRuby

TruffleRuby can use the MRI, FFI, or Citrus backend:

``` ruby
# Use FFI backend (recommended for tree-sitter grammars)
TreeHaver.backend = :ffi

# Or try MRI backend if ruby_tree_sitter compiles on your TruffleRuby version
TreeHaver.backend = :mri

# Or use Citrus backend for zero native dependencies
TreeHaver.backend = :citrus
</code></pre>

<h3 id="advanced-thread-safe-backend-switching">Advanced: Thread-Safe Backend Switching</h3>

<p>TreeHaver provides <code>with_backend</code> for thread-safe, temporary backend switching. This is<br>
essential for testing, benchmarking, and applications that need different backends in<br>
different contexts.</p>

<h4 id="testing-with-multiple-backends">Testing with Multiple Backends</h4>

<p>Test the same code path with different backends using <code>with_backend</code>:</p>

<pre class="code language-ruby"><code class="language-ruby"># In your test setup
RSpec.describe(&quot;MyParser&quot;) do
  # Test with each available backend
  [:mri, :rust, :citrus].each do |backend_name|
    context &quot;with #{backend_name} backend&quot; do
      it &quot;parses correctly&quot; do
        TreeHaver.with_backend(backend_name) do
          parser = TreeHaver::Parser.new
          result = parser.parse(&quot;x = 42&quot;)
          expect(result.root_node.type).to(eq(&quot;document&quot;))
        end
        # Backend automatically restored after block
      end
    end
  end
end
</code></pre>

<h4 id="thread-isolation">Thread Isolation</h4>

<p>Each thread can use a different backend safely‚Äî<code>with_backend</code> uses thread-local storage:</p>

<pre class="code language-ruby"><code class="language-ruby">threads = []

threads &lt;&lt; Thread.new do
  TreeHaver.with_backend(:mri) do
    # This thread uses MRI backend
    parser = TreeHaver::Parser.new
    100.times { parser.parse(&quot;x = 1&quot;) }
  end
end

threads &lt;&lt; Thread.new do
  TreeHaver.with_backend(:citrus) do
    # This thread uses Citrus backend simultaneously
    parser = TreeHaver::Parser.new
    100.times { parser.parse(&quot;x = 1&quot;) }
  end
end

threads.each(&amp;:join)
</code></pre>

<h4 id="nested-blocks">Nested Blocks</h4>

<p><code>with_backend</code> supports nesting‚Äîinner blocks override outer blocks:</p>

<pre class="code language-ruby"><code class="language-ruby">TreeHaver.with_backend(:rust) do
  puts TreeHaver.effective_backend  # =&gt; :rust

  TreeHaver.with_backend(:citrus) do
    puts TreeHaver.effective_backend  # =&gt; :citrus
  end

  puts TreeHaver.effective_backend  # =&gt; :rust (restored)
end
</code></pre>

<h4 id="fallback-pattern">Fallback Pattern</h4>

<p>Try one backend, fall back to another on failure:</p>

<pre class="code language-ruby"><code class="language-ruby">def parse_with_fallback(source)
  TreeHaver.with_backend(:mri) do
    TreeHaver::Parser.new.tap { |p| p.language = load_language }.parse(source)
  end
rescue TreeHaver::NotAvailable
  # Fall back to Citrus if MRI backend unavailable
  TreeHaver.with_backend(:citrus) do
    TreeHaver::Parser.new.tap { |p| p.language = load_language }.parse(source)
  end
end
</code></pre>

<h3 id="complete-real-world-example">Complete Real-World Example</h3>

<p>Here‚Äôs a practical example that extracts package names from a TOML file:</p>

<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver&quot;

# Setup
TreeHaver.register_language(
  :toml,
  path: &quot;/usr/local/lib/libtree-sitter-toml.so&quot;,
)

def extract_package_name(toml_content)
  # Create parser
  parser = TreeHaver::Parser.new
  parser.language = TreeHaver::Language.toml

  # Parse
  tree = parser.parse(toml_content)
  root = tree.root_node

  # Find [package] table
  root.each do |child|
    next unless child.type == &quot;table&quot;

    child.each do |table_elem|
      if table_elem.type == &quot;pair&quot;
        # Look for name = &quot;...&quot; pair
        key = table_elem.each.first&amp;.type
        # In a real implementation, you&#39;d extract the text value
        # This is simplified for demonstration
      end
    end
  end
end

# Usage
toml = &lt;&lt;~TOML
  [package]
  name = &quot;awesome-app&quot;
  version = &quot;2.0.0&quot;
TOML

package_name = extract_package_name(toml)
</code></pre>

<h3 id="-rspec-integration">üß™ RSpec Integration</h3>

<p>TreeHaver provides shared RSpec helpers for conditional test execution based on dependency availability. This is useful for testing code that uses optional backends.</p>

<pre class="code language-ruby"><code class="language-ruby"># In your spec_helper.rb
require &quot;tree_haver/rspec&quot;
</code></pre>

<p>This automatically configures RSpec with exclusion filters for all TreeHaver dependencies. Use tags to conditionally run tests:</p>

<pre class="code language-ruby"><code class="language-ruby"># Runs only when FFI backend is available
it &quot;parses with FFI&quot;, :ffi do
  # ...
end

# Runs only when ruby_tree_sitter gem is available
it &quot;uses MRI backend&quot;, :mri_backend do
  # ...
end

# Runs only when tree-sitter-toml grammar works
it &quot;parses TOML&quot;, :tree_sitter_toml do
  # ...
end

# Runs only when any markdown backend is available
it &quot;parses markdown&quot;, :markdown_backend do
  # ...
end
</code></pre>

<p><strong>Available Tags:</strong></p>

<table>
  <thead>
    <tr>
      <th>Tag</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>:ffi</code></td>
      <td>FFI backend available (dynamic check)</td>
    </tr>
    <tr>
      <td><code>:mri_backend</code></td>
      <td>ruby_tree_sitter gem available</td>
    </tr>
    <tr>
      <td><code>:rust_backend</code></td>
      <td>tree_stump gem available</td>
    </tr>
    <tr>
      <td><code>:java_backend</code></td>
      <td>Java backend available (JRuby)</td>
    </tr>
    <tr>
      <td><code>:prism_backend</code></td>
      <td>Prism gem available</td>
    </tr>
    <tr>
      <td><code>:psych_backend</code></td>
      <td>Psych available (stdlib)</td>
    </tr>
    <tr>
      <td><code>:commonmarker</code></td>
      <td>commonmarker gem available</td>
    </tr>
    <tr>
      <td><code>:markly</code></td>
      <td>markly gem available</td>
    </tr>
    <tr>
      <td><code>:citrus_toml</code></td>
      <td>toml-rb with Citrus grammar available</td>
    </tr>
    <tr>
      <td><code>:jruby</code></td>
      <td>Running on JRuby</td>
    </tr>
    <tr>
      <td><code>:truffleruby</code></td>
      <td>Running on TruffleRuby</td>
    </tr>
    <tr>
      <td><code>:mri</code></td>
      <td>Running on MRI (CRuby)</td>
    </tr>
    <tr>
      <td><code>:tree_sitter_bash</code></td>
      <td>Bash grammar available and working</td>
    </tr>
    <tr>
      <td><code>:tree_sitter_toml</code></td>
      <td>TOML grammar available and working</td>
    </tr>
    <tr>
      <td><code>:tree_sitter_json</code></td>
      <td>JSON grammar available and working</td>
    </tr>
    <tr>
      <td><code>:tree_sitter_jsonc</code></td>
      <td>JSONC grammar available and working</td>
    </tr>
    <tr>
      <td><code>:toml_backend</code></td>
      <td>Any TOML backend available</td>
    </tr>
    <tr>
      <td><code>:markdown_backend</code></td>
      <td>Any markdown backend available</td>
    </tr>
    <tr>
      <td><code>:toml_merge</code></td>
      <td>toml-merge gem functional</td>
    </tr>
    <tr>
      <td><code>:json_merge</code></td>
      <td>json-merge gem functional</td>
    </tr>
    <tr>
      <td><code>:prism_merge</code></td>
      <td>prism-merge gem functional</td>
    </tr>
    <tr>
      <td><code>:psych_merge</code></td>
      <td>psych-merge gem functional</td>
    </tr>
  </tbody>
</table>

<p>All tags have negated versions (e.g., <code>:not_mri_backend</code>, <code>:not_jruby</code>) for testing fallback behavior.</p>

<p><strong>Debug Output:</strong></p>

<p>Set <code>TREE_HAVER_DEBUG=1</code> to print a dependency summary at the start of your test suite:</p>

<pre class="code language-bash"><code class="language-bash">TREE_HAVER_DEBUG=1 bundle exec rspec
</code></pre>

<h2 id="-floss-funding">ü¶∑ FLOSS Funding</h2>

<p>While kettle-rb tools are free software and will always be, the project would benefit immensely from some funding.<br>
Raising a monthly budget of‚Ä¶ ‚Äúdollars‚Äù would make the project more sustainable.</p>

<p>We welcome both individual and corporate sponsors! We also offer a<br>
wide array of funding channels to account for your preferences<br>
(although currently <a href="https://opencollective.com/kettle-rb">Open Collective</a> is our preferred funding platform).</p>

<p><strong>If you‚Äôre working in a company that‚Äôs making significant use of kettle-rb tools we‚Äôd<br>
appreciate it if you suggest to your company to become a kettle-rb sponsor.</strong></p>

<p>You can support the development of kettle-rb tools via<br>
<a href="https://github.com/sponsors/pboling">GitHub Sponsors</a>,<br>
<a href="https://liberapay.com/pboling/donate">Liberapay</a>,<br>
<a href="https://www.paypal.com/paypalme/peterboling">PayPal</a>,<br>
<a href="https://opencollective.com/kettle-rb">Open Collective</a><br>
and <a href="https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&amp;utm_medium=referral&amp;utm_campaign=readme">Tidelift</a>.</p>

<table>
  <thead>
    <tr>
      <th>üìç NOTE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>If doing a sponsorship in the form of donation is problematic for your company <br> from an accounting standpoint, we‚Äôd recommend the use of Tidelift, <br> where you can get a support-like subscription instead.</td>
    </tr>
  </tbody>
</table>

<h3 id="open-collective-for-individuals">Open Collective for Individuals</h3>

<p>Support us with a monthly donation and help us continue our activities. [<a href="https://opencollective.com/kettle-rb#backer">Become a backer</a>]</p>

<p>NOTE: <a href="https://github.com/kettle-rb/tree_haver/blob/main/exe/kettle-readme-backers">kettle-readme-backers</a> updates this list every day, automatically.</p>

<!-- OPENCOLLECTIVE-INDIVIDUALS:START -->
<p>No backers yet. Be the first!<br>
<!-- OPENCOLLECTIVE-INDIVIDUALS:END --></p>

<h3 id="open-collective-for-organizations">Open Collective for Organizations</h3>

<p>Become a sponsor and get your logo on our README on GitHub with a link to your site. [<a href="https://opencollective.com/kettle-rb#sponsor">Become a sponsor</a>]</p>

<p>NOTE: <a href="https://github.com/kettle-rb/tree_haver/blob/main/exe/kettle-readme-backers">kettle-readme-backers</a> updates this list every day, automatically.</p>

<!-- OPENCOLLECTIVE-ORGANIZATIONS:START -->
<p>No sponsors yet. Be the first!<br>
<!-- OPENCOLLECTIVE-ORGANIZATIONS:END --></p>

<h3 id="another-way-to-support-open-source">Another way to support open-source</h3>

<p>I‚Äôm driven by a passion to foster a thriving open-source community ‚Äì a space where people can tackle complex problems, no matter how small. Revitalizing libraries that have fallen into disrepair, and building new libraries focused on solving real-world challenges, are my passions. I was recently affected by layoffs, and the tech jobs market is unwelcoming. I‚Äôm reaching out here because your support would significantly aid my efforts to provide for my family, and my farm (11 üêî chickens, 2 üê∂ dogs, 3 üê∞ rabbits, 8 üêà‚Äç cats).</p>

<p>If you work at a company that uses my work, please encourage them to support me as a corporate sponsor. My work on gems you use might show up in <code>bundle fund</code>.</p>

<p>I‚Äôm developing a new library, <a href="https://github.com/galtzo-floss/floss_funding">floss_funding</a>, designed to empower open-source developers like myself to get paid for the work we do, in a sustainable way. Please give it a look.</p>

<p><strong><a href="https://floss-funding.dev">Floss-Funding.dev</a>: üëâÔ∏è No network calls. üëâÔ∏è No tracking. üëâÔ∏è No oversight. üëâÔ∏è Minimal crypto hashing. üí° Easily disabled nags</strong></p>

<p><a href="https://opencollective.com/kettle-rb#backer"><img src="https://opencollective.com/kettle-rb/backers/badge.svg?style=flat" alt="OpenCollective Backers"></a> <a href="https://opencollective.com/kettle-rb#sponsor"><img src="https://opencollective.com/kettle-rb/sponsors/badge.svg?style=flat" alt="OpenCollective Sponsors"></a> <a href="https://github.com/sponsors/pboling"><img src="https://img.shields.io/badge/Sponsor_Me!-pboling.svg?style=social&amp;logo=github" alt="Sponsor Me on Github"></a> <a href="https://liberapay.com/pboling/donate"><img src="https://img.shields.io/liberapay/goal/pboling.svg?logo=liberapay&amp;color=a51611&amp;style=flat" alt="Liberapay Goal Progress"></a> <a href="https://www.paypal.com/paypalme/peterboling"><img src="https://img.shields.io/badge/donate-paypal-a51611.svg?style=flat&amp;logo=paypal" alt="Donate on PayPal"></a> <a href="https://www.buymeacoffee.com/pboling"><img src="https://img.shields.io/badge/buy_me_a_coffee-%E2%9C%93-a51611.svg?style=flat" alt="Buy me a coffee"></a> <a href="https://polar.sh/pboling"><img src="https://img.shields.io/badge/polar-donate-a51611.svg?style=flat" alt="Donate on Polar"></a> <a href="https://ko-fi.com/O5O86SNP4"><img src="https://img.shields.io/badge/ko--fi-%E2%9C%93-a51611.svg?style=flat" alt="Donate to my FLOSS efforts at ko-fi.com"></a> <a href="https://patreon.com/galtzo"><img src="https://img.shields.io/badge/patreon-donate-a51611.svg?style=flat" alt="Donate to my FLOSS efforts using Patreon"></a></p>

<h2 id="-security">üîê Security</h2>

<p>See <a href="file.SECURITY.html" title="SECURITY.md">SECURITY.md</a>.</p>

<h2 id="-contributing">ü§ù Contributing</h2>

<p>If you need some ideas of where to help, you could work on adding more code coverage,<br>
or if it is already üíØ (see <a href="#code-coverage">below</a>) check <a href="file.REEK.html" title="reek">reek</a>, <a href="https://github.com/kettle-rb/tree_haver/issues">issues</a>, or <a href="https://github.com/kettle-rb/tree_haver/pulls">PRs</a>,<br>
or use the gem and think about how it could be better.</p>

<p>We <a href="https://keepachangelog.com/en/1.0.0/"><img src="https://img.shields.io/badge/keep--a--changelog-1.0.0-34495e.svg?style=flat" alt="Keep A Changelog"></a> so if you make changes, remember to update it.</p>

<p>See <a href="file.CONTRIBUTING.html" title="CONTRIBUTING.md">CONTRIBUTING.md</a> for more detailed instructions.</p>

<h3 id="-release-instructions">üöÄ Release Instructions</h3>

<p>See <a href="file.CONTRIBUTING.html" title="CONTRIBUTING.md">CONTRIBUTING.md</a>.</p>

<h3 id="code-coverage">Code Coverage</h3>

<p><a href="https://codecov.io/gh/kettle-rb/tree_haver"><img src="https://codecov.io/gh/kettle-rb/tree_haver/graphs/tree.svg" alt="Coverage Graph"></a></p>

<p><a href="https://coveralls.io/github/kettle-rb/tree_haver?branch=main"><img src="https://coveralls.io/repos/github/kettle-rb/tree_haver/badge.svg?branch=main" alt="Coveralls Test Coverage"></a></p>

<p><a href="https://qlty.sh/gh/kettle-rb/projects/tree_haver/metrics/code?sort=coverageRating"><img src="https://qlty.sh/gh/kettle-rb/projects/tree_haver/coverage.svg" alt="QLTY Test Coverage"></a></p>

<h3 id="-code-of-conduct">ü™á Code of Conduct</h3>

<p>Everyone interacting with this project‚Äôs codebases, issue trackers,<br>
chat rooms and mailing lists agrees to follow the <a href="file.CODE_OF_CONDUCT.html" title="&lt;img src=&quot;https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg&quot; alt=&quot;Contributor Covenant 2.1&quot;&gt;"><img src="https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg" alt="Contributor Covenant 2.1"></a>.</p>

<h2 id="-contributors">üåà Contributors</h2>

<p><a href="https://github.com/kettle-rb/tree_haver/graphs/contributors"><img src="https://contrib.rocks/image?repo=kettle-rb/tree_haver" alt="Contributors"></a></p>

<p>Made with <a href="https://contrib.rocks">contributors-img</a>.</p>

<p>Also see GitLab Contributors: <a href="https://gitlab.com/kettle-rb/tree_haver/-/graphs/main">https://gitlab.com/kettle-rb/tree_haver/-/graphs/main</a></p>

<details>
    <summary>‚≠êÔ∏è Star History</summary>

<a href="https://star-history.com/#kettle-rb/tree_haver&amp;Date">
 <picture>
   <source media="(prefers-color-scheme: dark)" srcset="https://api.star-history.com/svg?repos=kettle-rb/tree_haver&amp;type=Date&amp;theme=dark"></source>
   <source media="(prefers-color-scheme: light)" srcset="https://api.star-history.com/svg?repos=kettle-rb/tree_haver&amp;type=Date"></source>
   <img alt="Star History Chart" src="https://api.star-history.com/svg?repos=kettle-rb/tree_haver&amp;type=Date">
 </picture>
</a>

</details>

<h2 id="-versioning">üìå Versioning</h2>

<p>This Library adheres to <a href="https://semver.org/spec/v2.0.0.html"><img src="https://img.shields.io/badge/semver-2.0.0-259D6C.svg?style=flat" alt="Semantic Versioning 2.0.0"></a>.<br>
Violations of this scheme should be reported as bugs.<br>
Specifically, if a minor or patch version is released that breaks backward compatibility,<br>
a new version should be immediately released that restores compatibility.<br>
Breaking changes to the public API will only be introduced with new major versions.</p>

<blockquote>
  <p>dropping support for a platform is both obviously and objectively a breaking change <br><br>
‚ÄîJordan Harband (<a href="https://github.com/ljharb">@ljharb</a>, maintainer of SemVer) <a href="https://github.com/semver/semver/issues/716#issuecomment-869336139">in SemVer issue 716</a></p>
</blockquote>

<p>I understand that policy doesn‚Äôt work universally (‚Äúexceptions to every rule!‚Äù),<br>
but it is the policy here.<br>
As such, in many cases it is good to specify a dependency on this library using<br>
the <a href="http://guides.rubygems.org/patterns/#pessimistic-version-constraint">Pessimistic Version Constraint</a> with two digits of precision.</p>

<p>For example:</p>

<pre class="code language-ruby"><code class="language-ruby">spec.add_dependency(&quot;tree_haver&quot;, &quot;~&gt; 1.0&quot;)
</code></pre>

<details>
  <summary>üìå Is "Platform Support" part of the public API? More details inside.</summary>

  <p>SemVer should, IMO, but doesn‚Äôt explicitly, say that dropping support for specific Platforms
is a <em>breaking change</em> to an API, and for that reason the bike shedding is endless.</p>

  <p>To get a better understanding of how SemVer is intended to work over a project‚Äôs lifetime,
read this article from the creator of SemVer:</p>

  <ul>
    <li><a href="https://tom.preston-werner.com/2022/05/23/major-version-numbers-are-not-sacred.html">‚ÄúMajor Version Numbers are Not Sacred‚Äù</a></li>
  </ul>
</details>

<p>See <a href="file.CHANGELOG.html" title="CHANGELOG.md">CHANGELOG.md</a> for a list of releases.</p>

<h2 id="-license">üìÑ License</h2>

<p>The gem is available as open source under the terms of<br>
the <a href="file.LICENSE.html" title="MIT License">MIT License</a> <a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-259D6C.svg" alt="License: MIT"></a>.<br>
See <a href="file.LICENSE.html" title="LICENSE.txt">LICENSE.txt</a> for the official <a href="https://opensource.stackexchange.com/questions/5778/why-do-licenses-such-as-the-mit-license-specify-a-single-year">Copyright Notice</a>.</p>

<h3 id="-copyright">¬© Copyright</h3>

<ul>
    <li>
        Copyright (c) 2025-2026 Peter H.¬†Boling, of
        <a href="https://discord.gg/3qme4XHNKN">
            Galtzo.com
            <picture>
              <img src="https://logos.galtzo.com/assets/images/galtzo-floss/avatar-128px-blank.svg" alt="Galtzo.com Logo (Wordless) by Aboling0, CC BY-SA 4.0" width="24">
            </picture>
        </a>, and tree_haver contributors.
    </li>
</ul>

<h2 id="-a-request-for-help">ü§ë A request for help</h2>

<p>Maintainers have teeth and need to pay their dentists.<br>
After getting laid off in an RIF in March, and encountering difficulty finding a new one,<br>
I began spending most of my time building open source tools.<br>
I‚Äôm hoping to be able to pay for my kids‚Äô health insurance this month,<br>
so if you value the work I am doing, I need your support.<br>
Please consider sponsoring me or the project.</p>

<p>To join the community or get help üëáÔ∏è Join the Discord.</p>

<p><a href="https://discord.gg/3qme4XHNKN"><img src="https://img.shields.io/discord/1373797679469170758?style=for-the-badge&amp;logo=discord" alt="Live Chat on Discord"></a></p>

<p>To say ‚Äúthanks!‚Äù ‚òùÔ∏è Join the Discord or üëáÔ∏è send money.</p>

<p><a href="https://opencollective.com/kettle-rb"><img src="https://img.shields.io/opencollective/all/kettle-rb?style=for-the-badge" alt="Sponsor kettle-rb/tree_haver on Open Source Collective"></a> üíå <a href="https://github.com/sponsors/pboling"><img src="https://img.shields.io/badge/Sponsor_Me!-pboling-blue?style=for-the-badge&amp;logo=github" alt="Sponsor me on GitHub Sponsors"></a> üíå <a href="https://liberapay.com/pboling/donate"><img src="https://img.shields.io/liberapay/goal/pboling.svg?style=for-the-badge&amp;logo=liberapay&amp;color=a51611" alt="Sponsor me on Liberapay"></a> üíå <a href="https://www.paypal.com/paypalme/peterboling"><img src="https://img.shields.io/badge/donate-paypal-a51611.svg?style=for-the-badge&amp;logo=paypal&amp;color=0A0A0A" alt="Donate on PayPal"></a></p>

<h3 id="please-give-the-project-a-star--">Please give the project a star ‚≠ê ‚ô•.</h3>

<p>Thanks for RTFM. ‚ò∫Ô∏è</p>

</div></div>

      <div id="footer">
  Generated on Tue Jan  6 04:46:42 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.0).
</div>

    </div>
  </body>
</html>