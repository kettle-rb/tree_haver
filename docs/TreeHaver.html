<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: TreeHaver
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "TreeHaver";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (T)</a> &raquo;
    
    
    <span class="title">TreeHaver</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: TreeHaver
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/tree_haver.rb<span class="defines">,<br />
  lib/tree_haver/node.rb,<br /> lib/tree_haver/tree.rb,<br /> lib/tree_haver/point.rb,<br /> lib/tree_haver/version.rb,<br /> lib/tree_haver/backends/ffi.rb,<br /> lib/tree_haver/backends/mri.rb,<br /> lib/tree_haver/backends/java.rb,<br /> lib/tree_haver/backends/rust.rb,<br /> lib/tree_haver/backends/prism.rb,<br /> lib/tree_haver/backends/psych.rb,<br /> lib/tree_haver/grammar_finder.rb,<br /> lib/tree_haver/path_validator.rb,<br /> lib/tree_haver/backends/citrus.rb,<br /> lib/tree_haver/backends/markly.rb,<br /> lib/tree_haver/language_registry.rb,<br /> lib/tree_haver/backends/commonmarker.rb,<br /> lib/tree_haver/citrus_grammar_finder.rb,<br /> lib/tree_haver/rspec/dependency_tags.rb</span>
</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>TreeHaver is a cross-Ruby adapter for code parsing with 10 backends.</p>

<p>Provides a unified API for parsing source code across MRI Ruby, JRuby, and TruffleRuby<br />
using tree-sitter grammars or language-specific native parsers.</p>

<p>== Backends</p>

<p>Supports 10 backends:</p>
<ul>
  <li>Tree-sitter: MRI (C), Rust, FFI, Java</li>
  <li>Native parsers: Prism (Ruby), Psych (YAML), Commonmarker (Markdown), Markly (GFM)</li>
  <li>Pure Ruby: Citrus (portable fallback)</li>
</ul>

<p>== Platform Compatibility</p>

<p>Not all backends work on all Ruby platforms:</p>

<table>
  <thead>
    <tr>
      <th>Backend</th>
      <th>MRI</th>
      <th>JRuby</th>
      <th>TruffleRuby</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MRI (C ext)</td>
      <td>✓</td>
      <td>✗</td>
      <td>✗</td>
    </tr>
    <tr>
      <td>Rust</td>
      <td>✓</td>
      <td>✗</td>
      <td>✗</td>
    </tr>
    <tr>
      <td>FFI</td>
      <td>✓</td>
      <td>✓</td>
      <td>✗</td>
    </tr>
    <tr>
      <td>Java</td>
      <td>✗</td>
      <td>✓</td>
      <td>✗</td>
    </tr>
    <tr>
      <td>Prism</td>
      <td>✓</td>
      <td>✓</td>
      <td>✓</td>
    </tr>
    <tr>
      <td>Psych</td>
      <td>✓</td>
      <td>✓</td>
      <td>✓</td>
    </tr>
    <tr>
      <td>Citrus</td>
      <td>✓</td>
      <td>✓</td>
      <td>✓</td>
    </tr>
    <tr>
      <td>Commonmarker</td>
      <td>✓</td>
      <td>✗</td>
      <td>?</td>
    </tr>
    <tr>
      <td>Markly</td>
      <td>✓</td>
      <td>✗</td>
      <td>?</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>JRuby: Cannot load native C/Rust extensions; use FFI, Java, or pure Ruby backends</li>
  <li>TruffleRuby: FFI doesn’t support STRUCT_BY_VALUE; magnus/rb-sys incompatible with C API;<br />
use Prism, Psych, Citrus, or potentially Commonmarker/Markly</li>
</ul>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Basic usage with tree-sitter</p>
</div></h5>
      
      <pre class="example code"><code><span class='comment'># Load a language grammar
</span><span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Language.html" title="TreeHaver::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_from_library'><span class='object_link'><a href="TreeHaver/Language.html#from_library-class_method" title="TreeHaver::Language.from_library (method)">from_library</a></span></span><span class='lparen'>(</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/usr/local/lib/libtree-sitter-toml.so</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>symbol:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tree_sitter_toml</span><span class='tstring_end'>&quot;</span></span>
<span class='rparen'>)</span>

<span class='comment'># Create and configure a parser
</span><span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>
<span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='id identifier rubyid_language'>language</span>

<span class='comment'># Parse source code
</span><span class='id identifier rubyid_tree'>tree</span> <span class='op'>=</span> <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[package]\nname = \&quot;my-app\&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_root'><span class='object_link'><a href="top-level-namespace.html" title="Top Level Namespace (root)">root</a></span></span> <span class='op'>=</span> <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_root_node'>root_node</span>

<span class='comment'># Use unified Position API (works across all backends)
</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_root'><span class='object_link'><a href="top-level-namespace.html" title="Top Level Namespace (root)">root</a></span></span><span class='period'>.</span><span class='id identifier rubyid_start_line'>start_line</span>      <span class='comment'># =&gt; 1 (1-based)
</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_root'><span class='object_link'><a href="top-level-namespace.html" title="Top Level Namespace (root)">root</a></span></span><span class='period'>.</span><span class='id identifier rubyid_source_position'>source_position</span> <span class='comment'># =&gt; {start_line:, end_line:, start_column:, end_column:}</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Using language-specific backends</p>
</div></h5>
      
      <pre class="example code"><code><span class='comment'># Parse Ruby with Prism
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:prism</span>
<span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>
<span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Prism.html" title="TreeHaver::Backends::Prism (module)">Prism</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Prism/Language.html" title="TreeHaver::Backends::Prism::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_ruby'><span class='object_link'><a href="TreeHaver/Backends/Prism/Language.html#ruby-class_method" title="TreeHaver::Backends::Prism::Language.ruby (method)">ruby</a></span></span>
<span class='id identifier rubyid_tree'>tree</span> <span class='op'>=</span> <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>class Example; end</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='comment'># Parse YAML with Psych
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:psych</span>
<span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>
<span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Psych.html" title="TreeHaver::Backends::Psych (module)">Psych</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Psych/Language.html" title="TreeHaver::Backends::Psych::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_yaml'><span class='object_link'><a href="TreeHaver/Backends/Psych/Language.html#yaml-class_method" title="TreeHaver::Backends::Psych::Language.yaml (method)">yaml</a></span></span>
<span class='id identifier rubyid_tree'>tree</span> <span class='op'>=</span> <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key: value</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

<span class='comment'># Parse Markdown with Commonmarker
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:commonmarker</span>
<span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>
<span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Commonmarker.html" title="TreeHaver::Backends::Commonmarker (module)">Commonmarker</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Commonmarker/Language.html" title="TreeHaver::Backends::Commonmarker::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_markdown'><span class='object_link'><a href="TreeHaver/Backends/Commonmarker/Language.html#markdown-class_method" title="TreeHaver::Backends::Commonmarker::Language.markdown (method)">markdown</a></span></span>
<span class='id identifier rubyid_tree'>tree</span> <span class='op'>=</span> <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'># Heading\nParagraph</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Using language registration</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_register_language'><span class='object_link'><a href="#register_language-class_method" title="TreeHaver.register_language (method)">register_language</a></span></span><span class='lparen'>(</span><span class='symbol'>:toml</span><span class='comma'>,</span> <span class='label'>path:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/usr/local/lib/libtree-sitter-toml.so</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Language.html" title="TreeHaver::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_toml'>toml</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Using GrammarFinder for automatic discovery</p>
</div></h5>
      
      <pre class="example code"><code><span class='comment'># GrammarFinder automatically locates grammar libraries on the system
</span><span class='id identifier rubyid_finder'>finder</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/GrammarFinder.html" title="TreeHaver::GrammarFinder (class)">GrammarFinder</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/GrammarFinder.html#initialize-instance_method" title="TreeHaver::GrammarFinder#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:toml</span><span class='rparen'>)</span>
<span class='id identifier rubyid_finder'>finder</span><span class='period'>.</span><span class='id identifier rubyid_register!'>register!</span> <span class='kw'>if</span> <span class='id identifier rubyid_finder'>finder</span><span class='period'>.</span><span class='id identifier rubyid_available?'>available?</span>
<span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'>TreeHaver</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Language.html" title="TreeHaver::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_toml'>toml</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Selecting a backend</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:mri</span>          <span class='comment'># Force MRI (ruby_tree_sitter)
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:rust</span>         <span class='comment'># Force Rust (tree_stump)
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:ffi</span>          <span class='comment'># Force FFI
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:java</span>         <span class='comment'># Force Java (JRuby)
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:prism</span>        <span class='comment'># Force Prism (Ruby)
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:psych</span>        <span class='comment'># Force Psych (YAML)
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:commonmarker</span> <span class='comment'># Force Commonmarker (Markdown)
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:markly</span>       <span class='comment'># Force Markly (GFM)
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:citrus</span>       <span class='comment'># Force Citrus (pure Ruby)
</span><span class='const'>TreeHaver</span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:auto</span>         <span class='comment'># Auto-select (default)</span></code></pre>
    
  </div>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://tree-sitter.github.io/tree-sitter/" target="_parent" title="tree-sitter documentation">tree-sitter documentation</a></li>
    
      <li><span class='object_link'><a href="TreeHaver/GrammarFinder.html" title="TreeHaver::GrammarFinder (class)">For automatic grammar library discovery</a></span></li>
    
      <li><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">For available parsing backends</a></span></li>
    
  </ul>

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span>, <span class='object_link'><a href="TreeHaver/LanguageRegistry.html" title="TreeHaver::LanguageRegistry (module)">LanguageRegistry</a></span>, <span class='object_link'><a href="TreeHaver/PathValidator.html" title="TreeHaver::PathValidator (module)">PathValidator</a></span>, <span class='object_link'><a href="TreeHaver/RSpec.html" title="TreeHaver::RSpec (module)">RSpec</a></span>, <span class='object_link'><a href="TreeHaver/Version.html" title="TreeHaver::Version (module)">Version</a></span>
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="TreeHaver/BackendConflict.html" title="TreeHaver::BackendConflict (class)">BackendConflict</a></span>, <span class='object_link'><a href="TreeHaver/CitrusGrammarFinder.html" title="TreeHaver::CitrusGrammarFinder (class)">CitrusGrammarFinder</a></span>, <span class='object_link'><a href="TreeHaver/Error.html" title="TreeHaver::Error (class)">Error</a></span>, <span class='object_link'><a href="TreeHaver/GrammarFinder.html" title="TreeHaver::GrammarFinder (class)">GrammarFinder</a></span>, <span class='object_link'><a href="TreeHaver/Language.html" title="TreeHaver::Language (class)">Language</a></span>, <span class='object_link'><a href="TreeHaver/Node.html" title="TreeHaver::Node (class)">Node</a></span>, <span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span>, <span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span>, <span class='object_link'><a href="TreeHaver/Point.html" title="TreeHaver::Point (class)">Point</a></span>, <span class='object_link'><a href="TreeHaver/Tree.html" title="TreeHaver::Tree (class)">Tree</a></span>
    
  
</p>

  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="CITRUS_DEFAULTS-constant" class="">CITRUS_DEFAULTS =
          <div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This constant is part of a private API.</strong>
  You should avoid using this constant if possible, as it may be removed or be changed in the future.
</p>
<p>Default Citrus configurations for known languages</p>

<p>These are used by <span class='object_link'><a href="#parser_for-class_method" title="TreeHaver.parser_for (method)">parser_for</a></span> when no explicit citrus_config is provided<br />
and tree-sitter backends are not available (e.g., on TruffleRuby).</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='label'>toml:</span> <span class='lbrace'>{</span>
    <span class='label'>gem_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>toml-rb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>grammar_const:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TomlRB::Document</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>require_path:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>toml-rb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='rbrace'>}</span><span class='comma'>,</span>
<span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
        <dt id="NATIVE_BACKENDS-constant" class="">NATIVE_BACKENDS =
          <div class="docstring">
  <div class="discussion">
    <p>Native tree-sitter backends that support loading shared libraries (.so files)<br />
These backends wrap the tree-sitter C library via various bindings.<br />
Pure Ruby backends (Citrus, Prism, Psych, Commonmarker, Markly) are excluded.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='qsymbols_beg'>%i[</span><span class='tstring_content'>mri</span><span class='words_sep'> </span><span class='tstring_content'>rust</span><span class='words_sep'> </span><span class='tstring_content'>ffi</span><span class='words_sep'> </span><span class='tstring_content'>java</span><span class='tstring_end'>]</span></span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
        <dt id="VERSION-constant" class="">VERSION =
          <div class="docstring">
  <div class="discussion">
    <p>Traditional location for VERSION constant</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the version string</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='const'><span class='object_link'><a href="TreeHaver/Version.html" title="TreeHaver::Version (module)">Version</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Version.html#VERSION-constant" title="TreeHaver::Version::VERSION (constant)">VERSION</a></span></span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#backend-class_method" title="backend (class method)">.<strong>backend</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#backend=-class_method" title="backend= (class method)">.<strong>backend=</strong>(name)  &#x21d2; Symbol<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Set the backend to use.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#backend_module-class_method" title="backend_module (class method)">.<strong>backend_module</strong>  &#x21d2; Module<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Determine the concrete backend module to use.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#backend_protect-class_method" title="backend_protect (class method)">.<strong>backend_protect</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Alias for backend_protect?.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#backend_protect=-class_method" title="backend_protect= (class method)">.<strong>backend_protect=</strong>(value)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Whether backend conflict protection is enabled.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#backend_protect%3F-class_method" title="backend_protect? (class method)">.<strong>backend_protect?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Check if backend conflict protection is enabled.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#backends_used-class_method" title="backends_used (class method)">.<strong>backends_used</strong>  &#x21d2; Set&lt;Symbol&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Track which backends have been used in this process.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#capabilities-class_method" title="capabilities (class method)">.<strong>capabilities</strong>  &#x21d2; Hash{Symbol =&gt; Object} </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Get capabilities of the current backend.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_backend_conflict!-class_method" title="check_backend_conflict! (class method)">.<strong>check_backend_conflict!</strong>(backend)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Check if using a backend would cause a conflict.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#conflicting_backends_for-class_method" title="conflicting_backends_for (class method)">.<strong>conflicting_backends_for</strong>(backend)  &#x21d2; Array&lt;Symbol&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Check if a backend would conflict with previously used backends.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#current_backend_context-class_method" title="current_backend_context (class method)">.<strong>current_backend_context</strong>  &#x21d2; Hash{Symbol =&gt; Object} </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Thread-local backend context storage.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#effective_backend-class_method" title="effective_backend (class method)">.<strong>effective_backend</strong>  &#x21d2; Symbol </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Get the effective backend for current context.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parser_for-class_method" title="parser_for (class method)">.<strong>parser_for</strong>(language_name, library_path: nil, symbol: nil, citrus_config: nil)  &#x21d2; TreeHaver::Parser </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Create a parser configured for a specific language.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#record_backend_usage-class_method" title="record_backend_usage (class method)">.<strong>record_backend_usage</strong>(backend)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'><p>Record that a backend has been used.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#register_language-class_method" title="register_language (class method)">.<strong>register_language</strong>(name, path: nil, symbol: nil, grammar_module: nil, gem_name: nil)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Register a language helper by name (backend-agnostic).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#registered_language-class_method" title="registered_language (class method)">.<strong>registered_language</strong>(name)  &#x21d2; Hash<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'><p>Fetch a registered language entry.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reset_backend!-class_method" title="reset_backend! (class method)">.<strong>reset_backend!</strong>(to: :auto)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Reset backend selection memoization.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#resolve_backend_module-class_method" title="resolve_backend_module (class method)">.<strong>resolve_backend_module</strong>(explicit_backend = nil)  &#x21d2; Module<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Get backend module for a specific backend (with explicit override).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#resolve_effective_backend-class_method" title="resolve_effective_backend (class method)">.<strong>resolve_effective_backend</strong>(explicit_backend = nil)  &#x21d2; Symbol </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Resolve the effective backend considering explicit override.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#resolve_native_backend_module-class_method" title="resolve_native_backend_module (class method)">.<strong>resolve_native_backend_module</strong>(explicit_backend = nil)  &#x21d2; Module<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Resolve a native tree-sitter backend module (for from_library).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#with_backend-class_method" title="with_backend (class method)">.<strong>with_backend</strong>(name) { ... } &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Execute a block with a specific backend in thread-local context.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="backend-class_method">
  
    .<strong>backend</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_backend'>backend</span>  <span class='comment'># =&gt; :auto</span></code></pre>
    
  </div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


338
339
340
341
342
343
344
345
346
347
348
349
350
351</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 338</span>

<span class='kw'>def</span> <span class='id identifier rubyid_backend'>backend</span>
  <span class='ivar'>@backend</span> <span class='op'>||=</span> <span class='kw'>case</span> <span class='lparen'>(</span><span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TREE_HAVER_BACKEND</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='symbol'>:auto</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='comment'># rubocop:disable ThreadSafety/ClassInstanceVariable
</span>  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>mri</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:mri</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rust</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:rust</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ffi</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:ffi</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>java</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:java</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>citrus</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:citrus</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prism</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:prism</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>psych</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:psych</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>commonmarker</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:commonmarker</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>markly</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='symbol'>:markly</span>
  <span class='kw'>else</span> <span class='symbol'>:auto</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="backend=-class_method">
  
    .<strong>backend=</strong>(name)  &#x21d2; <tt>Symbol</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Set the backend to use</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Force FFI backend</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:ffi</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Force Rust backend</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_backend'><span class='object_link'><a href="#backend-class_method" title="TreeHaver.backend (method)">backend</a></span></span> <span class='op'>=</span> <span class='symbol'>:rust</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>backend name (:auto, :mri, :rust, :ffi, :java, :citrus)</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend that was set</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


361
362
363</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 361</span>

<span class='kw'>def</span> <span class='id identifier rubyid_backend='>backend=</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='ivar'>@backend</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='comment'># rubocop:disable ThreadSafety/ClassInstanceVariable
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="backend_module-class_method">
  
    .<strong>backend_module</strong>  &#x21d2; <tt>Module</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Determine the concrete backend module to use</p>

<p>This method performs backend auto-selection when backend is :auto.<br />
On JRuby, prefers Java backend if available, then FFI, then Citrus.<br />
On MRI, prefers MRI backend if available, then Rust, then FFI, then Citrus.<br />
Citrus is the final fallback as it’s pure Ruby and works everywhere.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_mod'>mod</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_backend_module'>backend_module</span>
<span class='kw'>if</span> <span class='id identifier rubyid_mod'>mod</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Using </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_mod'>mod</span><span class='period'>.</span><span class='id identifier rubyid_capabilities'>capabilities</span><span class='lbracket'>[</span><span class='symbol'>:backend</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> backend</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Module</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend module (Backends::MRI, Backends::Rust, Backends::FFI, Backends::Java, or Backends::Citrus), or nil if none available</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 657</span>

<span class='kw'>def</span> <span class='id identifier rubyid_backend_module'>backend_module</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_effective_backend'>effective_backend</span>  <span class='comment'># Changed from: backend
</span>  <span class='kw'>when</span> <span class='symbol'>:mri</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/MRI.html" title="TreeHaver::Backends::MRI (module)">MRI</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:rust</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Rust.html" title="TreeHaver::Backends::Rust (module)">Rust</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:ffi</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/FFI.html" title="TreeHaver::Backends::FFI (module)">FFI</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:java</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Java.html" title="TreeHaver::Backends::Java (module)">Java</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:citrus</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Citrus.html" title="TreeHaver::Backends::Citrus (module)">Citrus</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:prism</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Prism.html" title="TreeHaver::Backends::Prism (module)">Prism</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:psych</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Psych.html" title="TreeHaver::Backends::Psych (module)">Psych</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:commonmarker</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Commonmarker.html" title="TreeHaver::Backends::Commonmarker (module)">Commonmarker</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:markly</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Markly.html" title="TreeHaver::Backends::Markly (module)">Markly</a></span></span>
  <span class='kw'>else</span>
    <span class='comment'># auto-select: prefer native/fast backends, fall back to pure Ruby (Citrus)
</span>    <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'>RUBY_ENGINE</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'>RUBY_ENGINE</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>jruby</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Java.html" title="TreeHaver::Backends::Java (module)">Java</a></span></span><span class='period'>.</span><span class='id identifier rubyid_available?'><span class='object_link'><a href="TreeHaver/Backends/Java.html#available%3F-class_method" title="TreeHaver::Backends::Java.available? (method)">available?</a></span></span>
      <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Java.html" title="TreeHaver::Backends::Java (module)">Java</a></span></span>
    <span class='kw'>elsif</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'>RUBY_ENGINE</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'>RUBY_ENGINE</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/MRI.html" title="TreeHaver::Backends::MRI (module)">MRI</a></span></span><span class='period'>.</span><span class='id identifier rubyid_available?'><span class='object_link'><a href="TreeHaver/Backends/MRI.html#available%3F-class_method" title="TreeHaver::Backends::MRI.available? (method)">available?</a></span></span>
      <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/MRI.html" title="TreeHaver::Backends::MRI (module)">MRI</a></span></span>
    <span class='kw'>elsif</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'>RUBY_ENGINE</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'>RUBY_ENGINE</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Rust.html" title="TreeHaver::Backends::Rust (module)">Rust</a></span></span><span class='period'>.</span><span class='id identifier rubyid_available?'><span class='object_link'><a href="TreeHaver/Backends/Rust.html#available%3F-class_method" title="TreeHaver::Backends::Rust.available? (method)">available?</a></span></span>
      <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Rust.html" title="TreeHaver::Backends::Rust (module)">Rust</a></span></span>
    <span class='kw'>elsif</span> <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/FFI.html" title="TreeHaver::Backends::FFI (module)">FFI</a></span></span><span class='period'>.</span><span class='id identifier rubyid_available?'><span class='object_link'><a href="TreeHaver/Backends/FFI.html#available%3F-class_method" title="TreeHaver::Backends::FFI.available? (method)">available?</a></span></span>
      <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/FFI.html" title="TreeHaver::Backends::FFI (module)">FFI</a></span></span>
    <span class='kw'>elsif</span> <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Citrus.html" title="TreeHaver::Backends::Citrus (module)">Citrus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_available?'><span class='object_link'><a href="TreeHaver/Backends/Citrus.html#available%3F-class_method" title="TreeHaver::Backends::Citrus.available? (method)">available?</a></span></span>
      <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Citrus.html" title="TreeHaver::Backends::Citrus (module)">Citrus</a></span></span>  <span class='comment'># Pure Ruby fallback
</span>    <span class='kw'>else</span>
      <span class='comment'># No backend available
</span>      <span class='kw'>nil</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="backend_protect-class_method">
  
    .<strong>backend_protect</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Alias for backend_protect?</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


290
291
292</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 290</span>

<span class='kw'>def</span> <span class='id identifier rubyid_backend_protect'>backend_protect</span>
  <span class='id identifier rubyid_backend_protect?'>backend_protect?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="backend_protect=-class_method">
  
    .<strong>backend_protect=</strong>(value)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Whether backend conflict protection is enabled</p>

<p>When true (default), TreeHaver will raise BackendConflict if you try to<br />
use a backend that is known to conflict with a previously used backend.<br />
For example, FFI will not work after MRI has been used.</p>

<p>Set to false to disable protection (useful for testing compatibility).</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Disable protection for testing</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_backend_protect'><span class='object_link'><a href="#backend_protect-class_method" title="TreeHaver.backend_protect (method)">backend_protect</a></span></span> <span class='op'>=</span> <span class='kw'>false</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


276
277
278
279</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 276</span>

<span class='kw'>def</span> <span class='id identifier rubyid_backend_protect='>backend_protect=</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
  <span class='ivar'>@backend_protect_mutex</span> <span class='op'>||=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@backend_protect_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span> <span class='ivar'>@backend_protect</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="backend_protect?-class_method">
  
    .<strong>backend_protect?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Check if backend conflict protection is enabled</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if protection is enabled (default)</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


284
285
286
287</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 284</span>

<span class='kw'>def</span> <span class='id identifier rubyid_backend_protect?'>backend_protect?</span>
  <span class='kw'>return</span> <span class='ivar'>@backend_protect</span> <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='ivar'>@backend_protect</span><span class='rparen'>)</span> <span class='comment'># rubocop:disable ThreadSafety/ClassInstanceVariable
</span>  <span class='kw'>true</span>  <span class='comment'># Default is protected
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="backends_used-class_method">
  
    .<strong>backends_used</strong>  &#x21d2; <tt>Set&lt;Symbol&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Track which backends have been used in this process</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Set&lt;Symbol&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>set of backend symbols that have been used</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


297
298
299</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 297</span>

<span class='kw'>def</span> <span class='id identifier rubyid_backends_used'>backends_used</span>
  <span class='ivar'>@backends_used</span> <span class='op'>||=</span> <span class='const'>Set</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='comment'># rubocop:disable ThreadSafety/ClassInstanceVariable
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="capabilities-class_method">
  
    .<strong>capabilities</strong>  &#x21d2; <tt>Hash{Symbol =&gt; Object}</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Get capabilities of the current backend</p>

<p>Returns a hash describing what features the selected backend supports.<br />
Common keys include:</p>
<ul>
  <li>:backend - Symbol identifying the backend (:mri, :rust, :ffi, :java)</li>
  <li>:parse - Whether parsing is implemented</li>
  <li>:query - Whether the Query API is available</li>
  <li>:bytes_field - Whether byte position fields are available</li>
  <li>:incremental - Whether incremental parsing is supported</li>
</ul>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_capabilities'>capabilities</span>
<span class='comment'># =&gt; { backend: :mri, query: true, bytes_field: true }</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash{Symbol =&gt; Object}</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>capability map, or empty hash if no backend available</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


710
711
712
713
714</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 710</span>

<span class='kw'>def</span> <span class='id identifier rubyid_capabilities'>capabilities</span>
  <span class='id identifier rubyid_mod'>mod</span> <span class='op'>=</span> <span class='id identifier rubyid_backend_module'>backend_module</span>
  <span class='kw'>return</span> <span class='lbrace'>{</span><span class='rbrace'>}</span> <span class='kw'>unless</span> <span class='id identifier rubyid_mod'>mod</span>
  <span class='id identifier rubyid_mod'>mod</span><span class='period'>.</span><span class='id identifier rubyid_capabilities'>capabilities</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_backend_conflict!-class_method">
  
    .<strong>check_backend_conflict!</strong>(backend)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Check if using a backend would cause a conflict</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>backend</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend to check</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TreeHaver/BackendConflict.html" title="TreeHaver::BackendConflict (class)">BackendConflict</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if protection is enabled and there’s a conflict</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


324
325
326
327
328
329
330
331
332
333
334</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 324</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_backend_conflict!'>check_backend_conflict!</span><span class='lparen'>(</span><span class='id identifier rubyid_backend'>backend</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_backend_protect?'>backend_protect?</span>

  <span class='id identifier rubyid_conflicts'>conflicts</span> <span class='op'>=</span> <span class='id identifier rubyid_conflicting_backends_for'>conflicting_backends_for</span><span class='lparen'>(</span><span class='id identifier rubyid_backend'>backend</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_conflicts'>conflicts</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="TreeHaver/BackendConflict.html" title="TreeHaver::BackendConflict (class)">BackendConflict</a></span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot use </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_backend'>backend</span><span class='embexpr_end'>}</span><span class='tstring_content'> backend: it is blocked by previously used backend(s): </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_conflicts'>conflicts</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>. </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_backend'>backend</span><span class='embexpr_end'>}</span><span class='tstring_content'> backend will segfault when </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_conflicts'>conflicts</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='embexpr_end'>}</span><span class='tstring_content'> has already loaded. </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>To disable this protection (at risk of segfaults), set TreeHaver.backend_protect = false</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="conflicting_backends_for-class_method">
  
    .<strong>conflicting_backends_for</strong>(backend)  &#x21d2; <tt>Array&lt;Symbol&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Check if a backend would conflict with previously used backends</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>backend</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend to check</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;Symbol&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>list of previously used backends that block this one</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


314
315
316
317</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 314</span>

<span class='kw'>def</span> <span class='id identifier rubyid_conflicting_backends_for'>conflicting_backends_for</span><span class='lparen'>(</span><span class='id identifier rubyid_backend'>backend</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_blockers'>blockers</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends.html#BLOCKED_BY-constant" title="TreeHaver::Backends::BLOCKED_BY (constant)">BLOCKED_BY</a></span></span><span class='lbracket'>[</span><span class='id identifier rubyid_backend'>backend</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_blockers'>blockers</span> <span class='op'>&amp;</span> <span class='id identifier rubyid_backends_used'>backends_used</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="current_backend_context-class_method">
  
    .<strong>current_backend_context</strong>  &#x21d2; <tt>Hash{Symbol =&gt; Object}</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Thread-local backend context storage</p>

<p>Returns a hash containing the thread-local backend context with keys:</p>
<ul>
  <li>:backend - The backend name (Symbol) or nil if using global default</li>
  <li>:depth - The nesting depth (Integer) for proper cleanup</li>
</ul>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_ctx'>ctx</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_current_backend_context'>current_backend_context</span>
<span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:backend</span><span class='rbracket'>]</span>  <span class='comment'># =&gt; nil or :ffi, :mri, etc.
</span><span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:depth</span><span class='rbracket'>]</span>    <span class='comment'># =&gt; 0, 1, 2, etc.</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash{Symbol =&gt; Object}</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>context hash with :backend and :depth keys</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


390
391
392
393
394
395</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 390</span>

<span class='kw'>def</span> <span class='id identifier rubyid_current_backend_context'>current_backend_context</span>
  <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:tree_haver_backend_context</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lbrace'>{</span>
    <span class='label'>backend:</span> <span class='kw'>nil</span><span class='comma'>,</span>  <span class='comment'># nil means &quot;use global default&quot;
</span>    <span class='label'>depth:</span> <span class='int'>0</span><span class='comma'>,</span>       <span class='comment'># Track nesting depth for proper cleanup
</span>  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="effective_backend-class_method">
  
    .<strong>effective_backend</strong>  &#x21d2; <tt>Symbol</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Get the effective backend for current context</p>

<p>Priority: thread-local context → global @backend → :auto</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_effective_backend'>effective_backend</span>  <span class='comment'># =&gt; :auto (default)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>With thread-local context</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_with_backend'><span class='object_link'><a href="#with_backend-class_method" title="TreeHaver.with_backend (method)">with_backend</a></span></span><span class='lparen'>(</span><span class='symbol'>:ffi</span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_effective_backend'>effective_backend</span>  <span class='comment'># =&gt; :ffi
</span><span class='kw'>end</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend to use</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


408
409
410
411</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 408</span>

<span class='kw'>def</span> <span class='id identifier rubyid_effective_backend'>effective_backend</span>
  <span class='id identifier rubyid_ctx'>ctx</span> <span class='op'>=</span> <span class='id identifier rubyid_current_backend_context'>current_backend_context</span>
  <span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:backend</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_backend'>backend</span> <span class='op'>||</span> <span class='symbol'>:auto</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="parser_for-class_method">
  
    .<strong>parser_for</strong>(language_name, library_path: nil, symbol: nil, citrus_config: nil)  &#x21d2; <tt><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">TreeHaver::Parser</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Create a parser configured for a specific language</p>

<p>This is the recommended high-level API for creating a parser. It handles:</p>
<ol>
  <li>Checking if the language is already registered</li>
  <li>Auto-discovering tree-sitter grammar via GrammarFinder</li>
  <li>Falling back to Citrus grammar if tree-sitter is unavailable</li>
  <li>Creating and configuring the parser</li>
</ol>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Basic usage (auto-discovers grammar)</p>
</div></h5>
      
      <pre class="example code"><code><span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parser_for'>parser_for</span><span class='lparen'>(</span><span class='symbol'>:toml</span><span class='rparen'>)</span>
<span class='id identifier rubyid_tree'>tree</span> <span class='op'>=</span> <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[package]\nname = \&quot;my-app\&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>With explicit library path</p>
</div></h5>
      
      <pre class="example code"><code><span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parser_for'>parser_for</span><span class='lparen'>(</span><span class='symbol'>:toml</span><span class='comma'>,</span> <span class='label'>library_path:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/custom/path/libtree-sitter-toml.so</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>With Citrus fallback configuration</p>
</div></h5>
      
      <pre class="example code"><code><span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parser_for'>parser_for</span><span class='lparen'>(</span><span class='symbol'>:toml</span><span class='comma'>,</span>
  <span class='label'>citrus_config:</span> <span class='lbrace'>{</span> <span class='label'>gem_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>toml-rb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>grammar_const:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TomlRB::Document</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>language_name</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the language to parse (e.g., :toml, :json, :bash)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>library_path</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>optional explicit path to tree-sitter grammar library</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>symbol</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>optional tree-sitter symbol name (defaults to “tree_sitter_<name>")</name></p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>citrus_config</span>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>optional Citrus fallback configuration</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    
    
    
    
    <p class="tag_title">Options Hash (<tt>citrus_config:</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:gem_name</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'><p>gem name for the Citrus grammar</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:grammar_const</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'><p>fully qualified constant name for grammar module</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">TreeHaver::Parser</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>configured parser with language set</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">TreeHaver::NotAvailable</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if no parser backend is available for the language</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892
893
894
895
896
897
898
899
900
901
902
903
904
905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930
931
932
933
934
935
936
937</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 856</span>

<span class='kw'>def</span> <span class='id identifier rubyid_parser_for'>parser_for</span><span class='lparen'>(</span><span class='id identifier rubyid_language_name'>language_name</span><span class='comma'>,</span> <span class='label'>library_path:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>symbol:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>citrus_config:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_language_name'>language_name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span>
  <span class='id identifier rubyid_symbol'>symbol</span> <span class='op'>||=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tree_sitter_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Step 1: Try to get the language (may already be registered)
</span>  <span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='kw'>begin</span>
    <span class='comment'># Check if already registered and loadable
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_registered_language'>registered_language</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
      <span class='const'><span class='object_link'><a href="TreeHaver/Language.html" title="TreeHaver::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_public_send'>public_send</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>path:</span> <span class='id identifier rubyid_library_path'>library_path</span><span class='comma'>,</span> <span class='label'>symbol:</span> <span class='id identifier rubyid_symbol'>symbol</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span></span><span class='comma'>,</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='const'>LoadError</span>
    <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='comment'># Step 2: If not registered, try GrammarFinder for tree-sitter
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_language'>language</span>
    <span class='comment'># Principle of Least Surprise: If user provides an explicit path,
</span>    <span class='comment'># it MUST exist. Don&#39;t silently fall back to auto-discovery.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_library_path'>library_path</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_library_path'>library_path</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='kw'>unless</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_exist?'>exist?</span><span class='lparen'>(</span><span class='id identifier rubyid_library_path'>library_path</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span></span><span class='comma'>,</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Specified parser path does not exist: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_library_path'>library_path</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_register_language'>register_language</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>path:</span> <span class='id identifier rubyid_library_path'>library_path</span><span class='comma'>,</span> <span class='label'>symbol:</span> <span class='id identifier rubyid_symbol'>symbol</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TreeHaver/Language.html" title="TreeHaver::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_public_send'>public_send</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span></span><span class='comma'>,</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='const'>LoadError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='comment'># Re-raise with more context since user explicitly provided this path
</span>        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span></span><span class='comma'>,</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to load parser from specified path </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_library_path'>library_path</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='comment'># Auto-discover via GrammarFinder (no explicit path provided)
</span>      <span class='kw'>begin</span>
        <span class='id identifier rubyid_finder'>finder</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TreeHaver/GrammarFinder.html" title="TreeHaver::GrammarFinder (class)">GrammarFinder</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/GrammarFinder.html#initialize-instance_method" title="TreeHaver::GrammarFinder#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_finder'>finder</span><span class='period'>.</span><span class='id identifier rubyid_available?'>available?</span>
          <span class='id identifier rubyid_finder'>finder</span><span class='period'>.</span><span class='id identifier rubyid_register!'>register!</span>
          <span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TreeHaver/Language.html" title="TreeHaver::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_public_send'>public_send</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span></span><span class='comma'>,</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='const'>LoadError</span>
        <span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Step 3: Try Citrus fallback if tree-sitter failed
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_language'>language</span>
    <span class='comment'># Use explicit config, or fall back to built-in defaults for known languages
</span>    <span class='id identifier rubyid_citrus_config'>citrus_config</span> <span class='op'>||=</span> <span class='const'><span class='object_link'><a href="#CITRUS_DEFAULTS-constant" title="TreeHaver::CITRUS_DEFAULTS (constant)">CITRUS_DEFAULTS</a></span></span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

    <span class='comment'># Only attempt if we have the required configuration
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_citrus_config'>citrus_config</span><span class='lbracket'>[</span><span class='symbol'>:gem_name</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_citrus_config'>citrus_config</span><span class='lbracket'>[</span><span class='symbol'>:grammar_const</span><span class='rbracket'>]</span>
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_citrus_finder'>citrus_finder</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TreeHaver/CitrusGrammarFinder.html" title="TreeHaver::CitrusGrammarFinder (class)">CitrusGrammarFinder</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/CitrusGrammarFinder.html#initialize-instance_method" title="TreeHaver::CitrusGrammarFinder#initialize (method)">new</a></span></span><span class='lparen'>(</span>
          <span class='label'>language:</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
          <span class='label'>gem_name:</span> <span class='id identifier rubyid_citrus_config'>citrus_config</span><span class='lbracket'>[</span><span class='symbol'>:gem_name</span><span class='rbracket'>]</span><span class='comma'>,</span>
          <span class='label'>grammar_const:</span> <span class='id identifier rubyid_citrus_config'>citrus_config</span><span class='lbracket'>[</span><span class='symbol'>:grammar_const</span><span class='rbracket'>]</span><span class='comma'>,</span>
          <span class='label'>require_path:</span> <span class='id identifier rubyid_citrus_config'>citrus_config</span><span class='lbracket'>[</span><span class='symbol'>:require_path</span><span class='rbracket'>]</span><span class='comma'>,</span>
        <span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_citrus_finder'>citrus_finder</span><span class='period'>.</span><span class='id identifier rubyid_available?'>available?</span>
          <span class='id identifier rubyid_citrus_finder'>citrus_finder</span><span class='period'>.</span><span class='id identifier rubyid_register!'>register!</span>
          <span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TreeHaver/Language.html" title="TreeHaver::Language (class)">Language</a></span></span><span class='period'>.</span><span class='id identifier rubyid_public_send'>public_send</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span></span><span class='comma'>,</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='const'>LoadError</span><span class='comma'>,</span> <span class='const'>NameError</span><span class='comma'>,</span> <span class='const'>TypeError</span>
        <span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Step 4: Raise if nothing worked
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_language'>language</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="TreeHaver/NotAvailable.html" title="TreeHaver::NotAvailable (class)">NotAvailable</a></span></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No parser available for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>. </span><span class='tstring_end'>&quot;</span></span> \
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Install tree-sitter-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> or the appropriate Ruby gem. </span><span class='tstring_end'>&quot;</span></span> \
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Set TREE_SITTER_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>_PATH for custom grammar location.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Step 5: Create and configure parser
</span>  <span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>
  <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_language'>language</span> <span class='op'>=</span> <span class='id identifier rubyid_language'>language</span>
  <span class='id identifier rubyid_parser'>parser</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="record_backend_usage-class_method">
  
    .<strong>record_backend_usage</strong>(backend)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>
<p class="note returns_void">This method returns an undefined value.</p><p>Record that a backend has been used</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>backend</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend that was used</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


306
307
308</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 306</span>

<span class='kw'>def</span> <span class='id identifier rubyid_record_backend_usage'>record_backend_usage</span><span class='lparen'>(</span><span class='id identifier rubyid_backend'>backend</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_backends_used'>backends_used</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_backend'>backend</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="register_language-class_method">
  
    .<strong>register_language</strong>(name, path: nil, symbol: nil, grammar_module: nil, gem_name: nil)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Register a language helper by name (backend-agnostic)</p>

<p>After registration, you can use dynamic helpers like <code>TreeHaver::Language.toml</code><br />
to load the registered language. TreeHaver will automatically use the appropriate<br />
grammar based on the active backend.</p>

<p>The <code>name</code> parameter is an arbitrary identifier you choose - it doesn’t need to<br />
match the actual language name. This is useful for:</p>
<ul>
  <li>Testing: Use unique names like <code>:toml_test</code> to avoid collisions</li>
  <li>Aliasing: Register the same grammar under multiple names</li>
  <li>Versioning: Register different grammar versions as <code>:ruby_2</code> and <code>:ruby_3</code></li>
</ul>

<p>The actual grammar identity comes from <code>path</code>/<code>symbol</code> (tree-sitter) or<br />
<code>grammar_module</code> (Citrus), not from the name.</p>

<p>IMPORTANT: This method INTENTIONALLY allows registering BOTH a tree-sitter<br />
library AND a Citrus grammar for the same language IN A SINGLE CALL.<br />
This is achieved by using separate <code>if</code> statements (not <code>elsif</code>) and no early<br />
returns. This design is deliberate and provides significant benefits:</p>

<p>Why register both backends for one language?</p>
<ul>
  <li>Backend flexibility: Code works regardless of which backend is active</li>
  <li>Performance testing: Compare tree-sitter vs Citrus performance</li>
  <li>Gradual migration: Transition between backends without breaking code</li>
  <li>Fallback scenarios: Use Citrus when tree-sitter library unavailable</li>
  <li>Platform portability: tree-sitter on Linux/Mac, Citrus on JRuby/Windows</li>
</ul>

<p>The active backend determines which registration is used automatically.<br />
No code changes needed to switch backends - just change TreeHaver.backend.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Register tree-sitter grammar only</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_register_language'>register_language</span><span class='lparen'>(</span>
  <span class='symbol'>:toml</span><span class='comma'>,</span>
  <span class='label'>path:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/usr/local/lib/libtree-sitter-toml.so</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>symbol:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tree_sitter_toml</span><span class='tstring_end'>&quot;</span></span>
<span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Register Citrus grammar only</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_register_language'>register_language</span><span class='lparen'>(</span>
  <span class='symbol'>:toml</span><span class='comma'>,</span>
  <span class='label'>grammar_module:</span> <span class='const'>TomlRB</span><span class='op'>::</span><span class='const'>Document</span><span class='comma'>,</span>
  <span class='label'>gem_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>toml-rb</span><span class='tstring_end'>&quot;</span></span>
<span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Register BOTH backends in separate calls</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_register_language'>register_language</span><span class='lparen'>(</span>
  <span class='symbol'>:toml</span><span class='comma'>,</span>
  <span class='label'>path:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/usr/local/lib/libtree-sitter-toml.so</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>symbol:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tree_sitter_toml</span><span class='tstring_end'>&quot;</span></span>
<span class='rparen'>)</span>
<span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_register_language'>register_language</span><span class='lparen'>(</span>
  <span class='symbol'>:toml</span><span class='comma'>,</span>
  <span class='label'>grammar_module:</span> <span class='const'>TomlRB</span><span class='op'>::</span><span class='const'>Document</span><span class='comma'>,</span>
  <span class='label'>gem_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>toml-rb</span><span class='tstring_end'>&quot;</span></span>
<span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Register BOTH backends in ONE call (recommended for maximum flexibility)</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_register_language'>register_language</span><span class='lparen'>(</span>
  <span class='symbol'>:toml</span><span class='comma'>,</span>
  <span class='label'>path:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/usr/local/lib/libtree-sitter-toml.so</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>symbol:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tree_sitter_toml</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='label'>grammar_module:</span> <span class='const'>TomlRB</span><span class='op'>::</span><span class='const'>Document</span><span class='comma'>,</span>
  <span class='label'>gem_name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>toml-rb</span><span class='tstring_end'>&quot;</span></span>
<span class='rparen'>)</span>
<span class='comment'># Now TreeHaver::Language.toml works with ANY backend!</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>identifier for this registration (can be any name you choose)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>path</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>absolute path to the language shared library (for tree-sitter)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>symbol</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>optional exported factory symbol (e.g., “tree_sitter_toml”)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>grammar_module</span>
      
      
        <span class='type'>(<tt>Module</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Citrus grammar module that responds to .parse(source)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>gem_name</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>optional gem name for error messages</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 789</span>

<span class='kw'>def</span> <span class='id identifier rubyid_register_language'>register_language</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>path:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>symbol:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>grammar_module:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>gem_name:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># Register tree-sitter backend if path provided
</span>  <span class='comment'># Note: Uses `if` not `elsif` so both backends can be registered in one call
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_path'>path</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/LanguageRegistry.html" title="TreeHaver::LanguageRegistry (module)">LanguageRegistry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_register'><span class='object_link'><a href="TreeHaver/LanguageRegistry.html#register-class_method" title="TreeHaver::LanguageRegistry.register (method)">register</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='symbol'>:tree_sitter</span><span class='comma'>,</span> <span class='label'>path:</span> <span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='label'>symbol:</span> <span class='id identifier rubyid_symbol'>symbol</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Register Citrus backend if grammar_module provided
</span>  <span class='comment'># Note: Uses `if` not `elsif` so both backends can be registered in one call
</span>  <span class='comment'># This allows maximum flexibility - register once, use with any backend
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_grammar_module'>grammar_module</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_grammar_module'>grammar_module</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:parse</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Grammar module must respond to :parse</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='const'><span class='object_link'><a href="TreeHaver/LanguageRegistry.html" title="TreeHaver::LanguageRegistry (module)">LanguageRegistry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_register'><span class='object_link'><a href="TreeHaver/LanguageRegistry.html#register-class_method" title="TreeHaver::LanguageRegistry.register (method)">register</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='symbol'>:citrus</span><span class='comma'>,</span> <span class='label'>grammar_module:</span> <span class='id identifier rubyid_grammar_module'>grammar_module</span><span class='comma'>,</span> <span class='label'>gem_name:</span> <span class='id identifier rubyid_gem_name'>gem_name</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Require at least one backend to be registered
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_path'>path</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_grammar_module'>grammar_module</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must provide at least one of: path (tree-sitter) or grammar_module (Citrus)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Note: No early return! This method intentionally processes both `if` blocks
</span>  <span class='comment'># above to allow registering multiple backends for the same language.
</span>  <span class='comment'># Both tree-sitter and Citrus can be registered simultaneously for maximum
</span>  <span class='comment'># flexibility. See method documentation for rationale.
</span>  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="registered_language-class_method">
  
    .<strong>registered_language</strong>(name)  &#x21d2; <tt>Hash</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>
<p>Fetch a registered language entry</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>language identifier</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>registration hash with keys :path and :symbol, or nil if not registered</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


824
825
826</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 824</span>

<span class='kw'>def</span> <span class='id identifier rubyid_registered_language'>registered_language</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="TreeHaver/LanguageRegistry.html" title="TreeHaver::LanguageRegistry (module)">LanguageRegistry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_registered'><span class='object_link'><a href="TreeHaver/LanguageRegistry.html#registered-class_method" title="TreeHaver::LanguageRegistry.registered (method)">registered</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reset_backend!-class_method">
  
    .<strong>reset_backend!</strong>(to: :auto)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Reset backend selection memoization</p>

<p>Primarily useful in tests to switch backends without cross-example leakage.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Reset to auto-selection</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_reset_backend!'>reset_backend!</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Reset to specific backend</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_reset_backend!'>reset_backend!</span><span class='lparen'>(</span><span class='label'>to:</span> <span class='symbol'>:ffi</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>to</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>:auto</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>backend name or nil to clear (defaults to :auto)</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


375
376
377</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 375</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reset_backend!'>reset_backend!</span><span class='lparen'>(</span><span class='label'>to:</span> <span class='symbol'>:auto</span><span class='rparen'>)</span>
  <span class='ivar'>@backend</span> <span class='op'>=</span> <span class='id identifier rubyid_to'>to</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='comment'># rubocop:disable ThreadSafety/ClassInstanceVariable
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="resolve_backend_module-class_method">
  
    .<strong>resolve_backend_module</strong>(explicit_backend = nil)  &#x21d2; <tt>Module</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Get backend module for a specific backend (with explicit override)</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_mod'>mod</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_resolve_backend_module'>resolve_backend_module</span><span class='lparen'>(</span><span class='symbol'>:ffi</span><span class='rparen'>)</span>
<span class='id identifier rubyid_mod'>mod</span><span class='period'>.</span><span class='id identifier rubyid_capabilities'>capabilities</span><span class='lbracket'>[</span><span class='symbol'>:backend</span><span class='rbracket'>]</span>  <span class='comment'># =&gt; :ffi</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>explicit_backend</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>explicitly requested backend</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Module</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend module or nil if not available</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TreeHaver/BackendConflict.html" title="TreeHaver::BackendConflict (class)">BackendConflict</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if the backend conflicts with previously used backends</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 530</span>

<span class='kw'>def</span> <span class='id identifier rubyid_resolve_backend_module'>resolve_backend_module</span><span class='lparen'>(</span><span class='id identifier rubyid_explicit_backend'>explicit_backend</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># Temporarily override effective backend
</span>  <span class='id identifier rubyid_requested'>requested</span> <span class='op'>=</span> <span class='id identifier rubyid_resolve_effective_backend'>resolve_effective_backend</span><span class='lparen'>(</span><span class='id identifier rubyid_explicit_backend'>explicit_backend</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_mod'>mod</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_requested'>requested</span>
  <span class='kw'>when</span> <span class='symbol'>:mri</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/MRI.html" title="TreeHaver::Backends::MRI (module)">MRI</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:rust</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Rust.html" title="TreeHaver::Backends::Rust (module)">Rust</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:ffi</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/FFI.html" title="TreeHaver::Backends::FFI (module)">FFI</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:java</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Java.html" title="TreeHaver::Backends::Java (module)">Java</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:citrus</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Citrus.html" title="TreeHaver::Backends::Citrus (module)">Citrus</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:prism</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Prism.html" title="TreeHaver::Backends::Prism (module)">Prism</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:psych</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Psych.html" title="TreeHaver::Backends::Psych (module)">Psych</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:commonmarker</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Commonmarker.html" title="TreeHaver::Backends::Commonmarker (module)">Commonmarker</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:markly</span>
    <span class='const'><span class='object_link'><a href="TreeHaver/Backends.html" title="TreeHaver::Backends (module)">Backends</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Backends/Markly.html" title="TreeHaver::Backends::Markly (module)">Markly</a></span></span>
  <span class='kw'>when</span> <span class='symbol'>:auto</span>
    <span class='id identifier rubyid_backend_module'>backend_module</span>  <span class='comment'># Fall back to normal resolution for :auto
</span>  <span class='kw'>else</span>
    <span class='comment'># Unknown backend name - return nil to trigger error in caller
</span>    <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='comment'># Return nil if the module doesn&#39;t exist
</span>  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_mod'>mod</span>

  <span class='comment'># Check for backend conflicts FIRST, before checking availability
</span>  <span class='comment'># This is critical because the conflict causes the backend to report unavailable
</span>  <span class='comment'># We want to raise a clear error explaining WHY it&#39;s unavailable
</span>  <span class='comment'># Use the requested backend name directly (not capabilities) because
</span>  <span class='comment'># capabilities may be empty when the backend is blocked/unavailable
</span>  <span class='id identifier rubyid_check_backend_conflict!'>check_backend_conflict!</span><span class='lparen'>(</span><span class='id identifier rubyid_requested'>requested</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_requested'>requested</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_requested'>requested</span> <span class='op'>!=</span> <span class='symbol'>:auto</span>

  <span class='comment'># Now check if the backend is available
</span>  <span class='comment'># Why assume modules without available? are available?
</span>  <span class='comment'># - Some backends might be mocked in tests without an available? method
</span>  <span class='comment'># - This makes the code more defensive and test-friendly
</span>  <span class='comment'># - It allows graceful degradation if a backend module is incomplete
</span>  <span class='comment'># - Backward compatibility: if a module doesn&#39;t declare availability, assume it works
</span>  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_mod'>mod</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:available?</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_mod'>mod</span><span class='period'>.</span><span class='id identifier rubyid_available?'>available?</span>

  <span class='comment'># Record that this backend is being used
</span>  <span class='id identifier rubyid_record_backend_usage'>record_backend_usage</span><span class='lparen'>(</span><span class='id identifier rubyid_requested'>requested</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_requested'>requested</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_requested'>requested</span> <span class='op'>!=</span> <span class='symbol'>:auto</span>

  <span class='id identifier rubyid_mod'>mod</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="resolve_effective_backend-class_method">
  
    .<strong>resolve_effective_backend</strong>(explicit_backend = nil)  &#x21d2; <tt>Symbol</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Resolve the effective backend considering explicit override</p>

<p>Priority: explicit &gt; thread context &gt; global &gt; :auto</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_resolve_effective_backend'>resolve_effective_backend</span><span class='lparen'>(</span><span class='symbol'>:ffi</span><span class='rparen'>)</span>  <span class='comment'># =&gt; :ffi</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>With thread-local context</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_with_backend'><span class='object_link'><a href="#with_backend-class_method" title="TreeHaver.with_backend (method)">with_backend</a></span></span><span class='lparen'>(</span><span class='symbol'>:mri</span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_resolve_effective_backend'>resolve_effective_backend</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>  <span class='comment'># =&gt; :mri
</span>  <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_resolve_effective_backend'>resolve_effective_backend</span><span class='lparen'>(</span><span class='symbol'>:ffi</span><span class='rparen'>)</span>  <span class='comment'># =&gt; :ffi (explicit wins)
</span><span class='kw'>end</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>explicit_backend</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>explicitly requested backend</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend to use</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


517
518
519
520</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 517</span>

<span class='kw'>def</span> <span class='id identifier rubyid_resolve_effective_backend'>resolve_effective_backend</span><span class='lparen'>(</span><span class='id identifier rubyid_explicit_backend'>explicit_backend</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_explicit_backend'>explicit_backend</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='kw'>if</span> <span class='id identifier rubyid_explicit_backend'>explicit_backend</span>
  <span class='id identifier rubyid_effective_backend'>effective_backend</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="resolve_native_backend_module-class_method">
  
    .<strong>resolve_native_backend_module</strong>(explicit_backend = nil)  &#x21d2; <tt>Module</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Resolve a native tree-sitter backend module (for from_library)</p>

<p>This method is similar to resolve_backend_module but ONLY considers<br />
backends that support loading shared libraries (.so files):</p>
<ul>
  <li>MRI (ruby_tree_sitter C extension)</li>
  <li>Rust (tree_stump)</li>
  <li>FFI (ffi gem with libtree-sitter)</li>
  <li>Java (jtreesitter on JRuby)</li>
</ul>

<p>Pure Ruby backends (Citrus, Prism, Psych, Commonmarker, Markly) are NOT<br />
considered because they don’t support from_library.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>explicit_backend</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>explicitly requested backend</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Module</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the backend module or nil if none available</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TreeHaver/BackendConflict.html" title="TreeHaver::BackendConflict (class)">BackendConflict</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if the backend conflicts with previously used backends</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 604</span>

<span class='kw'>def</span> <span class='id identifier rubyid_resolve_native_backend_module'>resolve_native_backend_module</span><span class='lparen'>(</span><span class='id identifier rubyid_explicit_backend'>explicit_backend</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># Short-circuit on TruffleRuby: no native backends work
</span>  <span class='comment'># - MRI: C extension, MRI only
</span>  <span class='comment'># - Rust: magnus requires MRI&#39;s C API
</span>  <span class='comment'># - FFI: STRUCT_BY_VALUE not supported
</span>  <span class='comment'># - Java: requires JRuby&#39;s Java interop
</span>  <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'>RUBY_ENGINE</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'>RUBY_ENGINE</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>truffleruby</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_explicit_backend'>explicit_backend</span> <span class='comment'># Auto-select: no backends available
</span>    <span class='comment'># If explicit backend requested, let it fail with proper error below
</span>  <span class='kw'>end</span>

  <span class='comment'># Get the effective backend (considers thread-local and global settings)
</span>  <span class='id identifier rubyid_requested'>requested</span> <span class='op'>=</span> <span class='id identifier rubyid_resolve_effective_backend'>resolve_effective_backend</span><span class='lparen'>(</span><span class='id identifier rubyid_explicit_backend'>explicit_backend</span><span class='rparen'>)</span>

  <span class='comment'># If the effective backend is a native backend, use it
</span>  <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="#NATIVE_BACKENDS-constant" title="TreeHaver::NATIVE_BACKENDS (constant)">NATIVE_BACKENDS</a></span></span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_requested'>requested</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_resolve_backend_module'>resolve_backend_module</span><span class='lparen'>(</span><span class='id identifier rubyid_requested'>requested</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># If a specific non-native backend was explicitly requested, return nil
</span>  <span class='comment'># (from_library only works with native backends that load .so files)
</span>  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_explicit_backend'>explicit_backend</span>

  <span class='comment'># If effective backend is :auto, auto-select from native backends in priority order
</span>  <span class='comment'># Note: non-native backends set via with_backend are NOT used here because
</span>  <span class='comment'># from_library only works with native backends
</span>  <span class='id identifier rubyid_native_priority'>native_priority</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'>RUBY_ENGINE</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'>RUBY_ENGINE</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>jruby</span><span class='tstring_end'>&quot;</span></span>
    <span class='qsymbols_beg'>%i[</span><span class='tstring_content'>java</span><span class='words_sep'> </span><span class='tstring_content'>ffi</span><span class='tstring_end'>]</span></span> <span class='comment'># JRuby: Java first, then FFI
</span>  <span class='kw'>else</span>
    <span class='qsymbols_beg'>%i[</span><span class='tstring_content'>mri</span><span class='words_sep'> </span><span class='tstring_content'>rust</span><span class='words_sep'> </span><span class='tstring_content'>ffi</span><span class='tstring_end'>]</span></span> <span class='comment'># MRI: MRI first, then Rust, then FFI
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_native_priority'>native_priority</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_backend'>backend</span><span class='op'>|</span>
    <span class='id identifier rubyid_mod'>mod</span> <span class='op'>=</span> <span class='id identifier rubyid_resolve_backend_module'>resolve_backend_module</span><span class='lparen'>(</span><span class='id identifier rubyid_backend'>backend</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_mod'>mod</span> <span class='kw'>if</span> <span class='id identifier rubyid_mod'>mod</span>
  <span class='kw'>end</span>

  <span class='kw'>nil</span> <span class='comment'># No native backend available
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="with_backend-class_method">
  
    .<strong>with_backend</strong>(name) { ... } &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Execute a block with a specific backend in thread-local context</p>

<p>This method provides temporary, thread-safe backend switching for a block of code.<br />
The backend setting is automatically restored when the block exits, even if<br />
an exception is raised. Supports nesting—inner blocks override outer blocks,<br />
and each level is properly unwound.</p>

<p>Thread Safety: Each thread maintains its own backend context, so concurrent<br />
threads can safely use different backends without interfering with each other.</p>

<p>Use Cases:</p>
<ul>
  <li>Testing: Test the same code path with different backends</li>
  <li>Performance comparison: Benchmark parsing with different backends</li>
  <li>Fallback scenarios: Try one backend, fall back to another on failure</li>
  <li>Thread isolation: Different threads can use different backends safely</li>
</ul>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Basic usage</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_with_backend'>with_backend</span><span class='lparen'>(</span><span class='symbol'>:mri</span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>
  <span class='id identifier rubyid_tree'>tree</span> <span class='op'>=</span> <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_source'>source</span><span class='rparen'>)</span>
<span class='kw'>end</span>
<span class='comment'># Backend is automatically restored here</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Nested blocks (inner overrides outer)</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_with_backend'>with_backend</span><span class='lparen'>(</span><span class='symbol'>:rust</span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_parser1'>parser1</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>  <span class='comment'># Uses :rust
</span>  <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_with_backend'>with_backend</span><span class='lparen'>(</span><span class='symbol'>:citrus</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_parser2'>parser2</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>  <span class='comment'># Uses :citrus
</span>  <span class='kw'>end</span>
  <span class='id identifier rubyid_parser3'>parser3</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>  <span class='comment'># Back to :rust
</span><span class='kw'>end</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Testing multiple backends</p>
</div></h5>
      
      <pre class="example code"><code><span class='lbracket'>[</span><span class='symbol'>:mri</span><span class='comma'>,</span> <span class='symbol'>:rust</span><span class='comma'>,</span> <span class='symbol'>:citrus</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_backend_name'>backend_name</span><span class='op'>|</span>
  <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_with_backend'>with_backend</span><span class='lparen'>(</span><span class='id identifier rubyid_backend_name'>backend_name</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_source'>source</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_backend_name'>backend_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_root_node'>root_node</span><span class='period'>.</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Exception safety (backend restored even on error)</p>
</div></h5>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_with_backend'>with_backend</span><span class='lparen'>(</span><span class='symbol'>:mri</span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Something went wrong</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>rescue</span>
  <span class='comment'># Handle error
</span><span class='kw'>end</span>
<span class='comment'># Backend is still restored to its previous value</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Thread isolation</p>
</div></h5>
      
      <pre class="example code"><code><span class='id identifier rubyid_threads'>threads</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='symbol'>:mri</span><span class='comma'>,</span> <span class='symbol'>:rust</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_backend_name'>backend_name</span><span class='op'>|</span>
  <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
    <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_with_backend'>with_backend</span><span class='lparen'>(</span><span class='id identifier rubyid_backend_name'>backend_name</span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='comment'># Each thread uses its own backend independently
</span>      <span class='const'><span class='object_link'><a href="" title="TreeHaver (module)">TreeHaver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TreeHaver/Parser.html" title="TreeHaver::Parser (class)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TreeHaver/Parser.html#initialize-instance_method" title="TreeHaver::Parser#initialize (method)">new</a></span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_threads'>threads</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:join</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>backend name (:mri, :rust, :ffi, :java, :citrus, :auto)</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'><p>block to execute with the specified backend</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the return value of the block</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if backend name is nil</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TreeHaver/BackendConflict.html" title="TreeHaver::BackendConflict (class)">BackendConflict</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if the requested backend conflicts with a previously used backend</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li>#effective_backend</li>
    
      <li>#current_backend_context</li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/tree_haver.rb', line 481</span>

<span class='kw'>def</span> <span class='id identifier rubyid_with_backend'>with_backend</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Backend name required</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='comment'># Get context FIRST to ensure it exists
</span>  <span class='id identifier rubyid_ctx'>ctx</span> <span class='op'>=</span> <span class='id identifier rubyid_current_backend_context'>current_backend_context</span>
  <span class='id identifier rubyid_old_backend'>old_backend</span> <span class='op'>=</span> <span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:backend</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_old_depth'>old_depth</span> <span class='op'>=</span> <span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:depth</span><span class='rbracket'>]</span>

  <span class='kw'>begin</span>
    <span class='comment'># Set new backend and increment depth
</span>    <span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:backend</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span>
    <span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:depth</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='int'>1</span>

    <span class='comment'># Execute block
</span>    <span class='kw'>yield</span>
  <span class='kw'>ensure</span>
    <span class='comment'># Restore previous backend and depth
</span>    <span class='comment'># This ensures proper unwinding even with exceptions
</span>    <span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:backend</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_old_backend'>old_backend</span>
    <span class='id identifier rubyid_ctx'>ctx</span><span class='lbracket'>[</span><span class='symbol'>:depth</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_old_depth'>old_depth</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Tue Dec 30 03:22:58 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.0).
</div>

    </div>
  </body>
</html>