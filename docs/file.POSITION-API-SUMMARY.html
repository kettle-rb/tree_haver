<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: POSITION-API-SUMMARY
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "POSITION-API-SUMMARY";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: POSITION-API-SUMMARY</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="position-api">Position API</h1>

<p><strong>Date:</strong> December 18, 2025<br>
<strong>Feature:</strong> Unified Position API for all tree_haver backends<br>
<strong>Version:</strong> Unreleased (planned for v3.1.0)</p>

<hr>

<h2 id="what-was-done">What Was Done</h2>

<p>Added four position-related methods to all tree_haver backend Node classes to provide a consistent API for position information across all backends:</p>

<h3 id="new-methods">New Methods</h3>

<ol>
  <li>
<strong><code>start_line</code></strong> - Returns 1-based line number where node starts
    <ul>
      <li>Converts 0-based row to 1-based line number</li>
      <li>Formula: <code>start_point.row + 1</code> (or uses backend’s native 1-based line if available)</li>
    </ul>
  </li>
  <li>
<strong><code>end_line</code></strong> - Returns 1-based line number where node ends
    <ul>
      <li>Converts 0-based row to 1-based line number</li>
      <li>Formula: <code>end_point.row + 1</code> (or uses backend’s native 1-based line if available)</li>
    </ul>
  </li>
  <li>
<strong><code>source_position</code></strong> - Returns position hash with 1-based lines and 0-based columns
    <ul>
      <li>Format: <code>{start_line:, end_line:, start_column:, end_column:}</code>
</li>
      <li>Compatible with <code>*-merge</code> gems’ <code>FileAnalysisBase</code> expectations</li>
      <li>Lines are 1-based (human-readable)</li>
      <li>Columns are 0-based (matches tree-sitter convention)</li>
    </ul>
  </li>
  <li>
<strong><code>first_child</code></strong> - Convenience method for iteration
    <ul>
      <li>Returns <code>children.first</code>
</li>
      <li>Provides compatibility with code expecting <code>first_child</code> method</li>
    </ul>
  </li>
</ol>

<hr>

<h2 id="backends-updated">Backends Updated</h2>

<h3 id="-main-treehavernode-wrapper">✅ Main TreeHaver::Node Wrapper</h3>
<p><strong>File:</strong> <code>vendor/tree_haver/lib/tree_haver/node.rb</code><br>
<strong>Lines:</strong> 113-149, 230-241</p>

<p>Added all four methods to the main unified Node wrapper. This automatically covers:</p>
<ul>
  <li>Tree-sitter MRI backend</li>
  <li>Tree-sitter FFI backend</li>
  <li>Tree-sitter Java backend</li>
  <li>Tree-sitter Rust backend</li>
</ul>

<p>All tree-sitter backends use <code>TreeHaver::Node</code> to wrap their raw nodes, so they inherit these methods automatically.</p>

<h3 id="-commonmarker-backend-already-complete">✅ Commonmarker Backend (Already Complete)</h3>
<p><strong>File:</strong> <code>vendor/tree_haver/lib/tree_haver/backends/commonmarker.rb</code><br>
<strong>Lines:</strong> 286-324, 342-348</p>

<p>Already had all four methods implemented. Uses Commonmarker’s <code>sourcepos</code> array which provides 1-based line numbers directly.</p>

<h3 id="-markly-backend-already-complete">✅ Markly Backend (Already Complete)</h3>
<p><strong>File:</strong> <code>vendor/tree_haver/lib/tree_haver/backends/markly.rb</code><br>
<strong>Lines:</strong> 346-382</p>

<p>Already had all four methods implemented. Uses Markly’s <code>source_position</code> hash which provides 1-based line numbers directly.</p>

<h3 id="-prism-backend-already-complete">✅ Prism Backend (Already Complete)</h3>
<p><strong>File:</strong> <code>vendor/tree_haver/lib/tree_haver/backends/prism.rb</code><br>
<strong>Lines:</strong> 398-438</p>

<p>Already had all four methods implemented. Uses Prism’s <code>Location</code> object which provides 1-based line numbers directly.</p>

<h3 id="-psych-backend-newly-added">✅ Psych Backend (Newly Added)</h3>
<p><strong>File:</strong> <code>vendor/tree_haver/lib/tree_haver/backends/psych.rb</code><br>
<strong>Lines:</strong> 363-402</p>

<p>Added all four methods:</p>
<ul>
  <li>
<code>start_line</code> - Calculates from <code>start_point.row + 1</code>
</li>
  <li>
<code>end_line</code> - Calculates from <code>end_point.row + 1</code>
</li>
  <li>
<code>source_position</code> - Returns hash with 1-based lines and 0-based columns</li>
  <li>
<code>first_child</code> - Returns <code>children.first</code>
</li>
</ul>

<h3 id="-citrus-backend-newly-added">✅ Citrus Backend (Newly Added)</h3>
<p><strong>File:</strong> <code>vendor/tree_haver/lib/tree_haver/backends/citrus.rb</code><br>
<strong>Lines:</strong> 375-409</p>

<p>Added all four methods:</p>
<ul>
  <li>
<code>start_line</code> - Calculates from <code>start_point[:row] + 1</code>
</li>
  <li>
<code>end_line</code> - Calculates from <code>end_point[:row] + 1</code>
</li>
  <li>
<code>source_position</code> - Returns hash with 1-based lines and 0-based columns</li>
  <li>
<code>first_child</code> - Returns <code>child(0)</code>
</li>
</ul>

<hr>

<h2 id="testing">Testing</h2>

<h3 id="manual-verification">Manual Verification</h3>

<p>Tested Psych backend successfully:</p>
<pre class="code language-ruby"><code class="language-ruby">require &quot;tree_haver/backends/psych&quot;
parser = TreeHaver::Backends::Psych::Parser.new
parser.language = TreeHaver::Backends::Psych::Language.yaml
tree = parser.parse(&quot;foo: bar&quot;)
node = tree.root_node

# Verified all methods work:
node.respond_to?(:start_line)      # =&gt; true
node.respond_to?(:end_line)        # =&gt; true
node.respond_to?(:source_position) # =&gt; true
node.respond_to?(:first_child)     # =&gt; true
node.start_line                    # =&gt; 1
node.source_position               # =&gt; {start_line: 1, end_line: 2, start_column: 0, end_column: 0}
</code></pre>

<h3 id="no-syntax-errors">No Syntax Errors</h3>

<p>Both Psych and Citrus backends load without syntax errors:</p>
<pre class="code language-bash"><code class="language-bash">ruby -I vendor/tree_haver/lib -r tree_haver/backends/psych -r tree_haver/backends/citrus -e &quot;puts &#39;Backends loaded successfully&#39;&quot;
# Output: Backends loaded successfully
</code></pre>

<hr>

<h2 id="benefits">Benefits</h2>

<h3 id="1-consistent-api-across-all-backends">1. Consistent API Across All Backends</h3>
<p>All Node classes now respond to the same position methods, regardless of backend.</p>

<h3 id="2-compatible-with--merge-gems">2. Compatible with *-merge Gems</h3>
<p>The <code>source_position</code> method returns exactly what <code>FileAnalysisBase</code> expects, eliminating the need for per-gem workarounds.</p>

<h3 id="3-backward-compatible">3. Backward Compatible</h3>
<p>Existing code using <code>start_point</code>/<code>end_point</code> continues to work unchanged. The new methods are additive only.</p>

<h3 id="4-language-agnostic">4. Language-Agnostic</h3>
<p>Position information is a property of the source text, not the language. These methods work identically for:</p>
<ul>
  <li>Ruby (Prism backend)</li>
  <li>Markdown (Commonmarker, Markly backends)</li>
  <li>YAML (Psych backend)</li>
  <li>TOML (Citrus backend via toml-rb)</li>
  <li>JSON (tree-sitter backends)</li>
  <li>Any future language backends</li>
</ul>

<hr>

<h2 id="implementation-notes">Implementation Notes</h2>

<h3 id="why-not-a-mixin">Why Not a Mixin?</h3>

<p>The original plan suggested a mixin (<code>NodePositionMixin</code>), but the implementation uses direct method definitions instead because:</p>

<ol>
  <li>
<strong>Backend-Specific Optimizations</strong> - Some backends already have 1-based line numbers (Commonmarker, Markly, Prism), so they can skip the conversion</li>
  <li>
<strong>Different Point Representations</strong> - Some backends return Point objects, others return hashes</li>
  <li>
<strong>Already Implemented</strong> - Many backends already had these methods, just needed to verify/add missing ones</li>
</ol>

<h3 id="conversion-formula">Conversion Formula</h3>

<p>For backends with 0-based rows (tree-sitter, Psych, Citrus):</p>
<ul>
  <li><code>start_line = start_point.row + 1</code></li>
  <li><code>end_line = end_point.row + 1</code></li>
</ul>

<p>For backends with 1-based lines (Commonmarker, Markly, Prism):</p>
<ul>
  <li>Use the backend’s native line number directly</li>
</ul>

<hr>
</div></div>

      <div id="footer">
  Generated on Thu Jan  8 04:04:23 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.0).
</div>

    </div>
  </body>
</html>