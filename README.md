| üìç NOTE |
| --- |
| RubyGems (the [GitHub org](https://github.com/rubygems/), not the website) [suffered](https://joel.drapper.me/p/ruby-central-security-measures/) a [hostile takeover](https://pup-e.com/blog/goodbye-rubygems/) in September 2025. |
| Ultimately [4 maintainers](https://www.reddit.com/r/ruby/s/gOk42POCaV) were [hard removed](https://bsky.app/profile/martinemde.com/post/3m3occezxxs2q) and a reason has been given for only 1 of those, while 2 others resigned in protest. |
| It is a [complicated story](https://joel.drapper.me/p/ruby-central-takeover/) which is difficult to [parse quickly](https://joel.drapper.me/p/ruby-central-fact-check/). |
| Simply put - there was active policy for adding or removing maintainers/owners of [rubygems](https://github.com/ruby/rubygems/blob/b1ab33a3d52310a84d16b193991af07f5a6a07c0/doc/rubygems/POLICIES.md?plain=1#L187-L196) and [bundler](https://github.com/ruby/rubygems/blob/b1ab33a3d52310a84d16b193991af07f5a6a07c0/doc/bundler/playbooks/TEAM_CHANGES.md), and those [policies were not followed](https://www.reddit.com/r/ruby/comments/1ove9vp/rubycentral_hates_this_one_fact/). |
| I'm adding notes like this to gems because I [don't condone theft](https://joel.drapper.me/p/ruby-central/) of repositories or gems from their rightful owners. |
| If a similar theft happened with my repos/gems, I'd hope some would stand up for me. |
| Disenfranchised former-maintainers have started [gem.coop](https://gem.coop). |
| Once available I will publish there exclusively; unless RubyCentral makes amends with the community. |
| The ["Technology for Humans: Joel Draper"](https://youtu.be/_H4qbtC5qzU?si=BvuBU90R2wAqD2E6) podcast episode by [reinteractive](https://reinteractive.com/ruby-on-rails) is the most cogent summary I'm aware of. |
| See [here](https://github.com/gem-coop/gem.coop/issues/12), [here](https://gem.coop) and [here](https://martinemde.com/2025/10/05/announcing-gem-coop.html) for more info on what comes next. |
| What I'm doing: A (WIP) proposal for [bundler/gem scopes](https://github.com/galtzo-floss/bundle-namespace), and a (WIP) proposal for a federated [gem server](https://github.com/galtzo-floss/gem-server). |

[rubygems-org]: https://github.com/rubygems/
[draper-security]: https://joel.drapper.me/p/ruby-central-security-measures/
[draper-takeover]: https://joel.drapper.me/p/ruby-central-takeover/
[ellen-takeover]: https://pup-e.com/blog/goodbye-rubygems/
[simi-removed]: https://www.reddit.com/r/ruby/s/gOk42POCaV
[martin-removed]: https://bsky.app/profile/martinemde.com/post/3m3occezxxs2q
[draper-lies]: https://joel.drapper.me/p/ruby-central-fact-check/
[draper-theft]: https://joel.drapper.me/p/ruby-central/
[reinteractive]: https://reinteractive.com/ruby-on-rails
[gem-coop]: https://gem.coop
[gem-naming]: https://github.com/gem-coop/gem.coop/issues/12
[martin-ann]: https://martinemde.com/2025/10/05/announcing-gem-coop.html
[gem-scopes]: https://github.com/galtzo-floss/bundle-namespace
[gem-server]: https://github.com/galtzo-floss/gem-server
[reinteractive-podcast]: https://youtu.be/_H4qbtC5qzU?si=BvuBU90R2wAqD2E6
[bundler-maint-policy]: https://github.com/ruby/rubygems/blob/b1ab33a3d52310a84d16b193991af07f5a6a07c0/doc/bundler/playbooks/TEAM_CHANGES.md
[rubygems-maint-policy]: https://github.com/ruby/rubygems/blob/b1ab33a3d52310a84d16b193991af07f5a6a07c0/doc/rubygems/POLICIES.md?plain=1#L187-L196
[policy-fail]: https://www.reddit.com/r/ruby/comments/1ove9vp/rubycentral_hates_this_one_fact/

[![Galtzo FLOSS Logo by Aboling0, CC BY-SA 4.0](https://logos.galtzo.com/assets/images/galtzo-floss/avatar-192px.svg)](https://discord.gg/3qme4XHNKN) [![ruby-lang Logo, Yukihiro Matsumoto, Ruby Visual Identity Team, CC BY-SA 2.5](https://logos.galtzo.com/assets/images/ruby-lang/avatar-192px.svg)](https://www.ruby-lang.org/) [![kettle-rb Logo by Aboling0, CC BY-SA 4.0](https://logos.galtzo.com/assets/images/kettle-rb/avatar-192px.svg)](https://github.com/kettle-rb)

[üñºÔ∏ègaltzo-i]: https://logos.galtzo.com/assets/images/galtzo-floss/avatar-192px.svg
[üñºÔ∏ègaltzo-discord]: https://discord.gg/3qme4XHNKN
[üñºÔ∏èruby-lang-i]: https://logos.galtzo.com/assets/images/ruby-lang/avatar-192px.svg
[üñºÔ∏èruby-lang]: https://www.ruby-lang.org/
[üñºÔ∏èkettle-rb-i]: https://logos.galtzo.com/assets/images/kettle-rb/avatar-192px.svg
[üñºÔ∏èkettle-rb]: https://github.com/kettle-rb

# üå¥ TreeHaver

[![Version](https://img.shields.io/gem/v/tree_haver.svg)](https://bestgems.org/gems/tree_haver) [![GitHub tag (latest SemVer)](https://img.shields.io/github/tag/kettle-rb/tree_haver.svg)](http://github.com/kettle-rb/tree_haver/releases) [![License: MIT](https://img.shields.io/badge/License-MIT-259D6C.svg)](https://opensource.org/licenses/MIT) [![Downloads Rank](https://img.shields.io/gem/rd/tree_haver.svg)](https://bestgems.org/gems/tree_haver) [![Open Source Helpers](https://www.codetriage.com/kettle-rb/tree_haver/badges/users.svg)](https://www.codetriage.com/kettle-rb/tree_haver) [![CodeCov Test Coverage](https://codecov.io/gh/kettle-rb/tree_haver/graph/badge.svg)](https://codecov.io/gh/kettle-rb/tree_haver) [![Coveralls Test Coverage](https://coveralls.io/repos/github/kettle-rb/tree_haver/badge.svg?branch=main)](https://coveralls.io/github/kettle-rb/tree_haver?branch=main) [![QLTY Test Coverage](https://qlty.sh/gh/kettle-rb/projects/tree_haver/coverage.svg)](https://qlty.sh/gh/kettle-rb/projects/tree_haver/metrics/code?sort=coverageRating) [![QLTY Maintainability](https://qlty.sh/gh/kettle-rb/projects/tree_haver/maintainability.svg)](https://qlty.sh/gh/kettle-rb/projects/tree_haver) [![CI Heads](https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml) [![CI Runtime Dependencies @ HEAD](https://github.com/kettle-rb/tree_haver/actions/workflows/dep-heads.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/dep-heads.yml) [![CI Current](https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml) [![CI Truffle Ruby](https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml) [![Deps Locked](https://github.com/kettle-rb/tree_haver/actions/workflows/locked_deps.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/locked_deps.yml) [![Deps Unlocked](https://github.com/kettle-rb/tree_haver/actions/workflows/unlocked_deps.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/unlocked_deps.yml) [![CI Supported](https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml) [![CI Test Coverage](https://github.com/kettle-rb/tree_haver/actions/workflows/coverage.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/coverage.yml) [![CI Style](https://github.com/kettle-rb/tree_haver/actions/workflows/style.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/style.yml) [![CodeQL](https://github.com/kettle-rb/tree_haver/actions/workflows/codeql-analysis.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/security/code-scanning) [![Apache SkyWalking Eyes License Compatibility Check](https://github.com/kettle-rb/tree_haver/actions/workflows/license-eye.yml/badge.svg)](https://github.com/kettle-rb/tree_haver/actions/workflows/license-eye.yml)

`if ci_badges.map(&:color).detect { it != "green"}` ‚òùÔ∏è [let me know](https://discord.gg/3qme4XHNKN), as I may have missed the [discord notification](https://discord.gg/3qme4XHNKN).

-----
`if ci_badges.map(&:color).all? { it == "green"}` üëáÔ∏è send money so I can do more of this. FLOSS maintenance is now my full-time job.

[![OpenCollective Backers](https://opencollective.com/kettle-rb/backers/badge.svg?style=flat)](https://opencollective.com/kettle-rb#backer) [![OpenCollective Sponsors](https://opencollective.com/kettle-rb/sponsors/badge.svg?style=flat)](https://opencollective.com/kettle-rb#sponsor) [![Sponsor Me on Github](https://img.shields.io/badge/Sponsor_Me!-pboling.svg?style=social&logo=github)](https://github.com/sponsors/pboling) [![Liberapay Goal Progress](https://img.shields.io/liberapay/goal/pboling.svg?logo=liberapay&color=a51611&style=flat)](https://liberapay.com/pboling/donate) [![Donate on PayPal](https://img.shields.io/badge/donate-paypal-a51611.svg?style=flat&logo=paypal)](https://www.paypal.com/paypalme/peterboling) [![Buy me a coffee](https://img.shields.io/badge/buy_me_a_coffee-%E2%9C%93-a51611.svg?style=flat)](https://www.buymeacoffee.com/pboling) [![Donate on Polar](https://img.shields.io/badge/polar-donate-a51611.svg?style=flat)](https://polar.sh/pboling) [![Donate at ko-fi.com](https://img.shields.io/badge/ko--fi-%E2%9C%93-a51611.svg?style=flat)](https://ko-fi.com/O5O86SNP4)

## üåª Synopsis

TreeHaver is a cross-Ruby adapter for the [tree-sitter](https://tree-sitter.github.io/tree-sitter/) and [Citrus](https://github.com/mjackson/citrus) parsing libraries and other dedicated parsing tools that works seamlessly across MRI Ruby, JRuby, and TruffleRuby. It provides a unified API for parsing source code using grammars, regardless of your Ruby implementation.

### The Adapter Pattern: Like Faraday, but for Parsing

If you've used [Faraday](https://github.com/lostisland/faraday), [multi\_json](https://github.com/intridea/multi_json), or [multi\_xml](https://github.com/sferik/multi_xml), you'll feel right at home with TreeHaver. These gems share a common philosophy:

| Gem | Unified API for | Backend Examples |
| --- | --- | --- |
| **Faraday** | HTTP requests | Net::HTTP, Typhoeus, Patron, Excon |
| **multi\_json** | JSON parsing | Oj, Yajl, JSON gem |
| **multi\_xml** | XML parsing | Nokogiri, LibXML, Ox |
| **TreeHaver** | Code parsing | MRI, Rust, FFI, Java, Prism, Psych, Commonmarker, Markly, Citrus (& Co.) |

**Write once, run anywhere.**

**Learn once, write anywhere.**

Just as Faraday lets you swap HTTP adapters without changing your code, TreeHaver lets you swap tree-sitter backends. Your parsing code remains the same whether you're running on MRI with native C extensions, JRuby with FFI, or TruffleRuby.

``` ruby
# Your code stays the same regardless of backend
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Language.from_library("/path/to/grammar.so")
tree = parser.parse(source_code)

# TreeHaver automatically picks the best available backend:
# - MRI: ruby_tree_sitter, tree_stump, ffi, prism, psych, commonmarker, markly, citrus
# - JRuby: ffi, java-tree-sitter (not a gem, but the jtreesitter maven package), prism, psych, commonmarker, markly, citrus
# - TruffleRuby: prism, psych, commonmarker, markly, citrus
#   (tree-sitter backends don't work on Truffleruby with ffi gem due to FFI STRUCT_BY_VALUE limitation)
```

### Key Features

  - **Universal Ruby Support**: Works on MRI Ruby, JRuby, and TruffleRuby
  - **10 Parsing Backends** - Choose the right backend for your needs:
      - **Tree-sitter Backends** (high-performance, incremental parsing):
          - **MRI Backend**: Leverages [`ruby_tree_sitter`](https://github.com/Faveod/ruby-tree-sitter) gem (C extension, fastest on MRI)
          - **Rust Backend**: Uses [`tree_stump`](https://github.com/joker1007/tree_stump) gem (Rust with precompiled binaries)
              - **Note**: `tree_stump` currently requires unreleased fixes in the `main` branch.
          - **FFI Backend**: Pure Ruby FFI bindings to `libtree-sitter` (JRuby only; TruffleRuby's FFI doesn't support tree-sitter's struct-by-value returns)
          - **Java Backend**: Native Java integration for JRuby with [`java-tree-sitter`](https://github.com/tree-sitter/java-tree-sitter) / [`jtreesitter`](https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter) grammar JARs
      - **Language-Specific Backends** (native parser integration):
          - **Prism Backend**: Ruby's official parser ([Prism](https://github.com/ruby/prism), stdlib in Ruby 3.4+)
          - **Psych Backend**: Ruby's YAML parser ([Psych](https://github.com/ruby/psych), stdlib)
          - **Commonmarker Backend**: Fast Markdown parser ([Commonmarker](https://github.com/gjtorikian/commonmarker), comrak Rust)
          - **Markly Backend**: GitHub Flavored Markdown ([Markly](https://github.com/ioquatix/markly), cmark-gfm C)
      - **Pure Ruby Fallback**:
          - **Citrus Backend**: Pure Ruby parsing via [`citrus`](https://github.com/mjackson/citrus) (no native dependencies)
  - **Automatic Backend Selection**: Intelligently selects the best backend for your Ruby implementation
  - **Language Agnostic**: Parse any language - Ruby, Markdown, YAML, JSON, Bash, TOML, JavaScript, etc.
  - **Grammar Discovery**: Built-in `GrammarFinder` utility for platform-aware grammar library discovery
  - **Unified Position API**: Consistent `start_line`, `end_line`, `source_position` across all backends
  - **Thread-Safe**: Built-in language registry with thread-safe caching
  - **Minimal API Surface**: Simple, focused API that covers the most common use cases
### Backend Requirements

TreeHaver has minimal dependencies and automatically selects the best backend for your Ruby implementation. Each backend has specific version requirements:

#### MRI Backend (ruby\_tree\_sitter, C extensions)

**Requires `ruby_tree_sitter` v2.0+**

In ruby\_tree\_sitter v2.0, all TreeSitter exceptions were changed to inherit from `Exception` (not `StandardError`). This was an intentional breaking change made for thread-safety and signal handling reasons.

**Exception Mapping**: TreeHaver catches `TreeSitter::TreeSitterError` and its subclasses, converting them to `TreeHaver::NotAvailable` while preserving the original error message. This provides a consistent exception API across all backends:

| ruby\_tree\_sitter Exception | TreeHaver Exception | When It Occurs |
| --- | --- | --- |
| `TreeSitter::ParserNotFoundError` | `TreeHaver::NotAvailable` | Parser library file cannot be loaded |
| `TreeSitter::LanguageLoadError` | `TreeHaver::NotAvailable` | Language symbol loads but returns nothing |
| `TreeSitter::SymbolNotFoundError` | `TreeHaver::NotAvailable` | Symbol not found in library |
| `TreeSitter::ParserVersionError` | `TreeHaver::NotAvailable` | Parser version incompatible with tree-sitter |
| `TreeSitter::QueryCreationError` | `TreeHaver::NotAvailable` | Query creation fails |

``` ruby
# Add to your Gemfile for MRI backend
gem "ruby_tree_sitter", "~> 2.0"
```

#### Rust Backend (tree\_stump)

**MRI Ruby only** - Does not work on JRuby or TruffleRuby.

The Rust backend uses [tree\_stump](https://github.com/joker1007/tree_stump), which is a Rust native extension built with [magnus](https://github.com/matsadler/magnus) and [rb-sys](https://github.com/oxidize-rb/rb-sys). These libraries are only compatible with MRI Ruby's C API.

  - **JRuby**: Cannot load native `.so` extensions (runs on JVM)
  - **TruffleRuby**: magnus/rb-sys are incompatible with TruffleRuby's C API emulation
NOTE: `tree_stump` currently requires unreleased fixes in the `main` branch.

``` ruby
# Add to your Gemfile for Rust backend (MRI only)
gem "tree_stump", github: "joker1007/tree_stump", branch: "main"
```

#### FFI Backend

**MRI and JRuby only** - Does not work on TruffleRuby.

Requires the `ffi` gem and a system installation of `libtree-sitter`.

  - **TruffleRuby**: TruffleRuby's FFI implementation doesn't support `STRUCT_BY_VALUE` return types, which tree-sitter's C API uses for functions like `ts_tree_root_node` and `ts_node_child`.

<!-- end list -->
``` ruby
# Add to your Gemfile for FFI backend (MRI and JRuby)
gem "ffi", ">= 1.15", "< 2.0"
```

``` bash
# Install libtree-sitter on your system:
# macOS
brew install tree-sitter

# Ubuntu/Debian
apt-get install libtree-sitter0 libtree-sitter-dev

# Fedora
dnf install tree-sitter tree-sitter-devel
```

#### Citrus Backend

Pure Ruby parser with no native dependencies:

``` ruby
# Add to your Gemfile for Citrus backend
gem "citrus", "~> 3.0"
```

#### Java Backend (JRuby only)

No additional dependencies required beyond grammar JARs built for java-tree-sitter / jtreesitter.

### Backend Platform Compatibility

Not all backends work on all Ruby platforms. Here's a complete compatibility matrix:

| Backend | MRI | JRuby | TruffleRuby | Notes |
| --- | :-: | :-: | :-: | --- |
| **MRI** ([ruby\_tree\_sitter](https://github.com/Faveod/ruby-tree-sitter)) | ‚úÖ | ‚ùå | ‚ùå | C extension, MRI only |
| **Rust** ([tree\_stump](https://github.com/joker1007/tree_stump)) | ‚úÖ | ‚ùå | ‚ùå | magnus/rb-sys incompatible with non-MRI |
| **FFI** | ‚úÖ | ‚úÖ | ‚ùå | TruffleRuby FFI doesn't support `STRUCT_BY_VALUE` |
| **Java** ([jtreesitter](https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter)) | ‚ùå | ‚úÖ | ‚ùå | JRuby only, requires grammar JARs |
| **Prism** | ‚úÖ | ‚úÖ | ‚úÖ | Ruby parsing, stdlib in Ruby 3.4+ |
| **Psych** | ‚úÖ | ‚úÖ | ‚úÖ | YAML parsing, stdlib |
| **Citrus** | ‚úÖ | ‚úÖ | ‚úÖ | Pure Ruby, no native dependencies |
| **Commonmarker** | ‚úÖ | ‚ùå | ‚ùì | Rust extension for Markdown |
| **Markly** | ‚úÖ | ‚ùå | ‚ùì | C extension for Markdown |

**Legend**: ‚úÖ = Works, ‚ùå = Does not work, ‚ùì = Untested

#### TruffleRuby Limitations

TruffleRuby has **no working tree-sitter backend**:

  - **FFI**: TruffleRuby's FFI doesn't support `STRUCT_BY_VALUE` return types (used by `ts_tree_root_node`, `ts_node_child`, etc.)
  - **MRI/Rust**: C and Rust extensions require MRI's C API internals (`RBasic.flags`, `rb_gc_writebarrier`, etc.) that TruffleRuby doesn't expose
TruffleRuby users should use: **Prism** (Ruby), **Psych** (YAML), **Citrus** (TOML via toml-rb), or potentially **Commonmarker/Markly** (Markdown).

#### JRuby Limitations

JRuby runs on the JVM and **cannot load native `.so` extensions**:

  - **MRI/Rust**: C and Rust extensions simply cannot be loaded
  - **FFI**: Works\! JRuby has excellent FFI support
JRuby users should use: **FFI backend** or **Java backend** for tree-sitter, plus **Prism**, **Psych**, **Citrus** for other formats.

[ruby_tree_sitter]: https://github.com/Faveod/ruby-tree-sitter
[tree_stump]: https://github.com/joker1007/tree_stump
[jtreesitter]: https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter

### Why TreeHaver?

tree-sitter is a powerful parser generator that creates incremental parsers for many programming languages. However, integrating it into Ruby applications can be challenging:

  - MRI-based C extensions don't work on JRuby
  - FFI-based solutions may not be optimal for MRI
  - Managing different backends for different Ruby implementations is cumbersome
TreeHaver solves these problems by providing a unified API that automatically selects the appropriate backend for your Ruby implementation, allowing you to write code once and run it anywhere.


### The `*-merge` Gem Family

The `*-merge` gem family provides intelligent, AST-based merging for various file formats. At the foundation is [tree_haver][tree_haver], which provides a unified cross-Ruby parsing API that works seamlessly across MRI, JRuby, and TruffleRuby.

| Gem                                      | Format   | Parser Backend(s)                                                                                   | Description                                                                      |
|------------------------------------------|----------|-----------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| [tree_haver][tree_haver]                 | Multi    | MRI C, Rust, FFI, Java, Prism, Psych, Commonmarker, Markly, Citrus                                  | **Foundation**: Cross-Ruby adapter for parsing libraries (like Faraday for HTTP) |
| [ast-merge][ast-merge]                   | Text     | internal                                                                                            | **Infrastructure**: Shared base classes and merge logic for all `*-merge` gems   |
| [prism-merge][prism-merge]               | Ruby     | [Prism][prism]                                                                                      | Smart merge for Ruby source files                                                |
| [psych-merge][psych-merge]               | YAML     | [Psych][psych]                                                                                      | Smart merge for YAML files                                                       |
| [json-merge][json-merge]                 | JSON     | [tree-sitter-json][ts-json] (via tree_haver)                                                        | Smart merge for JSON files                                                       |
| [jsonc-merge][jsonc-merge]               | JSONC    | [tree-sitter-jsonc][ts-jsonc] (via tree_haver)                                                      | ‚ö†Ô∏è Proof of concept; Smart merge for JSON with Comments                          |
| [bash-merge][bash-merge]                 | Bash     | [tree-sitter-bash][ts-bash] (via tree_haver)                                                        | Smart merge for Bash scripts                                                     |
| [rbs-merge][rbs-merge]                   | RBS      | [RBS][rbs]                                                                                          | Smart merge for Ruby type signatures                                             |
| [dotenv-merge][dotenv-merge]             | Dotenv   | internal                                                                                            | Smart merge for `.env` files                                                     |
| [toml-merge][toml-merge]                 | TOML     | [Citrus + toml-rb][toml-rb] (default, via tree_haver), [tree-sitter-toml][ts-toml] (via tree_haver) | Smart merge for TOML files                                                       |
| [markdown-merge][markdown-merge]         | Markdown | [Commonmarker][commonmarker] / [Markly][markly] (via tree_haver)                                    | **Foundation**: Shared base for Markdown mergers with inner code block merging   |
| [markly-merge][markly-merge]             | Markdown | [Markly][markly] (via tree_haver)                                                                   | Smart merge for Markdown (CommonMark via cmark-gfm C)                            |
| [commonmarker-merge][commonmarker-merge] | Markdown | [Commonmarker][commonmarker] (via tree_haver)                                                       | Smart merge for Markdown (CommonMark via comrak Rust)                            |

**Example implementations** for the gem templating use case:

| Gem | Purpose | Description |
| --- | --- | --- |
| [kettle-dev](https://github.com/kettle-rb/kettle-dev) | Gem Development | Gem templating tool using `*-merge` gems |
| [kettle-jem](https://github.com/kettle-rb/kettle-jem) | Gem Templating | Gem template library with smart merge support |

[tree_haver]: https://github.com/kettle-rb/tree_haver
[ast-merge]: https://github.com/kettle-rb/ast-merge
[prism-merge]: https://github.com/kettle-rb/prism-merge
[psych-merge]: https://github.com/kettle-rb/psych-merge
[json-merge]: https://github.com/kettle-rb/json-merge
[jsonc-merge]: https://github.com/kettle-rb/jsonc-merge
[bash-merge]: https://github.com/kettle-rb/bash-merge
[rbs-merge]: https://github.com/kettle-rb/rbs-merge
[dotenv-merge]: https://github.com/kettle-rb/dotenv-merge
[toml-merge]: https://github.com/kettle-rb/toml-merge
[markdown-merge]: https://github.com/kettle-rb/markdown-merge
[markly-merge]: https://github.com/kettle-rb/markly-merge
[commonmarker-merge]: https://github.com/kettle-rb/commonmarker-merge
[kettle-dev]: https://github.com/kettle-rb/kettle-dev
[kettle-jem]: https://github.com/kettle-rb/kettle-jem
[prism]: https://github.com/ruby/prism
[psych]: https://github.com/ruby/psych
[ts-json]: https://github.com/tree-sitter/tree-sitter-json
[ts-bash]: https://github.com/tree-sitter/tree-sitter-bash
[ts-toml]: https://github.com/tree-sitter-grammars/tree-sitter-toml
[rbs]: https://github.com/ruby/rbs
[toml-rb]: https://github.com/emancu/toml-rb
[markly]: https://github.com/ioquatix/markly
[commonmarker]: https://github.com/gjtorikian/commonmarker


[ts-jsonc]: https://gitlab.com/WhyNotHugo/tree-sitter-jsonc
[dotenv]: https://github.com/bkeepers/dotenv

### Comparison with Other Ruby AST / Parser Bindings

| Feature | [tree\_haver](https://github.com/kettle-rb/tree_haver) (this gem) | [ruby\_tree\_sitter](https://github.com/Faveod/ruby-tree-sitter) | [tree\_stump](https://github.com/joker1007/tree_stump) | [citrus](https://github.com/mjackson/citrus) |
| --- | --- | --- | --- | --- |
| **MRI Ruby** | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes |
| **JRuby** | ‚úÖ Yes (FFI, Java, or Citrus backend) | ‚ùå No | ‚ùå No | ‚úÖ Yes |
| **TruffleRuby** | ‚úÖ Yes (FFI or Citrus) | ‚ùå No | ‚ùì Unknown | ‚úÖ Yes |
| **Backend** | Multi (MRI C, Rust, FFI, Java, Citrus) | C extension only | Rust extension | Pure Ruby |
| **Incremental Parsing** | ‚úÖ Via MRI C/Rust/Java backend | ‚úÖ Yes | ‚úÖ Yes | ‚ùå No |
| **Query API** | ‚ö° Via MRI/Rust/Java backend | ‚úÖ Yes | ‚úÖ Yes | ‚ùå No |
| **Grammar Discovery** | ‚úÖ Built-in `GrammarFinder` | ‚ùå Manual | ‚ùå Manual | ‚ùå Manual |
| **Security Validations** | ‚úÖ `PathValidator` | ‚ùå No | ‚ùå No | ‚ùå No |
| **Language Registration** | ‚úÖ Thread-safe registry | ‚ùå No | ‚ùå No | ‚ùå No |
| **Native Performance** | ‚ö° Backend-dependent | ‚úÖ Native C | ‚úÖ Native Rust | ‚ùå Pure Ruby |
| **Precompiled Binaries** | ‚ö° Via Rust backend | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Pure Ruby |
| **Zero Native Deps** | ‚ö° Via Citrus backend | ‚ùå No | ‚ùå No | ‚úÖ Yes |
| **Minimum Ruby** | 3.2+ | 3.0+ | 3.1+ | 0+ |

[ruby_tree_sitter]: https://github.com/Faveod/ruby-tree-sitter
[tree_stump]: https://github.com/joker1007/tree_stump
[citrus]: https://github.com/mjackson/citrus
[tree_haver]: https://github.com/kettle-rb/tree_haver

**Note:** Java backend works with grammar JARs built specifically for `java-tree-sitter` / `jtreesitter`, or grammar .so files that statically link tree-sitter. This is why FFI is recommended for JRuby & TruffleRuby.

**Note:** TreeHaver can use `ruby_tree_sitter` (MRI) or `tree_stump` (MRI, JRuby?) as backends, or `java-tree-sitter` ([docs](https://tree-sitter.github.io/java-tree-sitter/), [maven](https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter), [source](https://github.com/tree-sitter/java-tree-sitter), JRuby), or FFI on any backend, giving you TreeHaver's unified API, grammar discovery, and security features, plus full access to incremental parsing when using those backends.

**Note:** `tree_stump` currently requires unreleased fixes in the `main` branch.

#### When to Use Each

**Choose TreeHaver when:**

  - You need JRuby or TruffleRuby support
  - You're building a library that should work across Ruby implementations
  - You want automatic grammar discovery and security validations
  - You want flexibility to switch backends without code changes
  - You need incremental parsing with a unified API
**Choose ruby\_tree\_sitter directly when:**

  - You only target MRI Ruby
  - You need the full Query API without abstraction
  - You want the most battle-tested C bindings
  - You don't need TreeHaver's grammar discovery
**Choose tree\_stump directly when:**

  - You only target MRI Ruby
  - You prefer Rust-based native extensions
  - You want precompiled binaries without system dependencies
  - You don't need TreeHaver's grammar discovery
  - **Note:** `tree_stump` currently requires unreleased fixes in the `main` branch.
**Choose citrus directly when:**

  - You need zero native dependencies (pure Ruby)
  - You're using a Citrus grammar (not tree-sitter grammars)
  - Performance is less critical than portability
  - You don't need TreeHaver's unified API
## üí° Info you can shake a stick at

| Tokens to Remember | [![Gem name](https://img.shields.io/badge/name-tree__haver-3C2D2D.svg?style=square&logo=rubygems&logoColor=red)](https://bestgems.org/gems/tree_haver) [![Gem namespace](https://img.shields.io/badge/namespace-TreeHaver-3C2D2D.svg?style=square&logo=ruby&logoColor=white)](https://github.com/kettle-rb/tree_haver) |
| --- | --- |
| Works with JRuby | [![JRuby 10.0 Compat](https://img.shields.io/badge/JRuby-current-FBE742?style=for-the-badge&logo=ruby&logoColor=green)](https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml) [![JRuby HEAD Compat](https://img.shields.io/badge/JRuby-HEAD-FBE742?style=for-the-badge&logo=ruby&logoColor=blue)](https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml) |
| Works with Truffle Ruby | [![Truffle Ruby 23.1 Compat](https://img.shields.io/badge/Truffle_Ruby-23.1-34BCB1?style=for-the-badge&logo=ruby&logoColor=pink)](https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml) [![Truffle Ruby 24.1 Compat](https://img.shields.io/badge/Truffle_Ruby-current-34BCB1?style=for-the-badge&logo=ruby&logoColor=green)](https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml) |
| Works with MRI Ruby 3 | [![Ruby 3.2 Compat](https://img.shields.io/badge/Ruby-3.2-CC342D?style=for-the-badge&logo=ruby&logoColor=white)](https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml) [![Ruby 3.3 Compat](https://img.shields.io/badge/Ruby-3.3-CC342D?style=for-the-badge&logo=ruby&logoColor=white)](https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml) [![Ruby 3.4 Compat](https://img.shields.io/badge/Ruby-current-CC342D?style=for-the-badge&logo=ruby&logoColor=green)](https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml) [![Ruby HEAD Compat](https://img.shields.io/badge/Ruby-HEAD-CC342D?style=for-the-badge&logo=ruby&logoColor=blue)](https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml) |
| Support & Community | [![Join Me on Daily.dev's RubyFriends](https://img.shields.io/badge/daily.dev-%F0%9F%92%8E_Ruby_Friends-0A0A0A?style=for-the-badge&logo=dailydotdev&logoColor=white)](https://app.daily.dev/squads/rubyfriends) [![Live Chat on Discord](https://img.shields.io/discord/1373797679469170758?style=for-the-badge&logo=discord)](https://discord.gg/3qme4XHNKN) [![Get help from me on Upwork](https://img.shields.io/badge/UpWork-13544E?style=for-the-badge&logo=Upwork&logoColor=white)](https://www.upwork.com/freelancers/~014942e9b056abdf86?mp_source=share) [![Get help from me on Codementor](https://img.shields.io/badge/CodeMentor-Get_Help-1abc9c?style=for-the-badge&logo=CodeMentor&logoColor=white)](https://www.codementor.io/peterboling?utm_source=github&utm_medium=button&utm_term=peterboling&utm_campaign=github) |
| Source | [![Source on GitLab.com](https://img.shields.io/badge/GitLab-FBA326?style=for-the-badge&logo=Gitlab&logoColor=orange)](https://gitlab.com/kettle-rb/tree_haver/) [![Source on CodeBerg.org](https://img.shields.io/badge/CodeBerg-4893CC?style=for-the-badge&logo=CodeBerg&logoColor=blue)](https://codeberg.org/kettle-rb/tree_haver) [![Source on Github.com](https://img.shields.io/badge/GitHub-238636?style=for-the-badge&logo=Github&logoColor=green)](https://github.com/kettle-rb/tree_haver) [![The best SHA: dQw4w9WgXcQ\!](https://img.shields.io/badge/KLOC-2.484-FFDD67.svg?style=for-the-badge&logo=YouTube&logoColor=blue)](https://www.youtube.com/watch?v=dQw4w9WgXcQ) |
| Documentation | [![Current release on RubyDoc.info](https://img.shields.io/badge/RubyDoc-Current_Release-943CD2?style=for-the-badge&logo=readthedocs&logoColor=white)](http://rubydoc.info/gems/tree_haver) [![YARD on Galtzo.com](https://img.shields.io/badge/YARD_on_Galtzo.com-HEAD-943CD2?style=for-the-badge&logo=readthedocs&logoColor=white)](https://tree-haver.galtzo.com) [![Maintainer Blog](https://img.shields.io/badge/blog-railsbling-0093D0.svg?style=for-the-badge&logo=rubyonrails&logoColor=orange)](http://www.railsbling.com/tags/tree_haver) [![GitLab Wiki](https://img.shields.io/badge/wiki-examples-943CD2.svg?style=for-the-badge&logo=gitlab&logoColor=white)](https://gitlab.com/kettle-rb/tree_haver/-/wikis/home) [![GitHub Wiki](https://img.shields.io/badge/wiki-examples-943CD2.svg?style=for-the-badge&logo=github&logoColor=white)](https://github.com/kettle-rb/tree_haver/wiki) |
| Compliance | [![License: MIT](https://img.shields.io/badge/License-MIT-259D6C.svg)](https://opensource.org/licenses/MIT) [![Compatible with Apache Software Projects: Verified by SkyWalking Eyes](https://img.shields.io/badge/Apache_Compatible:_Category_A-%E2%9C%93-259D6C.svg?style=flat&logo=Apache)](https://dev.to/galtzo/how-to-check-license-compatibility-41h0) [![üìÑilo-declaration-img](https://img.shields.io/badge/ILO_Fundamental_Principles-‚úì-259D6C.svg?style=flat)](https://www.ilo.org/declaration/lang--en/index.htm) [![Security Policy](https://img.shields.io/badge/security-policy-259D6C.svg?style=flat)](SECURITY.md) [![Contributor Covenant 2.1](https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg)](CODE_OF_CONDUCT.md) [![SemVer 2.0.0](https://img.shields.io/badge/semver-2.0.0-259D6C.svg?style=flat)](https://semver.org/spec/v2.0.0.html) |
| Style | [![Enforced Code Style Linter](https://img.shields.io/badge/code_style_&_linting-rubocop--lts-34495e.svg?plastic&logo=ruby&logoColor=white)](https://github.com/rubocop-lts/rubocop-lts) [![Keep-A-Changelog 1.0.0](https://img.shields.io/badge/keep--a--changelog-1.0.0-34495e.svg?style=flat)](https://keepachangelog.com/en/1.0.0/) [![Gitmoji Commits](https://img.shields.io/badge/gitmoji_commits-%20%F0%9F%98%9C%20%F0%9F%98%8D-34495e.svg?style=flat-square)](https://gitmoji.dev) [![Compatibility appraised by: appraisal2](https://img.shields.io/badge/appraised_by-appraisal2-34495e.svg?plastic&logo=ruby&logoColor=white)](https://github.com/appraisal-rb/appraisal2) |
| Maintainer üéñÔ∏è | [![Follow Me on LinkedIn](https://img.shields.io/badge/PeterBoling-LinkedIn-0B66C2?style=flat&logo=newjapanprowrestling)](http://www.linkedin.com/in/peterboling) [![Follow Me on Ruby.Social](https://img.shields.io/mastodon/follow/109447111526622197?domain=https://ruby.social&style=flat&logo=mastodon&label=Ruby%20@galtzo)](https://ruby.social/@galtzo) [![Follow Me on Bluesky](https://img.shields.io/badge/@galtzo.com-0285FF?style=flat&logo=bluesky&logoColor=white)](https://bsky.app/profile/galtzo.com) [![Contact Maintainer](https://img.shields.io/badge/Contact-Maintainer-0093D0.svg?style=flat&logo=rubyonrails&logoColor=red)](http://www.railsbling.com/contact) [![My technical writing](https://img.shields.io/badge/dev.to-0A0A0A?style=flat&logo=devdotto&logoColor=white)](https://dev.to/galtzo) |
| `...` üíñ | [![Find Me on WellFound:](https://img.shields.io/badge/peter--boling-orange?style=flat&logo=wellfound)](https://wellfound.com/u/peter-boling) [![Find Me on CrunchBase](https://img.shields.io/badge/peter--boling-purple?style=flat&logo=crunchbase)](https://www.crunchbase.com/person/peter-boling) [![My LinkTree](https://img.shields.io/badge/galtzo-purple?style=flat&logo=linktree)](https://linktr.ee/galtzo) [![More About Me](https://img.shields.io/badge/about.me-0A0A0A?style=flat&logo=aboutme&logoColor=white)](https://about.me/peter.boling) [üßä](https://codeberg.org/pboling) [üêô](https://github.org/pboling) [üõñ](https://sr.ht/~galtzo/) [üß™](https://gitlab.com/pboling) |

### Compatibility

Compatible with MRI Ruby 3.2.0+, and concordant releases of JRuby, and TruffleRuby.

| üöö *Amazing* test matrix was brought to you by | üîé appraisal2 üîé and the color üíö green üíö |
| --- | --- |
| üëü Check it out\! | ‚ú® [github.com/appraisal-rb/appraisal2](https://github.com/appraisal-rb/appraisal2) ‚ú® |

### Federated DVCS

<details markdown="1">
  <summary>Find this repo on federated forges (Coming soon!)</summary>

| Federated [DVCS](https://railsbling.com/posts/dvcs/put_the_d_in_dvcs/) Repository | Status | Issues | PRs | Wiki | CI | Discussions |
| --- | --- | --- | --- | --- | --- | --- |
| üß™ [kettle-rb/tree\_haver on GitLab](https://gitlab.com/kettle-rb/tree_haver/) | The Truth | [üíö](https://gitlab.com/kettle-rb/tree_haver/-/issues) | [üíö](https://gitlab.com/kettle-rb/tree_haver/-/merge_requests) | [üíö](https://gitlab.com/kettle-rb/tree_haver/-/wikis/home) | üê≠ Tiny Matrix | ‚ûñ |
| üßä [kettle-rb/tree\_haver on CodeBerg](https://codeberg.org/kettle-rb/tree_haver) | An Ethical Mirror ([Donate](https://donate.codeberg.org/)) | [üíö](https://codeberg.org/kettle-rb/tree_haver/issues) | [üíö](https://codeberg.org/kettle-rb/tree_haver/pulls) | ‚ûñ | ‚≠ïÔ∏è No Matrix | ‚ûñ |
| üêô [kettle-rb/tree\_haver on GitHub](https://github.com/kettle-rb/tree_haver) | Another Mirror | [üíö](https://github.com/kettle-rb/tree_haver/issues) | [üíö](https://github.com/kettle-rb/tree_haver/pulls) | [üíö](https://github.com/kettle-rb/tree_haver/wiki) | üíØ Full Matrix | [üíö](https://github.com/kettle-rb/tree_haver/discussions) |
| üéÆÔ∏è [Discord Server](https://discord.gg/3qme4XHNKN) | [![Live Chat on Discord](https://img.shields.io/discord/1373797679469170758?style=for-the-badge&logo=discord)](https://discord.gg/3qme4XHNKN) | [Let's](https://discord.gg/3qme4XHNKN) | [talk](https://discord.gg/3qme4XHNKN) | [about](https://discord.gg/3qme4XHNKN) | [this](https://discord.gg/3qme4XHNKN) | [library\!](https://discord.gg/3qme4XHNKN) |

</details>

[gh-discussions]: https://github.com/kettle-rb/tree_haver/discussions

### Enterprise Support [![Tidelift](https://tidelift.com/badges/package/rubygems/tree_haver)](https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&utm_medium=referral&utm_campaign=readme)

Available as part of the Tidelift Subscription.

<details markdown="1">
  <summary>Need enterprise-level guarantees?</summary>

The maintainers of this and thousands of other packages are working with Tidelift to deliver commercial support and maintenance for the open source packages you use to build your applications. Save time, reduce risk, and improve code health, while paying the maintainers of the exact packages you use.

[![Get help from me on Tidelift](https://img.shields.io/badge/Tidelift_and_Sonar-Enterprise_Support-FD3456?style=for-the-badge&logo=sonar&logoColor=white)](https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&utm_medium=referral&utm_campaign=readme)

  - üí°Subscribe for support guarantees covering *all* your FLOSS dependencies
  - üí°Tidelift is part of [Sonar](https://blog.tidelift.com/tidelift-joins-sonar)
  - üí°Tidelift pays maintainers to maintain the software you depend on\!<br/>üìä`@`Pointy Haired Boss: An [enterprise support](https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&utm_medium=referral&utm_campaign=readme) subscription is "[never gonna let you down](https://www.youtube.com/watch?v=dQw4w9WgXcQ)", and *supports* open source maintainers
Alternatively:

  - [![Live Chat on Discord](https://img.shields.io/discord/1373797679469170758?style=for-the-badge&logo=discord)](https://discord.gg/3qme4XHNKN)
  - [![Get help from me on Upwork](https://img.shields.io/badge/UpWork-13544E?style=for-the-badge&logo=Upwork&logoColor=white)](https://www.upwork.com/freelancers/~014942e9b056abdf86?mp_source=share)
  - [![Get help from me on Codementor](https://img.shields.io/badge/CodeMentor-Get_Help-1abc9c?style=for-the-badge&logo=CodeMentor&logoColor=white)](https://www.codementor.io/peterboling?utm_source=github&utm_medium=button&utm_term=peterboling&utm_campaign=github)
</details>

## ‚ú® Installation

Install the gem and add to the application's Gemfile by executing:

``` console
bundle add tree_haver
```

If bundler is not being used to manage dependencies, install the gem by executing:

``` console
gem install tree_haver
```

### üîí Secure Installation

<details markdown="1">
  <summary>For Medium or High Security Installations</summary>

This gem is cryptographically signed, and has verifiable [SHA-256 and SHA-512](https://gitlab.com/kettle-rb/tree_haver/-/tree/main/checksums) checksums by
[stone\_checksums](https://github.com/galtzo-floss/stone_checksums). Be sure the gem you install hasn‚Äôt been tampered with
by following the instructions below.

Add my public key (if you haven‚Äôt already, expires 2045-04-29) as a trusted certificate:

``` console
gem cert --add <(curl -Ls https://raw.github.com/galtzo-floss/certs/main/pboling.pem)
```

You only need to do that once. Then proceed to install with:

``` console
gem install tree_haver -P HighSecurity
```

The `HighSecurity` trust profile will verify signed gems, and not allow the installation of unsigned dependencies.

If you want to up your security game full-time:

``` console
bundle config set --global trust-policy MediumSecurity
```

`MediumSecurity` instead of `HighSecurity` is necessary if not all the gems you use are signed.

NOTE: Be prepared to track down certs for signed gems and add them the same way you added mine.

</details>

## ‚öôÔ∏è Configuration

### Available Backends

TreeHaver supports 10 parsing backends, each with different trade-offs. The `auto` backend automatically selects the best available option.

#### Tree-sitter Backends (Universal Parsing)

| Backend | Description | Performance | Portability | Examples |
| --- | --- | --- | --- | --- |
| **Auto** | Auto-selects best backend | Varies | ‚úÖ Universal | [JSON](examples/auto_json.rb) ¬∑ [JSONC](examples/auto_jsonc.rb) ¬∑ [Bash](examples/auto_bash.rb) ¬∑ [TOML](examples/auto_toml.rb) |
| **MRI** | C extension via ruby\_tree\_sitter | ‚ö° Fastest | MRI only | [JSON](examples/mri_json.rb) ¬∑ [JSONC](examples/mri_jsonc.rb) ¬∑ \~\~Bash\~\~\* ¬∑ [TOML](examples/mri_toml.rb) |
| **Rust** | Precompiled via tree\_stump | ‚ö° Very Fast | ‚úÖ Good | [JSON](examples/rust_json.rb) ¬∑ [JSONC](examples/rust_jsonc.rb) ¬∑ \~\~Bash\~\~\* ¬∑ [TOML](examples/rust_toml.rb) |
| **FFI** | Dynamic linking via FFI | üîµ Fast | ‚úÖ Universal | [JSON](examples/ffi_json.rb) ¬∑ [JSONC](examples/ffi_jsonc.rb) ¬∑ [Bash](examples/ffi_bash.rb) ¬∑ [TOML](examples/ffi_toml.rb) |
| **Java** | JNI bindings | ‚ö° Very Fast | JRuby only | [JSON](examples/java_json.rb) ¬∑ [JSONC](examples/java_jsonc.rb) ¬∑ [Bash](examples/java_bash.rb) ¬∑ [TOML](examples/java_toml.rb) |

#### Language-Specific Backends (Native Parser Integration)

| Backend | Description | Performance | Portability | Examples |
| --- | --- | --- | --- | --- |
| **Prism** | Ruby's official parser | ‚ö° Very Fast | ‚úÖ Universal | [Ruby](examples/prism_ruby.rb) |
| **Psych** | Ruby's YAML parser (stdlib) | ‚ö° Very Fast | ‚úÖ Universal | [YAML](examples/psych_yaml.rb) |
| **Commonmarker** | Markdown via comrak (Rust) | ‚ö° Very Fast | ‚úÖ Good | [Markdown](examples/commonmarker_markdown.rb) ¬∑ [Merge](examples/commonmarker_merge_example.rb) |
| **Markly** | GFM via cmark-gfm (C) | ‚ö° Very Fast | ‚úÖ Good | [Markdown](examples/markly_markdown.rb) ¬∑ [Merge](examples/markly_merge_example.rb) |
| **Citrus** | Pure Ruby parsing | üü° Slower | ‚úÖ Universal | [TOML](examples/citrus_toml.rb) ¬∑ [Finitio](examples/citrus_finitio.rb) ¬∑ [Dhall](examples/citrus_dhall.rb) |

**Selection Priority (Auto mode):** MRI ‚Üí Rust ‚Üí FFI ‚Üí Java ‚Üí Prism ‚Üí Psych ‚Üí Commonmarker ‚Üí Markly ‚Üí Citrus

**Known Issues:**
  - \*MRI + Bash: ABI incompatibility (use FFI instead)
  - \*Rust + Bash: Version mismatch (use FFI instead)
**Backend Requirements:**

``` ruby
# Tree-sitter backends
gem "ruby_tree_sitter", "~> 2.0"  # MRI backend
gem "tree_stump"                   # Rust backend
gem "ffi", ">= 1.15", "< 2.0"     # FFI backend
# Java backend: no gem required (uses JRuby's built-in JNI)

# Language-specific backends
gem "prism", "~> 1.0"              # Ruby parsing (stdlib in Ruby 3.4+)
# Psych: no gem required (Ruby stdlib)
gem "commonmarker", ">= 0.23"      # Markdown parsing (comrak)
gem "markly", "~> 0.11"            # GFM parsing (cmark-gfm)

# Pure Ruby fallback
gem "citrus", "~> 3.0"             # Citrus backend
# Plus grammar gems: toml-rb, dhall, finitio, etc.
```

**Force Specific Backend:**

``` ruby
# Tree-sitter backends
TreeHaver.backend = :mri    # Force MRI backend (ruby_tree_sitter)
TreeHaver.backend = :rust   # Force Rust backend (tree_stump)
TreeHaver.backend = :ffi    # Force FFI backend
TreeHaver.backend = :java   # Force Java backend (JRuby only)

# Language-specific backends
TreeHaver.backend = :prism        # Force Prism (Ruby parsing)
TreeHaver.backend = :psych        # Force Psych (YAML parsing)
TreeHaver.backend = :commonmarker # Force Commonmarker (Markdown)
TreeHaver.backend = :markly       # Force Markly (GFM Markdown)

# Pure Ruby fallback
TreeHaver.backend = :citrus # Force Citrus backend

# Auto-selection (default)
TreeHaver.backend = :auto   # Let TreeHaver choose
```

**Block-based Backend Switching:**

Use `with_backend` to temporarily switch backends for a specific block of code.
This is thread-safe and supports nesting‚Äîthe previous backend is automatically
restored when the block exits (even if an exception is raised).

``` ruby
# Temporarily use a specific backend
TreeHaver.with_backend(:mri) do
  parser = TreeHaver::Parser.new
  tree = parser.parse(source)
  # All operations in this block use the MRI backend
end
# Backend is restored to its previous value here

# Nested blocks work correctly
TreeHaver.with_backend(:rust) do
  # Uses :rust
  TreeHaver.with_backend(:citrus) do
    # Uses :citrus
    parser = TreeHaver::Parser.new
  end
  # Back to :rust
end
# Back to original backend
```

This is particularly useful for:

  - **Testing**: Test the same code with different backends
  - **Performance comparison**: Benchmark different backends
  - **Fallback scenarios**: Try one backend, fall back to another
  - **Thread isolation**: Each thread can use a different backend safely

<!-- end list -->
``` ruby
# Example: Testing with multiple backends
[:mri, :rust, :citrus].each do |backend_name|
  TreeHaver.with_backend(backend_name) do
    parser = TreeHaver::Parser.new
    result = parser.parse(source)
    puts "#{backend_name}: #{result.root_node.type}"
  end
end
```

**Check Backend Capabilities:**

``` ruby
TreeHaver.backend              # => :ffi
TreeHaver.backend_module       # => TreeHaver::Backends::FFI
TreeHaver.capabilities         # => { backend: :ffi, parse: true, query: false, ... }
```

See [examples/](examples/) directory for **26 complete working examples** demonstrating all 10 backends with multiple languages (JSON, JSONC, Bash, TOML, Ruby, YAML, Markdown) plus markdown-merge integration examples.

### Security Considerations

**‚ö†Ô∏è Loading shared libraries (.so/.dylib/.dll) executes arbitrary native code.**

TreeHaver provides defense-in-depth validations, but you should understand the risks:

#### Attack Vectors Mitigated

TreeHaver's `PathValidator` module protects against:

  - **Path traversal**: Paths containing `/../` or `/./` are rejected
  - **Null byte injection**: Paths containing null bytes are rejected
  - **Non-absolute paths**: Relative paths are rejected to prevent CWD-based attacks
  - **Invalid extensions**: Only `.so`, `.dylib`, and `.dll` files are accepted
  - **Malicious filenames**: Filenames must match a safe pattern (alphanumeric, hyphens, underscores)
  - **Invalid language names**: Language names must be lowercase alphanumeric with underscores
  - **Invalid symbol names**: Symbol names must be valid C identifiers
#### Secure Usage

``` ruby
# Standard usage - paths from ENV are validated
finder = TreeHaver::GrammarFinder.new(:toml)
path = finder.find_library_path  # Validates ENV path before returning

# Maximum security - only trusted system directories
path = finder.find_library_path_safe  # Ignores ENV, only /usr/lib etc.

# Manual validation
if TreeHaver::PathValidator.safe_library_path?(user_provided_path)
  language = TreeHaver::Language.from_library(user_provided_path)
end

# Get validation errors for debugging
errors = TreeHaver::PathValidator.validation_errors(path)
# => ["Path is not absolute", "Path contains traversal sequence"]
```

#### Trusted Directories

The `find_library_path_safe` method only returns paths in trusted directories.

**Default trusted directories:**

  - `/usr/lib`, `/usr/lib64`
  - `/usr/lib/x86_64-linux-gnu`, `/usr/lib/aarch64-linux-gnu`
  - `/usr/local/lib`
  - `/opt/homebrew/lib`, `/opt/local/lib`
**Adding custom trusted directories:**

For non-standard installations (Homebrew on Linux, luarocks, mise, asdf, etc.), register additional trusted directories:

``` ruby
# Programmatically at application startup
TreeHaver::PathValidator.add_trusted_directory("/home/linuxbrew/.linuxbrew/Cellar")
TreeHaver::PathValidator.add_trusted_directory("~/.local/share/mise/installs/lua")

# Or via environment variable (comma-separated, in your shell profile)
export TREE_HAVER_TRUSTED_DIRS = "/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua"
```

**Example: Fedora Silverblue with Homebrew and luarocks**

``` bash
# In ~/.bashrc or ~/.zshrc
export TREE_HAVER_TRUSTED_DIRS="/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua"

# tree-sitter runtime library
export TREE_SITTER_RUNTIME_LIB=/home/linuxbrew/.linuxbrew/Cellar/tree-sitter/0.26.3/lib/libtree-sitter.so

# Language grammar (luarocks-installed)
export TREE_SITTER_TOML_PATH=~/.local/share/mise/installs/lua/5.4.8/luarocks/lib/luarocks/rocks-5.4/tree-sitter-toml/0.0.31-1/parser/toml.so
```

#### Recommendations

1.  **Production**: Consider using `find_library_path_safe` to ignore ENV overrides
2.  **Development**: Standard `find_library_path` is convenient for testing
3.  **User Input**: Always validate paths before passing to `Language.from_library`
4.  **CI/CD**: Be cautious of ENV vars that could be set by untrusted sources
5.  **Custom installs**: Register trusted directories via `TREE_HAVER_TRUSTED_DIRS` or `add_trusted_directory`
### Backend Selection

TreeHaver automatically selects the best backend for your Ruby implementation, but you can override this behavior:

``` ruby
# Automatic backend selection (default)
TreeHaver.backend = :auto

# Force a specific backend
TreeHaver.backend = :mri     # Use ruby_tree_sitter (MRI only, C extension)
TreeHaver.backend = :rust    # Use tree_stump (MRI, Rust extension with precompiled binaries)
                             # Note: `tree_stump` currently requires unreleased fixes in the `main` branch.
                             # See: https://github.com/joker1007/tree_stump
TreeHaver.backend = :ffi     # Use FFI bindings (works on MRI and JRuby)
TreeHaver.backend = :java    # Use Java bindings (JRuby only, coming soon)
TreeHaver.backend = :citrus  # Use Citrus pure Ruby parser
                             # NOTE: Portable, all Ruby implementations
                             # CAVEAT: few major language grammars, but many esoteric grammars
```

**Auto-selection priority on MRI:** MRI ‚Üí Rust ‚Üí FFI ‚Üí Citrus

You can also set the backend via environment variable:

``` bash
export TREE_HAVER_BACKEND=rust
```

### Environment Variables

TreeHaver recognizes several environment variables for configuration:

**Note**: All path-based environment variables are validated before use. Invalid paths are ignored.

#### Security Configuration

  - **`TREE_HAVER_TRUSTED_DIRS`**: Comma-separated list of additional trusted directories for grammar libraries

    ``` bash
    # For Homebrew on Linux and luarocks
    export TREE_HAVER_TRUSTED_DIRS="/home/linuxbrew/.linuxbrew/Cellar,~/.local/share/mise/installs/lua"
    ```

    Tilde (`~`) is expanded to the user's home directory. Directories listed here are considered safe for `find_library_path_safe`.
#### Core Runtime Library

  - **`TREE_SITTER_RUNTIME_LIB`**: Absolute path to the core `libtree-sitter` shared library
    ``` bash
    export TREE_SITTER_RUNTIME_LIB=/usr/local/lib/libtree-sitter.so
    ```
If not set, TreeHaver tries these names in order:

  - `tree-sitter`
  - `libtree-sitter.so.0`
  - `libtree-sitter.so`
  - `libtree-sitter.dylib`
  - `libtree-sitter.dll`
#### Language Symbol Resolution

When loading a language grammar, if you don't specify the `symbol:` parameter, TreeHaver resolves it in this precedence:

1.  **`TREE_SITTER_LANG_SYMBOL`**: Explicit symbol override
2.  Guessed from filename (e.g., `libtree-sitter-toml.so` ‚Üí `tree_sitter_toml`)
3.  Default fallback (`tree_sitter_toml`)

<!-- end list -->
``` bash
export TREE_SITTER_LANG_SYMBOL=tree_sitter_toml
```

#### Language Library Paths

For specific languages, you can set environment variables to point to grammar libraries:

``` bash
export TREE_SITTER_TOML_PATH=/usr/local/lib/libtree-sitter-toml.so
export TREE_SITTER_JSON_PATH=/usr/local/lib/libtree-sitter-json.so
```

#### JRuby-Specific: Java Backend JARs

For the Java backend on JRuby:

``` bash
export TREE_SITTER_JAVA_JARS_DIR=/path/to/java-tree-sitter/jars
```

For more see [docs](https://tree-sitter.github.io/java-tree-sitter/), [maven](https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter), and [source](https://github.com/tree-sitter/java-tree-sitter).

### Language Registration

Register languages once at application startup for convenient access:

``` ruby
# Register a TOML grammar
TreeHaver.register_language(
  :toml,
  path: "/usr/local/lib/libtree-sitter-toml.so",
  symbol: "tree_sitter_toml",  # optional, will be inferred if omitted
)

# Now you can use the convenient helper
language = TreeHaver::Language.toml

# Or still override path/symbol per-call
language = TreeHaver::Language.toml(
  path: "/custom/path/libtree-sitter-toml.so",
)
```

### Grammar Discovery with GrammarFinder

For libraries that need to automatically locate tree-sitter grammars (like the `*-merge` family of gems), TreeHaver provides the `GrammarFinder` utility class. It handles platform-aware grammar discovery without requiring language-specific code in TreeHaver itself.

``` ruby
# Create a finder for any language
finder = TreeHaver::GrammarFinder.new(:toml)

# Check if the grammar is available
if finder.available?
  puts "TOML grammar found at: #{finder.find_library_path}"
else
  puts finder.not_found_message
  # => "tree-sitter toml grammar not found. Searched: /usr/lib/libtree-sitter-toml.so, ..."
end

# Register the language if available
finder.register! if finder.available?

# Now use the registered language
language = TreeHaver::Language.toml
```

#### GrammarFinder Automatic Derivation

Given just the language name, `GrammarFinder` automatically derives:

| Property | Derived Value (for `:toml`) |
| --- | --- |
| ENV var | `TREE_SITTER_TOML_PATH` |
| Library filename | `libtree-sitter-toml.so` (Linux) or `.dylib` (macOS) |
| Symbol name | `tree_sitter_toml` |

#### Search Order

`GrammarFinder` searches for grammars in this order:

1.  **Environment variable**: `TREE_SITTER_<LANG>_PATH` (highest priority)
2.  **Extra paths**: Custom paths provided at initialization
3.  **System paths**: Common installation directories (`/usr/lib`, `/usr/local/lib`, `/opt/homebrew/lib`, etc.)
#### Usage in \*-merge Gems

The `GrammarFinder` pattern enables clean integration in language-specific merge gems:

``` ruby
# In toml-merge
finder = TreeHaver::GrammarFinder.new(:toml)
finder.register! if finder.available?

# In json-merge
finder = TreeHaver::GrammarFinder.new(:json)
finder.register! if finder.available?

# In bash-merge
finder = TreeHaver::GrammarFinder.new(:bash)
finder.register! if finder.available?
```

Each gem uses the same API‚Äîonly the language name changes.

#### Adding Custom Search Paths

For non-standard installations, provide extra search paths:

``` ruby
finder = TreeHaver::GrammarFinder.new(:toml, extra_paths: [
  "/opt/custom/lib",
  "/home/user/.local/lib",
])
```

#### Debug Information

Get detailed information about the grammar search:

``` ruby
finder = TreeHaver::GrammarFinder.new(:toml)
puts finder.search_info
# => {
#      language: :toml,
#      env_var: "TREE_SITTER_TOML_PATH",
#      env_value: nil,
#      symbol: "tree_sitter_toml",
#      library_filename: "libtree-sitter-toml.so",
#      search_paths: ["/usr/lib/libtree-sitter-toml.so", ...],
#      found_path: "/usr/lib/libtree-sitter-toml.so",
#      available: true
#    }
```

### Checking Capabilities

Different backends may support different features:

``` ruby
TreeHaver.capabilities
# => { backend: :mri, query: true, bytes_field: true }
# or
# => { backend: :ffi, parse: true, query: false, bytes_field: true }
# or
# => { backend: :citrus, parse: true, query: false, bytes_field: false }
```

### Compatibility Mode

For codebases migrating from `ruby_tree_sitter`, TreeHaver provides a compatibility shim:

``` ruby
require "tree_haver/compat"

# Now TreeSitter constants map to TreeHaver
parser = TreeSitter::Parser.new  # Actually creates TreeHaver::Parser
```

This is safe and idempotent‚Äîif the real `TreeSitter` module is already loaded, the shim does nothing.

#### ‚ö†Ô∏è Important: Exception Hierarchy

**Both ruby\_tree\_sitter v2+ and TreeHaver exceptions inherit from `Exception` (not `StandardError`).**

This design decision follows ruby\_tree\_sitter's lead for thread-safety and signal handling reasons. See [ruby\_tree\_sitter PR \#83](https://github.com/Faveod/ruby-tree-sitter/pull/83) for the rationale.

**What this means for exception handling:**

``` ruby
# ‚ö†Ô∏è This will NOT catch TreeHaver errors
begin
  TreeHaver::Language.from_library("/nonexistent.so")
rescue => e
  puts "Caught!"  # Never reached - TreeHaver::Error inherits Exception
end

# ‚úÖ Explicit rescue is required
begin
  TreeHaver::Language.from_library("/nonexistent.so")
rescue TreeHaver::Error => e
  puts "Caught!"  # This works
end

# ‚úÖ Or rescue specific exceptions
begin
  TreeHaver::Language.from_library("/nonexistent.so")
rescue TreeHaver::NotAvailable => e
  puts "Grammar not available: #{e.message}"
end
```

**TreeHaver Exception Hierarchy:**

    Exception
    ‚îî‚îÄ‚îÄ TreeHaver::Error              # Base error class
        ‚îú‚îÄ‚îÄ TreeHaver::NotAvailable   # Backend/grammar not available
        ‚îî‚îÄ‚îÄ TreeHaver::BackendConflict # Backend incompatibility detected

**Compatibility Mode Behavior:**

The compat mode (`require "tree_haver/compat"`) creates aliases but **does not change the exception hierarchy**:

``` ruby
require "tree_haver/compat"

# TreeSitter constants are now aliases to TreeHaver
TreeSitter::Error       # => TreeHaver::Error (still inherits Exception)
TreeSitter::Parser      # => TreeHaver::Parser
TreeSitter::Language    # => TreeHaver::Language

# Exception handling remains the same
begin
  TreeSitter::Language.load("missing", "/nonexistent.so")
rescue TreeSitter::Error => e  # Still requires explicit rescue
  puts "Error: #{e.message}"
end
```

**Best Practices:**

1.  **Always use explicit rescue** for TreeHaver errors:

    ``` ruby
    begin
      finder = TreeHaver::GrammarFinder.new(:toml)
      finder.register! if finder.available?
      language = TreeHaver::Language.toml
    rescue TreeHaver::NotAvailable => e
      warn("TOML grammar not available: #{e.message}")
      # Fallback to another backend or fail gracefully
    end
    ```

2.  **Never rely on `rescue => e`** to catch TreeHaver errors (it won't work)
**Why inherit from Exception?**

Following ruby\_tree\_sitter's reasoning:
  - **Thread safety**: Prevents accidental catching in thread cleanup code
  - **Signal handling**: Ensures parsing errors don't interfere with SIGTERM/SIGINT
  - **Intentional handling**: Forces developers to explicitly handle parsing errors
See `lib/tree_haver/compat.rb` for compatibility layer documentation.

## üîß Basic Usage

### Quick Start

The simplest way to parse code is with `TreeHaver.parser_for`, which handles all the complexity of language loading, grammar discovery, and backend selection:

``` ruby
require "tree_haver"

# Parse TOML - auto-discovers grammar and falls back to Citrus if needed
parser = TreeHaver.parser_for(:toml)
tree = parser.parse("[package]\nname = \"my-app\"")

# Parse JSON
parser = TreeHaver.parser_for(:json)
tree = parser.parse('{"key": "value"}')

# Parse Bash
parser = TreeHaver.parser_for(:bash)
tree = parser.parse("#!/bin/bash\necho hello")

# With explicit library path
parser = TreeHaver.parser_for(:toml, library_path: "/custom/path/libtree-sitter-toml.so")

# With Citrus fallback configuration
parser = TreeHaver.parser_for(
  :toml,
  citrus_config: {gem_name: "toml-rb", grammar_const: "TomlRB::Document"},
)
```

`TreeHaver.parser_for` handles:
1.  Checking if the language is already registered
2.  Auto-discovering tree-sitter grammar via `GrammarFinder`
3.  Falling back to Citrus grammar if tree-sitter is unavailable
4.  Creating and configuring the parser
5.  Raising `NotAvailable` with a helpful message if nothing works
### Manual Parser Setup

For more control, you can create parsers manually:

TreeHaver works with any language through its 10 backends. Here are examples for different parsing needs:

#### Parsing with Tree-sitter (Universal Languages)

``` ruby
require "tree_haver"

# Load a tree-sitter grammar (works with MRI, Rust, FFI, or Java backend)
language = TreeHaver::Language.from_library(
  "/usr/local/lib/libtree-sitter-toml.so",
  symbol: "tree_sitter_toml",
)

# Create a parser
parser = TreeHaver::Parser.new
parser.language = language

# Parse source code
source = <<~TOML
  [package]
  name = "my-app"
  version = "1.0.0"
TOML

tree = parser.parse(source)

# Access the unified Position API (works across all backends)
root = tree.root_node
puts "Root type: #{root.type}"              # => "document"
puts "Start line: #{root.start_line}"       # => 1 (1-based)
puts "End line: #{root.end_line}"           # => 3
puts "Position: #{root.source_position}"    # => {start_line: 1, end_line: 3, ...}

# Traverse the tree
root.each do |child|
  puts "Child: #{child.type} at line #{child.start_line}"
end
```

#### Parsing Ruby with Prism

``` ruby
require "tree_haver"

TreeHaver.backend = :prism
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Backends::Prism::Language.ruby

source = <<~RUBY
  class Example
    def hello
      puts "Hello, world!"
    end
  end
RUBY

tree = parser.parse(source)
root = tree.root_node

# Find all method definitions
def find_methods(node, results = [])
  results << node if node.type == "def_node"
  node.children.each { |child| find_methods(child, results) }
  results
end

methods = find_methods(root)
methods.each do |method_node|
  pos = method_node.source_position
  puts "Method at lines #{pos[:start_line]}-#{pos[:end_line]}"
end
```

#### Parsing YAML with Psych

``` ruby
require "tree_haver"

TreeHaver.backend = :psych
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Backends::Psych::Language.yaml

source = <<~YAML
  database:
    host: localhost
    port: 5432
YAML

tree = parser.parse(source)
root = tree.root_node

# Navigate YAML structure
def show_structure(node, indent = 0)
  prefix = "  " * indent
  puts "#{prefix}#{node.type} (line #{node.start_line})"
  node.children.each { |child| show_structure(child, indent + 1) }
end

show_structure(root)
```

#### Parsing Markdown with Commonmarker or Markly

``` ruby
require "tree_haver"

# Choose your backend
TreeHaver.backend = :commonmarker  # or :markly for GFM

parser = TreeHaver::Parser.new
parser.language = TreeHaver::Backends::Commonmarker::Language.markdown

source = <<~MARKDOWN
  # My Document

  ## Section

  - Item 1
  - Item 2
MARKDOWN

tree = parser.parse(source)
root = tree.root_node

# Find all headings
def find_headings(node, results = [])
  results << node if node.type == "heading"
  node.children.each { |child| find_headings(child, results) }
  results
end

headings = find_headings(root)
headings.each do |heading|
  level = heading.header_level
  text = heading.children.map(&:text).join
  puts "H#{level}: #{text} (line #{heading.start_line})"
end
```

### Using Language Registration

For cleaner code, register languages at startup:

``` ruby
# At application initialization
TreeHaver.register_language(
  :toml,
  path: "/usr/local/lib/libtree-sitter-toml.so",
)

TreeHaver.register_language(
  :json,
  path: "/usr/local/lib/libtree-sitter-json.so",
)

# Later in your code
toml_language = TreeHaver::Language.toml
json_language = TreeHaver::Language.json

parser = TreeHaver::Parser.new
parser.language = toml_language
tree = parser.parse(toml_source)
```

#### Flexible Language Names

The `name` parameter in `register_language` is an arbitrary identifier you choose‚Äîit doesn't
need to match the actual language name. The actual grammar identity comes from the `path`
and `symbol` parameters (for tree-sitter) or `grammar_module` (for Citrus).

This flexibility is useful for:

  - **Aliasing**: Register the same grammar under multiple names
  - **Versioning**: Register different grammar versions (e.g., `:ruby_2`, `:ruby_3`)
  - **Testing**: Use unique names to avoid collisions between tests
  - **Context-specific naming**: Use names that make sense for your application

<!-- end list -->
``` ruby
# Register the same TOML grammar under different names for different purposes
TreeHaver.register_language(
  :config_parser,  # Custom name for your app
  path: "/usr/local/lib/libtree-sitter-toml.so",
  symbol: "tree_sitter_toml",
)

TreeHaver.register_language(
  :toml_v1,  # Version-specific name
  path: "/usr/local/lib/libtree-sitter-toml.so",
  symbol: "tree_sitter_toml",
)

# Use your custom names
config_lang = TreeHaver::Language.config_parser
versioned_lang = TreeHaver::Language.toml_v1
```

### Parsing Different Languages

TreeHaver works with any tree-sitter grammar:

``` ruby
# Parse Ruby code
ruby_lang = TreeHaver::Language.from_library(
  "/path/to/libtree-sitter-ruby.so",
)
parser = TreeHaver::Parser.new
parser.language = ruby_lang
tree = parser.parse("class Foo; end")

# Parse JavaScript
js_lang = TreeHaver::Language.from_library(
  "/path/to/libtree-sitter-javascript.so",
)
parser.language = js_lang  # Reuse the same parser
tree = parser.parse("const x = 42;")
```

### Walking the AST

TreeHaver provides simple node traversal:

``` ruby
tree = parser.parse(source)
root = tree.root_node

# Recursive tree walk
def walk_tree(node, depth = 0)
  puts "#{"  " * depth}#{node.type}"
  node.each { |child| walk_tree(child, depth + 1) }
end

walk_tree(root)
```

### Incremental Parsing

TreeHaver supports incremental parsing when using the MRI or Rust backends. This is a major performance optimization for editors and IDEs that need to re-parse on every keystroke.

``` ruby
# Check if current backend supports incremental parsing
if TreeHaver.capabilities[:incremental]
  puts "Incremental parsing is available!"
end

# Initial parse
parser = TreeHaver::Parser.new
parser.language = language
tree = parser.parse_string(nil, "x = 1")

# User edits the source: "x = 1" -> "x = 42"
# Mark the tree as edited (tell tree-sitter what changed)
tree.edit(
  start_byte: 4,           # edit starts at byte 4
  old_end_byte: 5,         # old text "1" ended at byte 5
  new_end_byte: 6,         # new text "42" ends at byte 6
  start_point: {row: 0, column: 4},
  old_end_point: {row: 0, column: 5},
  new_end_point: {row: 0, column: 6},
)

# Re-parse incrementally - tree-sitter reuses unchanged nodes
new_tree = parser.parse_string(tree, "x = 42")
```

**Note:** Incremental parsing requires the MRI (`ruby_tree_sitter`), Rust (`tree_stump`), or Java (`java-tree-sitter` / `jtreesitter`) backend. The FFI and Citrus backends do not currently support incremental parsing. You can check support with:

**Note:** `tree_stump` currently requires unreleased fixes in the `main` branch.

``` ruby
tree.supports_editing?  # => true if edit() is available
```

### Error Handling

``` ruby
begin
  language = TreeHaver::Language.from_library("/path/to/grammar.so")
rescue TreeHaver::NotAvailable => e
  puts "Failed to load grammar: #{e.message}"
end

# Check if a backend is available
if TreeHaver.backend_module.nil?
  puts "No TreeHaver backend is available!"
  puts "Install ruby_tree_sitter (MRI), ffi gem with libtree-sitter, or citrus gem"
end
```

### Platform-Specific Examples

#### MRI Ruby

On MRI, TreeHaver uses `ruby_tree_sitter` by default:

``` ruby
# Gemfile
gem "tree_haver"
gem "ruby_tree_sitter"  # MRI backend

# Code - no changes needed, TreeHaver auto-selects MRI backend
parser = TreeHaver::Parser.new
```

#### JRuby

On JRuby, TreeHaver can use the FFI backend, Java backend, or Citrus backend:

**Option 1: FFI Backend (recommended for tree-sitter grammars)**

``` ruby
# Gemfile
gem "tree_haver"
gem "ffi"  # Required for FFI backend

# Ensure libtree-sitter is installed on your system
# On macOS with Homebrew:
#   brew install tree-sitter

# On Ubuntu/Debian:
#   sudo apt-get install libtree-sitter0 libtree-sitter-dev

# Code - TreeHaver auto-selects FFI backend on JRuby
parser = TreeHaver::Parser.new
```

**Option 2: Java Backend (native JVM performance)**

``` bash
# 1. Download java-tree-sitter JAR from Maven Central
mkdir -p vendor/jars
curl -fSL -o vendor/jars/jtreesitter-0.23.2.jar \
  "https://repo1.maven.org/maven2/io/github/tree-sitter/jtreesitter/0.23.2/jtreesitter-0.23.2.jar"

# 2. Set environment variables
export CLASSPATH="$(pwd)/vendor/jars:$CLASSPATH"
export LD_LIBRARY_PATH="/path/to/libtree-sitter/lib:$LD_LIBRARY_PATH"

# 3. Run with JRuby (requires Java 22+ for Foreign Function API)
JAVA_OPTS="--enable-native-access=ALL-UNNAMED" jruby your_script.rb
```

``` ruby
# Force Java backend
TreeHaver.backend = :java

# Check if Java backend is available
if TreeHaver::Backends::Java.available?
  puts "Java backend is ready!"
  puts TreeHaver.capabilities
  # => { backend: :java, parse: true, query: true, bytes_field: true, incremental: true }
end
```

**‚ö†Ô∏è Java Backend Limitation: Symbol Resolution**

The Java backend uses Java's Foreign Function & Memory (FFM) API which loads libraries in isolation. Unlike the system's dynamic linker (`dlopen`), FFM's `SymbolLookup.or()` chains symbol lookups but doesn't resolve dynamic library dependencies.

This means grammar `.so` files with unresolved references to `libtree-sitter.so` symbols won't load correctly. Most grammars from luarocks, npm, or other sources have these dependencies.

**Recommended approach for JRuby:** Use the **FFI backend**:

``` ruby
# On JRuby, use FFI backend (recommended)
TreeHaver.backend = :ffi
```

The FFI backend uses Ruby's FFI gem which relies on the system's dynamic linker, correctly resolving symbol dependencies between `libtree-sitter.so` and grammar libraries.

The Java backend will work with:

  - Grammar JARs built specifically for java-tree-sitter / jtreesitter (self-contained, [docs](https://tree-sitter.github.io/java-tree-sitter/), [maven](https://central.sonatype.com/artifact/io.github.tree-sitter/jtreesitter), [source](https://github.com/tree-sitter/java-tree-sitter))
  - Grammar `.so` files that statically link tree-sitter
**Option 3: Citrus Backend (pure Ruby, portable)**

``` ruby
# Gemfile
gem "tree_haver"
gem "citrus"  # Pure Ruby parser, zero native dependencies

# Code - Force Citrus backend for maximum portability
TreeHaver.backend = :citrus

# Check if Citrus backend is available
if TreeHaver::Backends::Citrus.available?
  puts "Citrus backend is ready!"
  puts TreeHaver.capabilities
  # => { backend: :citrus, parse: true, query: false, bytes_field: false }
end
```

**‚ö†Ô∏è Citrus Backend Limitations:**

  - Uses Citrus grammars (not tree-sitter grammars)
  - No incremental parsing support
  - No query API
  - Pure Ruby performance (slower than native backends)
  - Best for: prototyping, environments without native extension support, teaching
#### TruffleRuby

TruffleRuby can use the MRI, FFI, or Citrus backend:

``` ruby
# Use FFI backend (recommended for tree-sitter grammars)
TreeHaver.backend = :ffi

# Or try MRI backend if ruby_tree_sitter compiles on your TruffleRuby version
TreeHaver.backend = :mri

# Or use Citrus backend for zero native dependencies
TreeHaver.backend = :citrus
```

### Advanced: Thread-Safe Backend Switching

TreeHaver provides `with_backend` for thread-safe, temporary backend switching. This is
essential for testing, benchmarking, and applications that need different backends in
different contexts.

#### Testing with Multiple Backends

Test the same code path with different backends using `with_backend`:

``` ruby
# In your test setup
RSpec.describe("MyParser") do
  # Test with each available backend
  [:mri, :rust, :citrus].each do |backend_name|
    context "with #{backend_name} backend" do
      it "parses correctly" do
        TreeHaver.with_backend(backend_name) do
          parser = TreeHaver::Parser.new
          result = parser.parse("x = 42")
          expect(result.root_node.type).to(eq("document"))
        end
        # Backend automatically restored after block
      end
    end
  end
end
```

#### Thread Isolation

Each thread can use a different backend safely‚Äî`with_backend` uses thread-local storage:

``` ruby
threads = []

threads << Thread.new do
  TreeHaver.with_backend(:mri) do
    # This thread uses MRI backend
    parser = TreeHaver::Parser.new
    100.times { parser.parse("x = 1") }
  end
end

threads << Thread.new do
  TreeHaver.with_backend(:citrus) do
    # This thread uses Citrus backend simultaneously
    parser = TreeHaver::Parser.new
    100.times { parser.parse("x = 1") }
  end
end

threads.each(&:join)
```

#### Nested Blocks

`with_backend` supports nesting‚Äîinner blocks override outer blocks:

``` ruby
TreeHaver.with_backend(:rust) do
  puts TreeHaver.effective_backend  # => :rust

  TreeHaver.with_backend(:citrus) do
    puts TreeHaver.effective_backend  # => :citrus
  end

  puts TreeHaver.effective_backend  # => :rust (restored)
end
```

#### Fallback Pattern

Try one backend, fall back to another on failure:

``` ruby
def parse_with_fallback(source)
  TreeHaver.with_backend(:mri) do
    TreeHaver::Parser.new.tap { |p| p.language = load_language }.parse(source)
  end
rescue TreeHaver::NotAvailable
  # Fall back to Citrus if MRI backend unavailable
  TreeHaver.with_backend(:citrus) do
    TreeHaver::Parser.new.tap { |p| p.language = load_language }.parse(source)
  end
end
```

### Complete Real-World Example

Here's a practical example that extracts package names from a TOML file:

``` ruby
require "tree_haver"

# Setup
TreeHaver.register_language(
  :toml,
  path: "/usr/local/lib/libtree-sitter-toml.so",
)

def extract_package_name(toml_content)
  # Create parser
  parser = TreeHaver::Parser.new
  parser.language = TreeHaver::Language.toml

  # Parse
  tree = parser.parse(toml_content)
  root = tree.root_node

  # Find [package] table
  root.each do |child|
    next unless child.type == "table"

    child.each do |table_elem|
      if table_elem.type == "pair"
        # Look for name = "..." pair
        key = table_elem.each.first&.type
        # In a real implementation, you'd extract the text value
        # This is simplified for demonstration
      end
    end
  end
end

# Usage
toml = <<~TOML
  [package]
  name = "awesome-app"
  version = "2.0.0"
TOML

package_name = extract_package_name(toml)
```

### üß™ RSpec Integration

TreeHaver provides shared RSpec helpers for conditional test execution based on dependency availability. This is useful for testing code that uses optional backends.

``` ruby
# In your spec_helper.rb
require "tree_haver/rspec"
```

This automatically configures RSpec with exclusion filters for all TreeHaver dependencies. Use tags to conditionally run tests:

``` ruby
# Runs only when FFI backend is available
it "parses with FFI", :ffi do
  # ...
end

# Runs only when ruby_tree_sitter gem is available
it "uses MRI backend", :mri_backend do
  # ...
end

# Runs only when tree-sitter-toml grammar works
it "parses TOML", :tree_sitter_toml do
  # ...
end

# Runs only when any markdown backend is available
it "parses markdown", :markdown_backend do
  # ...
end
```

**Available Tags:**

| Tag | Description |
| --- | --- |
| `:ffi` | FFI backend available (dynamic check) |
| `:mri_backend` | ruby\_tree\_sitter gem available |
| `:rust_backend` | tree\_stump gem available |
| `:java_backend` | Java backend available (JRuby) |
| `:prism_backend` | Prism gem available |
| `:psych_backend` | Psych available (stdlib) |
| `:commonmarker` | commonmarker gem available |
| `:markly` | markly gem available |
| `:citrus_toml` | toml-rb with Citrus grammar available |
| `:jruby` | Running on JRuby |
| `:truffleruby` | Running on TruffleRuby |
| `:mri` | Running on MRI (CRuby) |
| `:tree_sitter_bash` | Bash grammar available and working |
| `:tree_sitter_toml` | TOML grammar available and working |
| `:tree_sitter_json` | JSON grammar available and working |
| `:tree_sitter_jsonc` | JSONC grammar available and working |
| `:toml_backend` | Any TOML backend available |
| `:markdown_backend` | Any markdown backend available |
| `:toml_merge` | toml-merge gem functional |
| `:json_merge` | json-merge gem functional |
| `:prism_merge` | prism-merge gem functional |
| `:psych_merge` | psych-merge gem functional |

All tags have negated versions (e.g., `:not_mri_backend`, `:not_jruby`) for testing fallback behavior.

**Debug Output:**

Set `TREE_HAVER_DEBUG=1` to print a dependency summary at the start of your test suite:

``` bash
TREE_HAVER_DEBUG=1 bundle exec rspec
```

## ü¶∑ FLOSS Funding

While kettle-rb tools are free software and will always be, the project would benefit immensely from some funding.
Raising a monthly budget of... "dollars" would make the project more sustainable.

We welcome both individual and corporate sponsors\! We also offer a
wide array of funding channels to account for your preferences
(although currently [Open Collective](https://opencollective.com/kettle-rb) is our preferred funding platform).

**If you're working in a company that's making significant use of kettle-rb tools we'd
appreciate it if you suggest to your company to become a kettle-rb sponsor.**

You can support the development of kettle-rb tools via
[GitHub Sponsors](https://github.com/sponsors/pboling),
[Liberapay](https://liberapay.com/pboling/donate),
[PayPal](https://www.paypal.com/paypalme/peterboling),
[Open Collective](https://opencollective.com/kettle-rb)
and [Tidelift](https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&utm_medium=referral&utm_campaign=readme).

| üìç NOTE |
| --- |
| If doing a sponsorship in the form of donation is problematic for your company <br/> from an accounting standpoint, we'd recommend the use of Tidelift, <br/> where you can get a support-like subscription instead. |

### Open Collective for Individuals

Support us with a monthly donation and help us continue our activities. \[[Become a backer](https://opencollective.com/kettle-rb#backer)\]

NOTE: [kettle-readme-backers](https://github.com/kettle-rb/tree_haver/blob/main/exe/kettle-readme-backers) updates this list every day, automatically.

<!-- OPENCOLLECTIVE-INDIVIDUALS:START -->
No backers yet. Be the first\!
<!-- OPENCOLLECTIVE-INDIVIDUALS:END -->

### Open Collective for Organizations

Become a sponsor and get your logo on our README on GitHub with a link to your site. \[[Become a sponsor](https://opencollective.com/kettle-rb#sponsor)\]

NOTE: [kettle-readme-backers](https://github.com/kettle-rb/tree_haver/blob/main/exe/kettle-readme-backers) updates this list every day, automatically.

<!-- OPENCOLLECTIVE-ORGANIZATIONS:START -->
No sponsors yet. Be the first\!
<!-- OPENCOLLECTIVE-ORGANIZATIONS:END -->

[kettle-readme-backers]: https://github.com/kettle-rb/tree_haver/blob/main/exe/kettle-readme-backers

### Another way to support open-source

I‚Äôm driven by a passion to foster a thriving open-source community ‚Äì a space where people can tackle complex problems, no matter how small. Revitalizing libraries that have fallen into disrepair, and building new libraries focused on solving real-world challenges, are my passions. I was recently affected by layoffs, and the tech jobs market is unwelcoming. I‚Äôm reaching out here because your support would significantly aid my efforts to provide for my family, and my farm (11 üêî chickens, 2 üê∂ dogs, 3 üê∞ rabbits, 8 üêà‚Äç cats).

If you work at a company that uses my work, please encourage them to support me as a corporate sponsor. My work on gems you use might show up in `bundle fund`.

I‚Äôm developing a new library, [floss\_funding](https://github.com/galtzo-floss/floss_funding), designed to empower open-source developers like myself to get paid for the work we do, in a sustainable way. Please give it a look.

**[Floss-Funding.dev](https://floss-funding.dev): üëâÔ∏è No network calls. üëâÔ∏è No tracking. üëâÔ∏è No oversight. üëâÔ∏è Minimal crypto hashing. üí° Easily disabled nags**

[![OpenCollective Backers](https://opencollective.com/kettle-rb/backers/badge.svg?style=flat)](https://opencollective.com/kettle-rb#backer) [![OpenCollective Sponsors](https://opencollective.com/kettle-rb/sponsors/badge.svg?style=flat)](https://opencollective.com/kettle-rb#sponsor) [![Sponsor Me on Github](https://img.shields.io/badge/Sponsor_Me!-pboling.svg?style=social&logo=github)](https://github.com/sponsors/pboling) [![Liberapay Goal Progress](https://img.shields.io/liberapay/goal/pboling.svg?logo=liberapay&color=a51611&style=flat)](https://liberapay.com/pboling/donate) [![Donate on PayPal](https://img.shields.io/badge/donate-paypal-a51611.svg?style=flat&logo=paypal)](https://www.paypal.com/paypalme/peterboling) [![Buy me a coffee](https://img.shields.io/badge/buy_me_a_coffee-%E2%9C%93-a51611.svg?style=flat)](https://www.buymeacoffee.com/pboling) [![Donate on Polar](https://img.shields.io/badge/polar-donate-a51611.svg?style=flat)](https://polar.sh/pboling) [![Donate to my FLOSS efforts at ko-fi.com](https://img.shields.io/badge/ko--fi-%E2%9C%93-a51611.svg?style=flat)](https://ko-fi.com/O5O86SNP4) [![Donate to my FLOSS efforts using Patreon](https://img.shields.io/badge/patreon-donate-a51611.svg?style=flat)](https://patreon.com/galtzo)

## üîê Security

See [SECURITY.md](SECURITY.md).

## ü§ù Contributing

If you need some ideas of where to help, you could work on adding more code coverage,
or if it is already üíØ (see [below](#code-coverage)) check [reek](REEK), [issues](https://github.com/kettle-rb/tree_haver/issues), or [PRs](https://github.com/kettle-rb/tree_haver/pulls),
or use the gem and think about how it could be better.

We [![Keep A Changelog](https://img.shields.io/badge/keep--a--changelog-1.0.0-34495e.svg?style=flat)](https://keepachangelog.com/en/1.0.0/) so if you make changes, remember to update it.

See [CONTRIBUTING.md](CONTRIBUTING.md) for more detailed instructions.

### üöÄ Release Instructions

See [CONTRIBUTING.md](CONTRIBUTING.md).

### Code Coverage

[![Coverage Graph](https://codecov.io/gh/kettle-rb/tree_haver/graphs/tree.svg)](https://codecov.io/gh/kettle-rb/tree_haver)

[![Coveralls Test Coverage](https://coveralls.io/repos/github/kettle-rb/tree_haver/badge.svg?branch=main)](https://coveralls.io/github/kettle-rb/tree_haver?branch=main)

[![QLTY Test Coverage](https://qlty.sh/gh/kettle-rb/projects/tree_haver/coverage.svg)](https://qlty.sh/gh/kettle-rb/projects/tree_haver/metrics/code?sort=coverageRating)

### ü™á Code of Conduct

Everyone interacting with this project's codebases, issue trackers,
chat rooms and mailing lists agrees to follow the [![Contributor Covenant 2.1](https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg)](CODE_OF_CONDUCT.md).

## üåà Contributors

[![Contributors](https://contrib.rocks/image?repo=kettle-rb/tree_haver)](https://github.com/kettle-rb/tree_haver/graphs/contributors)

Made with [contributors-img](https://contrib.rocks).

Also see GitLab Contributors: <https://gitlab.com/kettle-rb/tree_haver/-/graphs/main>

<details>
    <summary>‚≠êÔ∏è Star History</summary>

<a href="https://star-history.com/#kettle-rb/tree_haver&Date">
 <picture>
   <source media="(prefers-color-scheme: dark)" srcset="https://api.star-history.com/svg?repos=kettle-rb/tree_haver&type=Date&theme=dark" />
   <source media="(prefers-color-scheme: light)" srcset="https://api.star-history.com/svg?repos=kettle-rb/tree_haver&type=Date" />
   <img alt="Star History Chart" src="https://api.star-history.com/svg?repos=kettle-rb/tree_haver&type=Date" />
 </picture>
</a>

</details>

## üìå Versioning

This Library adheres to [![Semantic Versioning 2.0.0](https://img.shields.io/badge/semver-2.0.0-259D6C.svg?style=flat)](https://semver.org/spec/v2.0.0.html).
Violations of this scheme should be reported as bugs.
Specifically, if a minor or patch version is released that breaks backward compatibility,
a new version should be immediately released that restores compatibility.
Breaking changes to the public API will only be introduced with new major versions.

> dropping support for a platform is both obviously and objectively a breaking change <br/>
> ‚ÄîJordan Harband ([@ljharb](https://github.com/ljharb), maintainer of SemVer) [in SemVer issue 716](https://github.com/semver/semver/issues/716#issuecomment-869336139)

I understand that policy doesn't work universally ("exceptions to every rule\!"),
but it is the policy here.
As such, in many cases it is good to specify a dependency on this library using
the [Pessimistic Version Constraint](http://guides.rubygems.org/patterns/#pessimistic-version-constraint) with two digits of precision.

For example:

``` ruby
spec.add_dependency("tree_haver", "~> 1.0")
```

<details markdown="1">
<summary>üìå Is "Platform Support" part of the public API? More details inside.</summary>

SemVer should, IMO, but doesn't explicitly, say that dropping support for specific Platforms
is a *breaking change* to an API, and for that reason the bike shedding is endless.

To get a better understanding of how SemVer is intended to work over a project's lifetime,
read this article from the creator of SemVer:

  - ["Major Version Numbers are Not Sacred"](https://tom.preston-werner.com/2022/05/23/major-version-numbers-are-not-sacred.html)
</details>

See [CHANGELOG.md](CHANGELOG.md) for a list of releases.

## üìÑ License

The gem is available as open source under the terms of
the [MIT License](LICENSE.txt) [![License: MIT](https://img.shields.io/badge/License-MIT-259D6C.svg)](https://opensource.org/licenses/MIT).
See [LICENSE.txt](LICENSE.txt) for the official [Copyright Notice](https://opensource.stackexchange.com/questions/5778/why-do-licenses-such-as-the-mit-license-specify-a-single-year).

### ¬© Copyright

<ul>
    <li>
        Copyright (c) 2025-2026 Peter H.¬†Boling, of
        <a href="https://discord.gg/3qme4XHNKN">
            Galtzo.com
            <picture>
              <img src="https://logos.galtzo.com/assets/images/galtzo-floss/avatar-128px-blank.svg" alt="Galtzo.com Logo (Wordless) by Aboling0, CC BY-SA 4.0" width="24">
            </picture>
        </a>, and tree_haver contributors.
    </li>
</ul>

## ü§ë A request for help

Maintainers have teeth and need to pay their dentists.
After getting laid off in an RIF in March, and encountering difficulty finding a new one,
I began spending most of my time building open source tools.
I'm hoping to be able to pay for my kids' health insurance this month,
so if you value the work I am doing, I need your support.
Please consider sponsoring me or the project.

To join the community or get help üëáÔ∏è Join the Discord.

[![Live Chat on Discord](https://img.shields.io/discord/1373797679469170758?style=for-the-badge&logo=discord)](https://discord.gg/3qme4XHNKN)

To say "thanks\!" ‚òùÔ∏è Join the Discord or üëáÔ∏è send money.

[![Sponsor kettle-rb/tree\_haver on Open Source Collective](https://img.shields.io/opencollective/all/kettle-rb?style=for-the-badge)](https://opencollective.com/kettle-rb) üíå [![Sponsor me on GitHub Sponsors](https://img.shields.io/badge/Sponsor_Me!-pboling-blue?style=for-the-badge&logo=github)](https://github.com/sponsors/pboling) üíå [![Sponsor me on Liberapay](https://img.shields.io/liberapay/goal/pboling.svg?style=for-the-badge&logo=liberapay&color=a51611)](https://liberapay.com/pboling/donate) üíå [![Donate on PayPal](https://img.shields.io/badge/donate-paypal-a51611.svg?style=for-the-badge&logo=paypal&color=0A0A0A)](https://www.paypal.com/paypalme/peterboling)

### Please give the project a star ‚≠ê ‚ô•.

Thanks for RTFM. ‚ò∫Ô∏è

[‚õ≥liberapay-img]: https://img.shields.io/liberapay/goal/pboling.svg?logo=liberapay&color=a51611&style=flat
[‚õ≥liberapay-bottom-img]: https://img.shields.io/liberapay/goal/pboling.svg?style=for-the-badge&logo=liberapay&color=a51611
[‚õ≥liberapay]: https://liberapay.com/pboling/donate
[üñáosc-all-img]: https://img.shields.io/opencollective/all/kettle-rb
[üñáosc-sponsors-img]: https://img.shields.io/opencollective/sponsors/kettle-rb
[üñáosc-backers-img]: https://img.shields.io/opencollective/backers/kettle-rb
[üñáosc-backers]: https://opencollective.com/kettle-rb#backer
[üñáosc-backers-i]: https://opencollective.com/kettle-rb/backers/badge.svg?style=flat
[üñáosc-sponsors]: https://opencollective.com/kettle-rb#sponsor
[üñáosc-sponsors-i]: https://opencollective.com/kettle-rb/sponsors/badge.svg?style=flat
[üñáosc-all-bottom-img]: https://img.shields.io/opencollective/all/kettle-rb?style=for-the-badge
[üñáosc-sponsors-bottom-img]: https://img.shields.io/opencollective/sponsors/kettle-rb?style=for-the-badge
[üñáosc-backers-bottom-img]: https://img.shields.io/opencollective/backers/kettle-rb?style=for-the-badge
[üñáosc]: https://opencollective.com/kettle-rb
[üñásponsor-img]: https://img.shields.io/badge/Sponsor_Me!-pboling.svg?style=social&logo=github
[üñásponsor-bottom-img]: https://img.shields.io/badge/Sponsor_Me!-pboling-blue?style=for-the-badge&logo=github
[üñásponsor]: https://github.com/sponsors/pboling
[üñápolar-img]: https://img.shields.io/badge/polar-donate-a51611.svg?style=flat
[üñápolar]: https://polar.sh/pboling
[üñákofi-img]: https://img.shields.io/badge/ko--fi-%E2%9C%93-a51611.svg?style=flat
[üñákofi]: https://ko-fi.com/O5O86SNP4
[üñápatreon-img]: https://img.shields.io/badge/patreon-donate-a51611.svg?style=flat
[üñápatreon]: https://patreon.com/galtzo
[üñábuyme-small-img]: https://img.shields.io/badge/buy_me_a_coffee-%E2%9C%93-a51611.svg?style=flat
[üñábuyme-img]: https://img.buymeacoffee.com/button-api/?text=Buy%20me%20a%20latte&emoji=&slug=pboling&button_colour=FFDD00&font_colour=000000&font_family=Cookie&outline_colour=000000&coffee_colour=ffffff
[üñábuyme]: https://www.buymeacoffee.com/pboling
[üñápaypal-img]: https://img.shields.io/badge/donate-paypal-a51611.svg?style=flat&logo=paypal
[üñápaypal-bottom-img]: https://img.shields.io/badge/donate-paypal-a51611.svg?style=for-the-badge&logo=paypal&color=0A0A0A
[üñápaypal]: https://www.paypal.com/paypalme/peterboling
[üñáfloss-funding.dev]: https://floss-funding.dev
[üñáfloss-funding-gem]: https://github.com/galtzo-floss/floss_funding
[‚úâÔ∏èdiscord-invite]: https://discord.gg/3qme4XHNKN
[‚úâÔ∏èdiscord-invite-img-ftb]: https://img.shields.io/discord/1373797679469170758?style=for-the-badge&logo=discord
[‚úâÔ∏èruby-friends-img]: https://img.shields.io/badge/daily.dev-%F0%9F%92%8E_Ruby_Friends-0A0A0A?style=for-the-badge&logo=dailydotdev&logoColor=white
[‚úâÔ∏èruby-friends]: https://app.daily.dev/squads/rubyfriends
[‚úábundle-group-pattern]: https://gist.github.com/pboling/4564780
[‚õ≥Ô∏ègem-namespace]: https://github.com/kettle-rb/tree_haver
[‚õ≥Ô∏ènamespace-img]: https://img.shields.io/badge/namespace-TreeHaver-3C2D2D.svg?style=square&logo=ruby&logoColor=white
[‚õ≥Ô∏ègem-name]: https://bestgems.org/gems/tree_haver
[‚õ≥Ô∏èname-img]: https://img.shields.io/badge/name-tree__haver-3C2D2D.svg?style=square&logo=rubygems&logoColor=red
[‚õ≥Ô∏ètag-img]: https://img.shields.io/github/tag/kettle-rb/tree_haver.svg
[‚õ≥Ô∏ètag]: http://github.com/kettle-rb/tree_haver/releases
[üöÇmaint-blog]: http://www.railsbling.com/tags/tree_haver
[üöÇmaint-blog-img]: https://img.shields.io/badge/blog-railsbling-0093D0.svg?style=for-the-badge&logo=rubyonrails&logoColor=orange
[üöÇmaint-contact]: http://www.railsbling.com/contact
[üöÇmaint-contact-img]: https://img.shields.io/badge/Contact-Maintainer-0093D0.svg?style=flat&logo=rubyonrails&logoColor=red
[üíñüñálinkedin]: http://www.linkedin.com/in/peterboling
[üíñüñálinkedin-img]: https://img.shields.io/badge/PeterBoling-LinkedIn-0B66C2?style=flat&logo=newjapanprowrestling
[üíñ‚úåÔ∏èwellfound]: https://wellfound.com/u/peter-boling
[üíñ‚úåÔ∏èwellfound-img]: https://img.shields.io/badge/peter--boling-orange?style=flat&logo=wellfound
[üíñüí≤crunchbase]: https://www.crunchbase.com/person/peter-boling
[üíñüí≤crunchbase-img]: https://img.shields.io/badge/peter--boling-purple?style=flat&logo=crunchbase
[üíñüêòruby-mast]: https://ruby.social/@galtzo
[üíñüêòruby-mast-img]: https://img.shields.io/mastodon/follow/109447111526622197?domain=https://ruby.social&style=flat&logo=mastodon&label=Ruby%20@galtzo
[üíñü¶ãbluesky]: https://bsky.app/profile/galtzo.com
[üíñü¶ãbluesky-img]: https://img.shields.io/badge/@galtzo.com-0285FF?style=flat&logo=bluesky&logoColor=white
[üíñüå≥linktree]: https://linktr.ee/galtzo
[üíñüå≥linktree-img]: https://img.shields.io/badge/galtzo-purple?style=flat&logo=linktree
[üíñüíÅüèº‚Äç‚ôÇÔ∏èdevto]: https://dev.to/galtzo
[üíñüíÅüèº‚Äç‚ôÇÔ∏èdevto-img]: https://img.shields.io/badge/dev.to-0A0A0A?style=flat&logo=devdotto&logoColor=white
[üíñüíÅüèº‚Äç‚ôÇÔ∏èaboutme]: https://about.me/peter.boling
[üíñüíÅüèº‚Äç‚ôÇÔ∏èaboutme-img]: https://img.shields.io/badge/about.me-0A0A0A?style=flat&logo=aboutme&logoColor=white
[üíñüßäberg]: https://codeberg.org/pboling
[üíñüêôhub]: https://github.org/pboling
[üíñüõñhut]: https://sr.ht/~galtzo/
[üíñüß™lab]: https://gitlab.com/pboling
[üë®üèº‚Äçüè´expsup-upwork]: https://www.upwork.com/freelancers/~014942e9b056abdf86?mp_source=share
[üë®üèº‚Äçüè´expsup-upwork-img]: https://img.shields.io/badge/UpWork-13544E?style=for-the-badge&logo=Upwork&logoColor=white
[üë®üèº‚Äçüè´expsup-codementor]: https://www.codementor.io/peterboling?utm_source=github&utm_medium=button&utm_term=peterboling&utm_campaign=github
[üë®üèº‚Äçüè´expsup-codementor-img]: https://img.shields.io/badge/CodeMentor-Get_Help-1abc9c?style=for-the-badge&logo=CodeMentor&logoColor=white
[üèôÔ∏èentsup-tidelift]: https://tidelift.com/subscription/pkg/rubygems-tree_haver?utm_source=rubygems-tree_haver&utm_medium=referral&utm_campaign=readme
[üèôÔ∏èentsup-tidelift-img]: https://img.shields.io/badge/Tidelift_and_Sonar-Enterprise_Support-FD3456?style=for-the-badge&logo=sonar&logoColor=white
[üèôÔ∏èentsup-tidelift-sonar]: https://blog.tidelift.com/tidelift-joins-sonar
[üíÅüèº‚Äç‚ôÇÔ∏èpeterboling]: http://www.peterboling.com
[üöÇrailsbling]: http://www.railsbling.com
[üìúsrc-gl-img]: https://img.shields.io/badge/GitLab-FBA326?style=for-the-badge&logo=Gitlab&logoColor=orange
[üìúsrc-gl]: https://gitlab.com/kettle-rb/tree_haver/
[üìúsrc-cb-img]: https://img.shields.io/badge/CodeBerg-4893CC?style=for-the-badge&logo=CodeBerg&logoColor=blue
[üìúsrc-cb]: https://codeberg.org/kettle-rb/tree_haver
[üìúsrc-gh-img]: https://img.shields.io/badge/GitHub-238636?style=for-the-badge&logo=Github&logoColor=green
[üìúsrc-gh]: https://github.com/kettle-rb/tree_haver
[üìúdocs-cr-rd-img]: https://img.shields.io/badge/RubyDoc-Current_Release-943CD2?style=for-the-badge&logo=readthedocs&logoColor=white
[üìúdocs-head-rd-img]: https://img.shields.io/badge/YARD_on_Galtzo.com-HEAD-943CD2?style=for-the-badge&logo=readthedocs&logoColor=white
[üìúgl-wiki]: https://gitlab.com/kettle-rb/tree_haver/-/wikis/home
[üìúgh-wiki]: https://github.com/kettle-rb/tree_haver/wiki
[üìúgl-wiki-img]: https://img.shields.io/badge/wiki-examples-943CD2.svg?style=for-the-badge&logo=gitlab&logoColor=white
[üìúgh-wiki-img]: https://img.shields.io/badge/wiki-examples-943CD2.svg?style=for-the-badge&logo=github&logoColor=white
[üëΩdl-rank]: https://bestgems.org/gems/tree_haver
[üëΩdl-ranki]: https://img.shields.io/gem/rd/tree_haver.svg
[üëΩoss-help]: https://www.codetriage.com/kettle-rb/tree_haver
[üëΩoss-helpi]: https://www.codetriage.com/kettle-rb/tree_haver/badges/users.svg
[üëΩversion]: https://bestgems.org/gems/tree_haver
[üëΩversioni]: https://img.shields.io/gem/v/tree_haver.svg
[üèÄqlty-mnt]: https://qlty.sh/gh/kettle-rb/projects/tree_haver
[üèÄqlty-mnti]: https://qlty.sh/gh/kettle-rb/projects/tree_haver/maintainability.svg
[üèÄqlty-cov]: https://qlty.sh/gh/kettle-rb/projects/tree_haver/metrics/code?sort=coverageRating
[üèÄqlty-covi]: https://qlty.sh/gh/kettle-rb/projects/tree_haver/coverage.svg
[üèÄcodecov]: https://codecov.io/gh/kettle-rb/tree_haver
[üèÄcodecovi]: https://codecov.io/gh/kettle-rb/tree_haver/graph/badge.svg
[üèÄcoveralls]: https://coveralls.io/github/kettle-rb/tree_haver?branch=main
[üèÄcoveralls-img]: https://coveralls.io/repos/github/kettle-rb/tree_haver/badge.svg?branch=main
[üñêcodeQL]: https://github.com/kettle-rb/tree_haver/security/code-scanning
[üñêcodeQL-img]: https://github.com/kettle-rb/tree_haver/actions/workflows/codeql-analysis.yml/badge.svg
[üöé2-cov-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/coverage.yml
[üöé2-cov-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/coverage.yml/badge.svg
[üöé3-hd-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml
[üöé3-hd-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/heads.yml/badge.svg
[üöé5-st-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/style.yml
[üöé5-st-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/style.yml/badge.svg
[üöé6-s-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml
[üöé6-s-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/supported.yml/badge.svg
[üöé9-t-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml
[üöé9-t-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/truffle.yml/badge.svg
[üöé11-c-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml
[üöé11-c-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/current.yml/badge.svg
[üöé12-crh-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/dep-heads.yml
[üöé12-crh-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/dep-heads.yml/badge.svg
[üöé13-üîíÔ∏è-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/locked_deps.yml
[üöé13-üîíÔ∏è-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/locked_deps.yml/badge.svg
[üöé14-üîìÔ∏è-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/unlocked_deps.yml
[üöé14-üîìÔ∏è-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/unlocked_deps.yml/badge.svg
[üöé15-ü™™-wf]: https://github.com/kettle-rb/tree_haver/actions/workflows/license-eye.yml
[üöé15-ü™™-wfi]: https://github.com/kettle-rb/tree_haver/actions/workflows/license-eye.yml/badge.svg
[üíéruby-3.2i]: https://img.shields.io/badge/Ruby-3.2-CC342D?style=for-the-badge&logo=ruby&logoColor=white
[üíéruby-3.3i]: https://img.shields.io/badge/Ruby-3.3-CC342D?style=for-the-badge&logo=ruby&logoColor=white
[üíéruby-c-i]: https://img.shields.io/badge/Ruby-current-CC342D?style=for-the-badge&logo=ruby&logoColor=green
[üíéruby-headi]: https://img.shields.io/badge/Ruby-HEAD-CC342D?style=for-the-badge&logo=ruby&logoColor=blue
[üíétruby-23.1i]: https://img.shields.io/badge/Truffle_Ruby-23.1-34BCB1?style=for-the-badge&logo=ruby&logoColor=pink
[üíétruby-c-i]: https://img.shields.io/badge/Truffle_Ruby-current-34BCB1?style=for-the-badge&logo=ruby&logoColor=green
[üíétruby-headi]: https://img.shields.io/badge/Truffle_Ruby-HEAD-34BCB1?style=for-the-badge&logo=ruby&logoColor=blue
[üíéjruby-c-i]: https://img.shields.io/badge/JRuby-current-FBE742?style=for-the-badge&logo=ruby&logoColor=green
[üíéjruby-headi]: https://img.shields.io/badge/JRuby-HEAD-FBE742?style=for-the-badge&logo=ruby&logoColor=blue
[ü§ùgh-issues]: https://github.com/kettle-rb/tree_haver/issues
[ü§ùgh-pulls]: https://github.com/kettle-rb/tree_haver/pulls
[ü§ùgl-issues]: https://gitlab.com/kettle-rb/tree_haver/-/issues
[ü§ùgl-pulls]: https://gitlab.com/kettle-rb/tree_haver/-/merge_requests
[ü§ùcb-issues]: https://codeberg.org/kettle-rb/tree_haver/issues
[ü§ùcb-pulls]: https://codeberg.org/kettle-rb/tree_haver/pulls
[ü§ùcb-donate]: https://donate.codeberg.org/
[ü§ùcontributing]: CONTRIBUTING.md
[üèÄcodecov-g]: https://codecov.io/gh/kettle-rb/tree_haver/graphs/tree.svg
[üñêcontrib-rocks]: https://contrib.rocks
[üñêcontributors]: https://github.com/kettle-rb/tree_haver/graphs/contributors
[üñêcontributors-img]: https://contrib.rocks/image?repo=kettle-rb/tree_haver
[üöécontributors-gl]: https://gitlab.com/kettle-rb/tree_haver/-/graphs/main
[ü™áconduct]: CODE_OF_CONDUCT.md
[ü™áconduct-img]: https://img.shields.io/badge/Contributor_Covenant-2.1-259D6C.svg
[üìåpvc]: http://guides.rubygems.org/patterns/#pessimistic-version-constraint
[üìåsemver]: https://semver.org/spec/v2.0.0.html
[üìåsemver-img]: https://img.shields.io/badge/semver-2.0.0-259D6C.svg?style=flat
[üìåsemver-breaking]: https://github.com/semver/semver/issues/716#issuecomment-869336139
[üìåmajor-versions-not-sacred]: https://tom.preston-werner.com/2022/05/23/major-version-numbers-are-not-sacred.html
[üìåchangelog]: CHANGELOG.md
[üìókeep-changelog]: https://keepachangelog.com/en/1.0.0/
[üìókeep-changelog-img]: https://img.shields.io/badge/keep--a--changelog-1.0.0-34495e.svg?style=flat
[üìågitmoji]: https://gitmoji.dev
[üìågitmoji-img]: https://img.shields.io/badge/gitmoji_commits-%20%F0%9F%98%9C%20%F0%9F%98%8D-34495e.svg?style=flat-square
[üßÆkloc]: https://www.youtube.com/watch?v=dQw4w9WgXcQ
[üßÆkloc-img]: https://img.shields.io/badge/KLOC-2.190-FFDD67.svg?style=for-the-badge&logo=YouTube&logoColor=blue
[üîêsecurity]: SECURITY.md
[üîêsecurity-img]: https://img.shields.io/badge/security-policy-259D6C.svg?style=flat
[üìÑcopyright-notice-explainer]: https://opensource.stackexchange.com/questions/5778/why-do-licenses-such-as-the-mit-license-specify-a-single-year
[üìÑlicense]: LICENSE.txt
[üìÑlicense-ref]: https://opensource.org/licenses/MIT
[üìÑlicense-img]: https://img.shields.io/badge/License-MIT-259D6C.svg
[üìÑlicense-compat]: https://dev.to/galtzo/how-to-check-license-compatibility-41h0
[üìÑlicense-compat-img]: https://img.shields.io/badge/Apache_Compatible:_Category_A-%E2%9C%93-259D6C.svg?style=flat&logo=Apache
[üìÑilo-declaration]: https://www.ilo.org/declaration/lang--en/index.htm
[üìÑilo-declaration-img]: https://img.shields.io/badge/ILO_Fundamental_Principles-‚úì-259D6C.svg?style=flat
[üöéyard-current]: http://rubydoc.info/gems/tree_haver
[üöéyard-head]: https://tree-haver.galtzo.com
[üíéstone_checksums]: https://github.com/galtzo-floss/stone_checksums
[üíéSHA_checksums]: https://gitlab.com/kettle-rb/tree_haver/-/tree/main/checksums
[üíérlts]: https://github.com/rubocop-lts/rubocop-lts
[üíérlts-img]: https://img.shields.io/badge/code_style_&_linting-rubocop--lts-34495e.svg?plastic&logo=ruby&logoColor=white
[üíéappraisal2]: https://github.com/appraisal-rb/appraisal2
[üíéappraisal2-img]: https://img.shields.io/badge/appraised_by-appraisal2-34495e.svg?plastic&logo=ruby&logoColor=white
[üíéd-in-dvcs]: https://railsbling.com/posts/dvcs/put_the_d_in_dvcs/

[ts-jsonc]: https://gitlab.com/WhyNotHugo/tree-sitter-jsonc
[dotenv]: https://github.com/bkeepers/dotenv
